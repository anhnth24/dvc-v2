# [system] Schema - System Configuration and Multi-Tenancy

## OVERVIEW

The `[system]` schema manages system-wide configuration, multi-tenancy settings, validation rules, and operational parameters for the DVC v2 system. It provides centralized configuration management across all services.

## SCHEMA CREATION

```sql
-- System configuration and multi-tenant management
CREATE SCHEMA [system];
GO
```

## CONFIGURATION TABLES

### 1. CH_FILEDAUVAODAURA - File input/output configuration

```sql
CREATE TABLE [system].CH_FILEDAUVAODAURA (
    FileConfigID BIGINT PRIMARY KEY IDENTITY,
    ConfigCode NVARCHAR(100) UNIQUE NOT NULL,
    ConfigName NVARCHAR(255) NOT NULL,
    FileType NVARCHAR(50) NOT NULL, -- Input/Output/Template/Result
    Category NVARCHAR(100),
    SubCategory NVARCHAR(100),

    -- File validation
    AllowedExtensions NVARCHAR(500), -- JSON array: [".pdf", ".doc", ".docx"]
    MaxFileSizeMB DECIMAL(10,2) DEFAULT 10,
    MinFileSizeMB DECIMAL(10,2) DEFAULT 0,
    ValidationRules NVARCHAR(MAX), -- JSON validation rules
    RequiredMetadata NVARCHAR(MAX), -- JSON required metadata fields

    -- Processing configuration
    ProcessingRules NVARCHAR(MAX), -- JSON processing instructions
    EnableOCR BIT DEFAULT 0,
    OCRLanguage NVARCHAR(20) DEFAULT 'vi',
    EnableAIProcessing BIT DEFAULT 0,
    AIProcessingModel NVARCHAR(100),

    -- Storage configuration
    StoragePath NVARCHAR(500), -- MinIO bucket/path pattern
    RetentionDays INT DEFAULT 2555, -- 7 years default
    ArchiveAfterDays INT DEFAULT 1095, -- 3 years
    CompressionEnabled BIT DEFAULT 1,

    -- Status
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT
);
GO

CREATE INDEX IX_FILE_CONFIG_Code ON [system].CH_FILEDAUVAODAURA(ConfigCode);
CREATE INDEX IX_FILE_CONFIG_Type ON [system].CH_FILEDAUVAODAURA(FileType, Category);
CREATE INDEX IX_FILE_CONFIG_Active ON [system].CH_FILEDAUVAODAURA(IsActive, FileType);
GO
```

### 2. CH_LYDO - Reason configuration

```sql
CREATE TABLE [system].CH_LYDO (
    LyDoConfigID BIGINT PRIMARY KEY IDENTITY,
    ConfigCode NVARCHAR(100) UNIQUE NOT NULL,
    ConfigName NVARCHAR(255) NOT NULL,

    -- Action context
    ActionType NVARCHAR(100) NOT NULL, -- Reject/Cancel/Suspend/Return/Approve/etc.
    Category NVARCHAR(100), -- Technical/Legal/Administrative/Business
    Severity TINYINT DEFAULT 1, -- 1=Low, 2=Medium, 3=High, 4=Critical

    -- Reason content
    ReasonText NVARCHAR(2000) NOT NULL,
    DetailedDescription NVARCHAR(4000),
    LegalBasis NVARCHAR(1000),

    -- Applicability
    ApplicableContexts NVARCHAR(MAX), -- JSON array of contexts
    TTHCTypes NVARCHAR(MAX), -- JSON array of TTHC types
    ProcessingSteps NVARCHAR(MAX), -- JSON array of workflow steps

    -- Automation
    TriggerAutoActions BIT DEFAULT 0,
    AutoActions NVARCHAR(MAX), -- JSON array of automatic actions
    RequiredFollowUp NVARCHAR(1000),

    -- Notification settings
    NotifyCitizen BIT DEFAULT 1,
    NotificationTemplate NVARCHAR(255),
    NotificationMethod TINYINT DEFAULT 1, -- 1=Email, 2=SMS, 3=Both, 4=Portal

    -- Status
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT
);
GO

CREATE INDEX IX_LYDO_CONFIG_Action ON [system].CH_LYDO(ActionType, Category);
CREATE INDEX IX_LYDO_CONFIG_Severity ON [system].CH_LYDO(Severity, ActionType);
CREATE INDEX IX_LYDO_CONFIG_Active ON [system].CH_LYDO(IsActive, ActionType);
GO
```

### 3. CH_NGUOIKY - Digital signer configuration

```sql
CREATE TABLE [system].CH_NGUOIKY (
    NguoiKyConfigID BIGINT PRIMARY KEY IDENTITY,
    ConfigCode NVARCHAR(100) UNIQUE NOT NULL,
    ConfigName NVARCHAR(255) NOT NULL,

    -- Signer classification
    SignerType NVARCHAR(50) NOT NULL, -- Position/Role/Individual/System
    SignerRoleID BIGINT,
    SignerUserID BIGINT,
    Position NVARCHAR(255) NOT NULL,
    Authority NVARCHAR(500),
    Jurisdiction NVARCHAR(500),

    -- Digital signature configuration
    UseDigitalSignature BIT DEFAULT 1,
    SignatureLevel TINYINT DEFAULT 1, -- 1=Simple, 2=Advanced, 3=Qualified
    CertificateRequired BIT DEFAULT 1,
    HSMRequired BIT DEFAULT 0, -- Hardware Security Module required?

    -- Certificate details
    CertificateThumbprint NVARCHAR(500),
    CertificateSubject NVARCHAR(1000),
    CertificateIssuer NVARCHAR(1000),
    CertificateValidFrom DATETIME2,
    CertificateValidTo DATETIME2,

    -- Business rules
    SigningRules NVARCHAR(MAX), -- JSON rules for when this signer can sign
    RequiredApprovals NVARCHAR(MAX), -- JSON required pre-approvals

    -- Status
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_NGUOIKY_Role FOREIGN KEY (SignerRoleID) REFERENCES [identity].RBAC_ROLE(RoleID),
    CONSTRAINT FK_NGUOIKY_User FOREIGN KEY (SignerUserID) REFERENCES [identity].USER_PROFILE(UserID)
);
GO

CREATE INDEX IX_SIGNER_CONFIG_Type ON [system].CH_NGUOIKY(SignerType, IsActive);
CREATE INDEX IX_SIGNER_CONFIG_Role ON [system].CH_NGUOIKY(SignerRoleID, IsActive);
CREATE INDEX IX_SIGNER_CONFIG_Cert ON [system].CH_NGUOIKY(CertificateValidTo, IsActive);
GO
```

### 4. CH_BIEUMAU - Template configuration

```sql
CREATE TABLE [system].CH_BIEUMAU (
    BieuMauConfigID BIGINT PRIMARY KEY IDENTITY,
    ConfigCode NVARCHAR(100) UNIQUE NOT NULL,
    ConfigName NVARCHAR(255) NOT NULL,

    -- Template classification
    TemplateType NVARCHAR(50) NOT NULL, -- Form/Document/Report/Notification/Receipt
    Category NVARCHAR(100), -- Application/Result/Internal/External
    SubCategory NVARCHAR(100),

    -- Template content
    TemplateFormat NVARCHAR(50) NOT NULL, -- PDF/DOC/DOCX/HTML/JSON/XML
    TemplateContent NVARCHAR(MAX),
    TemplatePath NVARCHAR(500),
    FileID NVARCHAR(255), -- MinIO file ID

    -- Version management
    Version NVARCHAR(20) NOT NULL DEFAULT '1.0',
    IsCurrentVersion BIT DEFAULT 1,
    PreviousVersionID BIGINT,
    ChangeLog NVARCHAR(2000),

    -- Metadata
    Author NVARCHAR(255),
    Description NVARCHAR(2000),
    Keywords NVARCHAR(500),
    Language NVARCHAR(10) DEFAULT 'vi-VN',

    -- Template engine configuration
    VariableFields NVARCHAR(MAX), -- JSON definition of variable fields
    ValidationRules NVARCHAR(MAX), -- JSON validation rules for fields

    -- Status
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_BIEUMAU_Previous FOREIGN KEY (PreviousVersionID) REFERENCES [system].CH_BIEUMAU(BieuMauConfigID)
);
GO

CREATE INDEX IX_TEMPLATE_CONFIG_Type ON [system].CH_BIEUMAU(TemplateType, IsCurrentVersion);
CREATE INDEX IX_TEMPLATE_CONFIG_Code ON [system].CH_BIEUMAU(ConfigCode, Version);
CREATE INDEX IX_TEMPLATE_CONFIG_Active ON [system].CH_BIEUMAU(IsActive, TemplateType);
GO
```

### 5. CH_BIENLAIBIENTU - Receipt configuration

```sql
CREATE TABLE [system].CH_BIENLAIBIENTU (
    BienLaiBienTuConfigID BIGINT PRIMARY KEY IDENTITY,
    ConfigCode NVARCHAR(100) UNIQUE NOT NULL,
    ConfigName NVARCHAR(255) NOT NULL,

    -- Receipt classification
    ReceiptType NVARCHAR(50) NOT NULL, -- Payment/Service/Confirmation/Delivery
    TransactionType NVARCHAR(100), -- Fee payment/Document submission/Result delivery
    ServiceCategory NVARCHAR(100),

    -- Format configuration
    IsElectronic BIT DEFAULT 1,
    DigitalFormat NVARCHAR(50) DEFAULT 'PDF',
    RequireDigitalSignature BIT DEFAULT 1,
    UseBlockchain BIT DEFAULT 0,

    -- Numbering system
    NumberingPattern NVARCHAR(100) NOT NULL,
    NumberingSequence NVARCHAR(100),
    ResetFrequency NVARCHAR(50) DEFAULT 'Yearly',

    -- Template configuration
    TemplateID BIGINT,
    HeaderText NVARCHAR(500),
    FooterText NVARCHAR(500),

    -- Visual elements
    IncludeQRCode BIT DEFAULT 1,
    IncludeBarcode BIT DEFAULT 0,

    -- Field configuration
    IncludeFields NVARCHAR(MAX), -- JSON array of fields to include
    CalculatedFields NVARCHAR(MAX), -- JSON calculated field definitions

    -- Status
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_BIENLAI_Template FOREIGN KEY (TemplateID) REFERENCES [system].CH_BIEUMAU(BieuMauConfigID)
);
GO

CREATE INDEX IX_RECEIPT_CONFIG_Type ON [system].CH_BIENLAIBIENTU(ReceiptType, IsActive);
CREATE INDEX IX_RECEIPT_CONFIG_Transaction ON [system].CH_BIENLAIBIENTU(TransactionType, IsActive);
GO
```

## VALIDATION AND BUSINESS RULES

### 6. VALIDATION_RULES - System-wide validation rules

```sql
CREATE TABLE [system].VALIDATION_RULES (
    ValidationRuleID BIGINT PRIMARY KEY IDENTITY,

    -- Rule scope
    EntityType NVARCHAR(100) NOT NULL, -- TTHC, DOCUMENT, WORKFLOW_STEP, etc.
    EntityID BIGINT, -- Specific entity ID (NULL = applies to all)
    FieldName NVARCHAR(100), -- Specific field (NULL = entity-level)

    -- Rule definition
    RuleType NVARCHAR(50) NOT NULL, -- REQUIRED, FORMAT, RANGE, CUSTOM, DEPENDENCY
    ValidationExpression NVARCHAR(1000),
    ErrorMessage NVARCHAR(500) NOT NULL,
    ErrorMessageEN NVARCHAR(500),

    -- Dependencies
    DependsOnField NVARCHAR(100),
    DependsOnValue NVARCHAR(500),

    -- Classification
    Severity TINYINT DEFAULT 1, -- 1=Error, 2=Warning, 3=Info
    ExecutionOrder INT DEFAULT 0,

    -- Status
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,

    CONSTRAINT CHK_VALRULE_RuleType CHECK (RuleType IN ('REQUIRED', 'FORMAT', 'RANGE', 'CUSTOM', 'DEPENDENCY', 'FILE_SIZE', 'FILE_TYPE'))
);
GO

CREATE INDEX IX_VALRULE_Entity ON [system].VALIDATION_RULES(EntityType, EntityID, IsActive);
CREATE INDEX IX_VALRULE_Field ON [system].VALIDATION_RULES(FieldName, RuleType);
CREATE INDEX IX_VALRULE_Execution ON [system].VALIDATION_RULES(ExecutionOrder, IsActive);
GO
```

## SEQUENCE MANAGEMENT

### 7. SYS_HOSO_SEQUENCES - Application sequence management

```sql
CREATE TABLE [system].SYS_HOSO_SEQUENCES (
    TinhThanhCode NVARCHAR(20) NOT NULL,
    DateCode NVARCHAR(8) NOT NULL, -- YYYYMMDD format
    SequenceName NVARCHAR(200) NOT NULL,
    CurrentValue BIGINT DEFAULT 0,
    CreatedAt DATETIME2 DEFAULT GETDATE(),

    PRIMARY KEY (TinhThanhCode, DateCode, SequenceName)
);
GO

CREATE INDEX IX_SEQUENCE_Province ON [system].SYS_HOSO_SEQUENCES(TinhThanhCode, DateCode);
GO
```

## MULTI-TENANT CONFIGURATION

### 8. TENANT_CONFIGURATION - Tenant-specific settings

```sql
CREATE TABLE [system].TENANT_CONFIGURATION (
    TenantConfigID BIGINT PRIMARY KEY IDENTITY,
    TenantID BIGINT NOT NULL,
    ConfigSection NVARCHAR(100) NOT NULL,
    ConfigKey NVARCHAR(100) NOT NULL,
    ConfigValue NVARCHAR(MAX),
    DataType NVARCHAR(50) DEFAULT 'STRING', -- STRING, INT, BOOL, JSON, DECIMAL

    -- Metadata
    Description NVARCHAR(500),
    DefaultValue NVARCHAR(MAX),
    IsRequired BIT DEFAULT 0,
    IsSecure BIT DEFAULT 0, -- Encrypted storage required

    -- Validation
    ValidationPattern NVARCHAR(500),
    AllowedValues NVARCHAR(MAX), -- JSON array for enumerated values

    -- Lifecycle
    EffectiveFrom DATETIME2 DEFAULT GETDATE(),
    EffectiveTo DATETIME2,
    IsActive BIT DEFAULT 1,

    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    UNIQUE (TenantID, ConfigSection, ConfigKey)
);
GO

CREATE INDEX IX_TENANT_CONFIG_Tenant ON [system].TENANT_CONFIGURATION(TenantID, ConfigSection);
CREATE INDEX IX_TENANT_CONFIG_Key ON [system].TENANT_CONFIGURATION(ConfigKey, IsActive);
GO
```

## FEATURE FLAGS

### 9. FEATURE_FLAGS - System feature toggles

```sql
CREATE TABLE [system].FEATURE_FLAGS (
    FeatureFlagID BIGINT PRIMARY KEY IDENTITY,
    FeatureKey NVARCHAR(100) UNIQUE NOT NULL,
    FeatureName NVARCHAR(255) NOT NULL,
    Description NVARCHAR(1000),

    -- Flag configuration
    IsEnabled BIT DEFAULT 0,
    EnvironmentRestriction NVARCHAR(100), -- DEV, TEST, PROD, ALL
    TenantRestriction NVARCHAR(MAX), -- JSON array of allowed tenant IDs
    UserRestriction NVARCHAR(MAX), -- JSON array of allowed user IDs
    RoleRestriction NVARCHAR(MAX), -- JSON array of allowed roles

    -- Rollout configuration
    RolloutPercentage DECIMAL(5,2) DEFAULT 100.00, -- 0.00 to 100.00
    RolloutStrategy NVARCHAR(50) DEFAULT 'ALL', -- ALL, PERCENTAGE, WHITELIST, GRADUAL

    -- Lifecycle
    EffectiveFrom DATETIME2 DEFAULT GETDATE(),
    EffectiveTo DATETIME2,
    AutoExpiry BIT DEFAULT 0,

    -- Dependencies
    DependsOnFeatures NVARCHAR(MAX), -- JSON array of required features
    ConflictsWith NVARCHAR(MAX), -- JSON array of conflicting features

    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT
);
GO

CREATE INDEX IX_FEATURE_Flag ON [system].FEATURE_FLAGS(FeatureKey, IsEnabled);
CREATE INDEX IX_FEATURE_Environment ON [system].FEATURE_FLAGS(EnvironmentRestriction, IsEnabled);
GO
```

## KEY FEATURES

### Centralized Configuration Management
- **File Processing**: Comprehensive file handling configuration
- **Validation Rules**: System-wide business rule management
- **Template System**: Document and form template management
- **Digital Signatures**: PKI and certificate management
- **Receipt Generation**: Automated receipt configuration

### Multi-Tenant Support
- **Tenant Isolation**: Complete configuration separation by tenant
- **Inherited Defaults**: Fallback to system defaults when tenant-specific config not found
- **Environment-Specific**: Different configurations per environment
- **Feature Flags**: Gradual rollout and A/B testing capabilities

### Business Rule Engine
- **Validation Framework**: Extensible validation rule system
- **Conditional Logic**: Complex business rule support
- **Error Handling**: Comprehensive error message management
- **Localization**: Multi-language error message support

### Operational Excellence
- **Sequence Management**: Unique identifier generation
- **Version Control**: Template and configuration versioning
- **Audit Integration**: Complete change tracking
- **Performance Optimization**: Cached configuration access

## CROSS-SCHEMA INTEGRATION

### Configuration Access Pattern
```sql
-- Function to get configuration value with tenant fallback
CREATE FUNCTION [system].GetConfigValue(
    @TenantID BIGINT,
    @ConfigSection NVARCHAR(100),
    @ConfigKey NVARCHAR(100)
)
RETURNS NVARCHAR(MAX)
AS
BEGIN
    DECLARE @Value NVARCHAR(MAX);

    -- Try tenant-specific first
    SELECT @Value = ConfigValue
    FROM [system].TENANT_CONFIGURATION
    WHERE TenantID = @TenantID
        AND ConfigSection = @ConfigSection
        AND ConfigKey = @ConfigKey
        AND IsActive = 1
        AND (EffectiveTo IS NULL OR EffectiveTo > GETDATE());

    -- Fallback to default tenant (TenantID = 0)
    IF @Value IS NULL
    BEGIN
        SELECT @Value = ConfigValue
        FROM [system].TENANT_CONFIGURATION
        WHERE TenantID = 0
            AND ConfigSection = @ConfigSection
            AND ConfigKey = @ConfigKey
            AND IsActive = 1
            AND (EffectiveTo IS NULL OR EffectiveTo > GETDATE());
    END

    RETURN @Value;
END;
GO
```

### Feature Flag Evaluation
```sql
-- Function to check if feature is enabled for user
CREATE FUNCTION [system].IsFeatureEnabled(
    @FeatureKey NVARCHAR(100),
    @TenantID BIGINT,
    @UserID BIGINT
)
RETURNS BIT
AS
BEGIN
    DECLARE @IsEnabled BIT = 0;

    SELECT @IsEnabled =
        CASE
            WHEN ff.IsEnabled = 0 THEN 0
            WHEN ff.EffectiveTo IS NOT NULL AND ff.EffectiveTo < GETDATE() THEN 0
            WHEN ff.TenantRestriction IS NOT NULL
                AND @TenantID NOT IN (SELECT value FROM OPENJSON(ff.TenantRestriction)) THEN 0
            WHEN ff.UserRestriction IS NOT NULL
                AND @UserID NOT IN (SELECT value FROM OPENJSON(ff.UserRestriction)) THEN 0
            ELSE 1
        END
    FROM [system].FEATURE_FLAGS ff
    WHERE ff.FeatureKey = @FeatureKey;

    RETURN ISNULL(@IsEnabled, 0);
END;
GO
```

### 6. LGSP_SYNC_LOG - Government platform synchronization

```sql
CREATE TABLE [system].LGSP_SYNC_LOG (
    SyncID BIGINT PRIMARY KEY IDENTITY,

    -- Synchronization identification
    BatchID NVARCHAR(100), -- Batch identifier for grouped sync operations
    SyncType NVARCHAR(100) NOT NULL, -- Manual/Scheduled/Event-driven/Emergency
    SyncDirection NVARCHAR(50) NOT NULL, -- Push/Pull/Bidirectional

    -- Entity information
    EntityType NVARCHAR(100) NOT NULL, -- PROCEDURE/STATUS/ORGANIZATION/USER/DOCUMENT
    EntityID BIGINT, -- ID of the entity being synchronized
    EntityCode NVARCHAR(100), -- Business code of the entity
    EntityName NVARCHAR(500), -- Display name of the entity

    -- LGSP integration
    LGSPEndpoint NVARCHAR(500) NOT NULL, -- LGSP API endpoint
    LGSPMethod NVARCHAR(20) DEFAULT 'POST', -- HTTP method
    LGSPVersion NVARCHAR(20) DEFAULT '1.0', -- LGSP API version
    LGSPTransactionID NVARCHAR(255), -- LGSP transaction ID

    -- Request data
    RequestPayload NVARCHAR(MAX), -- JSON request payload
    RequestHeaders NVARCHAR(MAX), -- JSON request headers
    RequestSize INT, -- Request size in bytes
    RequestSentAt DATETIME2,

    -- Response data
    ResponsePayload NVARCHAR(MAX), -- JSON response payload
    ResponseHeaders NVARCHAR(MAX), -- JSON response headers
    ResponseSize INT, -- Response size in bytes
    ResponseReceivedAt DATETIME2,
    ResponseTime DECIMAL(10,2), -- Response time in milliseconds

    -- Synchronization status
    SyncStatus NVARCHAR(100) NOT NULL, -- Pending/InProgress/Completed/Failed/Cancelled/Timeout
    StatusCode INT, -- HTTP status code or custom status code
    StatusMessage NVARCHAR(1000), -- Status message or error description
    CompletionPercentage DECIMAL(5,2) DEFAULT 0, -- For long-running operations

    -- Error handling
    ErrorCode NVARCHAR(100), -- Error code from LGSP or internal
    ErrorMessage NVARCHAR(2000), -- Detailed error message
    ErrorDetails NVARCHAR(MAX), -- JSON error details
    ErrorCategory NVARCHAR(100), -- Network/Authentication/Validation/Business/System
    IsTransientError BIT DEFAULT 0, -- Can be retried

    -- Retry logic
    RetryCount INT DEFAULT 0, -- Current retry attempt
    MaxRetries INT DEFAULT 3, -- Maximum retry attempts
    NextRetryAt DATETIME2, -- Next retry time
    RetryStrategy NVARCHAR(100) DEFAULT 'exponential', -- linear/exponential/fixed
    RetryInterval INT DEFAULT 300, -- Base retry interval in seconds

    -- Data transformation
    DataMappingVersion NVARCHAR(20), -- Version of data mapping used
    TransformationRules NVARCHAR(MAX), -- JSON transformation rules applied
    MappingErrors NVARCHAR(MAX), -- JSON mapping errors if any
    DataValidationResult NVARCHAR(MAX), -- JSON validation results

    -- Business context
    InitiatedBy BIGINT, -- User who initiated the sync
    InitiationReason NVARCHAR(200), -- Reason for synchronization
    BusinessPriority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    RelatedProcessID NVARCHAR(100), -- Related business process ID

    -- Impact tracking
    RecordsProcessed INT DEFAULT 0, -- Number of records processed
    RecordsSuccess INT DEFAULT 0, -- Number of successful records
    RecordsFailed INT DEFAULT 0, -- Number of failed records
    RecordsSkipped INT DEFAULT 0, -- Number of skipped records
    DataChanges NVARCHAR(MAX), -- JSON summary of data changes

    -- Performance metrics
    TotalProcessingTime DECIMAL(10,2), -- Total processing time in seconds
    NetworkLatency DECIMAL(8,2), -- Network latency in milliseconds
    DatabaseTime DECIMAL(8,2), -- Database operation time in milliseconds
    TransformationTime DECIMAL(8,2), -- Data transformation time in milliseconds

    -- Dependencies and relationships
    DependsOnSyncID BIGINT, -- Other sync operation this depends on
    TriggeredSyncIDs NVARCHAR(MAX), -- JSON array of sync IDs this triggered
    ParentSyncID BIGINT, -- Parent sync operation (for sub-operations)
    ChildSyncCount INT DEFAULT 0, -- Number of child sync operations

    -- Fallback and failover
    FallbackData NVARCHAR(MAX), -- JSON fallback data if LGSP unavailable
    FallbackUsed BIT DEFAULT 0, -- Whether fallback data was used
    CacheData NVARCHAR(MAX), -- JSON cached data
    CacheUsed BIT DEFAULT 0, -- Whether cached data was used
    CacheExpiryTime DATETIME2, -- When cached data expires

    -- Security and compliance
    SecurityLevel TINYINT DEFAULT 2, -- 1=Public, 2=Internal, 3=Confidential, 4=Secret
    EncryptionUsed BIT DEFAULT 0, -- Whether data was encrypted
    SignatureVerified BIT DEFAULT 0, -- Whether signature was verified
    AuditRequired BIT DEFAULT 1, -- Whether detailed audit is required
    ComplianceChecked BIT DEFAULT 0, -- Whether compliance check was performed

    -- External system correlation
    ExternalCorrelationID NVARCHAR(255), -- External system correlation ID
    ExternalBatchID NVARCHAR(255), -- External batch ID
    ExternalProcessID NVARCHAR(255), -- External process ID
    UpstreamSystemID NVARCHAR(100), -- Upstream system identifier

    -- Monitoring and alerting
    SLATargetSeconds INT DEFAULT 30, -- SLA target in seconds
    SLAStatus NVARCHAR(50) DEFAULT 'OnTrack', -- OnTrack/AtRisk/Breached
    AlertsSent INT DEFAULT 0, -- Number of alerts sent
    EscalationLevel INT DEFAULT 0, -- 0=None, 1=Supervisor, 2=Manager, 3=Director

    -- Configuration and environment
    Environment NVARCHAR(50) DEFAULT 'Production', -- Development/Staging/Production
    ConfigurationSnapshot NVARCHAR(MAX), -- JSON configuration snapshot
    FeatureFlags NVARCHAR(MAX), -- JSON active feature flags
    SystemVersion NVARCHAR(50), -- System version during sync

    -- Cleanup and archiving
    ArchiveAfterDays INT DEFAULT 90, -- Archive after X days
    PurgeAfterDays INT DEFAULT 2555, -- Purge after 7 years (compliance)
    IsArchived BIT DEFAULT 0, -- Has been archived
    ArchivedAt DATETIME2, -- When archived

    -- Timing
    StartedAt DATETIME2 DEFAULT GETDATE(),
    CompletedAt DATETIME2,
    LastUpdatedAt DATETIME2 DEFAULT GETDATE(),

    -- Constraints
    CONSTRAINT FK_LGSP_SYNC_INITIATED_BY FOREIGN KEY (InitiatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_LGSP_SYNC_DEPENDS_ON FOREIGN KEY (DependsOnSyncID) REFERENCES [system].LGSP_SYNC_LOG(SyncID),
    CONSTRAINT FK_LGSP_SYNC_PARENT FOREIGN KEY (ParentSyncID) REFERENCES [system].LGSP_SYNC_LOG(SyncID),
    CONSTRAINT CK_LGSP_SYNC_Priority CHECK (BusinessPriority BETWEEN 1 AND 4),
    CONSTRAINT CK_LGSP_SYNC_Security CHECK (SecurityLevel BETWEEN 1 AND 4),
    CONSTRAINT CK_LGSP_SYNC_Records CHECK (RecordsProcessed = RecordsSuccess + RecordsFailed + RecordsSkipped),
    CONSTRAINT CK_LGSP_SYNC_Retry CHECK (RetryCount <= MaxRetries)
);
GO

-- Indexes for LGSP_SYNC_LOG
CREATE INDEX IX_LGSP_SYNC_Status ON [system].LGSP_SYNC_LOG(SyncStatus, StartedAt DESC);
CREATE INDEX IX_LGSP_SYNC_Entity ON [system].LGSP_SYNC_LOG(EntityType, EntityID, StartedAt DESC);
CREATE INDEX IX_LGSP_SYNC_Batch ON [system].LGSP_SYNC_LOG(BatchID, SyncStatus);
CREATE INDEX IX_LGSP_SYNC_Retry ON [system].LGSP_SYNC_LOG(NextRetryAt, RetryCount) WHERE SyncStatus = 'Failed' AND RetryCount < MaxRetries;
CREATE INDEX IX_LGSP_SYNC_User ON [system].LGSP_SYNC_LOG(InitiatedBy, StartedAt DESC);
CREATE INDEX IX_LGSP_SYNC_Priority ON [system].LGSP_SYNC_LOG(BusinessPriority, StartedAt DESC);
CREATE INDEX IX_LGSP_SYNC_SLA ON [system].LGSP_SYNC_LOG(SLAStatus, StartedAt DESC) WHERE SLAStatus != 'OnTrack';
CREATE INDEX IX_LGSP_SYNC_Dependencies ON [system].LGSP_SYNC_LOG(DependsOnSyncID, ParentSyncID);
CREATE INDEX IX_LGSP_SYNC_Transaction ON [system].LGSP_SYNC_LOG(LGSPTransactionID) WHERE LGSPTransactionID IS NOT NULL;
CREATE INDEX IX_LGSP_SYNC_Environment ON [system].LGSP_SYNC_LOG(Environment, StartedAt DESC);
GO
```

### 7. LGSP_ENTITY_MAPPING - Entity mapping configuration

```sql
CREATE TABLE [system].LGSP_ENTITY_MAPPING (
    MappingID BIGINT PRIMARY KEY IDENTITY,

    -- Entity identification
    EntityType NVARCHAR(100) NOT NULL, -- PROCEDURE/STATUS/ORGANIZATION/USER/DOCUMENT
    InternalFieldName NVARCHAR(200) NOT NULL, -- Internal field name
    InternalFieldType NVARCHAR(100) NOT NULL, -- VARCHAR/INT/DATETIME/JSON/etc.

    -- LGSP mapping
    LGSPFieldName NVARCHAR(200) NOT NULL, -- LGSP field name
    LGSPFieldType NVARCHAR(100) NOT NULL, -- String/Integer/DateTime/Object/Array
    LGSPFieldPath NVARCHAR(500), -- JSON path for nested fields
    IsRequired BIT DEFAULT 0, -- Required field in LGSP

    -- Data transformation
    TransformationRule NVARCHAR(MAX), -- JSON transformation rule
    DefaultValue NVARCHAR(1000), -- Default value if internal field is null
    ValidationRule NVARCHAR(MAX), -- JSON validation rule
    FormatRule NVARCHAR(1000), -- Formatting rule (date format, etc.)

    -- Mapping metadata
    MappingVersion NVARCHAR(20) DEFAULT '1.0', -- Mapping version
    Description NVARCHAR(2000), -- Mapping description
    Examples NVARCHAR(MAX), -- JSON examples
    Notes NVARCHAR(2000), -- Additional notes

    -- Synchronization behavior
    SyncDirection NVARCHAR(50) DEFAULT 'Both', -- Push/Pull/Both/None
    SyncPriority INT DEFAULT 100, -- Lower number = higher priority
    ConflictResolution NVARCHAR(100) DEFAULT 'LastWriteWins', -- LastWriteWins/SourceWins/TargetWins/Manual

    -- Data quality and validation
    DataQualityRules NVARCHAR(MAX), -- JSON data quality rules
    BusinessRules NVARCHAR(MAX), -- JSON business validation rules
    CustomValidation NVARCHAR(1000), -- Custom validation function
    AllowEmptyValues BIT DEFAULT 1, -- Allow empty/null values

    -- Performance optimization
    IsIndexed BIT DEFAULT 0, -- Is this field indexed in LGSP
    CacheDuration INT DEFAULT 300, -- Cache duration in seconds
    CompressionEnabled BIT DEFAULT 0, -- Enable compression for large fields
    BatchProcessing BIT DEFAULT 1, -- Support batch processing

    -- Monitoring and alerting
    EnableMonitoring BIT DEFAULT 1, -- Enable field-level monitoring
    AlertThreshold DECIMAL(5,2) DEFAULT 95.0, -- Alert if success rate < threshold
    SLATargetMs INT DEFAULT 100, -- SLA target in milliseconds

    -- Localization and formatting
    LocalizationSupport BIT DEFAULT 0, -- Supports localization
    LocaleDependent BIT DEFAULT 0, -- Value depends on locale
    TimeZoneDependent BIT DEFAULT 0, -- Value depends on timezone
    CultureSpecificFormat BIT DEFAULT 0, -- Uses culture-specific formatting

    -- Error handling
    ErrorHandlingStrategy NVARCHAR(100) DEFAULT 'Skip', -- Skip/Default/Fail/Retry
    MaxErrorCount INT DEFAULT 10, -- Maximum errors before stopping
    ErrorNotificationThreshold INT DEFAULT 5, -- Notify after X errors

    -- Version control and history
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    LastModifiedAt DATETIME2,
    LastModifiedBy BIGINT,
    VersionHistory NVARCHAR(MAX), -- JSON version history

    -- Status and lifecycle
    IsActive BIT DEFAULT 1,
    IsDeprecated BIT DEFAULT 0,
    DeprecationDate DATETIME2,
    ReplacementMappingID BIGINT, -- Replacement mapping if deprecated

    -- Testing and validation
    TestData NVARCHAR(MAX), -- JSON test data for mapping
    TestResults NVARCHAR(MAX), -- JSON test results
    LastTested DATETIME2, -- When mapping was last tested
    TestPassed BIT DEFAULT 0, -- Last test result

    -- Constraints
    CONSTRAINT FK_LGSP_MAPPING_CREATED_BY FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_LGSP_MAPPING_MODIFIED_BY FOREIGN KEY (LastModifiedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_LGSP_MAPPING_REPLACEMENT FOREIGN KEY (ReplacementMappingID) REFERENCES [system].LGSP_ENTITY_MAPPING(MappingID),
    CONSTRAINT UC_LGSP_MAPPING_Entity_Field UNIQUE (EntityType, InternalFieldName, MappingVersion),
    CONSTRAINT CK_LGSP_MAPPING_Priority CHECK (SyncPriority > 0),
    CONSTRAINT CK_LGSP_MAPPING_Alert_Threshold CHECK (AlertThreshold BETWEEN 0 AND 100)
);
GO

-- Indexes for LGSP_ENTITY_MAPPING
CREATE INDEX IX_LGSP_MAPPING_Entity ON [system].LGSP_ENTITY_MAPPING(EntityType, IsActive);
CREATE INDEX IX_LGSP_MAPPING_Version ON [system].LGSP_ENTITY_MAPPING(MappingVersion, EntityType);
CREATE INDEX IX_LGSP_MAPPING_Sync ON [system].LGSP_ENTITY_MAPPING(SyncDirection, SyncPriority);
CREATE INDEX IX_LGSP_MAPPING_Active ON [system].LGSP_ENTITY_MAPPING(IsActive, IsDeprecated);
CREATE INDEX IX_LGSP_MAPPING_LGSP_Field ON [system].LGSP_ENTITY_MAPPING(LGSPFieldName, EntityType);
CREATE INDEX IX_LGSP_MAPPING_Modified ON [system].LGSP_ENTITY_MAPPING(LastModifiedAt DESC);
GO
```

### 8. LGSP_CONFIGURATION - LGSP integration configuration

```sql
CREATE TABLE [system].LGSP_CONFIGURATION (
    ConfigID BIGINT PRIMARY KEY IDENTITY,

    -- Configuration identification
    ConfigKey NVARCHAR(200) UNIQUE NOT NULL,
    ConfigName NVARCHAR(500) NOT NULL,
    ConfigCategory NVARCHAR(100) NOT NULL, -- Connection/Authentication/Mapping/Monitoring
    ConfigType NVARCHAR(100) NOT NULL, -- String/Integer/Boolean/JSON/URL/Secret

    -- Configuration values
    ConfigValue NVARCHAR(MAX), -- Configuration value (encrypted if sensitive)
    DefaultValue NVARCHAR(MAX), -- Default value
    IsEncrypted BIT DEFAULT 0, -- Whether value is encrypted
    IsSecret BIT DEFAULT 0, -- Whether value is sensitive

    -- Environment specific
    Environment NVARCHAR(50) DEFAULT 'All', -- All/Development/Staging/Production
    TenantID BIGINT DEFAULT 0, -- 0 = global, >0 = tenant-specific

    -- Validation and constraints
    ValidationRule NVARCHAR(MAX), -- JSON validation rule
    AllowedValues NVARCHAR(MAX), -- JSON array of allowed values
    MinValue DECIMAL(18,6), -- Minimum value for numeric configs
    MaxValue DECIMAL(18,6), -- Maximum value for numeric configs
    MaxLength INT, -- Maximum length for string configs

    -- Usage and behavior
    IsRequired BIT DEFAULT 0, -- Required configuration
    IsReadOnly BIT DEFAULT 0, -- Read-only configuration
    RequiresRestart BIT DEFAULT 0, -- Requires service restart to take effect
    HotReloadable BIT DEFAULT 1, -- Can be reloaded without restart

    -- Monitoring and caching
    CacheEnabled BIT DEFAULT 1, -- Enable caching
    CacheDuration INT DEFAULT 300, -- Cache duration in seconds
    MonitoringEnabled BIT DEFAULT 1, -- Enable monitoring
    ChangeNotification BIT DEFAULT 1, -- Send notification on change

    -- Access control
    AccessLevel NVARCHAR(100) DEFAULT 'Admin', -- Public/Internal/Admin/System
    RequiredRole NVARCHAR(100), -- Role required to modify
    RequiredPermission NVARCHAR(100), -- Permission required to modify

    -- Documentation
    Description NVARCHAR(2000), -- Configuration description
    Documentation NVARCHAR(MAX), -- Detailed documentation
    Examples NVARCHAR(MAX), -- JSON examples
    RelatedConfigs NVARCHAR(MAX), -- JSON array of related config keys

    -- Change tracking
    LastModified DATETIME2 DEFAULT GETDATE(),
    ModifiedBy BIGINT,
    ChangeReason NVARCHAR(1000), -- Reason for change
    ChangeHistory NVARCHAR(MAX), -- JSON change history

    -- Status and lifecycle
    IsActive BIT DEFAULT 1,
    IsDeprecated BIT DEFAULT 0,
    DeprecationDate DATETIME2,
    DeprecationReason NVARCHAR(1000),

    -- Constraints
    CONSTRAINT FK_LGSP_CONFIG_MODIFIED_BY FOREIGN KEY (ModifiedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_LGSP_CONFIG_Cache_Duration CHECK (CacheDuration >= 0),
    CONSTRAINT CK_LGSP_CONFIG_Min_Max CHECK (MinValue IS NULL OR MaxValue IS NULL OR MinValue <= MaxValue),
    CONSTRAINT CK_LGSP_CONFIG_Max_Length CHECK (MaxLength IS NULL OR MaxLength > 0)
);
GO

-- Indexes for LGSP_CONFIGURATION
CREATE INDEX IX_LGSP_CONFIG_Category ON [system].LGSP_CONFIGURATION(ConfigCategory, IsActive);
CREATE INDEX IX_LGSP_CONFIG_Environment ON [system].LGSP_CONFIGURATION(Environment, TenantID);
CREATE INDEX IX_LGSP_CONFIG_Type ON [system].LGSP_CONFIGURATION(ConfigType, IsSecret);
CREATE INDEX IX_LGSP_CONFIG_Active ON [system].LGSP_CONFIGURATION(IsActive, IsDeprecated);
CREATE INDEX IX_LGSP_CONFIG_Modified ON [system].LGSP_CONFIGURATION(LastModified DESC);
CREATE INDEX IX_LGSP_CONFIG_Access ON [system].LGSP_CONFIGURATION(AccessLevel, RequiredRole);
GO
```

## BUSINESS RULES

### Configuration Hierarchy
1. **User-Specific**: Highest priority (if applicable)
2. **Tenant-Specific**: Organization-level configuration
3. **System Default**: Fallback configuration (TenantID = 0)
4. **Hard-Coded**: Application defaults

### Validation Rule Processing
- Rules processed in execution order
- Error severity determines processing continuation
- Dependencies validated before dependent rules
- Localized error messages based on user language

### Feature Flag Strategy
- **Development**: All features enabled for testing
- **Staging**: Production-like feature configuration
- **Production**: Gradual rollout with percentage-based enabling
- **Emergency**: Immediate feature disable capability

## PERFORMANCE CONSIDERATIONS

### Caching Strategy
- Configuration values cached at application startup
- Feature flags cached with short TTL (5 minutes)
- Validation rules cached per entity type
- Template metadata cached until version changes

### Query Optimization
- Composite indexes for tenant + configuration queries
- Separate indexes for feature flag evaluation
- Partitioned validation rules by entity type
- Optimized sequence generation for high concurrency

### Scalability Features
- Read replicas for configuration queries
- Distributed caching with Redis
- Async configuration updates
- Bulk configuration management APIs

## MAINTENANCE PROCEDURES

### Configuration Management
- Version control for all configuration changes
- Deployment scripts for environment promotion
- Configuration validation before activation
- Rollback procedures for failed deployments

### Performance Monitoring
- Configuration query performance tracking
- Feature flag evaluation timing
- Validation rule execution monitoring
- Cache hit rate analysis

### Data Quality
- Configuration value validation
- Orphaned configuration cleanup
- Feature flag lifecycle management
- Template version maintenance