# [audit] Schema - Audit and Logging System

## OVERVIEW

The `[audit]` schema provides comprehensive audit trail and compliance logging for the DVC v2 system. It captures all changes across the system for security, compliance, and forensic analysis requirements.

## SCHEMA CREATION

```sql
-- Audit and logging
CREATE SCHEMA [audit];
GO
```

## AUDIT SYSTEM TABLES

### 1. SYS_AUDIT_QUEUE - Audit queue for async processing

```sql
CREATE TABLE [audit].SYS_AUDIT_QUEUE (
    ID BIGINT PRIMARY KEY IDENTITY,
    TableName NVARCHAR(128) NOT NULL,
    PrimaryKey NVARCHAR(100) NOT NULL,
    Operation NVARCHAR(10) NOT NULL, -- INSERT, UPDATE, DELETE
    QueuedAt DATETIME2 DEFAULT GETDATE(),
    ProcessedAt DATETIME2,
    IsProcessed BIT DEFAULT 0,
    ProcessingAttempts INT DEFAULT 0,
    LastError NVARCHAR(1000)
);
GO

CREATE INDEX IX_Queue_Unprocessed ON [audit].SYS_AUDIT_QUEUE(IsProcessed, QueuedAt);
CREATE INDEX IX_Queue_Table ON [audit].SYS_AUDIT_QUEUE(TableName, QueuedAt DESC);
CREATE INDEX IX_Queue_Processing ON [audit].SYS_AUDIT_QUEUE(ProcessingAttempts, QueuedAt);
GO
```

### 2. SYS_AUDIT_LOG - Full audit log (populated asynchronously)

```sql
CREATE TABLE [audit].SYS_AUDIT_LOG (
    ID BIGINT PRIMARY KEY IDENTITY,
    TableName NVARCHAR(128) NOT NULL,
    Operation NVARCHAR(10) NOT NULL,
    PrimaryKey NVARCHAR(100) NOT NULL,

    -- Change data
    OldValues NVARCHAR(4000), -- Compressed JSON
    NewValues NVARCHAR(4000), -- Compressed JSON
    ChangeDetails NVARCHAR(1000), -- Summary of key changes

    -- User context
    ChangedBy BIGINT,
    ChangedByUsername NVARCHAR(100),
    ChangedAt DATETIME2 DEFAULT GETDATE(),

    -- Technical context
    IPAddress NVARCHAR(45),
    UserAgent NVARCHAR(500),
    SessionID NVARCHAR(128),

    -- Business context
    ChangeReason NVARCHAR(200),
    BusinessContext NVARCHAR(200), -- E.g., 'HoSo Processing', 'Admin Update'
    WorkflowInstanceId NVARCHAR(255),

    -- Compliance
    ComplianceLevel TINYINT DEFAULT 1, -- 1=Standard, 2=Sensitive, 3=Confidential
    RetentionYears INT DEFAULT 7,

    -- Performance
    ChangeSize INT, -- Size of change data
    ProcessingTime INT -- Milliseconds
);
GO

-- Partitioned indexes for performance
CREATE INDEX IX_Audit_Table_Date ON [audit].SYS_AUDIT_LOG(TableName, ChangedAt DESC);
CREATE INDEX IX_Audit_User ON [audit].SYS_AUDIT_LOG(ChangedBy, ChangedAt DESC);
CREATE INDEX IX_Audit_Context ON [audit].SYS_AUDIT_LOG(BusinessContext, ChangedAt DESC);
CREATE INDEX IX_Audit_PrimaryKey ON [audit].SYS_AUDIT_LOG(TableName, PrimaryKey, ChangedAt DESC);
CREATE INDEX IX_Audit_Workflow ON [audit].SYS_AUDIT_LOG(WorkflowInstanceId, ChangedAt DESC);
GO
```

### 3. SECURITY_AUDIT_LOG - Security-specific audit events

```sql
CREATE TABLE [audit].SECURITY_AUDIT_LOG (
    SecurityAuditID BIGINT PRIMARY KEY IDENTITY,

    -- Event classification
    EventType NVARCHAR(50) NOT NULL, -- LOGIN, LOGOUT, PERMISSION_CHANGE, ACCESS_DENIED, etc.
    EventCategory NVARCHAR(50) NOT NULL, -- AUTHENTICATION, AUTHORIZATION, DATA_ACCESS, SYSTEM
    Severity TINYINT NOT NULL, -- 1=Info, 2=Warning, 3=Error, 4=Critical

    -- User and session
    UserID BIGINT,
    Username NVARCHAR(100),
    SessionID NVARCHAR(128),

    -- Technical details
    IPAddress NVARCHAR(45) NOT NULL,
    UserAgent NVARCHAR(1000),
    RequestPath NVARCHAR(500),
    HTTPMethod NVARCHAR(10),

    -- Security context
    ResourceAccessed NVARCHAR(500),
    PermissionChecked NVARCHAR(200),
    AccessGranted BIT,
    FailureReason NVARCHAR(1000),

    -- Risk assessment
    RiskScore TINYINT DEFAULT 0, -- 0-100
    ThreatIndicators NVARCHAR(MAX), -- JSON array
    GeolocationData NVARCHAR(500), -- JSON

    -- Compliance
    RequiresInvestigation BIT DEFAULT 0,
    InvestigationStatus TINYINT DEFAULT 0, -- 0=None, 1=Pending, 2=InProgress, 3=Resolved
    InvestigatedBy BIGINT,
    InvestigatedAt DATETIME2,

    EventTime DATETIME2 DEFAULT GETDATE(),

    CONSTRAINT FK_SECURITY_AUDIT_USER FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SECURITY_AUDIT_INVESTIGATOR FOREIGN KEY (InvestigatedBy) REFERENCES [identity].USER_PROFILE(UserID)
);
GO

CREATE INDEX IX_Security_Event ON [audit].SECURITY_AUDIT_LOG(EventType, EventTime DESC);
CREATE INDEX IX_Security_User ON [audit].SECURITY_AUDIT_LOG(UserID, EventTime DESC);
CREATE INDEX IX_Security_IP ON [audit].SECURITY_AUDIT_LOG(IPAddress, EventTime DESC);
CREATE INDEX IX_Security_Risk ON [audit].SECURITY_AUDIT_LOG(RiskScore DESC, EventTime DESC);
CREATE INDEX IX_Security_Investigation ON [audit].SECURITY_AUDIT_LOG(RequiresInvestigation, InvestigationStatus);
GO
```

### 4. SYSTEM_PERFORMANCE_LOG - System performance and health metrics

```sql
CREATE TABLE [audit].SYSTEM_PERFORMANCE_LOG (
    PerformanceLogID BIGINT PRIMARY KEY IDENTITY,

    -- Measurement details
    MetricName NVARCHAR(100) NOT NULL,
    MetricCategory NVARCHAR(50) NOT NULL, -- DATABASE, API, WORKFLOW, EXTERNAL
    MetricValue DECIMAL(18,6) NOT NULL,
    MetricUnit NVARCHAR(20), -- ms, MB, count, percent

    -- Context
    ComponentName NVARCHAR(100),
    OperationName NVARCHAR(200),
    RequestID NVARCHAR(255),

    -- Performance thresholds
    ThresholdWarning DECIMAL(18,6),
    ThresholdCritical DECIMAL(18,6),
    IsThresholdExceeded BIT DEFAULT 0,

    -- Additional data
    AdditionalData NVARCHAR(MAX), -- JSON
    SamplingRate DECIMAL(5,4) DEFAULT 1.0, -- 0.0 to 1.0

    MeasuredAt DATETIME2 DEFAULT GETDATE(),

    -- Indexes for time-series queries
    INDEX IX_Performance_Metric_Time NONCLUSTERED (MetricName, MeasuredAt DESC),
    INDEX IX_Performance_Category_Time NONCLUSTERED (MetricCategory, MeasuredAt DESC),
    INDEX IX_Performance_Threshold NONCLUSTERED (IsThresholdExceeded, MeasuredAt DESC)
);
GO
```

## AUDIT TRIGGERS AND PROCEDURES

### Automatic Audit Capture

```sql
-- Example audit trigger for critical tables
CREATE TRIGGER tr_HOSO_Audit
ON [case].HOSO
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Operation NVARCHAR(10);

    IF EXISTS(SELECT * FROM inserted) AND EXISTS(SELECT * FROM deleted)
        SET @Operation = 'UPDATE';
    ELSE IF EXISTS(SELECT * FROM inserted)
        SET @Operation = 'INSERT';
    ELSE
        SET @Operation = 'DELETE';

    INSERT INTO [audit].SYS_AUDIT_QUEUE (TableName, PrimaryKey, Operation)
    SELECT
        'case.HOSO',
        COALESCE(i.HoSoID, d.HoSoID),
        @Operation
    FROM inserted i
    FULL OUTER JOIN deleted d ON i.HoSoID = d.HoSoID;
END;
GO
```

### Audit Processing Procedure

```sql
CREATE PROCEDURE [audit].ProcessAuditQueue
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BatchSize INT = 1000;

    WITH QueueBatch AS (
        SELECT TOP (@BatchSize) *
        FROM [audit].SYS_AUDIT_QUEUE
        WHERE IsProcessed = 0
        ORDER BY QueuedAt
    )
    UPDATE QueueBatch
    SET IsProcessed = 1,
        ProcessedAt = GETDATE();

    -- Process the audit records
    -- (Implementation would capture old/new values and create audit log entries)
END;
GO
```

## PARTITIONING STRATEGY

### Monthly Partitioning for Audit Log

```sql
-- Partition function for monthly partitioning
CREATE PARTITION FUNCTION pf_AuditLog_Month (DATETIME2)
AS RANGE RIGHT FOR VALUES (
    '2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01',
    '2024-05-01', '2024-06-01', '2024-07-01', '2024-08-01',
    '2024-09-01', '2024-10-01', '2024-11-01', '2024-12-01',
    '2025-01-01', '2025-02-01', '2025-03-01', '2025-04-01'
);
GO

-- Partition scheme
CREATE PARTITION SCHEME ps_AuditLog_Month
AS PARTITION pf_AuditLog_Month
ALL TO ([PRIMARY]);
GO

-- Apply partitioning to audit log table
ALTER TABLE [audit].SYS_AUDIT_LOG
DROP CONSTRAINT [PK__SYS_AUDIT_LOG];
GO

ALTER TABLE [audit].SYS_AUDIT_LOG
ADD CONSTRAINT PK_SYS_AUDIT_LOG
PRIMARY KEY CLUSTERED (ID, ChangedAt);
GO

-- Move table to partitioned scheme
CREATE CLUSTERED INDEX IX_AuditLog_Partitioned
ON [audit].SYS_AUDIT_LOG (ChangedAt, ID)
ON ps_AuditLog_Month(ChangedAt);
GO
```

## KEY FEATURES

### Comprehensive Audit Coverage
- **All Data Changes**: Capture INSERT, UPDATE, DELETE operations
- **Security Events**: Authentication, authorization, access attempts
- **Performance Metrics**: System health and performance tracking
- **Business Context**: Workflow and business process correlation

### Asynchronous Processing
- **Queue-Based**: Non-blocking audit capture
- **Batch Processing**: Efficient audit log creation
- **Error Handling**: Retry mechanisms for failed processing
- **Performance Optimization**: Minimal impact on transaction performance

### Compliance and Retention
- **Legal Compliance**: 7-year default retention for government records
- **Data Classification**: Sensitivity-based retention policies
- **Immutable Records**: Append-only audit log design
- **Forensic Analysis**: Complete change reconstruction capability

### Security Monitoring
- **Risk Assessment**: Automated threat scoring
- **Anomaly Detection**: Unusual access pattern identification
- **Investigation Support**: Security incident response tools
- **Compliance Reporting**: Audit trail for regulatory requirements

## CROSS-SCHEMA INTEGRATION

### Audit Capture from All Schemas
```sql
-- All schemas write to audit queue via triggers
-- identity → audit (user changes, role assignments)
-- organization → audit (organizational changes)
-- tthc → audit (procedure modifications)
-- workflow → audit (workflow state changes)
-- case → audit (application processing)
-- document → audit (document operations)
-- payment → audit (financial transactions)
```

### Performance Impact Mitigation
- Triggers insert to queue only (minimal overhead)
- Asynchronous processing prevents blocking
- Optimized queue processing with batching
- Partitioned storage for efficient queries

## BUSINESS RULES

### Audit Requirements
- **Government Compliance**: Full audit trail for all government operations
- **Change Attribution**: Every change must be attributed to a user
- **Immutable Records**: Audit records cannot be modified after creation
- **Context Preservation**: Business context must be captured with technical changes

### Retention Policies
- **Standard Data**: 7 years retention (government requirement)
- **Sensitive Data**: 10 years retention
- **Security Events**: 5 years retention
- **Performance Data**: 2 years retention

### Access Control
- **Read-Only Access**: Audit data cannot be modified
- **Role-Based Access**: Limited access based on user roles
- **Investigation Rights**: Special access for security investigations
- **Compliance Officers**: Full audit access for compliance review

## PERFORMANCE CONSIDERATIONS

### High-Volume Optimization
- **Partitioned Tables**: Monthly partitioning for large tables
- **Compressed Storage**: JSON compression for change data
- **Batch Processing**: Efficient queue processing
- **Archive Strategy**: Automated old data archival

### Query Optimization
- **Indexed Lookups**: Optimized indexes for common queries
- **Time-Range Queries**: Partition elimination for date ranges
- **User Activity Queries**: User-specific audit trails
- **Change History**: Complete change tracking for entities

### Scalability Features
- **Horizontal Scaling**: Read replicas for audit queries
- **Storage Tiering**: Hot/warm/cold storage based on age
- **Background Processing**: Minimal impact on operational systems
- **Archive Integration**: Long-term storage for compliance

## MONITORING AND ALERTING

### Real-Time Monitoring
- **Queue Depth**: Monitor audit queue processing
- **Processing Lag**: Alert on processing delays
- **Error Rates**: Monitor failed audit processing
- **Performance Impact**: Track audit overhead

### Security Alerting
- **High-Risk Events**: Immediate alerts for critical security events
- **Anomaly Detection**: Automated threat detection
- **Failed Access Attempts**: Brute force attack detection
- **Privilege Escalation**: Unauthorized permission changes

### Compliance Reporting
- **Regular Reports**: Scheduled compliance reports
- **Ad-Hoc Queries**: Investigation support queries
- **Trend Analysis**: Long-term audit data analysis
- **Retention Compliance**: Automated retention policy enforcement