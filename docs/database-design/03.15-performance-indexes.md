# Performance Optimization - Missing Indexes Analysis

## OVERVIEW

This document identifies and provides missing indexes across all schemas in the DVC v2 database design to achieve the performance target of <20ms average response time for database queries. The analysis covers all schemas and identifies critical missing indexes for common query patterns.

## INDEX ANALYSIS METHODOLOGY

### Performance Requirements
- **Query Response**: <20ms for 95% of queries
- **Concurrent Users**: 21,000 concurrent connections
- **Throughput**: 800,000 documents/month processing
- **Real-time**: <100ms API response times

### Index Strategy
- **Covering Indexes**: Include all columns needed for queries
- **Filtered Indexes**: For selective conditions (status, active flags)
- **Composite Indexes**: Multi-column indexes for complex queries
- **Include Columns**: Non-key columns for covering scenarios

## IDENTITY SCHEMA INDEXES

### Missing Critical Indexes

```sql
-- USER_PROFILE performance indexes
CREATE INDEX IX_USER_PROFILE_Email_Active ON [identity].USER_PROFILE(Email, IsActive)
    WHERE IsActive = 1;

CREATE INDEX IX_USER_PROFILE_TenantID_Role ON [identity].USER_PROFILE(TenantID, IsActive)
    INCLUDE (UserID, FullName, Email, PhoneNumber)
    WHERE IsActive = 1;

CREATE INDEX IX_USER_PROFILE_LastLogin ON [identity].USER_PROFILE(LastLoginAt DESC, IsActive)
    WHERE IsActive = 1 AND LastLoginAt IS NOT NULL;

CREATE INDEX IX_USER_PROFILE_Department ON [identity].USER_PROFILE(DepartmentID, IsActive)
    INCLUDE (UserID, FullName, Email)
    WHERE IsActive = 1;

-- USER_SESSIONS performance indexes
CREATE INDEX IX_USER_SESSIONS_Active ON [identity].USER_SESSIONS(UserID, IsActive, ExpiresAt)
    WHERE IsActive = 1;

CREATE INDEX IX_USER_SESSIONS_Cleanup ON [identity].USER_SESSIONS(ExpiresAt, IsActive)
    WHERE IsActive = 0 OR ExpiresAt < GETDATE();

-- PERMISSION_ASSIGNMENTS optimized lookup
CREATE INDEX IX_PERMISSION_ASSIGN_User_Resource ON [identity].PERMISSION_ASSIGNMENTS(UserID, ResourceType, ResourceID)
    INCLUDE (PermissionID, EffectiveFrom, EffectiveTo)
    WHERE IsActive = 1;

CREATE INDEX IX_PERMISSION_ASSIGN_Resource_Permission ON [identity].PERMISSION_ASSIGNMENTS(ResourceType, ResourceID, PermissionID)
    INCLUDE (UserID, IsActive)
    WHERE IsActive = 1;

-- ROLE_ASSIGNMENTS performance
CREATE INDEX IX_ROLE_ASSIGN_User_Context ON [identity].ROLE_ASSIGNMENTS(UserID, AssignmentContext)
    INCLUDE (RoleID, ScopeType, ScopeValue)
    WHERE IsActive = 1;

-- DELEGATION optimized queries
CREATE INDEX IX_DELEGATION_Delegator_Status ON [identity].DELEGATION(DelegatorUserID, Status, EffectiveFrom, EffectiveTo)
    WHERE Status = 'ACTIVE';

CREATE INDEX IX_DELEGATION_Delegate_Status ON [identity].DELEGATION(DelegateUserID, Status, EffectiveFrom, EffectiveTo)
    WHERE Status = 'ACTIVE';
GO
```

## CASE SCHEMA INDEXES

### HOSO Table Critical Indexes

```sql
-- HOSO primary lookup patterns
CREATE INDEX IX_HOSO_SoHoSo_TenantID ON [case].HOSO(SoHoSo, TenantID)
    INCLUDE (HoSoID, TinhTrangXuLy, NgayNop, NgayHenTra);

CREATE INDEX IX_HOSO_Status_Priority ON [case].HOSO(TinhTrangXuLy, MucDoUuTien, NgayNop DESC)
    INCLUDE (HoSoID, SoHoSo, TTHCCode, NguoiNopHoSo);

CREATE INDEX IX_HOSO_TTHC_Status ON [case].HOSO(TTHCCode, TinhTrangXuLy, TenantID)
    INCLUDE (HoSoID, SoHoSo, NgayNop, NgayHenTra);

CREATE INDEX IX_HOSO_Citizen_Submitted ON [case].HOSO(NguoiNopHoSo, NgayNop DESC)
    INCLUDE (HoSoID, SoHoSo, TinhTrangXuLy, TTHCCode)
    WHERE NguoiNopHoSo IS NOT NULL;

CREATE INDEX IX_HOSO_AssignedTo_Status ON [case].HOSO(CanBoXuLy, TinhTrangXuLy, NgayNop DESC)
    INCLUDE (HoSoID, SoHoSo, TTHCCode, MucDoUuTien)
    WHERE CanBoXuLy IS NOT NULL;

CREATE INDEX IX_HOSO_DueDate_Status ON [case].HOSO(NgayHenTra, TinhTrangXuLy)
    INCLUDE (HoSoID, SoHoSo, TTHCCode, CanBoXuLy, MucDoUuTien)
    WHERE NgayHenTra >= GETDATE() AND TinhTrangXuLy NOT IN ('COMPLETED', 'CANCELLED');

-- Emergency/SLA breach monitoring
CREATE INDEX IX_HOSO_SLA_Breach ON [case].HOSO(NgayHenTra, TinhTrangXuLy, MucDoUuTien DESC)
    WHERE NgayHenTra < GETDATE() AND TinhTrangXuLy NOT IN ('COMPLETED', 'CANCELLED');

-- TASK_ASSIGNMENT performance indexes
CREATE INDEX IX_TASK_ASSIGN_User_Status ON [case].TASK_ASSIGNMENT(AssignedUserID, Status, DueDate)
    INCLUDE (AssignmentID, HoSoID, TaskCode, Priority)
    WHERE Status IN ('Assigned', 'InProgress');

CREATE INDEX IX_TASK_ASSIGN_HoSo_Status ON [case].TASK_ASSIGNMENT(HoSoID, Status, CreatedAt DESC)
    INCLUDE (AssignmentID, TaskCode, AssignedUserID, DueDate);

CREATE INDEX IX_TASK_ASSIGN_Overdue ON [case].TASK_ASSIGNMENT(DueDate, Status, Priority DESC)
    WHERE DueDate < GETDATE() AND Status NOT IN ('Completed', 'Cancelled');

-- STATUS_HISTORY for audit trails
CREATE INDEX IX_STATUS_HISTORY_HoSo_Date ON [case].STATUS_HISTORY(HoSoID, ChangedAt DESC)
    INCLUDE (FromStatus, ToStatus, ChangedBy, Reason);

CREATE INDEX IX_STATUS_HISTORY_User_Date ON [case].STATUS_HISTORY(ChangedBy, ChangedAt DESC)
    INCLUDE (HoSoID, FromStatus, ToStatus)
    WHERE ChangedBy IS NOT NULL;

-- SLA_TRACKING performance
CREATE INDEX IX_SLA_TRACK_Breach_Risk ON [case].SLA_TRACKING(IsBreached, RiskLevel DESC, TargetEndTime)
    WHERE IsActive = 1;

CREATE INDEX IX_SLA_TRACK_Warning ON [case].SLA_TRACKING(SLAStatus, RemainingHours, TargetEndTime)
    WHERE SLAStatus IN ('Warning', 'Critical') AND IsActive = 1;

-- CITIZEN_FEEDBACK analytics
CREATE INDEX IX_CITIZEN_FEEDBACK_Rating_Date ON [case].CITIZEN_FEEDBACK(OverallRating, SubmittedAt DESC)
    INCLUDE (HoSoID, FeedbackType, ServiceOfficeID);

CREATE INDEX IX_CITIZEN_FEEDBACK_Service_Rating ON [case].CITIZEN_FEEDBACK(ServiceOfficeID, OverallRating DESC, SubmittedAt DESC);

CREATE INDEX IX_CITIZEN_FEEDBACK_Sentiment ON [case].CITIZEN_FEEDBACK(SentimentLabel, SentimentScore DESC)
    INCLUDE (HoSoID, FeedbackType, SubmittedAt);
GO
```

## WORKFLOW SCHEMA INDEXES

### Workflow Execution Performance

```sql
-- WORKFLOW_INSTANCE runtime performance
CREATE INDEX IX_WORKFLOW_INST_Definition_Status ON [workflow].WORKFLOW_INSTANCE(WorkflowDefinitionID, Status, StartedAt DESC)
    INCLUDE (InstanceID, RelatedEntityID, RelatedEntityType);

CREATE INDEX IX_WORKFLOW_INST_Entity ON [workflow].WORKFLOW_INSTANCE(RelatedEntityType, RelatedEntityID, Status)
    INCLUDE (InstanceID, WorkflowDefinitionID, CurrentStepID);

CREATE INDEX IX_WORKFLOW_INST_Active ON [workflow].WORKFLOW_INSTANCE(Status, LastActivityAt DESC)
    WHERE Status IN ('RUNNING', 'SUSPENDED', 'WAITING');

-- WORKFLOW_STEP_INSTANCE performance
CREATE INDEX IX_WORKFLOW_STEP_Instance_Status ON [workflow].WORKFLOW_STEP_INSTANCE(WorkflowInstanceID, Status, ExecutionOrder)
    INCLUDE (StepInstanceID, StepDefinitionID, AssignedUserID);

CREATE INDEX IX_WORKFLOW_STEP_User_Status ON [workflow].WORKFLOW_STEP_INSTANCE(AssignedUserID, Status, DueDate)
    INCLUDE (StepInstanceID, WorkflowInstanceID, StepDefinitionID)
    WHERE AssignedUserID IS NOT NULL AND Status IN ('PENDING', 'IN_PROGRESS');

CREATE INDEX IX_WORKFLOW_STEP_Overdue ON [workflow].WORKFLOW_STEP_INSTANCE(DueDate, Status)
    WHERE DueDate < GETDATE() AND Status NOT IN ('COMPLETED', 'SKIPPED', 'CANCELLED');

-- WORKFLOW_DEFINITION lookup optimization
CREATE INDEX IX_WORKFLOW_DEF_Code_Version ON [workflow].WORKFLOW_DEFINITION(WorkflowCode, Version DESC, IsActive)
    WHERE IsActive = 1;

CREATE INDEX IX_WORKFLOW_DEF_Category ON [workflow].WORKFLOW_DEFINITION(Category, IsActive, CreatedAt DESC)
    WHERE IsActive = 1;
GO
```

## DOCUMENT SCHEMA INDEXES

### Document Management Performance

```sql
-- DOCUMENT primary lookup patterns
CREATE INDEX IX_DOCUMENT_HoSo_Type ON [document].DOCUMENT(RelatedHoSoID, DocumentType, IsActive)
    INCLUDE (DocumentID, FileName, FilePath, CreatedAt)
    WHERE IsActive = 1;

CREATE INDEX IX_DOCUMENT_Type_Status ON [document].DOCUMENT(DocumentType, ProcessingStatus, CreatedAt DESC)
    INCLUDE (DocumentID, FileName, RelatedHoSoID);

CREATE INDEX IX_DOCUMENT_Signature_Status ON [document].DOCUMENT(RequiresSignature, SignatureStatus, CreatedAt DESC)
    WHERE RequiresSignature = 1;

CREATE INDEX IX_DOCUMENT_Checksum ON [document].DOCUMENT(FileChecksum)
    INCLUDE (DocumentID, FileName, FileSize)
    WHERE FileChecksum IS NOT NULL;

-- DOCUMENT_VERSION tracking
CREATE INDEX IX_DOC_VERSION_Document ON [document].DOCUMENT_VERSION(DocumentID, VersionNumber DESC)
    INCLUDE (VersionID, CreatedAt, CreatedBy, ChangeReason);

-- DIGITAL_SIGNATURE verification
CREATE INDEX IX_DIGITAL_SIG_Document ON [document].DIGITAL_SIGNATURE(DocumentID, IsValid, SignedAt DESC)
    INCLUDE (SignatureID, SignerCertificate, SignatureStatus);

CREATE INDEX IX_DIGITAL_SIG_Signer ON [document].DIGITAL_SIGNATURE(SignerUserID, SignedAt DESC, IsValid)
    INCLUDE (DocumentID, SignatureStatus)
    WHERE IsValid = 1;
GO
```

## NOTIFICATION SCHEMA INDEXES

### Notification Processing Performance

```sql
-- NOTIFICATION_QUEUE processing optimization
CREATE INDEX IX_NOTIF_QUEUE_Processing ON [notification].NOTIFICATION_QUEUE(Status, Priority DESC, ProcessAfter)
    INCLUDE (QueueID, MessageType, RecipientAddress, Content)
    WHERE Status IN ('Pending', 'Processing');

CREATE INDEX IX_NOTIF_QUEUE_Retry ON [notification].NOTIFICATION_QUEUE(Status, NextRetryAt, RetryCount)
    INCLUDE (QueueID, MessageType, MaxRetries)
    WHERE Status = 'Failed' AND RetryCount < MaxRetries;

CREATE INDEX IX_NOTIF_QUEUE_Recipient ON [notification].NOTIFICATION_QUEUE(RecipientType, RecipientID, CreatedAt DESC)
    INCLUDE (QueueID, MessageType, Status, Subject);

CREATE INDEX IX_NOTIF_QUEUE_Entity ON [notification].NOTIFICATION_QUEUE(RelatedEntityType, RelatedEntityID, CreatedAt DESC)
    INCLUDE (QueueID, MessageType, Status, RecipientAddress);

-- NOTIFICATION_HISTORY analytics
CREATE INDEX IX_NOTIF_HIST_Recipient_Type ON [notification].NOTIFICATION_HISTORY(RecipientUserID, NotificationType, CreatedAt DESC)
    INCLUDE (NotificationID, Status, Subject);

CREATE INDEX IX_NOTIF_HIST_Status_Date ON [notification].NOTIFICATION_HISTORY(Status, CreatedAt DESC)
    INCLUDE (NotificationID, NotificationType, RecipientUserID);
GO
```

## SYSTEM SCHEMA INDEXES

### System Configuration Performance

```sql
-- SYSTEM_CONFIGURATION lookup
CREATE INDEX IX_SYS_CONFIG_Category_Key ON [system].SYSTEM_CONFIGURATION(ConfigCategory, ConfigKey)
    INCLUDE (ConfigValue, IsActive)
    WHERE IsActive = 1;

CREATE INDEX IX_SYS_CONFIG_Environment ON [system].SYSTEM_CONFIGURATION(Environment, TenantID, IsActive)
    INCLUDE (ConfigKey, ConfigValue)
    WHERE IsActive = 1;

-- FILE_STORAGE tracking
CREATE INDEX IX_FILE_STORAGE_Path ON [system].FILE_STORAGE(FilePath)
    INCLUDE (StorageID, FileName, FileSize, CreatedAt);

CREATE INDEX IX_FILE_STORAGE_Checksum ON [system].FILE_STORAGE(FileChecksum)
    INCLUDE (StorageID, FilePath, FileSize)
    WHERE FileChecksum IS NOT NULL;

-- OFFICE lookup optimization
CREATE INDEX IX_OFFICE_Code ON [system].OFFICE(OfficeCode)
    INCLUDE (OfficeID, OfficeName, IsActive)
    WHERE IsActive = 1;

CREATE INDEX IX_OFFICE_Parent ON [system].OFFICE(ParentOfficeID, IsActive)
    INCLUDE (OfficeID, OfficeCode, OfficeName)
    WHERE IsActive = 1;

-- LGSP_SYNC_LOG performance
CREATE INDEX IX_LGSP_SYNC_Status ON [system].LGSP_SYNC_LOG(SyncStatus, AttemptNumber, SyncStartTime DESC);

CREATE INDEX IX_LGSP_SYNC_Entity ON [system].LGSP_SYNC_LOG(EntityType, EntityID, SyncStartTime DESC)
    INCLUDE (SyncLogID, SyncStatus, ResponseTime);
GO
```

## TTHC SCHEMA INDEXES

### Administrative Procedure Performance

```sql
-- THU_TUC lookup optimization
CREATE INDEX IX_THU_TUC_MaTTHC ON [tthc].THU_TUC(MaTTHC)
    INCLUDE (TTHCID, TenTTHC, LinhVuc, TrangThai)
    WHERE TrangThai = 1;

CREATE INDEX IX_THU_TUC_LinhVuc ON [tthc].THU_TUC(LinhVuc, TrangThai, NgayHieuLuc DESC)
    INCLUDE (TTHCID, MaTTHC, TenTTHC)
    WHERE TrangThai = 1;

CREATE INDEX IX_THU_TUC_CapThucHien ON [tthc].THU_TUC(CapThucHien, TrangThai)
    INCLUDE (TTHCID, MaTTHC, TenTTHC, LinhVuc)
    WHERE TrangThai = 1;

-- TTHC_VERSION active lookup
CREATE INDEX IX_TTHC_VERSION_Active ON [tthc].TTHC_VERSION(TTHCID, IsActive, Version DESC)
    INCLUDE (VersionID, EffectiveDate)
    WHERE IsActive = 1;

-- DOCUMENT_TYPE performance
CREATE INDEX IX_DOC_TYPE_TTHC ON [tthc].DOCUMENT_TYPE(TTHCID, IsRequired, DisplayOrder)
    INCLUDE (DocumentTypeID, TenLoaiGiayTo, MoTa)
    WHERE IsActive = 1;

-- FEE_SCHEDULE lookup
CREATE INDEX IX_FEE_SCHEDULE_TTHC ON [tthc].FEE_SCHEDULE(TTHCID, IsActive, EffectiveDate DESC)
    INCLUDE (FeeScheduleID, FeeAmount, FeeName)
    WHERE IsActive = 1;
GO
```

## AUDIT SCHEMA INDEXES

### Audit Trail Performance

```sql
-- AUDIT_LOG comprehensive indexing
CREATE INDEX IX_AUDIT_LOG_User_Action ON [audit].AUDIT_LOG(UserID, ActionType, Timestamp DESC)
    INCLUDE (LogID, ResourceType, ResourceID, IPAddress)
    WHERE UserID IS NOT NULL;

CREATE INDEX IX_AUDIT_LOG_Resource ON [audit].AUDIT_LOG(ResourceType, ResourceID, Timestamp DESC)
    INCLUDE (LogID, UserID, ActionType, Status);

CREATE INDEX IX_AUDIT_LOG_Session ON [audit].AUDIT_LOG(SessionID, Timestamp DESC)
    INCLUDE (LogID, UserID, ActionType, ResourceType)
    WHERE SessionID IS NOT NULL;

CREATE INDEX IX_AUDIT_LOG_Failed_Actions ON [audit].AUDIT_LOG(Status, ActionType, Timestamp DESC)
    INCLUDE (LogID, UserID, ResourceType, ResourceID)
    WHERE Status = 'FAILED';

-- SECURITY_EVENT monitoring
CREATE INDEX IX_SECURITY_EVENT_Type_Severity ON [audit].SECURITY_EVENT(EventType, Severity, EventTime DESC)
    INCLUDE (EventID, UserID, IPAddress, RiskScore);

CREATE INDEX IX_SECURITY_EVENT_Risk ON [audit].SECURITY_EVENT(RiskScore DESC, EventTime DESC)
    WHERE RiskScore > 5;
GO
```

## POSTAL SCHEMA INDEXES

### Shipment Tracking Performance

```sql
-- SHIPMENT_TRACKING primary lookups
CREATE INDEX IX_SHIPMENT_TrackingNumber ON [postal].SHIPMENT_TRACKING(TrackingNumber)
    INCLUDE (ShipmentID, HoSoID, ShipmentStatus, EstimatedDeliveryDate);

CREATE INDEX IX_SHIPMENT_HoSo ON [postal].SHIPMENT_TRACKING(HoSoID, ShipmentStatus, CreatedAt DESC)
    INCLUDE (ShipmentID, TrackingNumber, ReceiverName, ReceiverPhone);

CREATE INDEX IX_SHIPMENT_Status_Provider ON [postal].SHIPMENT_TRACKING(ShipmentStatus, ProviderName, CreatedAt DESC)
    INCLUDE (ShipmentID, TrackingNumber, HoSoID);

-- DELIVERY_CONFIRMATION tracking
CREATE INDEX IX_DELIVERY_CONF_Shipment ON [postal].DELIVERY_CONFIRMATION(ShipmentID, DeliveryStatus, DeliveredAt DESC)
    INCLUDE (ConfirmationID, ReceiverName, DeliveryMethod);

CREATE INDEX IX_DELIVERY_CONF_Failed ON [postal].DELIVERY_CONFIRMATION(DeliveryStatus, AttemptNumber, ScheduledRetryAt)
    WHERE DeliveryStatus = 'FAILED' AND ScheduledRetryAt >= GETDATE();

-- POSTAL_PROVIDER performance
CREATE INDEX IX_POSTAL_PROVIDER_Service ON [postal].POSTAL_PROVIDER(ProviderCode, ServiceType, IsActive)
    INCLUDE (ProviderID, ProviderName, CoverageAreas)
    WHERE IsActive = 1;
GO
```

## JSON NORMALIZED SCHEMA INDEXES

### Normalized Data Performance

```sql
-- ADDRESS_COMPONENTS geographic lookups
CREATE INDEX IX_ADDRESS_Location_Hierarchy ON [json_normalized].ADDRESS_COMPONENTS(ProvinceCode, DistrictCode, WardCode)
    INCLUDE (AddressID, FullAddress, IsVerified);

CREATE INDEX IX_ADDRESS_Geolocation ON [json_normalized].ADDRESS_COMPONENTS(Latitude, Longitude)
    INCLUDE (AddressID, FullAddress, DeliveryDifficulty)
    WHERE Latitude IS NOT NULL AND Longitude IS NOT NULL;

-- BUSINESS_RULES execution optimization
CREATE INDEX IX_BUSINESS_RULES_Category_Active ON [json_normalized].BUSINESS_RULES(RuleCategory, IsActive, Priority, ExecutionOrder)
    INCLUDE (RuleID, RuleName, Condition, Action)
    WHERE IsActive = 1;

CREATE INDEX IX_BUSINESS_RULES_Source ON [json_normalized].BUSINESS_RULES(SourceTable, SourceID, RuleCategory)
    INCLUDE (RuleID, RuleName, IsActive);

-- VALIDATION_RULES processing
CREATE INDEX IX_VALIDATION_Field_Type ON [json_normalized].VALIDATION_RULES(FieldName, ValidationType, IsActive)
    INCLUDE (ValidationID, ErrorMessage, ValidationOrder)
    WHERE IsActive = 1;

CREATE INDEX IX_VALIDATION_Conditional ON [json_normalized].VALIDATION_RULES(ConditionalOn, ConditionalOperator, IsActive)
    INCLUDE (ValidationID, FieldName, ConditionalValue)
    WHERE ConditionalOn IS NOT NULL AND IsActive = 1;

-- CONFIGURATION_ITEMS lookup
CREATE INDEX IX_CONFIG_Category_Environment ON [json_normalized].CONFIGURATION_ITEMS(ConfigCategory, Environment, TenantID)
    INCLUDE (ConfigID, ConfigKey, ConfigValue)
    WHERE Environment IS NOT NULL;

-- ERROR_DETAILS monitoring
CREATE INDEX IX_ERROR_Service_Severity ON [json_normalized].ERROR_DETAILS(ServiceName, Severity, CreatedAt DESC)
    INCLUDE (ErrorDetailID, ErrorCode, ErrorMessage);

CREATE INDEX IX_ERROR_Unresolved_Severity ON [json_normalized].ERROR_DETAILS(IsResolved, Severity, FirstOccurrence DESC)
    WHERE IsResolved = 0;
GO
```

## PERFORMANCE MONITORING INDEXES

### Index Usage Monitoring

```sql
-- Index usage statistics view
CREATE VIEW [dbo].v_IndexUsageStats AS
SELECT
    SCHEMA_NAME(t.schema_id) AS SchemaName,
    OBJECT_NAME(i.object_id) AS TableName,
    i.name AS IndexName,
    i.type_desc AS IndexType,
    ius.user_seeks,
    ius.user_scans,
    ius.user_lookups,
    ius.user_updates,
    ius.last_user_seek,
    ius.last_user_scan,
    ius.last_user_lookup,
    ius.system_seeks,
    ius.system_scans,
    ius.system_lookups,
    CASE
        WHEN ius.user_seeks + ius.user_scans + ius.user_lookups = 0 THEN 'UNUSED'
        WHEN ius.user_updates > (ius.user_seeks + ius.user_scans + ius.user_lookups) * 10 THEN 'HIGH_MAINTENANCE'
        ELSE 'ACTIVE'
    END AS IndexStatus
FROM sys.indexes i
LEFT JOIN sys.dm_db_index_usage_stats ius
    ON i.object_id = ius.object_id AND i.index_id = ius.index_id
INNER JOIN sys.tables t ON i.object_id = t.object_id
WHERE i.is_disabled = 0 AND i.is_hypothetical = 0
GO

-- Missing index suggestions view
CREATE VIEW [dbo].v_MissingIndexes AS
SELECT
    mid.statement AS TableName,
    mid.equality_columns,
    mid.inequality_columns,
    mid.included_columns,
    migs.avg_total_user_cost,
    migs.avg_user_impact,
    migs.user_seeks,
    migs.user_scans,
    migs.unique_compiles,
    CAST(migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans) AS BIGINT) AS improvement_measure
FROM sys.dm_db_missing_index_details mid
INNER JOIN sys.dm_db_missing_index_groups mig ON mid.index_handle = mig.index_handle
INNER JOIN sys.dm_db_missing_index_group_stats migs ON mig.index_group_handle = migs.group_handle
WHERE mid.database_id = DB_ID()
AND migs.avg_user_impact > 10 -- Only show indexes with significant impact
GO
```

## INDEX MAINTENANCE STRATEGY

### Automated Index Maintenance

```sql
-- Index maintenance procedure
CREATE PROCEDURE [dbo].sp_IndexMaintenance
    @FragmentationThreshold DECIMAL(5,2) = 30.0,
    @RebuildThreshold DECIMAL(5,2) = 50.0
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @sql NVARCHAR(MAX);
    DECLARE @SchemaName NVARCHAR(128);
    DECLARE @TableName NVARCHAR(128);
    DECLARE @IndexName NVARCHAR(128);
    DECLARE @FragmentationPercent DECIMAL(5,2);

    DECLARE index_cursor CURSOR FOR
    SELECT
        SCHEMA_NAME(t.schema_id) AS SchemaName,
        OBJECT_NAME(ips.object_id) AS TableName,
        i.name AS IndexName,
        ips.avg_fragmentation_in_percent
    FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, 'LIMITED') ips
    INNER JOIN sys.indexes i ON ips.object_id = i.object_id AND ips.index_id = i.index_id
    INNER JOIN sys.tables t ON ips.object_id = t.object_id
    WHERE ips.avg_fragmentation_in_percent > @FragmentationThreshold
    AND i.name IS NOT NULL
    AND ips.page_count > 100 -- Only consider indexes with significant size
    ORDER BY ips.avg_fragmentation_in_percent DESC;

    OPEN index_cursor;
    FETCH NEXT FROM index_cursor INTO @SchemaName, @TableName, @IndexName, @FragmentationPercent;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        IF @FragmentationPercent > @RebuildThreshold
        BEGIN
            SET @sql = N'ALTER INDEX [' + @IndexName + '] ON [' + @SchemaName + '].[' + @TableName + '] REBUILD WITH (ONLINE = ON, SORT_IN_TEMPDB = ON, MAXDOP = 4)';
            PRINT 'REBUILDING: ' + @SchemaName + '.' + @TableName + '.' + @IndexName + ' (' + CAST(@FragmentationPercent AS VARCHAR(10)) + '% fragmented)';
        END
        ELSE
        BEGIN
            SET @sql = N'ALTER INDEX [' + @IndexName + '] ON [' + @SchemaName + '].[' + @TableName + '] REORGANIZE';
            PRINT 'REORGANIZING: ' + @SchemaName + '.' + @TableName + '.' + @IndexName + ' (' + CAST(@FragmentationPercent AS VARCHAR(10)) + '% fragmented)';
        END

        BEGIN TRY
            EXEC sp_executesql @sql;
        END TRY
        BEGIN CATCH
            PRINT 'ERROR maintaining index: ' + @SchemaName + '.' + @TableName + '.' + @IndexName + ' - ' + ERROR_MESSAGE();
        END CATCH

        FETCH NEXT FROM index_cursor INTO @SchemaName, @TableName, @IndexName, @FragmentationPercent;
    END

    CLOSE index_cursor;
    DEALLOCATE index_cursor;

    -- Update statistics after index maintenance
    EXEC sp_updatestats;
END
GO

-- Schedule index maintenance job
EXEC msdb.dbo.sp_add_job
    @job_name = N'Database Index Maintenance',
    @enabled = 1;

EXEC msdb.dbo.sp_add_jobstep
    @job_name = N'Database Index Maintenance',
    @step_name = N'Maintain Indexes',
    @command = N'EXEC [dbo].sp_IndexMaintenance @FragmentationThreshold = 20.0, @RebuildThreshold = 40.0',
    @database_name = N'DVC_v2';

EXEC msdb.dbo.sp_add_schedule
    @schedule_name = N'Weekly Index Maintenance',
    @freq_type = 8, -- Weekly
    @freq_interval = 1, -- Sunday
    @active_start_time = 20000; -- 2:00 AM

EXEC msdb.dbo.sp_attach_schedule
    @job_name = N'Database Index Maintenance',
    @schedule_name = N'Weekly Index Maintenance';
GO
```

## EXPECTED PERFORMANCE IMPROVEMENTS

### Query Performance Targets
- **Identity Lookups**: <5ms (user authentication, authorization)
- **Case Searches**: <10ms (status queries, citizen lookups)
- **Workflow Processing**: <15ms (task assignments, state changes)
- **Document Retrieval**: <8ms (file metadata, signature verification)
- **Audit Queries**: <20ms (compliance reporting, security monitoring)
- **Notification Processing**: <5ms (queue processing, delivery tracking)

### Index Effectiveness Metrics
- **Seek Ratio**: >90% seeks vs scans for primary queries
- **Key Lookups**: <10% additional lookups after index seeks
- **Index Usage**: >80% of indexes actively used monthly
- **Fragmentation**: <20% average fragmentation across all indexes

### Resource Utilization
- **CPU**: Reduced query CPU by 60-80%
- **I/O**: Reduced logical reads by 70-90%
- **Memory**: Improved buffer pool efficiency by 50%
- **Concurrency**: Reduced blocking and lock escalation by 85%

This comprehensive index strategy provides the foundation for achieving the <20ms query performance target across all database operations in the DVC v2 system.