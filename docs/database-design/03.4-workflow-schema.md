# [workflow] Schema - Workflow Management

## OVERVIEW

The `[workflow]` schema manages workflow definitions, execution states, and business process automation for the DVC v2 system. It integrates with Elsa 3.0 workflow engine to provide BPMN 2.0 compliant business process management with Vietnamese government procedure workflows.

## SCHEMA CREATION

```sql
-- Workflow Management
CREATE SCHEMA [workflow];
GO
```

## CORE WORKFLOW TABLES

### 1. DM_WORKFLOW - Workflow definitions and metadata

```sql
CREATE TABLE [workflow].DM_WORKFLOW (
    WorkflowID BIGINT PRIMARY KEY IDENTITY,
    TTHCID BIGINT, -- Associated administrative procedure

    -- Workflow identification
    WorkflowCode NVARCHAR(100) UNIQUE NOT NULL,
    WorkflowName NVARCHAR(500) NOT NULL,
    WorkflowDescription NVARCHAR(2000),
    WorkflowVersion NVARCHAR(20) DEFAULT '1.0',

    -- Workflow classification
    WorkflowType NVARCHAR(100) NOT NULL, -- TTHC/Administrative/Approval/Review/Emergency
    ProcessCategory NVARCHAR(100), -- Sequential/Parallel/Conditional/Loop
    ComplexityLevel TINYINT DEFAULT 2, -- 1=Simple, 2=Medium, 3=Complex, 4=Very Complex
    Priority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low

    -- BPMN and Elsa integration
    ElsaWorkflowDefinitionId NVARCHAR(255), -- Elsa workflow definition ID
    BPMNContent XML, -- BPMN 2.0 XML definition
    ElsaWorkflowVersion INT DEFAULT 1,
    WorkflowGraph NVARCHAR(MAX), -- JSON workflow graph for UI

    -- Processing characteristics
    EstimatedDuration INT NOT NULL, -- Expected duration in hours
    MaxDuration INT, -- Maximum allowed duration in hours
    CriticalPath NVARCHAR(MAX), -- JSON critical path steps
    ParallelismSupported BIT DEFAULT 0,

    -- Automation and integration
    AutomationLevel TINYINT DEFAULT 1, -- 1=Manual, 2=Semi-auto, 3=Fully-auto
    RequiresHumanReview BIT DEFAULT 1,
    StraightThroughProcessing BIT DEFAULT 0, -- STP capability
    APIIntegrationRequired BIT DEFAULT 0,
    ExternalSystemsIntegration NVARCHAR(MAX), -- JSON array of external systems

    -- Business rules and conditions
    BusinessRules NVARCHAR(MAX), -- JSON business rules
    ValidationRules NVARCHAR(MAX), -- JSON validation rules
    EscalationRules NVARCHAR(MAX), -- JSON escalation rules
    ComplianceRequirements NVARCHAR(MAX), -- JSON compliance rules

    -- Quality and performance
    SLATargetHours INT, -- Service Level Agreement target
    QualityCheckpoints NVARCHAR(MAX), -- JSON quality checkpoints
    PerformanceMetrics NVARCHAR(MAX), -- JSON performance metrics
    RiskLevel TINYINT DEFAULT 2, -- 1=Low, 2=Medium, 3=High, 4=Critical

    -- Capacity and resource management
    RequiredSkillSets NVARCHAR(MAX), -- JSON required skills
    OptimalStaffCount INT DEFAULT 1,
    MaxConcurrentInstances INT DEFAULT 100,
    ResourceRequirements NVARCHAR(MAX), -- JSON resource requirements

    -- Notification and communication
    NotificationTemplates NVARCHAR(MAX), -- JSON notification templates
    CommunicationPlan NVARCHAR(MAX), -- JSON communication plan
    StakeholderNotifications NVARCHAR(MAX), -- JSON stakeholder matrix

    -- Lifecycle management
    VersionHistory NVARCHAR(MAX), -- JSON version history
    ChangeLog NVARCHAR(MAX), -- JSON change log
    MigrationScript NVARCHAR(MAX), -- Script for data migration between versions
    RollbackPlan NVARCHAR(2000), -- Rollback procedure

    -- Status and deployment
    DeploymentStatus NVARCHAR(50) DEFAULT 'Draft', -- Draft/Testing/Deployed/Deprecated
    EnvironmentTarget NVARCHAR(100), -- Development/Staging/Production
    DeploymentDate DATETIME2,
    LastTestDate DATETIME2,

    -- Legal and compliance
    LegalFramework NVARCHAR(2000), -- Legal basis for workflow
    ComplianceStatus NVARCHAR(100), -- Compliant/Under Review/Non-compliant
    AuditRequirements NVARCHAR(MAX), -- JSON audit requirements
    RetentionPolicy NVARCHAR(500), -- Data retention policy

    -- Status
    IsActive BIT DEFAULT 1,
    IsPublished BIT DEFAULT 0,
    IsTemplate BIT DEFAULT 0, -- Can be used as template for other workflows

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,
    DeletedAt DATETIME2,
    DeletedBy BIGINT,

    -- Constraints
    CONSTRAINT CK_WORKFLOW_EstimatedDuration CHECK (EstimatedDuration > 0),
    CONSTRAINT CK_WORKFLOW_ComplexityLevel CHECK (ComplexityLevel BETWEEN 1 AND 4),
    CONSTRAINT CK_WORKFLOW_Priority CHECK (Priority BETWEEN 1 AND 4)
);
GO

-- Indexes
CREATE INDEX IX_WORKFLOW_Code ON [workflow].DM_WORKFLOW(WorkflowCode);
CREATE INDEX IX_WORKFLOW_TTHC ON [workflow].DM_WORKFLOW(TTHCID, IsActive);
CREATE INDEX IX_WORKFLOW_Type ON [workflow].DM_WORKFLOW(WorkflowType, DeploymentStatus);
CREATE INDEX IX_WORKFLOW_Status ON [workflow].DM_WORKFLOW(DeploymentStatus, IsActive);
CREATE INDEX IX_WORKFLOW_Elsa ON [workflow].DM_WORKFLOW(ElsaWorkflowDefinitionId, ElsaWorkflowVersion);
CREATE INDEX IX_WORKFLOW_Performance ON [workflow].DM_WORKFLOW(EstimatedDuration, ComplexityLevel);
CREATE INDEX IX_WORKFLOW_Updated ON [workflow].DM_WORKFLOW(UpdatedAt DESC);
GO
```

### 2. DM_WORKFLOW_STEP - Individual workflow steps/activities

```sql
CREATE TABLE [workflow].DM_WORKFLOW_STEP (
    StepID BIGINT PRIMARY KEY IDENTITY,
    WorkflowID BIGINT NOT NULL,

    -- Step identification
    StepCode NVARCHAR(100) NOT NULL,
    StepName NVARCHAR(500) NOT NULL,
    StepDescription NVARCHAR(2000),
    StepNumber INT NOT NULL,

    -- Step classification
    StepType NVARCHAR(100) NOT NULL, -- Task/Gateway/Event/Subprocess/Service
    ActivityType NVARCHAR(100), -- User/Service/Script/Manual/Automated/Approval
    StepCategory NVARCHAR(100), -- Input/Process/Review/Approve/Output/Notification

    -- BPMN and Elsa integration
    ElsaActivityId NVARCHAR(255), -- Elsa activity ID
    BPMNElementId NVARCHAR(255), -- BPMN element ID
    ActivityDefinition NVARCHAR(MAX), -- JSON activity definition
    ElsaActivityType NVARCHAR(200), -- Elsa-specific activity type

    -- Step processing
    IsStartStep BIT DEFAULT 0,
    IsEndStep BIT DEFAULT 0,
    IsDecisionPoint BIT DEFAULT 0,
    IsParallelGateway BIT DEFAULT 0,
    IsConditionalStep BIT DEFAULT 0,

    -- Timing and performance
    EstimatedDurationMinutes INT NOT NULL,
    MaxDurationMinutes INT,
    SLAMinutes INT, -- Step-level SLA
    IsTimeoutEnabled BIT DEFAULT 0,
    TimeoutActionType NVARCHAR(100), -- Escalate/Skip/Fail/Retry

    -- Assignment and routing
    AssignmentType NVARCHAR(100), -- Role/User/Pool/Rule/System
    AssignmentRules NVARCHAR(MAX), -- JSON assignment rules
    EscalationRules NVARCHAR(MAX), -- JSON escalation rules
    RouteConditions NVARCHAR(MAX), -- JSON routing conditions

    -- Human task configuration
    RequiresHumanInput BIT DEFAULT 1,
    TaskPriority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    UIFormDefinition NVARCHAR(MAX), -- JSON form definition
    InputFields NVARCHAR(MAX), -- JSON input field definitions
    ValidationRules NVARCHAR(MAX), -- JSON validation rules

    -- System integration
    IsSystemActivity BIT DEFAULT 0,
    APIEndpoint NVARCHAR(500), -- API endpoint for system activities
    ServiceConfiguration NVARCHAR(MAX), -- JSON service configuration
    RetryPolicy NVARCHAR(1000), -- JSON retry policy

    -- Business rules
    BusinessLogic NVARCHAR(MAX), -- JSON business logic
    ConditionExpression NVARCHAR(2000), -- Condition for conditional steps
    DataTransformation NVARCHAR(MAX), -- JSON data transformation rules
    ValidationScript NVARCHAR(MAX), -- Validation script

    -- Document and data handling
    RequiredDocuments NVARCHAR(MAX), -- JSON required documents
    GeneratedDocuments NVARCHAR(MAX), -- JSON documents generated by this step
    DataInputs NVARCHAR(MAX), -- JSON expected data inputs
    DataOutputs NVARCHAR(MAX), -- JSON expected data outputs

    -- Quality and compliance
    QualityCheckRequired BIT DEFAULT 0,
    QualityCheckCriteria NVARCHAR(MAX), -- JSON quality criteria
    ComplianceRules NVARCHAR(MAX), -- JSON compliance rules
    AuditLogging BIT DEFAULT 1,

    -- Notifications and communications
    NotificationRules NVARCHAR(MAX), -- JSON notification rules
    EmailTemplates NVARCHAR(MAX), -- JSON email templates
    SMSTemplates NVARCHAR(MAX), -- JSON SMS templates
    PushNotifications BIT DEFAULT 0,

    -- Error handling
    ErrorHandlingStrategy NVARCHAR(100), -- Retry/Skip/Fail/Escalate/Manual
    MaxRetryAttempts INT DEFAULT 3,
    RetryDelayMinutes INT DEFAULT 5,
    FallbackAction NVARCHAR(MAX), -- JSON fallback action

    -- Performance tracking
    AverageExecutionTime INT, -- Historical average in minutes
    SuccessRate DECIMAL(5,2) DEFAULT 100.0,
    ErrorRate DECIMAL(5,2) DEFAULT 0.0,
    LastPerformanceUpdate DATETIME2,

    -- Dependencies
    PreviousSteps NVARCHAR(MAX), -- JSON array of prerequisite steps
    NextSteps NVARCHAR(MAX), -- JSON array of subsequent steps
    ParallelSteps NVARCHAR(MAX), -- JSON array of parallel steps
    ConditionalNextSteps NVARCHAR(MAX), -- JSON conditional routing

    -- UI and display
    DisplayOrder INT DEFAULT 1,
    IconName NVARCHAR(100),
    ColorCode NVARCHAR(20),
    DisplayInTimeline BIT DEFAULT 1,

    -- Status
    IsActive BIT DEFAULT 1,
    IsOptional BIT DEFAULT 0,
    IsHidden BIT DEFAULT 0,
    CanBeSkipped BIT DEFAULT 0,

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,
    DeletedAt DATETIME2,
    DeletedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_WORKFLOW_STEP_WORKFLOW FOREIGN KEY (WorkflowID) REFERENCES [workflow].DM_WORKFLOW(WorkflowID),
    CONSTRAINT CK_WORKFLOW_STEP_Duration CHECK (EstimatedDurationMinutes > 0),
    CONSTRAINT CK_WORKFLOW_STEP_Priority CHECK (TaskPriority BETWEEN 1 AND 4),
    CONSTRAINT UC_WORKFLOW_STEP_CODE UNIQUE (WorkflowID, StepCode)
);
GO

-- Indexes
CREATE INDEX IX_WORKFLOW_STEP_Workflow ON [workflow].DM_WORKFLOW_STEP(WorkflowID, StepNumber);
CREATE INDEX IX_WORKFLOW_STEP_Code ON [workflow].DM_WORKFLOW_STEP(StepCode, WorkflowID);
CREATE INDEX IX_WORKFLOW_STEP_Type ON [workflow].DM_WORKFLOW_STEP(StepType, ActivityType);
CREATE INDEX IX_WORKFLOW_STEP_Elsa ON [workflow].DM_WORKFLOW_STEP(ElsaActivityId, ElsaActivityType);
CREATE INDEX IX_WORKFLOW_STEP_Assignment ON [workflow].DM_WORKFLOW_STEP(AssignmentType, IsActive);
CREATE INDEX IX_WORKFLOW_STEP_Human ON [workflow].DM_WORKFLOW_STEP(RequiresHumanInput, TaskPriority);
CREATE INDEX IX_WORKFLOW_STEP_System ON [workflow].DM_WORKFLOW_STEP(IsSystemActivity, IsActive);
CREATE INDEX IX_WORKFLOW_STEP_Performance ON [workflow].DM_WORKFLOW_STEP(AverageExecutionTime, SuccessRate);
GO
```

## WORKFLOW RUNTIME TABLES

### 3. WORKFLOW_INSTANCE - Workflow execution instances

```sql
CREATE TABLE [workflow].WORKFLOW_INSTANCE (
    InstanceID BIGINT PRIMARY KEY IDENTITY,
    WorkflowID BIGINT NOT NULL,
    HoSoID BIGINT, -- Associated case/application

    -- Instance identification
    InstanceCode NVARCHAR(100) NOT NULL,
    InstanceName NVARCHAR(500),

    -- Elsa integration
    ElsaWorkflowInstanceId NVARCHAR(255) UNIQUE, -- Elsa workflow instance ID
    ElsaCorrelationId NVARCHAR(255), -- Elsa correlation ID

    -- Instance metadata
    InitiatedBy BIGINT NOT NULL, -- User who started the workflow
    InitiatedFor BIGINT, -- User on whose behalf workflow is running
    InitiationSource NVARCHAR(100), -- Web/API/System/Auto/Manual

    -- Status and progress
    Status NVARCHAR(100) NOT NULL, -- Running/Suspended/Completed/Failed/Cancelled/Terminated
    SubStatus NVARCHAR(100), -- Detailed status information
    ProgressPercentage DECIMAL(5,2) DEFAULT 0.0,
    CurrentStepID BIGINT, -- Current active step

    -- Timing information
    StartedAt DATETIME2 DEFAULT GETDATE(),
    CompletedAt DATETIME2,
    DueDate DATETIME2,
    EstimatedCompletionDate DATETIME2,
    SuspendedAt DATETIME2,
    ResumedAt DATETIME2,

    -- Performance metrics
    ActualDurationMinutes INT,
    SLAStatus NVARCHAR(50), -- Met/AtRisk/Breached/Unknown
    TotalStepsCompleted INT DEFAULT 0,
    TotalStepsRemaining INT,

    -- Data and context
    InstanceData NVARCHAR(MAX), -- JSON instance-specific data
    ContextVariables NVARCHAR(MAX), -- JSON context variables
    InputParameters NVARCHAR(MAX), -- JSON input parameters
    OutputResults NVARCHAR(MAX), -- JSON final results

    -- Assignment and ownership
    CurrentAssignee BIGINT, -- Currently assigned user
    SupervisorID BIGINT, -- Supervising user
    TeamID BIGINT, -- Assigned team
    OrganizationID BIGINT, -- Processing organization

    -- Priority and urgency
    Priority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    UrgencyLevel TINYINT DEFAULT 3, -- 1=Urgent, 2=High, 3=Normal, 4=Low
    BusinessImpact TINYINT DEFAULT 3, -- 1=High, 2=Medium, 3=Low

    -- Error and exception handling
    HasErrors BIT DEFAULT 0,
    ErrorCount INT DEFAULT 0,
    LastErrorMessage NVARCHAR(2000),
    LastErrorOccurred DATETIME2,
    RetryCount INT DEFAULT 0,

    -- Process quality and compliance
    QualityScore DECIMAL(3,1), -- 1.0 to 5.0 quality rating
    ComplianceStatus NVARCHAR(100), -- Compliant/Non-compliant/Under Review
    AuditTrailEnabled BIT DEFAULT 1,

    -- Business metrics
    CustomerSatisfaction DECIMAL(3,1), -- Customer satisfaction rating
    ProcessingCost DECIMAL(10,2), -- Cost of processing this instance
    ValueDelivered DECIMAL(10,2), -- Business value delivered

    -- Communication and notifications
    NotificationsSent INT DEFAULT 0,
    LastNotificationSent DATETIME2,
    CommunicationLog NVARCHAR(MAX), -- JSON communication history

    -- Escalation tracking
    EscalationLevel INT DEFAULT 0,
    EscalatedAt DATETIME2,
    EscalatedTo BIGINT,
    EscalationReason NVARCHAR(1000),

    -- Version and changes
    WorkflowVersion NVARCHAR(20),
    InstanceVersion INT DEFAULT 1,
    MigrationHistory NVARCHAR(MAX), -- JSON migration history

    -- Cancellation and termination
    CancelledBy BIGINT,
    CancelledAt DATETIME2,
    CancellationReason NVARCHAR(1000),
    TerminatedBy BIGINT,
    TerminatedAt DATETIME2,
    TerminationReason NVARCHAR(1000),

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_WORKFLOW_INSTANCE_WORKFLOW FOREIGN KEY (WorkflowID) REFERENCES [workflow].DM_WORKFLOW(WorkflowID),
    CONSTRAINT FK_WORKFLOW_INSTANCE_CURRENT_STEP FOREIGN KEY (CurrentStepID) REFERENCES [workflow].DM_WORKFLOW_STEP(StepID),
    CONSTRAINT CK_WORKFLOW_INSTANCE_Priority CHECK (Priority BETWEEN 1 AND 4),
    CONSTRAINT CK_WORKFLOW_INSTANCE_Progress CHECK (ProgressPercentage BETWEEN 0 AND 100)
);
GO

-- Indexes
CREATE INDEX IX_WORKFLOW_INSTANCE_Workflow ON [workflow].WORKFLOW_INSTANCE(WorkflowID, Status);
CREATE INDEX IX_WORKFLOW_INSTANCE_HoSo ON [workflow].WORKFLOW_INSTANCE(HoSoID, Status);
CREATE INDEX IX_WORKFLOW_INSTANCE_Code ON [workflow].WORKFLOW_INSTANCE(InstanceCode);
CREATE INDEX IX_WORKFLOW_INSTANCE_Elsa ON [workflow].WORKFLOW_INSTANCE(ElsaWorkflowInstanceId);
CREATE INDEX IX_WORKFLOW_INSTANCE_Status ON [workflow].WORKFLOW_INSTANCE(Status, Priority);
CREATE INDEX IX_WORKFLOW_INSTANCE_Assignee ON [workflow].WORKFLOW_INSTANCE(CurrentAssignee, Status);
CREATE INDEX IX_WORKFLOW_INSTANCE_DueDate ON [workflow].WORKFLOW_INSTANCE(DueDate, Status);
CREATE INDEX IX_WORKFLOW_INSTANCE_SLA ON [workflow].WORKFLOW_INSTANCE(SLAStatus, DueDate);
CREATE INDEX IX_WORKFLOW_INSTANCE_Started ON [workflow].WORKFLOW_INSTANCE(StartedAt DESC);
CREATE INDEX IX_WORKFLOW_INSTANCE_Organization ON [workflow].WORKFLOW_INSTANCE(OrganizationID, Status);
GO
```

### 4. WORKFLOW_STEP_INSTANCE - Individual step execution records

```sql
CREATE TABLE [workflow].WORKFLOW_STEP_INSTANCE (
    StepInstanceID BIGINT PRIMARY KEY IDENTITY,
    InstanceID BIGINT NOT NULL,
    StepID BIGINT NOT NULL,

    -- Step instance identification
    StepInstanceCode NVARCHAR(100),
    ExecutionOrder INT NOT NULL,

    -- Elsa integration
    ElsaActivityInstanceId NVARCHAR(255), -- Elsa activity instance ID
    ElsaExecutionId NVARCHAR(255), -- Elsa execution ID

    -- Status and progress
    Status NVARCHAR(100) NOT NULL, -- Pending/Running/Completed/Failed/Skipped/Cancelled
    SubStatus NVARCHAR(100),
    ProgressPercentage DECIMAL(5,2) DEFAULT 0.0,

    -- Assignment and execution
    AssignedTo BIGINT, -- User assigned to this step
    ActualExecutor BIGINT, -- User who actually executed the step
    AssignedAt DATETIME2,
    StartedAt DATETIME2,
    CompletedAt DATETIME2,

    -- Timing and performance
    EstimatedDurationMinutes INT,
    ActualDurationMinutes INT,
    DueDate DATETIME2,
    SLAStatus NVARCHAR(50), -- Met/AtRisk/Breached

    -- Input and output data
    InputData NVARCHAR(MAX), -- JSON input data
    OutputData NVARCHAR(MAX), -- JSON output data
    ProcessingNotes NVARCHAR(2000), -- User notes during processing

    -- Decision and routing
    Decision NVARCHAR(100), -- Approve/Reject/Return/Forward/Cancel
    DecisionReason NVARCHAR(2000),
    NextStepPath NVARCHAR(100), -- Path taken for routing
    ConditionalResults NVARCHAR(MAX), -- JSON conditional evaluation results

    -- Quality and validation
    QualityChecked BIT DEFAULT 0,
    QualityScore DECIMAL(3,1),
    QualityNotes NVARCHAR(1000),
    ValidationStatus NVARCHAR(100), -- Passed/Failed/Warning
    ValidationResults NVARCHAR(MAX), -- JSON validation results

    -- Error handling
    HasErrors BIT DEFAULT 0,
    ErrorMessage NVARCHAR(2000),
    ErrorDetails NVARCHAR(MAX), -- JSON error details
    ErrorOccurredAt DATETIME2,
    RetryAttempt INT DEFAULT 0,

    -- Documents and attachments
    DocumentsProcessed NVARCHAR(MAX), -- JSON array of processed documents
    DocumentsGenerated NVARCHAR(MAX), -- JSON array of generated documents
    AttachmentsAdded NVARCHAR(MAX), -- JSON array of attachments

    -- System integration
    ExternalSystemCalls NVARCHAR(MAX), -- JSON array of external system calls
    APICallResults NVARCHAR(MAX), -- JSON API call results
    IntegrationStatus NVARCHAR(100), -- Success/Failed/Partial

    -- Business metrics
    ProcessingCost DECIMAL(10,2),
    ValueAdded DECIMAL(10,2),
    CustomerImpact NVARCHAR(100), -- Positive/Negative/Neutral

    -- Escalation
    EscalationLevel INT DEFAULT 0,
    EscalatedAt DATETIME2,
    EscalatedTo BIGINT,
    EscalationReason NVARCHAR(1000),

    -- Communications
    NotificationsSent INT DEFAULT 0,
    CommunicationLog NVARCHAR(MAX), -- JSON communication log

    -- Delegation and substitution
    DelegatedFrom BIGINT, -- Original assignee
    DelegatedTo BIGINT, -- Delegate who executed
    DelegationReason NVARCHAR(1000),
    DelegatedAt DATETIME2,

    -- Audit and compliance
    AuditLog NVARCHAR(MAX), -- JSON detailed audit log
    ComplianceChecked BIT DEFAULT 0,
    ComplianceStatus NVARCHAR(100),

    -- Version and changes
    InstanceVersion INT DEFAULT 1,
    DataChanges NVARCHAR(MAX), -- JSON data change log

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_WORKFLOW_STEP_INSTANCE_INSTANCE FOREIGN KEY (InstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID),
    CONSTRAINT FK_WORKFLOW_STEP_INSTANCE_STEP FOREIGN KEY (StepID) REFERENCES [workflow].DM_WORKFLOW_STEP(StepID),
    CONSTRAINT CK_WORKFLOW_STEP_INSTANCE_Progress CHECK (ProgressPercentage BETWEEN 0 AND 100),
    CONSTRAINT UC_WORKFLOW_STEP_INSTANCE UNIQUE (InstanceID, StepID, ExecutionOrder)
);
GO

-- Indexes
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_Instance ON [workflow].WORKFLOW_STEP_INSTANCE(InstanceID, Status);
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_Step ON [workflow].WORKFLOW_STEP_INSTANCE(StepID, Status);
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_Assigned ON [workflow].WORKFLOW_STEP_INSTANCE(AssignedTo, Status);
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_Executor ON [workflow].WORKFLOW_STEP_INSTANCE(ActualExecutor, CompletedAt DESC);
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_Status ON [workflow].WORKFLOW_STEP_INSTANCE(Status, CreatedAt DESC);
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_DueDate ON [workflow].WORKFLOW_STEP_INSTANCE(DueDate, Status);
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_SLA ON [workflow].WORKFLOW_STEP_INSTANCE(SLAStatus, DueDate);
CREATE INDEX IX_WORKFLOW_STEP_INSTANCE_Elsa ON [workflow].WORKFLOW_STEP_INSTANCE(ElsaActivityInstanceId);
GO
```

## SUPPORTING TABLES

### 5. WORKFLOW_ASSIGNMENT_RULES - Dynamic assignment rules

```sql
CREATE TABLE [workflow].WORKFLOW_ASSIGNMENT_RULES (
    RuleID BIGINT PRIMARY KEY IDENTITY,
    WorkflowID BIGINT,
    StepID BIGINT,

    -- Rule identification
    RuleName NVARCHAR(300) NOT NULL,
    RuleDescription NVARCHAR(1000),
    RuleType NVARCHAR(100) NOT NULL, -- Role/Skill/Workload/Random/RoundRobin/Priority

    -- Rule definition
    RuleExpression NVARCHAR(4000) NOT NULL, -- Business rule expression
    Conditions NVARCHAR(MAX), -- JSON conditions
    Priority INT DEFAULT 1,

    -- Assignment criteria
    RequiredRoles NVARCHAR(MAX), -- JSON array of required roles
    RequiredSkills NVARCHAR(MAX), -- JSON array of required skills
    WorkloadThreshold INT, -- Maximum workload
    ExperienceLevel TINYINT, -- 1=Junior, 2=Mid, 3=Senior, 4=Expert

    -- Organizational constraints
    OrganizationScope NVARCHAR(100), -- Same/Parent/Child/Any
    DepartmentScope NVARCHAR(100), -- Same/Parent/Child/Any
    LocationScope NVARCHAR(100), -- Same/Remote/Any

    -- Time-based rules
    WorkingHoursOnly BIT DEFAULT 1,
    TimeZoneConsidered BIT DEFAULT 1,
    WeekendAssignment BIT DEFAULT 0,
    HolidayAssignment BIT DEFAULT 0,

    -- Escalation rules
    EscalationEnabled BIT DEFAULT 1,
    EscalationDelayHours INT DEFAULT 24,
    EscalationTarget NVARCHAR(MAX), -- JSON escalation targets

    -- Status and lifecycle
    IsActive BIT DEFAULT 1,
    EffectiveFrom DATETIME2 DEFAULT GETDATE(),
    EffectiveTo DATETIME2,

    -- Performance tracking
    AssignmentCount INT DEFAULT 0,
    SuccessfulAssignments INT DEFAULT 0,
    FailedAssignments INT DEFAULT 0,
    AverageAssignmentTime INT, -- Minutes

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_WORKFLOW_ASSIGNMENT_WORKFLOW FOREIGN KEY (WorkflowID) REFERENCES [workflow].DM_WORKFLOW(WorkflowID),
    CONSTRAINT FK_WORKFLOW_ASSIGNMENT_STEP FOREIGN KEY (StepID) REFERENCES [workflow].DM_WORKFLOW_STEP(StepID)
);
GO

-- Indexes
CREATE INDEX IX_WORKFLOW_ASSIGNMENT_Workflow ON [workflow].WORKFLOW_ASSIGNMENT_RULES(WorkflowID, IsActive);
CREATE INDEX IX_WORKFLOW_ASSIGNMENT_Step ON [workflow].WORKFLOW_ASSIGNMENT_RULES(StepID, Priority);
CREATE INDEX IX_WORKFLOW_ASSIGNMENT_Type ON [workflow].WORKFLOW_ASSIGNMENT_RULES(RuleType, IsActive);
CREATE INDEX IX_WORKFLOW_ASSIGNMENT_Effective ON [workflow].WORKFLOW_ASSIGNMENT_RULES(EffectiveFrom, EffectiveTo);
GO
```

### 6. WORKFLOW_ESCALATION_LOG - Escalation tracking

```sql
CREATE TABLE [workflow].WORKFLOW_ESCALATION_LOG (
    EscalationID BIGINT PRIMARY KEY IDENTITY,
    InstanceID BIGINT,
    StepInstanceID BIGINT,

    -- Escalation details
    EscalationType NVARCHAR(100) NOT NULL, -- Time/Quality/Manual/System/Exception
    EscalationReason NVARCHAR(2000) NOT NULL,
    EscalationLevel INT NOT NULL, -- 1=First level, 2=Second level, etc.

    -- Escalation participants
    EscalatedFrom BIGINT NOT NULL, -- User or system that escalated
    EscalatedTo BIGINT NOT NULL, -- User or role escalated to
    EscalatedBy BIGINT, -- User who initiated escalation (if different)

    -- Timing
    EscalatedAt DATETIME2 DEFAULT GETDATE(),
    ResolvedAt DATETIME2,
    DurationMinutes INT,

    -- Resolution
    Resolution NVARCHAR(2000),
    ResolutionType NVARCHAR(100), -- Resolved/Reassigned/Escalated Further/Cancelled
    ResolvedBy BIGINT,

    -- Impact and metrics
    ImpactLevel TINYINT, -- 1=Low, 2=Medium, 3=High, 4=Critical
    BusinessImpact NVARCHAR(1000),
    CostImpact DECIMAL(10,2),
    CustomerImpact NVARCHAR(100), -- Low/Medium/High

    -- Communication
    NotificationsSent INT DEFAULT 0,
    CommunicationLog NVARCHAR(MAX), -- JSON communication history

    -- Follow-up actions
    FollowUpRequired BIT DEFAULT 0,
    FollowUpActions NVARCHAR(MAX), -- JSON follow-up actions
    PreventiveActions NVARCHAR(MAX), -- JSON preventive measures

    -- Status
    Status NVARCHAR(100) DEFAULT 'Open', -- Open/InProgress/Resolved/Closed

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_WORKFLOW_ESCALATION_INSTANCE FOREIGN KEY (InstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID),
    CONSTRAINT FK_WORKFLOW_ESCALATION_STEP_INSTANCE FOREIGN KEY (StepInstanceID) REFERENCES [workflow].WORKFLOW_STEP_INSTANCE(StepInstanceID)
);
GO

-- Indexes
CREATE INDEX IX_WORKFLOW_ESCALATION_Instance ON [workflow].WORKFLOW_ESCALATION_LOG(InstanceID, EscalatedAt DESC);
CREATE INDEX IX_WORKFLOW_ESCALATION_Step ON [workflow].WORKFLOW_ESCALATION_LOG(StepInstanceID, Status);
CREATE INDEX IX_WORKFLOW_ESCALATION_Type ON [workflow].WORKFLOW_ESCALATION_LOG(EscalationType, EscalationLevel);
CREATE INDEX IX_WORKFLOW_ESCALATION_Participants ON [workflow].WORKFLOW_ESCALATION_LOG(EscalatedTo, Status);
CREATE INDEX IX_WORKFLOW_ESCALATION_Status ON [workflow].WORKFLOW_ESCALATION_LOG(Status, EscalatedAt DESC);
GO
```

### 7. WORKFLOW_PERFORMANCE_METRICS - Performance tracking

```sql
CREATE TABLE [workflow].WORKFLOW_PERFORMANCE_METRICS (
    MetricID BIGINT PRIMARY KEY IDENTITY,

    -- Scope definition
    WorkflowID BIGINT,
    StepID BIGINT,
    OrganizationID BIGINT,
    PeriodType NVARCHAR(50) NOT NULL, -- Daily/Weekly/Monthly/Quarterly/Yearly
    PeriodStart DATE NOT NULL,
    PeriodEnd DATE NOT NULL,

    -- Volume metrics
    TotalInstances INT DEFAULT 0,
    CompletedInstances INT DEFAULT 0,
    FailedInstances INT DEFAULT 0,
    CancelledInstances INT DEFAULT 0,
    InProgressInstances INT DEFAULT 0,

    -- Performance metrics
    AverageDurationHours DECIMAL(8,2),
    MedianDurationHours DECIMAL(8,2),
    MinDurationHours DECIMAL(8,2),
    MaxDurationHours DECIMAL(8,2),
    StandardDeviationHours DECIMAL(8,2),

    -- Quality metrics
    QualityScore DECIMAL(3,1), -- Average quality score
    FirstTimeRightRate DECIMAL(5,2), -- Percentage processed correctly first time
    ReworkRate DECIMAL(5,2), -- Percentage requiring rework
    DefectRate DECIMAL(5,2), -- Percentage with defects

    -- SLA metrics
    SLAComplianceRate DECIMAL(5,2), -- Percentage meeting SLA
    AverageSLABreachHours DECIMAL(8,2),
    OnTimeDeliveryRate DECIMAL(5,2),

    -- Resource utilization
    TotalResourceHours DECIMAL(10,2),
    AverageResourcesUsed DECIMAL(5,2),
    PeakResourceUtilization DECIMAL(5,2),
    ResourceEfficiency DECIMAL(5,2), -- Percentage of productive time

    -- Cost metrics
    TotalProcessingCost DECIMAL(12,2),
    AverageCostPerInstance DECIMAL(10,2),
    CostEfficiency DECIMAL(5,2), -- Cost vs benchmark

    -- Customer satisfaction
    CustomerSatisfactionScore DECIMAL(3,1),
    ComplaintRate DECIMAL(5,2),
    ReprocessingRate DECIMAL(5,2),

    -- Automation metrics
    AutomationRate DECIMAL(5,2), -- Percentage of automated processing
    StraightThroughProcessingRate DECIMAL(5,2),
    ManualInterventionRate DECIMAL(5,2),

    -- Error and exception metrics
    ErrorRate DECIMAL(5,2),
    ExceptionRate DECIMAL(5,2),
    EscalationRate DECIMAL(5,2),
    RetryRate DECIMAL(5,2),

    -- Trend indicators
    VolumeGrowthRate DECIMAL(5,2), -- Compared to previous period
    PerformanceImprovement DECIMAL(5,2),
    QualityTrend NVARCHAR(50), -- Improving/Stable/Declining

    -- Benchmarking
    IndustryBenchmark DECIMAL(5,2),
    InternalBenchmark DECIMAL(5,2),
    BestPracticeGap DECIMAL(5,2),

    -- Status and calculation
    CalculatedAt DATETIME2 DEFAULT GETDATE(),
    CalculatedBy BIGINT,
    IsValidated BIT DEFAULT 0,
    ValidatedBy BIGINT,
    ValidatedAt DATETIME2,

    -- Constraints
    CONSTRAINT FK_WORKFLOW_METRICS_WORKFLOW FOREIGN KEY (WorkflowID) REFERENCES [workflow].DM_WORKFLOW(WorkflowID),
    CONSTRAINT FK_WORKFLOW_METRICS_STEP FOREIGN KEY (StepID) REFERENCES [workflow].DM_WORKFLOW_STEP(StepID),
    CONSTRAINT UC_WORKFLOW_METRICS UNIQUE (WorkflowID, StepID, OrganizationID, PeriodType, PeriodStart)
);
GO

-- Indexes
CREATE INDEX IX_WORKFLOW_METRICS_Workflow ON [workflow].WORKFLOW_PERFORMANCE_METRICS(WorkflowID, PeriodStart DESC);
CREATE INDEX IX_WORKFLOW_METRICS_Step ON [workflow].WORKFLOW_PERFORMANCE_METRICS(StepID, PeriodStart DESC);
CREATE INDEX IX_WORKFLOW_METRICS_Organization ON [workflow].WORKFLOW_PERFORMANCE_METRICS(OrganizationID, PeriodType);
CREATE INDEX IX_WORKFLOW_METRICS_Period ON [workflow].WORKFLOW_PERFORMANCE_METRICS(PeriodType, PeriodStart DESC);
GO
```

## CROSS-SCHEMA INTEGRATION VIEWS

```sql
-- View for Case service to access workflow information
CREATE VIEW [case].v_WorkflowInfo
AS
SELECT
    w.WorkflowID,
    w.WorkflowCode,
    w.WorkflowName,
    w.TTHCID,
    w.EstimatedDuration,
    w.SLATargetHours,
    w.AutomationLevel,
    w.DeploymentStatus,
    w.IsActive
FROM [workflow].DM_WORKFLOW w
WHERE w.IsActive = 1 AND w.DeploymentStatus = 'Deployed';
GO

-- View for Task assignment service
CREATE VIEW [case].v_WorkflowTasks
AS
SELECT
    wi.InstanceID,
    wi.InstanceCode,
    wi.Status as InstanceStatus,
    wi.CurrentAssignee,
    wi.Priority,
    si.StepInstanceID,
    si.StepID,
    s.StepName,
    s.StepType,
    si.Status as StepStatus,
    si.AssignedTo,
    si.DueDate,
    si.EstimatedDurationMinutes
FROM [workflow].WORKFLOW_INSTANCE wi
INNER JOIN [workflow].WORKFLOW_STEP_INSTANCE si ON wi.InstanceID = si.InstanceID
INNER JOIN [workflow].DM_WORKFLOW_STEP s ON si.StepID = s.StepID
WHERE wi.Status IN ('Running', 'Suspended')
AND si.Status IN ('Pending', 'Running');
GO

-- View for Notification service
CREATE VIEW [notification].v_WorkflowNotifications
AS
SELECT
    wi.InstanceID,
    wi.InstanceCode,
    wi.HoSoID,
    wi.InitiatedBy,
    wi.CurrentAssignee,
    wi.Status,
    wi.Priority,
    wi.DueDate,
    si.StepInstanceID,
    s.StepName,
    si.AssignedTo,
    si.Status as StepStatus,
    w.WorkflowName
FROM [workflow].WORKFLOW_INSTANCE wi
INNER JOIN [workflow].DM_WORKFLOW w ON wi.WorkflowID = w.WorkflowID
LEFT JOIN [workflow].WORKFLOW_STEP_INSTANCE si ON wi.InstanceID = si.InstanceID AND si.Status = 'Running'
LEFT JOIN [workflow].DM_WORKFLOW_STEP s ON si.StepID = s.StepID
WHERE wi.Status IN ('Running', 'Suspended', 'AtRisk');
GO
```

## KEY FEATURES

### BPMN 2.0 Compliance
- **Standard BPMN Elements**: Support for tasks, gateways, events, and subprocesses
- **XML Storage**: Native BPMN 2.0 XML storage with version control
- **Visual Workflow Designer**: JSON-based workflow graph for UI rendering
- **Process Validation**: Comprehensive validation of workflow definitions

### Elsa 3.0 Integration
- **Native Elsa Support**: Direct integration with Elsa workflow engine
- **Activity Mapping**: One-to-one mapping between database steps and Elsa activities
- **Instance Correlation**: Bidirectional linking between database and Elsa instances
- **Event-Driven Architecture**: Seamless integration with Elsa's event system

### Advanced Assignment Engine
- **Dynamic Assignment Rules**: Flexible rule-based task assignment
- **Skill-Based Routing**: Assignment based on required skills and experience
- **Workload Balancing**: Automatic workload distribution
- **Escalation Management**: Comprehensive escalation with multiple levels

### Performance Management
- **Real-Time Monitoring**: Live performance metrics and SLA tracking
- **Historical Analytics**: Comprehensive performance history and trends
- **Benchmarking**: Industry and internal benchmarks comparison
- **Optimization Recommendations**: AI-driven performance optimization

### Quality Assurance
- **Quality Checkpoints**: Configurable quality control points
- **Validation Framework**: Comprehensive validation rules engine
- **Error Handling**: Sophisticated error detection and recovery
- **Compliance Tracking**: Regulatory compliance monitoring

## BUSINESS RULES

### Workflow Definition Rules
- Workflows must have at least one start and one end step
- BPMN validation must pass before deployment
- Version control maintains backward compatibility
- Legal framework compliance is mandatory

### Instance Management Rules
- Only one instance per case for primary workflows
- SLA calculations based on business hours
- Automatic escalation after defined thresholds
- Audit trail must be maintained for all changes

### Assignment Rules
- Users can only be assigned tasks they have permissions for
- Workload thresholds cannot be exceeded
- Emergency assignments can bypass normal rules
- Delegation must be documented and approved

### Performance Rules
- SLA compliance must meet minimum thresholds
- Quality scores must be above acceptable levels
- Performance metrics updated in real-time
- Escalation required for repeated SLA breaches

## PERFORMANCE CONSIDERATIONS

### Indexing Strategy
- Composite indexes for common query patterns
- Specialized indexes for Elsa integration
- Time-based indexes for SLA monitoring
- Performance metric indexes for analytics

### Caching Strategy
- Workflow definitions cached with version tracking
- Assignment rules cached with dependency tracking
- Performance metrics cached with smart invalidation
- Step configurations cached per workflow

### Scalability Design
- Horizontal scaling support for high-volume processing
- Partition tables by date for historical data
- Archive completed instances to separate storage
- Load balancing for assignment engine

## INTEGRATION PATTERNS

### Event-Driven Architecture
```sql
-- Events published by Workflow service:
-- WorkflowStarted
-- WorkflowCompleted
-- WorkflowFailed
-- StepAssigned
-- StepCompleted
-- SLABreached
-- EscalationTriggered
-- QualityCheckFailed
```

### Elsa Integration Events
- ElsaWorkflowStarted → Update WORKFLOW_INSTANCE
- ElsaActivityCompleted → Update WORKFLOW_STEP_INSTANCE
- ElsaWorkflowSuspended → Update instance status
- ElsaWorkflowResumed → Update timing information

### Cross-Service Communication
- Case service creates workflow instances
- Identity service provides user assignments
- Notification service handles workflow communications
- Audit service logs all workflow activities

## MIGRATION CONSIDERATIONS

### From Legacy Workflow Systems
- Workflow definition migration and validation
- Historical instance data preservation
- Performance metrics historical data import
- User assignment and delegation migration

### To Microservices Architecture
- Workflow service extraction with Elsa engine
- Event-driven synchronization with other services
- API design for workflow orchestration
- Eventual consistency for distributed workflow data

### Elsa Version Upgrades
- Backward compatibility maintenance
- Gradual workflow migration strategies
- Version-specific feature flagging
- Rollback procedures for failed upgrades