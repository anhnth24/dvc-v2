# [document] Schema - Document Management

## OVERVIEW

The `[document]` schema manages comprehensive document lifecycle including file storage, versioning, digital signatures, OCR processing, and document workflows for the DVC v2 system. It integrates with MinIO object storage, digital signature systems, and provides advanced document processing capabilities.

## SCHEMA CREATION

```sql
-- Document Management
CREATE SCHEMA [document];
GO
```

## CORE DOCUMENT TABLES

### 1. FILE_STORAGE - Central file storage and metadata

```sql
CREATE TABLE [document].FILE_STORAGE (
    FileID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT, -- Associated case (nullable for standalone files)

    -- File identification
    FileName NVARCHAR(500) NOT NULL,
    OriginalFileName NVARCHAR(500) NOT NULL,
    FileCode NVARCHAR(100) UNIQUE NOT NULL, -- System-generated unique code
    FileTitle NVARCHAR(1000), -- Display title

    -- File classification
    FileCategory NVARCHAR(100) NOT NULL, -- Input/Process/Output/Archive/Template
    FileType NVARCHAR(100) NOT NULL, -- Document/Image/Video/Audio/Archive
    DocumentType NVARCHAR(200), -- Certificate/License/Report/Form/Other
    MimeType NVARCHAR(200) NOT NULL,
    FileExtension NVARCHAR(50) NOT NULL,

    -- Storage information
    StorageProvider NVARCHAR(100) DEFAULT 'MinIO', -- MinIO/Azure/AWS/Local
    StorageContainer NVARCHAR(200) NOT NULL, -- Container/Bucket name
    StoragePath NVARCHAR(1000) NOT NULL, -- Full storage path
    StorageURL NVARCHAR(2000), -- Accessible URL
    CDNUrl NVARCHAR(2000), -- CDN URL for faster access

    -- File properties
    FileSizeBytes BIGINT NOT NULL,
    FileHash NVARCHAR(128) NOT NULL, -- SHA-256 hash for integrity
    Checksum NVARCHAR(64), -- MD5 checksum
    PageCount INT DEFAULT 1, -- Number of pages (for documents)
    Duration INT, -- Duration in seconds (for media files)

    -- Content analysis
    Language NVARCHAR(20) DEFAULT 'vi', -- Detected language
    Encoding NVARCHAR(50), -- File encoding
    ContentType NVARCHAR(100), -- Structured/Unstructured/Mixed
    HasText BIT DEFAULT 0, -- Contains extractable text
    HasImages BIT DEFAULT 0, -- Contains images
    HasSignatures BIT DEFAULT 0, -- Contains digital signatures

    -- OCR and text extraction
    OCRProcessed BIT DEFAULT 0, -- OCR processing completed
    OCREngine NVARCHAR(100), -- OCR engine used
    OCRConfidence DECIMAL(5,2), -- OCR confidence score
    ExtractedText NVARCHAR(MAX), -- Extracted text content
    OCRResult NVARCHAR(MAX), -- JSON OCR detailed results

    -- Digital signature information
    IsSigned BIT DEFAULT 0, -- File is digitally signed
    SignatureCount INT DEFAULT 0, -- Number of signatures
    SignatureValid BIT, -- All signatures valid
    SignatureDetails NVARCHAR(MAX), -- JSON signature details
    CertificateInfo NVARCHAR(MAX), -- JSON certificate information

    -- Version management
    VersionNumber NVARCHAR(20) DEFAULT '1.0',
    ParentFileID BIGINT, -- Parent file for versions
    IsLatestVersion BIT DEFAULT 1, -- Is this the latest version
    VersionHistory NVARCHAR(MAX), -- JSON version history
    MergedFromFiles NVARCHAR(MAX), -- JSON files merged to create this

    -- Access control and security
    SecurityLevel TINYINT DEFAULT 2, -- 1=Public, 2=Internal, 3=Confidential, 4=Secret
    AccessPermissions NVARCHAR(MAX), -- JSON access permissions
    EncryptionStatus NVARCHAR(100), -- None/Transit/AtRest/Both
    EncryptionKey NVARCHAR(500), -- Encryption key reference
    RequireAuthentication BIT DEFAULT 1,

    -- Processing status
    ProcessingStatus NVARCHAR(100) DEFAULT 'Pending', -- Pending/Processing/Completed/Failed
    ProcessingStage NVARCHAR(200), -- Current processing stage
    ProcessingErrors NVARCHAR(MAX), -- JSON processing errors
    ProcessingLog NVARCHAR(MAX), -- JSON processing log

    -- Quality and validation
    QualityScore DECIMAL(3,1), -- Document quality score
    ValidationStatus NVARCHAR(100), -- Valid/Invalid/Warning/Unknown
    ValidationResults NVARCHAR(MAX), -- JSON validation results
    ComplianceChecked BIT DEFAULT 0, -- Compliance check performed
    ComplianceStatus NVARCHAR(100), -- Compliant/Non-compliant/Pending

    -- Virus scanning and security
    VirusScanStatus NVARCHAR(100) DEFAULT 'Pending', -- Pending/Scanning/Clean/Infected/Error
    VirusScanEngine NVARCHAR(100), -- Antivirus engine used
    VirusScanDate DATETIME2, -- Last scan date
    QuarantineStatus NVARCHAR(100), -- None/Quarantined/Released/Deleted
    ThreatDetails NVARCHAR(MAX), -- JSON threat details

    -- Indexing and search
    SearchableContent NVARCHAR(MAX), -- Preprocessed searchable content
    KeywordTags NVARCHAR(MAX), -- JSON keyword tags
    Categories NVARCHAR(MAX), -- JSON category classifications
    MetadataTags NVARCHAR(MAX), -- JSON metadata tags
    FullTextIndexed BIT DEFAULT 0, -- Indexed for full-text search

    -- Usage and analytics
    DownloadCount INT DEFAULT 0, -- Number of downloads
    ViewCount INT DEFAULT 0, -- Number of views
    LastAccessed DATETIME2, -- Last access timestamp
    PopularityScore DECIMAL(5,2) DEFAULT 0, -- Popularity score
    UsageMetrics NVARCHAR(MAX), -- JSON detailed usage metrics

    -- Retention and lifecycle
    RetentionPeriodYears INT, -- Retention period in years
    ExpiryDate DATETIME2, -- Document expiry date
    ArchivalDate DATETIME2, -- When to archive
    DisposalDate DATETIME2, -- When can be disposed
    RetentionPolicyID INT, -- Retention policy reference

    -- External integration
    ExternalSystemRef NVARCHAR(500), -- External system reference
    SourceSystem NVARCHAR(200), -- Originating system
    SyncStatus NVARCHAR(100), -- Sync status with external systems
    ExternalMetadata NVARCHAR(MAX), -- JSON external system metadata

    -- Workflow integration
    WorkflowStage NVARCHAR(200), -- Current workflow stage
    ApprovalStatus NVARCHAR(100), -- Pending/Approved/Rejected
    ReviewComments NVARCHAR(MAX), -- JSON review comments
    WorkflowHistory NVARCHAR(MAX), -- JSON workflow history

    -- AI and ML integration
    AIProcessed BIT DEFAULT 0, -- AI processing applied
    AIClassification NVARCHAR(MAX), -- JSON AI classification results
    ContentAnalysis NVARCHAR(MAX), -- JSON AI content analysis
    SentimentScore DECIMAL(3,1), -- Sentiment analysis score
    EntityExtraction NVARCHAR(MAX), -- JSON extracted entities

    -- Status and flags
    IsActive BIT DEFAULT 1, -- File is active
    IsDeleted BIT DEFAULT 0, -- Soft delete flag
    IsLocked BIT DEFAULT 0, -- File is locked for editing
    IsTemplate BIT DEFAULT 0, -- File is a template
    IsDraft BIT DEFAULT 0, -- File is in draft status

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,
    DeletedAt DATETIME2,
    DeletedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_FILE_STORAGE_PARENT FOREIGN KEY (ParentFileID) REFERENCES [document].FILE_STORAGE(FileID),
    CONSTRAINT CK_FILE_STORAGE_FileSizeBytes CHECK (FileSizeBytes > 0),
    CONSTRAINT CK_FILE_STORAGE_SecurityLevel CHECK (SecurityLevel BETWEEN 1 AND 4),
    CONSTRAINT CK_FILE_STORAGE_QualityScore CHECK (QualityScore BETWEEN 1.0 AND 5.0)
);
GO

-- Indexes
CREATE INDEX IX_FILE_STORAGE_HoSo ON [document].FILE_STORAGE(HoSoID, FileCategory);
CREATE INDEX IX_FILE_STORAGE_Code ON [document].FILE_STORAGE(FileCode);
CREATE INDEX IX_FILE_STORAGE_FileName ON [document].FILE_STORAGE(FileName);
CREATE INDEX IX_FILE_STORAGE_Hash ON [document].FILE_STORAGE(FileHash);
CREATE INDEX IX_FILE_STORAGE_Category ON [document].FILE_STORAGE(FileCategory, DocumentType);
CREATE INDEX IX_FILE_STORAGE_Storage ON [document].FILE_STORAGE(StorageProvider, StorageContainer);
CREATE INDEX IX_FILE_STORAGE_Status ON [document].FILE_STORAGE(ProcessingStatus, IsActive);
CREATE INDEX IX_FILE_STORAGE_Security ON [document].FILE_STORAGE(SecurityLevel, IsActive);
CREATE INDEX IX_FILE_STORAGE_Version ON [document].FILE_STORAGE(ParentFileID, VersionNumber);
CREATE INDEX IX_FILE_STORAGE_Created ON [document].FILE_STORAGE(CreatedAt DESC);
CREATE INDEX IX_FILE_STORAGE_Virus ON [document].FILE_STORAGE(VirusScanStatus, VirusScanDate DESC);
CREATE INDEX IX_FILE_STORAGE_OCR ON [document].FILE_STORAGE(OCRProcessed, Language);
CREATE INDEX IX_FILE_STORAGE_Signature ON [document].FILE_STORAGE(IsSigned, SignatureValid);

-- Full-text index for searchable content
CREATE FULLTEXT INDEX ON [document].FILE_STORAGE(SearchableContent, ExtractedText)
KEY INDEX PK__FILE_STO__2C8F3C3F WITH CHANGE_TRACKING AUTO;
GO
```

### 2. FILEKEMTHEOHOSO - Case-associated files and documents

```sql
CREATE TABLE [document].FILEKEMTHEOHOSO (
    FileKemTheoID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,
    FileID BIGINT NOT NULL,

    -- Document requirement fulfillment
    RequiredDocumentID BIGINT, -- Reference to required document from TTHC
    RequirementType NVARCHAR(100), -- Mandatory/Optional/Conditional
    FulfillmentStatus NVARCHAR(100), -- Fulfilled/Partial/Missing/Rejected

    -- Submission details
    SubmissionMethod NVARCHAR(100), -- Online/Office/Mail/Mobile/API
    SubmittedBy BIGINT NOT NULL, -- User who submitted
    SubmissionDate DATETIME2 DEFAULT GETDATE(),
    SubmissionLocation NVARCHAR(500), -- Where submitted

    -- Document role and purpose
    DocumentRole NVARCHAR(100), -- Evidence/Support/Identity/Proof/Reference
    DocumentPurpose NVARCHAR(500), -- Specific purpose description
    DocumentScope NVARCHAR(200), -- Full/Partial/Summary/Extract

    -- Original document information
    OriginalDocumentType NVARCHAR(200), -- Type of original document
    IsOriginal BIT DEFAULT 0, -- Is original document
    IsCertifiedCopy BIT DEFAULT 0, -- Is certified copy
    IsNotarized BIT DEFAULT 0, -- Is notarized
    AuthenticationLevel NVARCHAR(100), -- None/Copy/Certified/Notarized/Legalized

    -- Document source and authenticity
    IssuingAuthority NVARCHAR(500), -- Document issuing authority
    IssueDate DATE, -- Document issue date
    ExpiryDate DATE, -- Document expiry date
    DocumentNumber NVARCHAR(200), -- Official document number
    VerificationCode NVARCHAR(200), -- Verification code if available

    -- Validation and verification
    ValidationRequired BIT DEFAULT 1, -- Requires validation
    ValidationStatus NVARCHAR(100), -- Pending/Valid/Invalid/Expired/Suspicious
    ValidatedBy BIGINT, -- User who validated
    ValidationDate DATETIME2, -- Validation date
    ValidationNotes NVARCHAR(2000), -- Validation notes

    -- Quality assessment
    DocumentQuality NVARCHAR(100), -- Excellent/Good/Acceptable/Poor
    Legibility NVARCHAR(100), -- Clear/Readable/Unclear/Illegible
    Completeness NVARCHAR(100), -- Complete/Partial/Incomplete
    QualityIssues NVARCHAR(MAX), -- JSON quality issues

    -- Processing workflow
    ProcessingStage NVARCHAR(200), -- Current processing stage
    ProcessingPriority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    ProcessingNotes NVARCHAR(4000), -- Processing notes
    ProcessingHistory NVARCHAR(MAX), -- JSON processing history

    -- Review and approval
    ReviewRequired BIT DEFAULT 1, -- Requires review
    ReviewStatus NVARCHAR(100), -- Pending/Reviewed/Approved/Rejected
    ReviewedBy BIGINT, -- User who reviewed
    ReviewDate DATETIME2, -- Review date
    ReviewComments NVARCHAR(4000), -- Review comments

    -- Rejection and resubmission
    RejectionCount INT DEFAULT 0, -- Number of rejections
    RejectionReasons NVARCHAR(MAX), -- JSON rejection reasons
    ResubmissionRequired BIT DEFAULT 0, -- Requires resubmission
    ResubmissionGuidance NVARCHAR(4000), -- Guidance for resubmission

    -- Data extraction and processing
    ExtractedData NVARCHAR(MAX), -- JSON extracted data
    DataExtractionMethod NVARCHAR(100), -- Manual/OCR/AI/API
    ExtractionAccuracy DECIMAL(5,2), -- Extraction accuracy percentage
    ManualVerificationRequired BIT DEFAULT 0, -- Requires manual verification

    -- Integration and synchronization
    SyncedToExternalSystems NVARCHAR(MAX), -- JSON external system sync status
    ExternalValidationResults NVARCHAR(MAX), -- JSON external validation results
    APIIntegrationLog NVARCHAR(MAX), -- JSON API integration log

    -- Compliance and legal
    LegalRequirement BIT DEFAULT 0, -- Legal requirement
    ComplianceStatus NVARCHAR(100), -- Compliant/Non-compliant/Under Review
    RegulatoryReference NVARCHAR(500), -- Regulatory reference
    LegalValidityPeriod INT, -- Legal validity in days

    -- Display and organization
    DisplayOrder INT DEFAULT 1, -- Display order in case
    GroupCategory NVARCHAR(200), -- Grouping category
    IsPublicDocument BIT DEFAULT 0, -- Available to public
    IsSensitiveDocument BIT DEFAULT 0, -- Contains sensitive information

    -- Performance metrics
    ProcessingTime INT, -- Processing time in minutes
    ValidationTime INT, -- Validation time in minutes
    UserSatisfactionScore DECIMAL(3,1), -- User satisfaction
    ProcessingEfficiency DECIMAL(5,2), -- Processing efficiency

    -- Status and lifecycle
    Status NVARCHAR(100) DEFAULT 'Active', -- Active/Replaced/Archived/Deleted
    ReplacedBy BIGINT, -- File that replaced this one
    ArchivalReason NVARCHAR(1000), -- Reason for archival
    RetentionEndDate DATETIME2, -- When retention ends

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,
    DeletedAt DATETIME2,
    DeletedBy BIGINT,

    CONSTRAINT FK_FILEKEMTHEOHOSO_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_FILEKEMTHEOHOSO_FILE FOREIGN KEY (FileID) REFERENCES [document].FILE_STORAGE(FileID),
    CONSTRAINT FK_FILEKEMTHEOHOSO_REPLACED_BY FOREIGN KEY (ReplacedBy) REFERENCES [document].FILEKEMTHEOHOSO(FileKemTheoID),
    CONSTRAINT CK_FILEKEMTHEOHOSO_ProcessingPriority CHECK (ProcessingPriority BETWEEN 1 AND 4),
    CONSTRAINT UC_FILEKEMTHEOHOSO_UNIQUE UNIQUE (HoSoID, FileID)
);
GO

-- Indexes
CREATE INDEX IX_FILEKEMTHEOHOSO_HoSo ON [document].FILEKEMTHEOHOSO(HoSoID, Status);
CREATE INDEX IX_FILEKEMTHEOHOSO_File ON [document].FILEKEMTHEOHOSO(FileID, Status);
CREATE INDEX IX_FILEKEMTHEOHOSO_Required ON [document].FILEKEMTHEOHOSO(RequiredDocumentID, FulfillmentStatus);
CREATE INDEX IX_FILEKEMTHEOHOSO_Submission ON [document].FILEKEMTHEOHOSO(SubmissionDate DESC, SubmissionMethod);
CREATE INDEX IX_FILEKEMTHEOHOSO_Validation ON [document].FILEKEMTHEOHOSO(ValidationStatus, ValidationRequired);
CREATE INDEX IX_FILEKEMTHEOHOSO_Review ON [document].FILEKEMTHEOHOSO(ReviewStatus, ReviewRequired);
CREATE INDEX IX_FILEKEMTHEOHOSO_Processing ON [document].FILEKEMTHEOHOSO(ProcessingStage, ProcessingPriority);
GO
```

### 3. FILEXULYHOSO - Processing workflow files

```sql
CREATE TABLE [document].FILEXULYHOSO (
    FileXuLyID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,
    FileID BIGINT NOT NULL,
    QuaTrinhXuLyID BIGINT, -- Associated processing step

    -- Processing context
    ProcessingStage NVARCHAR(200) NOT NULL, -- Processing stage where file was created/used
    WorkflowStepID BIGINT, -- Associated workflow step
    ProcessingType NVARCHAR(100), -- Analysis/Review/Approval/Transformation/Communication

    -- File generation information
    GenerationType NVARCHAR(100), -- Manual/Automated/Template/Merged/Extracted
    SourceFiles NVARCHAR(MAX), -- JSON array of source file IDs
    GenerationTemplate NVARCHAR(500), -- Template used for generation
    GenerationParameters NVARCHAR(MAX), -- JSON generation parameters

    -- Processing details
    ProcessedBy BIGINT NOT NULL, -- User who processed
    ProcessingDate DATETIME2 DEFAULT GETDATE(),
    ProcessingDuration INT, -- Processing time in minutes
    ProcessingMethod NVARCHAR(200), -- Method used for processing

    -- Content and transformations
    OriginalContent NVARCHAR(MAX), -- Original content (if applicable)
    ProcessedContent NVARCHAR(MAX), -- Processed content
    ContentChanges NVARCHAR(MAX), -- JSON content changes made
    TransformationLog NVARCHAR(MAX), -- JSON transformation log

    -- Tool and system information
    ProcessingTool NVARCHAR(200), -- Tool used for processing
    SystemVersion NVARCHAR(100), -- System version used
    PluginsUsed NVARCHAR(MAX), -- JSON plugins/extensions used
    ConfigurationUsed NVARCHAR(MAX), -- JSON configuration used

    -- Quality and validation
    QualityCheckPerformed BIT DEFAULT 0, -- Quality check performed
    QualityScore DECIMAL(3,1), -- Quality score
    ValidationResults NVARCHAR(MAX), -- JSON validation results
    ErrorsDetected NVARCHAR(MAX), -- JSON errors detected
    CorrectiveActions NVARCHAR(MAX), -- JSON corrective actions taken

    -- Approval workflow
    RequiresApproval BIT DEFAULT 0, -- Requires approval
    ApprovalStatus NVARCHAR(100), -- Pending/Approved/Rejected/Escalated
    ApprovedBy BIGINT, -- User who approved
    ApprovalDate DATETIME2, -- Approval date
    ApprovalComments NVARCHAR(2000), -- Approval comments

    -- Review and feedback
    ReviewCycle INT DEFAULT 1, -- Review cycle number
    ReviewerAssigned BIGINT, -- Assigned reviewer
    ReviewStatus NVARCHAR(100), -- Not Started/In Progress/Completed/Skipped
    ReviewComments NVARCHAR(4000), -- Review comments
    ReviewScore DECIMAL(3,1), -- Review score

    -- Version and change management
    VersionCreated NVARCHAR(20), -- Version created
    ChangeReason NVARCHAR(2000), -- Reason for creating this version
    ChangeType NVARCHAR(100), -- Minor/Major/Critical/Rollback
    ImpactAssessment NVARCHAR(2000), -- Impact of changes

    -- Integration and synchronization
    SyncRequired BIT DEFAULT 0, -- Requires synchronization
    SyncStatus NVARCHAR(100), -- Pending/Synced/Failed/Partial
    SyncTargets NVARCHAR(MAX), -- JSON sync targets
    SyncLog NVARCHAR(MAX), -- JSON synchronization log

    -- Performance metrics
    ProcessingEfficiency DECIMAL(5,2), -- Processing efficiency
    TimeToComplete INT, -- Time to complete processing
    ResourceUtilization DECIMAL(5,2), -- Resource utilization
    CostOfProcessing DECIMAL(10,2), -- Cost of processing

    -- Communication and notifications
    NotificationsSent NVARCHAR(MAX), -- JSON notifications sent
    CommunicationLog NVARCHAR(MAX), -- JSON communication log
    StakeholdersNotified NVARCHAR(MAX), -- JSON stakeholders notified

    -- Error handling and recovery
    ErrorsEncountered NVARCHAR(MAX), -- JSON errors encountered
    RecoveryActions NVARCHAR(MAX), -- JSON recovery actions
    FallbackProcedures NVARCHAR(MAX), -- JSON fallback procedures used
    ManualInterventionRequired BIT DEFAULT 0, -- Required manual intervention

    -- Business impact
    BusinessValue DECIMAL(10,2), -- Business value generated
    CustomerImpact NVARCHAR(100), -- Customer impact level
    OperationalImpact NVARCHAR(100), -- Operational impact level
    StrategicRelevance NVARCHAR(100), -- Strategic relevance level

    -- Compliance and audit
    ComplianceChecked BIT DEFAULT 0, -- Compliance checked
    ComplianceStatus NVARCHAR(100), -- Compliant/Non-compliant/Pending
    AuditTrailGenerated BIT DEFAULT 1, -- Audit trail generated
    RegulatoryRequirements NVARCHAR(MAX), -- JSON regulatory requirements

    -- Status and lifecycle
    Status NVARCHAR(100) DEFAULT 'Active', -- Active/Archived/Superseded/Deleted
    LifecycleStage NVARCHAR(100), -- Creation/Processing/Review/Approval/Archive
    ExpiryDate DATETIME2, -- When this version expires
    ArchivalCriteria NVARCHAR(1000), -- Criteria for archival

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,
    DeletedAt DATETIME2,
    DeletedBy BIGINT,

    CONSTRAINT FK_FILEXULYHOSO_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_FILEXULYHOSO_FILE FOREIGN KEY (FileID) REFERENCES [document].FILE_STORAGE(FileID),
    CONSTRAINT FK_FILEXULYHOSO_QUATRINH FOREIGN KEY (QuaTrinhXuLyID) REFERENCES [case].QUATRINHXULY(QuaTrinhID),
    CONSTRAINT CK_FILEXULYHOSO_ProcessingDuration CHECK (ProcessingDuration >= 0),
    CONSTRAINT CK_FILEXULYHOSO_QualityScore CHECK (QualityScore BETWEEN 1.0 AND 5.0)
);
GO

-- Indexes
CREATE INDEX IX_FILEXULYHOSO_HoSo ON [document].FILEXULYHOSO(HoSoID, ProcessingDate DESC);
CREATE INDEX IX_FILEXULYHOSO_File ON [document].FILEXULYHOSO(FileID, Status);
CREATE INDEX IX_FILEXULYHOSO_QuaTrinh ON [document].FILEXULYHOSO(QuaTrinhXuLyID);
CREATE INDEX IX_FILEXULYHOSO_ProcessedBy ON [document].FILEXULYHOSO(ProcessedBy, ProcessingDate DESC);
CREATE INDEX IX_FILEXULYHOSO_Stage ON [document].FILEXULYHOSO(ProcessingStage, Status);
CREATE INDEX IX_FILEXULYHOSO_Approval ON [document].FILEXULYHOSO(ApprovalStatus, RequiresApproval);
CREATE INDEX IX_FILEXULYHOSO_Workflow ON [document].FILEXULYHOSO(WorkflowStepID, Status);
GO
```

### 4. FILEKETQUA - Result and output files

```sql
CREATE TABLE [document].FILEKETQUA (
    FileKetQuaID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,
    FileID BIGINT NOT NULL,

    -- Result classification
    ResultType NVARCHAR(100) NOT NULL, -- Certificate/License/Decision/Report/Notification
    ResultCategory NVARCHAR(200), -- Final/Interim/Supplementary/Amendment
    OfficialStatus NVARCHAR(100), -- Draft/Official/Certified/Legalized

    -- Legal and regulatory information
    LegalBasis NVARCHAR(2000), -- Legal basis for the result
    RegulationReference NVARCHAR(1000), -- Regulation reference
    AuthorityLevel NVARCHAR(100), -- Authority level issuing result
    JurisdictionScope NVARCHAR(500), -- Jurisdiction scope

    -- Issuance information
    IssuingAuthority BIGINT NOT NULL, -- Organization issuing result
    IssuingOfficer BIGINT NOT NULL, -- Officer issuing result
    IssueDate DATETIME2 DEFAULT GETDATE(), -- Issue date
    EffectiveDate DATETIME2, -- When result becomes effective
    ExpiryDate DATETIME2, -- When result expires

    -- Document numbers and references
    OfficialNumber NVARCHAR(200), -- Official document number
    SerialNumber NVARCHAR(200), -- Serial number
    ReferenceNumber NVARCHAR(200), -- Reference number
    CertificateNumber NVARCHAR(200), -- Certificate number
    RegistrationNumber NVARCHAR(200), -- Registration number

    -- Digital signature and security
    RequiresDigitalSignature BIT DEFAULT 1, -- Requires digital signature
    SignatureStatus NVARCHAR(100), -- Pending/Signed/Verified/Invalid
    SignedBy NVARCHAR(MAX), -- JSON array of signers
    SignatureTimestamp DATETIME2, -- Signature timestamp
    CertificateDetails NVARCHAR(MAX), -- JSON certificate details

    -- Quality assurance
    QualityReviewed BIT DEFAULT 0, -- Quality reviewed
    QualityApprovedBy BIGINT, -- Quality approved by
    QualityScore DECIMAL(3,1), -- Quality score
    QualityIssues NVARCHAR(MAX), -- JSON quality issues
    QualityAssuranceLog NVARCHAR(MAX), -- JSON QA log

    -- Template and formatting
    TemplateUsed NVARCHAR(500), -- Template used for generation
    TemplateVersion NVARCHAR(100), -- Template version
    FormattingApplied NVARCHAR(MAX), -- JSON formatting details
    CustomizationApplied NVARCHAR(MAX), -- JSON customizations

    -- Content and data
    ResultContent NVARCHAR(MAX), -- Main result content
    ResultData NVARCHAR(MAX), -- JSON structured result data
    VariableValues NVARCHAR(MAX), -- JSON template variable values
    CalculatedFields NVARCHAR(MAX), -- JSON calculated field values

    -- Delivery and distribution
    DeliveryMethod NVARCHAR(200), -- Physical/Email/Portal/API/Pickup
    DeliveryAddress NVARCHAR(1000), -- Delivery address
    DeliveryStatus NVARCHAR(100), -- Pending/Sent/Delivered/Failed/Returned
    DeliveryDate DATETIME2, -- Delivery date
    DeliveryConfirmation NVARCHAR(500), -- Delivery confirmation details

    -- Recipient information
    PrimaryRecipient BIGINT, -- Primary recipient user
    SecondaryRecipients NVARCHAR(MAX), -- JSON secondary recipients
    NotificationPreferences NVARCHAR(MAX), -- JSON notification preferences
    AccessPermissions NVARCHAR(MAX), -- JSON access permissions

    -- Validity and amendments
    ValidityPeriod INT, -- Validity period in days
    RenewalRequired BIT DEFAULT 0, -- Requires renewal
    RenewalProcedure NVARCHAR(2000), -- Renewal procedure
    AmendmentHistory NVARCHAR(MAX), -- JSON amendment history
    SupersedesDocument NVARCHAR(200), -- Document this supersedes

    -- Usage and restrictions
    UsageRestrictions NVARCHAR(2000), -- Usage restrictions
    CopyrightNotice NVARCHAR(1000), -- Copyright notice
    DistributionLimitations NVARCHAR(1000), -- Distribution limitations
    AccessClassification NVARCHAR(100), -- Public/Restricted/Confidential

    -- Integration and publishing
    PublishToPortal BIT DEFAULT 1, -- Publish to citizen portal
    PublishToAPI BIT DEFAULT 0, -- Available via API
    IntegrateWithNationalDB BIT DEFAULT 0, -- Integrate with national database
    ExternalSystemSync NVARCHAR(MAX), -- JSON external system sync

    -- Statistical and reporting
    StatisticalCategory NVARCHAR(200), -- Category for statistics
    ReportingCode NVARCHAR(100), -- Code for reporting
    BusinessMetrics NVARCHAR(MAX), -- JSON business metrics
    ImpactMeasurement NVARCHAR(MAX), -- JSON impact measurements

    -- Performance tracking
    ProcessingTimeTotal INT, -- Total processing time
    IssuanceTime INT, -- Time to issue result
    CustomerSatisfaction DECIMAL(3,1), -- Customer satisfaction score
    DeliverySuccess DECIMAL(5,2), -- Delivery success rate

    -- Compliance and audit
    ComplianceChecklist NVARCHAR(MAX), -- JSON compliance checklist
    AuditRequirements NVARCHAR(MAX), -- JSON audit requirements
    RetentionRequirement INT, -- Retention requirement in years
    DisposalInstructions NVARCHAR(2000), -- Disposal instructions

    -- Error handling and corrections
    CorrectionCount INT DEFAULT 0, -- Number of corrections made
    CorrectionHistory NVARCHAR(MAX), -- JSON correction history
    ErrorReportingMechanism NVARCHAR(1000), -- Error reporting process
    AppealProcedure NVARCHAR(2000), -- Appeal procedure

    -- Status and lifecycle
    Status NVARCHAR(100) DEFAULT 'Active', -- Active/Superseded/Revoked/Expired
    LifecycleStage NVARCHAR(100), -- Issued/Active/Expiring/Expired/Revoked
    StatusChangeHistory NVARCHAR(MAX), -- JSON status change history
    RevocationReason NVARCHAR(2000), -- Reason for revocation

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,
    DeletedAt DATETIME2,
    DeletedBy BIGINT,

    CONSTRAINT FK_FILEKETQUA_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_FILEKETQUA_FILE FOREIGN KEY (FileID) REFERENCES [document].FILE_STORAGE(FileID),
    CONSTRAINT CK_FILEKETQUA_ValidityPeriod CHECK (ValidityPeriod > 0 OR ValidityPeriod IS NULL),
    CONSTRAINT CK_FILEKETQUA_QualityScore CHECK (QualityScore BETWEEN 1.0 AND 5.0 OR QualityScore IS NULL)
);
GO

-- Indexes
CREATE INDEX IX_FILEKETQUA_HoSo ON [document].FILEKETQUA(HoSoID, Status);
CREATE INDEX IX_FILEKETQUA_File ON [document].FILEKETQUA(FileID);
CREATE INDEX IX_FILEKETQUA_Type ON [document].FILEKETQUA(ResultType, ResultCategory);
CREATE INDEX IX_FILEKETQUA_Authority ON [document].FILEKETQUA(IssuingAuthority, IssueDate DESC);
CREATE INDEX IX_FILEKETQUA_Official ON [document].FILEKETQUA(OfficialNumber);
CREATE INDEX IX_FILEKETQUA_Certificate ON [document].FILEKETQUA(CertificateNumber);
CREATE INDEX IX_FILEKETQUA_Effective ON [document].FILEKETQUA(EffectiveDate, ExpiryDate);
CREATE INDEX IX_FILEKETQUA_Delivery ON [document].FILEKETQUA(DeliveryStatus, DeliveryMethod);
CREATE INDEX IX_FILEKETQUA_Signature ON [document].FILEKETQUA(SignatureStatus, RequiresDigitalSignature);
GO
```

## SUPPORTING TABLES

### 5. DOCUMENT_TEMPLATES - Document templates management

```sql
CREATE TABLE [document].DOCUMENT_TEMPLATES (
    TemplateID BIGINT PRIMARY KEY IDENTITY,
    TTHCID BIGINT, -- Associated procedure

    -- Template identification
    TemplateCode NVARCHAR(100) UNIQUE NOT NULL,
    TemplateName NVARCHAR(500) NOT NULL,
    TemplateDescription NVARCHAR(2000),
    TemplateCategory NVARCHAR(200), -- Form/Certificate/Report/Letter/Decision

    -- Version management
    VersionNumber NVARCHAR(20) DEFAULT '1.0',
    ParentTemplateID BIGINT, -- Parent template for versions
    IsLatestVersion BIT DEFAULT 1,
    VersionHistory NVARCHAR(MAX), -- JSON version history

    -- Template content
    TemplateContent NVARCHAR(MAX) NOT NULL, -- Template content
    TemplateFormat NVARCHAR(100), -- HTML/Word/PDF/Excel/JSON
    StyleSheet NVARCHAR(MAX), -- CSS or styling information
    LayoutDefinition NVARCHAR(MAX), -- JSON layout definition

    -- Variables and fields
    TemplateVariables NVARCHAR(MAX), -- JSON template variables
    DataSourceMapping NVARCHAR(MAX), -- JSON data source mapping
    CalculationRules NVARCHAR(MAX), -- JSON calculation rules
    ValidationRules NVARCHAR(MAX), -- JSON validation rules

    -- Legal and compliance
    LegalBasis NVARCHAR(2000), -- Legal basis for template
    ApprovalRequired BIT DEFAULT 1, -- Requires approval
    ApprovedBy BIGINT, -- User who approved
    ApprovalDate DATETIME2, -- Approval date
    ComplianceChecked BIT DEFAULT 0, -- Compliance checked

    -- Usage and restrictions
    UsageScope NVARCHAR(200), -- Internal/Public/Restricted
    AccessLevel NVARCHAR(100), -- View/Use/Modify/Admin
    OrganizationRestrictions NVARCHAR(MAX), -- JSON organization restrictions
    UserRestrictions NVARCHAR(MAX), -- JSON user restrictions

    -- Generation settings
    AutoGenerationEnabled BIT DEFAULT 0, -- Can be auto-generated
    GenerationTriggers NVARCHAR(MAX), -- JSON generation triggers
    DefaultValues NVARCHAR(MAX), -- JSON default field values
    RequiredFields NVARCHAR(MAX), -- JSON required fields

    -- Output configuration
    OutputFormats NVARCHAR(MAX), -- JSON supported output formats
    DefaultOutputFormat NVARCHAR(100), -- Default output format
    PrintSettings NVARCHAR(MAX), -- JSON print settings
    DigitalSignatureRequired BIT DEFAULT 0, -- Requires digital signature

    -- Quality and testing
    TestingStatus NVARCHAR(100), -- Draft/Testing/Approved/Deprecated
    TestResults NVARCHAR(MAX), -- JSON test results
    QualityMetrics NVARCHAR(MAX), -- JSON quality metrics
    UsageFeedback NVARCHAR(MAX), -- JSON usage feedback

    -- Performance tracking
    UsageCount INT DEFAULT 0, -- Number of times used
    AverageGenerationTime INT, -- Average generation time in seconds
    ErrorRate DECIMAL(5,2) DEFAULT 0, -- Error rate percentage
    UserSatisfactionScore DECIMAL(3,1), -- User satisfaction score

    -- Localization
    DefaultLanguage NVARCHAR(20) DEFAULT 'vi', -- Default language
    SupportedLanguages NVARCHAR(500), -- Supported languages
    TranslationStatus NVARCHAR(MAX), -- JSON translation status
    LocalizationRules NVARCHAR(MAX), -- JSON localization rules

    -- Integration
    IntegrationEndpoints NVARCHAR(MAX), -- JSON integration endpoints
    APIConfiguration NVARCHAR(MAX), -- JSON API configuration
    ExternalSystemMapping NVARCHAR(MAX), -- JSON external system mapping
    SyncRequirements NVARCHAR(MAX), -- JSON sync requirements

    -- Status and lifecycle
    Status NVARCHAR(100) DEFAULT 'Draft', -- Draft/Active/Deprecated/Archived
    EffectiveDate DATETIME2, -- When template becomes effective
    ExpiryDate DATETIME2, -- When template expires
    MaintenanceSchedule NVARCHAR(1000), -- Maintenance schedule

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,
    DeletedAt DATETIME2,
    DeletedBy BIGINT,

    CONSTRAINT FK_DOCUMENT_TEMPLATES_PARENT FOREIGN KEY (ParentTemplateID) REFERENCES [document].DOCUMENT_TEMPLATES(TemplateID),
    CONSTRAINT CK_DOCUMENT_TEMPLATES_Version CHECK (VersionNumber IS NOT NULL AND LEN(VersionNumber) > 0)
);
GO

-- Indexes
CREATE INDEX IX_DOCUMENT_TEMPLATES_Code ON [document].DOCUMENT_TEMPLATES(TemplateCode);
CREATE INDEX IX_DOCUMENT_TEMPLATES_TTHC ON [document].DOCUMENT_TEMPLATES(TTHCID, Status);
CREATE INDEX IX_DOCUMENT_TEMPLATES_Category ON [document].DOCUMENT_TEMPLATES(TemplateCategory, Status);
CREATE INDEX IX_DOCUMENT_TEMPLATES_Version ON [document].DOCUMENT_TEMPLATES(ParentTemplateID, VersionNumber);
CREATE INDEX IX_DOCUMENT_TEMPLATES_Status ON [document].DOCUMENT_TEMPLATES(Status, EffectiveDate);
GO
```

### 6. DOCUMENT_PROCESSING_LOG - Processing activity log

```sql
CREATE TABLE [document].DOCUMENT_PROCESSING_LOG (
    LogID BIGINT PRIMARY KEY IDENTITY,
    FileID BIGINT NOT NULL,

    -- Processing details
    ProcessingType NVARCHAR(100) NOT NULL, -- Upload/OCR/Signature/Validation/Conversion
    ProcessingStage NVARCHAR(200), -- Stage in processing pipeline
    ProcessingEngine NVARCHAR(200), -- Engine/tool used
    ProcessingVersion NVARCHAR(100), -- Version of processing engine

    -- Timing information
    StartTime DATETIME2 DEFAULT GETDATE(),
    EndTime DATETIME2,
    DurationSeconds INT,
    QueueTime INT, -- Time spent in queue (seconds)
    ProcessingTime INT, -- Actual processing time (seconds)

    -- Input and output
    InputParameters NVARCHAR(MAX), -- JSON input parameters
    OutputResults NVARCHAR(MAX), -- JSON output results
    InputSize BIGINT, -- Input size in bytes
    OutputSize BIGINT, -- Output size in bytes

    -- Status and results
    ProcessingStatus NVARCHAR(100), -- Success/Failed/Warning/Cancelled
    ResultCode NVARCHAR(50), -- Specific result code
    ConfidenceScore DECIMAL(5,2), -- Confidence in results
    QualityScore DECIMAL(5,2), -- Quality of results

    -- Error handling
    ErrorCount INT DEFAULT 0, -- Number of errors
    WarningCount INT DEFAULT 0, -- Number of warnings
    ErrorDetails NVARCHAR(MAX), -- JSON error details
    WarningDetails NVARCHAR(MAX), -- JSON warning details
    ExceptionStack NVARCHAR(MAX), -- Exception stack trace

    -- Performance metrics
    CPUUsage DECIMAL(5,2), -- CPU usage percentage
    MemoryUsage BIGINT, -- Memory usage in bytes
    IOOperations INT, -- Number of I/O operations
    NetworkCalls INT, -- Number of network calls

    -- System context
    ProcessingServer NVARCHAR(200), -- Server that processed
    ServerLoad DECIMAL(5,2), -- Server load at time of processing
    SystemVersion NVARCHAR(200), -- System version
    EnvironmentInfo NVARCHAR(MAX), -- JSON environment information

    -- User context
    ProcessedBy BIGINT, -- User who initiated processing
    UserAgent NVARCHAR(1000), -- User agent string
    ClientIP NVARCHAR(45), -- Client IP address
    SessionID NVARCHAR(128), -- Session ID

    -- Integration context
    APIVersion NVARCHAR(100), -- API version used
    IntegrationMethod NVARCHAR(200), -- Integration method
    ExternalSystemCalls NVARCHAR(MAX), -- JSON external system calls
    ThirdPartyResponses NVARCHAR(MAX), -- JSON third-party responses

    -- Quality and validation
    ValidationPerformed BIT DEFAULT 0, -- Validation performed
    ValidationResults NVARCHAR(MAX), -- JSON validation results
    ManualReviewRequired BIT DEFAULT 0, -- Requires manual review
    QualityCheckResults NVARCHAR(MAX), -- JSON quality check results

    -- Business context
    BusinessProcess NVARCHAR(200), -- Business process context
    WorkflowStage NVARCHAR(200), -- Workflow stage
    BusinessPriority TINYINT, -- Business priority 1-5
    CostImpact DECIMAL(10,2), -- Cost impact of processing

    -- Retry and recovery
    RetryAttempt INT DEFAULT 0, -- Retry attempt number
    MaxRetries INT DEFAULT 3, -- Maximum retries configured
    RetryReason NVARCHAR(1000), -- Reason for retry
    RecoveryAction NVARCHAR(1000), -- Recovery action taken

    -- Audit and compliance
    AuditRequired BIT DEFAULT 1, -- Audit required
    ComplianceChecked BIT DEFAULT 0, -- Compliance checked
    SecurityLevel TINYINT, -- Security level 1-5
    DataClassification NVARCHAR(100), -- Data classification

    -- Resource utilization
    ResourceCost DECIMAL(10,4), -- Resource cost
    LicenseCost DECIMAL(10,4), -- License cost
    StorageCost DECIMAL(10,4), -- Storage cost
    BandwidthUsed BIGINT, -- Bandwidth used in bytes

    -- Feedback and learning
    UserFeedback NVARCHAR(2000), -- User feedback
    AccuracyRating DECIMAL(3,1), -- Accuracy rating from user
    ImprovementSuggestions NVARCHAR(2000), -- Improvement suggestions
    LearningData NVARCHAR(MAX), -- JSON data for machine learning

    -- Status flags
    IsSuccessful BIT AS (CASE WHEN ProcessingStatus = 'Success' THEN 1 ELSE 0 END) PERSISTED,
    RequiresFollowUp BIT DEFAULT 0, -- Requires follow-up action
    IsArchived BIT DEFAULT 0, -- Log is archived

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,

    CONSTRAINT FK_DOCUMENT_PROCESSING_LOG_FILE FOREIGN KEY (FileID) REFERENCES [document].FILE_STORAGE(FileID),
    CONSTRAINT CK_DOCUMENT_PROCESSING_LOG_Duration CHECK (DurationSeconds >= 0 OR DurationSeconds IS NULL),
    CONSTRAINT CK_DOCUMENT_PROCESSING_LOG_Confidence CHECK (ConfidenceScore BETWEEN 0 AND 100 OR ConfidenceScore IS NULL)
);
GO

-- Indexes
CREATE INDEX IX_DOCUMENT_PROCESSING_LOG_File ON [document].DOCUMENT_PROCESSING_LOG(FileID, StartTime DESC);
CREATE INDEX IX_DOCUMENT_PROCESSING_LOG_Type ON [document].DOCUMENT_PROCESSING_LOG(ProcessingType, ProcessingStatus);
CREATE INDEX IX_DOCUMENT_PROCESSING_LOG_Status ON [document].DOCUMENT_PROCESSING_LOG(ProcessingStatus, StartTime DESC);
CREATE INDEX IX_DOCUMENT_PROCESSING_LOG_Time ON [document].DOCUMENT_PROCESSING_LOG(StartTime DESC);
CREATE INDEX IX_DOCUMENT_PROCESSING_LOG_Duration ON [document].DOCUMENT_PROCESSING_LOG(DurationSeconds DESC);
CREATE INDEX IX_DOCUMENT_PROCESSING_LOG_Server ON [document].DOCUMENT_PROCESSING_LOG(ProcessingServer, StartTime DESC);
CREATE INDEX IX_DOCUMENT_PROCESSING_LOG_User ON [document].DOCUMENT_PROCESSING_LOG(ProcessedBy, StartTime DESC);
GO
```

## CROSS-SCHEMA INTEGRATION VIEWS

```sql
-- View for Case service to access case documents
CREATE VIEW [case].v_CaseDocuments
AS
SELECT
    fkt.HoSoID,
    fs.FileID,
    fs.FileName,
    fs.FileCategory,
    fs.DocumentType,
    fs.FileSizeBytes,
    fs.CreatedAt,
    fkt.RequirementType,
    fkt.ValidationStatus,
    fkt.DocumentRole
FROM [document].FILE_STORAGE fs
INNER JOIN [document].FILEKEMTHEOHOSO fkt ON fs.FileID = fkt.FileID
WHERE fs.IsActive = 1 AND fkt.Status = 'Active';
GO

-- View for Workflow service to access processing files
CREATE VIEW [workflow].v_ProcessingFiles
AS
SELECT
    fxl.HoSoID,
    fxl.QuaTrinhXuLyID,
    fs.FileID,
    fs.FileName,
    fs.FileCategory,
    fxl.ProcessingStage,
    fxl.ProcessingType,
    fxl.ProcessedBy,
    fxl.ProcessingDate
FROM [document].FILE_STORAGE fs
INNER JOIN [document].FILEXULYHOSO fxl ON fs.FileID = fxl.FileID
WHERE fs.IsActive = 1 AND fxl.Status = 'Active';
GO

-- View for Notification service to access result documents
CREATE VIEW [notification].v_ResultDocuments
AS
SELECT
    fkq.HoSoID,
    fs.FileID,
    fs.FileName,
    fkq.ResultType,
    fkq.OfficialNumber,
    fkq.IssuingAuthority,
    fkq.IssueDate,
    fkq.DeliveryStatus,
    fkq.PrimaryRecipient
FROM [document].FILE_STORAGE fs
INNER JOIN [document].FILEKETQUA fkq ON fs.FileID = fkq.FileID
WHERE fs.IsActive = 1 AND fkq.Status = 'Active';
GO

-- View for Audit service to access document processing history
CREATE VIEW [audit].v_DocumentAuditTrail
AS
SELECT
    dpl.FileID,
    fs.FileName,
    dpl.ProcessingType,
    dpl.ProcessingStatus,
    dpl.StartTime,
    dpl.EndTime,
    dpl.ProcessedBy,
    dpl.ErrorDetails
FROM [document].DOCUMENT_PROCESSING_LOG dpl
INNER JOIN [document].FILE_STORAGE fs ON dpl.FileID = fs.FileID
WHERE fs.IsActive = 1
ORDER BY dpl.StartTime DESC;
GO
```

## KEY FEATURES

### Comprehensive Document Lifecycle Management
- **End-to-End Tracking**: Complete document journey from upload to archival
- **Version Control**: Sophisticated version management with history tracking
- **Digital Signatures**: Native digital signature support with PKI integration
- **Quality Assurance**: Multi-level quality control and validation framework

### Advanced Processing Capabilities
- **OCR Integration**: Automated text extraction with confidence scoring
- **AI/ML Processing**: Content analysis, classification, and entity extraction
- **Virus Scanning**: Comprehensive security scanning with quarantine capabilities
- **Format Conversion**: Support for multiple document formats and conversions

### MinIO Object Storage Integration
- **Scalable Storage**: Distributed object storage with high availability
- **CDN Support**: Content delivery network integration for fast access
- **Encryption**: Data encryption at rest and in transit
- **Backup and Recovery**: Automated backup and disaster recovery capabilities

### Template Engine
- **Dynamic Templates**: Flexible template system for document generation
- **Variable Substitution**: Advanced variable substitution and calculation
- **Multi-format Output**: Support for PDF, Word, HTML, and other formats
- **Localization**: Multi-language template support

### Security and Compliance
- **Access Control**: Granular access control with role-based permissions
- **Audit Trail**: Comprehensive audit logging for all document operations
- **Data Classification**: Multi-level security classification system
- **Retention Management**: Automated retention and disposal management

## BUSINESS RULES

### Document Upload and Validation Rules
- All uploaded documents must pass virus scanning before processing
- File size limits enforced based on document type and user permissions
- Required documents must be validated before case can proceed
- OCR processing required for all scanned documents

### Digital Signature Rules
- Official documents must be digitally signed by authorized personnel
- Signature validation required before document distribution
- Certificate chain validation for all digital signatures
- Time-stamping required for legal documents

### Version Control Rules
- Only latest version is active for processing
- Historical versions preserved for audit purposes
- Version changes must be documented with reasons
- Critical documents require approval for version changes

### Access and Security Rules
- Document access based on security classification and user permissions
- Sensitive documents require additional authentication
- Audit logging required for all document access and modifications
- Data encryption required for confidential and secret documents

## PERFORMANCE CONSIDERATIONS

### Storage Optimization
- Object storage with distributed architecture for scalability
- CDN integration for fast global document access
- Intelligent tiering for cost-effective storage management
- Compression algorithms for storage space optimization

### Processing Performance
- Parallel processing for OCR and content analysis
- Queue-based processing for high-volume document handling
- Caching strategies for frequently accessed documents
- Background processing for non-critical operations

### Search and Retrieval
- Full-text indexing for rapid document search
- Metadata indexing for structured queries
- Intelligent caching for search results
- Faceted search capabilities for complex filtering

### Database Performance
- Partitioned tables for large document metadata volumes
- Strategic indexing for common query patterns
- Archive strategies for historical document data
- Optimized joins with case and workflow systems

## INTEGRATION PATTERNS

### Event-Driven Architecture
```sql
-- Events published by Document service:
-- DocumentUploaded
-- DocumentProcessed
-- DocumentSigned
-- DocumentValidated
-- DocumentApproved
-- DocumentDelivered
-- DocumentExpired
-- DocumentArchived
-- OCRCompleted
-- VirusScanCompleted
-- TemplateGenerated
-- SignatureValidated
```

### MinIO Integration
- Direct S3-compatible API integration
- Bucket policies for access control
- Lifecycle management for automatic archival
- Cross-region replication for disaster recovery

### External System Integration
- Digital signature service integration (USB tokens, cloud HSM)
- National database integration for document verification
- Third-party OCR engine integration
- Anti-virus service integration

### Workflow Integration
- Document state synchronization with workflow engine
- Automated document generation based on workflow triggers
- Document validation checkpoints in workflow processes
- Result document delivery integration

## MIGRATION CONSIDERATIONS

### From Legacy Document Systems
- Document content migration with metadata preservation
- File format conversion and standardization
- Access permission migration and validation
- Historical audit trail preservation

### Storage Migration
- Gradual migration from file system to object storage
- Content verification and integrity checking
- Performance baseline establishment
- Fallback procedures for migration issues

### Template Migration
- Legacy template conversion to new format
- Variable mapping and validation
- Template testing and approval process
- User training for new template system

### Integration Updates
- API endpoint migration for external systems
- Authentication mechanism updates
- Event schema migration for microservices
- Performance monitoring and optimization