# Foreign Key Relationships - Complete Database Integrity

## OVERVIEW

This document establishes comprehensive foreign key relationships between all tables in the DVC v2 database design, ensuring referential integrity, data consistency, and proper cascade behaviors. The relationships support the modular monolith architecture while preparing for future microservices decomposition.

## FOREIGN KEY STRATEGY

### Integrity Principles
- **Referential Integrity**: All foreign keys properly reference primary keys
- **Cascade Behavior**: Appropriate ON DELETE and ON UPDATE actions
- **Performance**: Foreign keys support query optimization
- **Business Logic**: Relationships reflect real-world business rules

### Cascade Strategies
- **CASCADE**: Delete/update child records when parent changes
- **RESTRICT**: Prevent parent changes if children exist
- **SET NULL**: Set foreign key to NULL when parent is deleted
- **SET DEFAULT**: Set foreign key to default value when parent is deleted

## IDENTITY SCHEMA RELATIONSHIPS

### Core Identity Relationships

```sql
-- USER_PROFILE base relationships
ALTER TABLE [identity].USER_PROFILE
ADD CONSTRAINT FK_USER_PROFILE_Department FOREIGN KEY (DepartmentID) REFERENCES [system].OFFICE(OfficeID),
    CONSTRAINT FK_USER_PROFILE_Manager FOREIGN KEY (ManagerID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_USER_PROFILE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_USER_PROFILE_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- USER_SESSIONS relationships
ALTER TABLE [identity].USER_SESSIONS
ADD CONSTRAINT FK_USER_SESSIONS_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID) ON DELETE CASCADE;

-- TWO_FACTOR_AUTHENTICATION relationships
ALTER TABLE [identity].TWO_FACTOR_AUTHENTICATION
ADD CONSTRAINT FK_2FA_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID) ON DELETE CASCADE;

-- ROLE_ASSIGNMENTS relationships
ALTER TABLE [identity].ROLE_ASSIGNMENTS
ADD CONSTRAINT FK_ROLE_ASSIGN_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID) ON DELETE CASCADE,
    CONSTRAINT FK_ROLE_ASSIGN_Role FOREIGN KEY (RoleID) REFERENCES [identity].ROLE_DEFINITION(RoleID) ON DELETE CASCADE,
    CONSTRAINT FK_ROLE_ASSIGN_AssignedBy FOREIGN KEY (AssignedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_ROLE_ASSIGN_ApprovedBy FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- PERMISSION_ASSIGNMENTS relationships
ALTER TABLE [identity].PERMISSION_ASSIGNMENTS
ADD CONSTRAINT FK_PERM_ASSIGN_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID) ON DELETE CASCADE,
    CONSTRAINT FK_PERM_ASSIGN_Permission FOREIGN KEY (PermissionID) REFERENCES [identity].PERMISSION_DEFINITION(PermissionID) ON DELETE CASCADE,
    CONSTRAINT FK_PERM_ASSIGN_GrantedBy FOREIGN KEY (GrantedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DELEGATION relationships
ALTER TABLE [identity].DELEGATION
ADD CONSTRAINT FK_DELEGATION_Delegator FOREIGN KEY (DelegatorUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELEGATION_Delegate FOREIGN KEY (DelegateUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELEGATION_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELEGATION_ApprovedBy FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- USER_ROLE_CONTEXT relationships
ALTER TABLE [identity].USER_ROLE_CONTEXT
ADD CONSTRAINT FK_USER_ROLE_CTX_Assignment FOREIGN KEY (RoleAssignmentID) REFERENCES [identity].ROLE_ASSIGNMENTS(AssignmentID) ON DELETE CASCADE;

-- RESOURCE_ACCESS_CONTROL relationships
ALTER TABLE [identity].RESOURCE_ACCESS_CONTROL
ADD CONSTRAINT FK_RAC_Permission FOREIGN KEY (PermissionID) REFERENCES [identity].PERMISSION_DEFINITION(PermissionID) ON DELETE CASCADE;
GO
```

## CASE SCHEMA RELATIONSHIPS

### Core Case Management Relationships

```sql
-- HOSO primary relationships
ALTER TABLE [case].HOSO
ADD CONSTRAINT FK_HOSO_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID),
    CONSTRAINT FK_HOSO_Submitter FOREIGN KEY (NguoiNopHoSo) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_HOSO_Processor FOREIGN KEY (CanBoXuLy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_HOSO_Office FOREIGN KEY (DonViTiepNhan) REFERENCES [system].OFFICE(OfficeID),
    CONSTRAINT FK_HOSO_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_HOSO_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- TASK_ASSIGNMENT relationships
ALTER TABLE [case].TASK_ASSIGNMENT
ADD CONSTRAINT FK_TASK_ASSIGN_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_TASK_ASSIGN_Workflow FOREIGN KEY (WorkflowInstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID),
    CONSTRAINT FK_TASK_ASSIGN_User FOREIGN KEY (AssignedUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TASK_ASSIGN_AssignedBy FOREIGN KEY (AssignedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TASK_ASSIGN_CompletedBy FOREIGN KEY (CompletedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TASK_ASSIGN_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TASK_ASSIGN_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- TASK_QUEUE relationships
ALTER TABLE [case].TASK_QUEUE
ADD CONSTRAINT FK_TASK_QUEUE_Assignment FOREIGN KEY (TaskAssignmentID) REFERENCES [case].TASK_ASSIGNMENT(AssignmentID) ON DELETE CASCADE,
    CONSTRAINT FK_TASK_QUEUE_CurrentUser FOREIGN KEY (CurrentAssignedUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TASK_QUEUE_PreviousUser FOREIGN KEY (PreviousAssignedUserID) REFERENCES [identity].USER_PROFILE(UserID);

-- STATUS_DEFINITION relationships
ALTER TABLE [case].STATUS_DEFINITION
ADD CONSTRAINT FK_STATUS_DEF_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_STATUS_DEF_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- STATUS_TRANSITION relationships
ALTER TABLE [case].STATUS_TRANSITION
ADD CONSTRAINT FK_STATUS_TRANS_From FOREIGN KEY (FromStatusID) REFERENCES [case].STATUS_DEFINITION(StatusID),
    CONSTRAINT FK_STATUS_TRANS_To FOREIGN KEY (ToStatusID) REFERENCES [case].STATUS_DEFINITION(StatusID),
    CONSTRAINT FK_STATUS_TRANS_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- STATUS_HISTORY relationships
ALTER TABLE [case].STATUS_HISTORY
ADD CONSTRAINT FK_STATUS_HIST_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_STATUS_HIST_Transition FOREIGN KEY (StatusTransitionID) REFERENCES [case].STATUS_TRANSITION(TransitionID),
    CONSTRAINT FK_STATUS_HIST_ChangedBy FOREIGN KEY (ChangedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_STATUS_HIST_ApprovedBy FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DELEGATION relationships (case schema)
ALTER TABLE [case].DELEGATION
ADD CONSTRAINT FK_CASE_DELEGATION_FromUser FOREIGN KEY (FromUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CASE_DELEGATION_ToUser FOREIGN KEY (ToUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CASE_DELEGATION_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_CASE_DELEGATION_Task FOREIGN KEY (TaskAssignmentID) REFERENCES [case].TASK_ASSIGNMENT(AssignmentID),
    CONSTRAINT FK_CASE_DELEGATION_ApprovedBy FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CASE_DELEGATION_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- APPROVAL_CHAIN relationships
ALTER TABLE [case].APPROVAL_CHAIN
ADD CONSTRAINT FK_APPROVAL_CHAIN_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_APPROVAL_CHAIN_Workflow FOREIGN KEY (WorkflowInstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID),
    CONSTRAINT FK_APPROVAL_CHAIN_Approver FOREIGN KEY (ApproverUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_APPROVAL_CHAIN_ActualApprover FOREIGN KEY (ActualApproverUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_APPROVAL_CHAIN_DelegatedFrom FOREIGN KEY (DelegatedFromUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_APPROVAL_CHAIN_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_APPROVAL_CHAIN_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- SLA_TRACKING relationships
ALTER TABLE [case].SLA_TRACKING
ADD CONSTRAINT FK_SLA_TRACK_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_SLA_TRACK_Workflow FOREIGN KEY (WorkflowInstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID),
    CONSTRAINT FK_SLA_TRACK_Task FOREIGN KEY (TaskAssignmentID) REFERENCES [case].TASK_ASSIGNMENT(AssignmentID),
    CONSTRAINT FK_SLA_TRACK_StatusTrans FOREIGN KEY (StatusTransitionID) REFERENCES [case].STATUS_TRANSITION(TransitionID),
    CONSTRAINT FK_SLA_TRACK_EscalatedTo FOREIGN KEY (EscalatedTo) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACK_ExtensionBy FOREIGN KEY (ExtensionApprovedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACK_PausedBy FOREIGN KEY (PausedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACK_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACK_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- CITIZEN_FEEDBACK relationships
ALTER TABLE [case].CITIZEN_FEEDBACK
ADD CONSTRAINT FK_CITIZEN_FEEDBACK_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_CITIZEN_FEEDBACK_Citizen FOREIGN KEY (CitizenID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_Office FOREIGN KEY (ServiceOfficeID) REFERENCES [system].OFFICE(OfficeID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_ResponseBy FOREIGN KEY (ResponseBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_EscalatedTo FOREIGN KEY (EscalatedTo) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_VerifiedBy FOREIGN KEY (VerifiedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- SERVICE_RATING relationships
ALTER TABLE [case].SERVICE_RATING
ADD CONSTRAINT FK_SERVICE_RATING_Office FOREIGN KEY (ServiceOfficeID) REFERENCES [system].OFFICE(OfficeID);
GO
```

## WORKFLOW SCHEMA RELATIONSHIPS

### Workflow Engine Relationships

```sql
-- WORKFLOW_DEFINITION relationships
ALTER TABLE [workflow].WORKFLOW_DEFINITION
ADD CONSTRAINT FK_WORKFLOW_DEF_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_WORKFLOW_DEF_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_WORKFLOW_DEF_ApprovedBy FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- WORKFLOW_STEP_DEFINITION relationships
ALTER TABLE [workflow].WORKFLOW_STEP_DEFINITION
ADD CONSTRAINT FK_WORKFLOW_STEP_DEF_Workflow FOREIGN KEY (WorkflowDefinitionID) REFERENCES [workflow].WORKFLOW_DEFINITION(WorkflowDefinitionID) ON DELETE CASCADE,
    CONSTRAINT FK_WORKFLOW_STEP_DEF_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_WORKFLOW_STEP_DEF_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- WORKFLOW_INSTANCE relationships
ALTER TABLE [workflow].WORKFLOW_INSTANCE
ADD CONSTRAINT FK_WORKFLOW_INST_Definition FOREIGN KEY (WorkflowDefinitionID) REFERENCES [workflow].WORKFLOW_DEFINITION(WorkflowDefinitionID),
    CONSTRAINT FK_WORKFLOW_INST_CurrentStep FOREIGN KEY (CurrentStepID) REFERENCES [workflow].WORKFLOW_STEP_DEFINITION(StepDefinitionID),
    CONSTRAINT FK_WORKFLOW_INST_InitiatedBy FOREIGN KEY (InitiatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_WORKFLOW_INST_CompletedBy FOREIGN KEY (CompletedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_WORKFLOW_INST_CancelledBy FOREIGN KEY (CancelledBy) REFERENCES [identity].USER_PROFILE(UserID);

-- WORKFLOW_STEP_INSTANCE relationships
ALTER TABLE [workflow].WORKFLOW_STEP_INSTANCE
ADD CONSTRAINT FK_WORKFLOW_STEP_INST_Instance FOREIGN KEY (WorkflowInstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID) ON DELETE CASCADE,
    CONSTRAINT FK_WORKFLOW_STEP_INST_Definition FOREIGN KEY (StepDefinitionID) REFERENCES [workflow].WORKFLOW_STEP_DEFINITION(StepDefinitionID),
    CONSTRAINT FK_WORKFLOW_STEP_INST_AssignedUser FOREIGN KEY (AssignedUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_WORKFLOW_STEP_INST_CompletedBy FOREIGN KEY (CompletedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_WORKFLOW_STEP_INST_DelegatedTo FOREIGN KEY (DelegatedTo) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## DOCUMENT SCHEMA RELATIONSHIPS

### Document Management Relationships

```sql
-- DOCUMENT base relationships
ALTER TABLE [document].DOCUMENT
ADD CONSTRAINT FK_DOCUMENT_HoSo FOREIGN KEY (RelatedHoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_DOCUMENT_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DOCUMENT_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DOCUMENT_VERSION relationships
ALTER TABLE [document].DOCUMENT_VERSION
ADD CONSTRAINT FK_DOC_VERSION_Document FOREIGN KEY (DocumentID) REFERENCES [document].DOCUMENT(DocumentID) ON DELETE CASCADE,
    CONSTRAINT FK_DOC_VERSION_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DOCUMENT_ACCESS_LOG relationships
ALTER TABLE [document].DOCUMENT_ACCESS_LOG
ADD CONSTRAINT FK_DOC_ACCESS_Document FOREIGN KEY (DocumentID) REFERENCES [document].DOCUMENT(DocumentID) ON DELETE CASCADE,
    CONSTRAINT FK_DOC_ACCESS_User FOREIGN KEY (AccessedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DIGITAL_SIGNATURE relationships
ALTER TABLE [document].DIGITAL_SIGNATURE
ADD CONSTRAINT FK_DIGITAL_SIG_Document FOREIGN KEY (DocumentID) REFERENCES [document].DOCUMENT(DocumentID) ON DELETE CASCADE,
    CONSTRAINT FK_DIGITAL_SIG_User FOREIGN KEY (SignerUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DIGITAL_SIG_VerifiedBy FOREIGN KEY (VerifiedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DOCUMENT_APPROVAL relationships
ALTER TABLE [document].DOCUMENT_APPROVAL
ADD CONSTRAINT FK_DOC_APPROVAL_Document FOREIGN KEY (DocumentID) REFERENCES [document].DOCUMENT(DocumentID) ON DELETE CASCADE,
    CONSTRAINT FK_DOC_APPROVAL_Approver FOREIGN KEY (ApproverUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DOC_APPROVAL_ApprovedBy FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## NOTIFICATION SCHEMA RELATIONSHIPS

### Notification System Relationships

```sql
-- NOTIFICATION_TEMPLATES relationships
ALTER TABLE [notification].NOTIFICATION_TEMPLATES
ADD CONSTRAINT FK_NOTIF_TEMPLATE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_NOTIF_TEMPLATE_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- NOTIFICATION_PREFERENCES relationships
ALTER TABLE [notification].NOTIFICATION_PREFERENCES
ADD CONSTRAINT FK_NOTIF_PREF_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID) ON DELETE CASCADE;

-- NOTIFICATION_QUEUE relationships
ALTER TABLE [notification].NOTIFICATION_QUEUE
ADD CONSTRAINT FK_NOTIF_QUEUE_Template FOREIGN KEY (TemplateID) REFERENCES [notification].NOTIFICATION_TEMPLATES(TemplateID),
    CONSTRAINT FK_NOTIF_QUEUE_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- NOTIFICATION_HISTORY relationships
ALTER TABLE [notification].NOTIFICATION_HISTORY
ADD CONSTRAINT FK_NOTIF_HIST_Template FOREIGN KEY (TemplateID) REFERENCES [notification].NOTIFICATION_TEMPLATES(TemplateID),
    CONSTRAINT FK_NOTIF_HIST_RecipientUser FOREIGN KEY (RecipientUserID) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## SYSTEM SCHEMA RELATIONSHIPS

### System Configuration Relationships

```sql
-- SYSTEM_CONFIGURATION relationships
ALTER TABLE [system].SYSTEM_CONFIGURATION
ADD CONSTRAINT FK_SYS_CONFIG_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SYS_CONFIG_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- OFFICE relationships
ALTER TABLE [system].OFFICE
ADD CONSTRAINT FK_OFFICE_Parent FOREIGN KEY (ParentOfficeID) REFERENCES [system].OFFICE(OfficeID),
    CONSTRAINT FK_OFFICE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_OFFICE_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- FILE_STORAGE relationships
ALTER TABLE [system].FILE_STORAGE
ADD CONSTRAINT FK_FILE_STORAGE_UploadedBy FOREIGN KEY (UploadedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DIGITAL_SIGNATURE_CONFIG relationships
ALTER TABLE [system].DIGITAL_SIGNATURE_CONFIG
ADD CONSTRAINT FK_DIGITAL_SIG_CONFIG_Office FOREIGN KEY (OfficeID) REFERENCES [system].OFFICE(OfficeID),
    CONSTRAINT FK_DIGITAL_SIG_CONFIG_User FOREIGN KEY (SignerUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DIGITAL_SIG_CONFIG_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DIGITAL_SIG_CONFIG_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- FORM_TEMPLATE relationships
ALTER TABLE [system].FORM_TEMPLATE
ADD CONSTRAINT FK_FORM_TEMPLATE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_FORM_TEMPLATE_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- REPORT_TEMPLATE relationships
ALTER TABLE [system].REPORT_TEMPLATE
ADD CONSTRAINT FK_REPORT_TEMPLATE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_REPORT_TEMPLATE_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- FEATURE_FLAGS relationships
ALTER TABLE [system].FEATURE_FLAGS
ADD CONSTRAINT FK_FEATURE_FLAGS_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_FEATURE_FLAGS_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- LGSP_SYNC_LOG relationships
ALTER TABLE [system].LGSP_SYNC_LOG
ADD CONSTRAINT FK_LGSP_SYNC_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- LGSP_ENTITY_MAPPING relationships
ALTER TABLE [system].LGSP_ENTITY_MAPPING
ADD CONSTRAINT FK_LGSP_ENTITY_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_LGSP_ENTITY_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- LGSP_CONFIGURATION relationships
ALTER TABLE [system].LGSP_CONFIGURATION
ADD CONSTRAINT FK_LGSP_CONFIG_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_LGSP_CONFIG_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## TTHC SCHEMA RELATIONSHIPS

### Administrative Procedure Relationships

```sql
-- TTHC_VERSION relationships
ALTER TABLE [tthc].TTHC_VERSION
ADD CONSTRAINT FK_TTHC_VERSION_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_TTHC_VERSION_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- TTHC_OFFICE relationships
ALTER TABLE [tthc].TTHC_OFFICE
ADD CONSTRAINT FK_TTHC_OFFICE_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_TTHC_OFFICE_Office FOREIGN KEY (OfficeID) REFERENCES [system].OFFICE(OfficeID) ON DELETE CASCADE,
    CONSTRAINT FK_TTHC_OFFICE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DOCUMENT_TYPE relationships
ALTER TABLE [tthc].DOCUMENT_TYPE
ADD CONSTRAINT FK_DOC_TYPE_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_DOC_TYPE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- FEE_SCHEDULE relationships
ALTER TABLE [tthc].FEE_SCHEDULE
ADD CONSTRAINT FK_FEE_SCHEDULE_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_FEE_SCHEDULE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- WORKFLOW_STEP relationships
ALTER TABLE [tthc].WORKFLOW_STEP
ADD CONSTRAINT FK_WF_STEP_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_WF_STEP_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- CONDITION_TEMPLATE relationships
ALTER TABLE [tthc].CONDITION_TEMPLATE
ADD CONSTRAINT FK_CONDITION_TEMPLATE_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_CONDITION_TEMPLATE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- TTHC_INTEGRATION relationships
ALTER TABLE [tthc].TTHC_INTEGRATION
ADD CONSTRAINT FK_TTHC_INTEGRATION_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_TTHC_INTEGRATION_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- BUSINESS_RULE relationships
ALTER TABLE [tthc].BUSINESS_RULE
ADD CONSTRAINT FK_BUSINESS_RULE_TTHC FOREIGN KEY (TTHCID) REFERENCES [tthc].THU_TUC(TTHCID) ON DELETE CASCADE,
    CONSTRAINT FK_BUSINESS_RULE_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## AUDIT SCHEMA RELATIONSHIPS

### Audit Trail Relationships

```sql
-- AUDIT_LOG relationships
ALTER TABLE [audit].AUDIT_LOG
ADD CONSTRAINT FK_AUDIT_LOG_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID);

-- SECURITY_EVENT relationships
ALTER TABLE [audit].SECURITY_EVENT
ADD CONSTRAINT FK_SECURITY_EVENT_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID);

-- COMPLIANCE_LOG relationships
ALTER TABLE [audit].COMPLIANCE_LOG
ADD CONSTRAINT FK_COMPLIANCE_LOG_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_COMPLIANCE_LOG_ReviewedBy FOREIGN KEY (ReviewedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## POSTAL SCHEMA RELATIONSHIPS

### Postal Service Relationships

```sql
-- SHIPMENT_TRACKING relationships
ALTER TABLE [postal].SHIPMENT_TRACKING
ADD CONSTRAINT FK_SHIPMENT_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_SHIPMENT_Provider FOREIGN KEY (ProviderID) REFERENCES [postal].POSTAL_PROVIDER(ProviderID),
    CONSTRAINT FK_SHIPMENT_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SHIPMENT_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DELIVERY_CONFIRMATION relationships
ALTER TABLE [postal].DELIVERY_CONFIRMATION
ADD CONSTRAINT FK_DELIVERY_CONF_Shipment FOREIGN KEY (ShipmentID) REFERENCES [postal].SHIPMENT_TRACKING(ShipmentID) ON DELETE CASCADE,
    CONSTRAINT FK_DELIVERY_CONF_ConfirmedBy FOREIGN KEY (ConfirmedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELIVERY_CONF_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- RETURN_HANDLING relationships
ALTER TABLE [postal].RETURN_HANDLING
ADD CONSTRAINT FK_RETURN_HANDLING_Shipment FOREIGN KEY (ShipmentID) REFERENCES [postal].SHIPMENT_TRACKING(ShipmentID) ON DELETE CASCADE,
    CONSTRAINT FK_RETURN_HANDLING_ProcessedBy FOREIGN KEY (ProcessedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_RETURN_HANDLING_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- POSTAL_PROVIDER relationships
ALTER TABLE [postal].POSTAL_PROVIDER
ADD CONSTRAINT FK_POSTAL_PROVIDER_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_POSTAL_PROVIDER_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## JSON NORMALIZED SCHEMA RELATIONSHIPS

### Normalized Data Relationships

```sql
-- ADDRESS_COMPONENTS relationships
ALTER TABLE [json_normalized].ADDRESS_COMPONENTS
ADD CONSTRAINT FK_ADDRESS_COMP_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- DOCUMENT_METADATA relationships
ALTER TABLE [json_normalized].DOCUMENT_METADATA
ADD CONSTRAINT FK_DOC_METADATA_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- CONFIGURATION_ITEMS relationships
ALTER TABLE [json_normalized].CONFIGURATION_ITEMS
ADD CONSTRAINT FK_CONFIG_ITEMS_TenantOffice FOREIGN KEY (OfficeID) REFERENCES [system].OFFICE(OfficeID);

-- BUSINESS_RULES relationships
ALTER TABLE [json_normalized].BUSINESS_RULES
ADD CONSTRAINT FK_BUSINESS_RULES_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_BUSINESS_RULES_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- VALIDATION_RULES relationships
ALTER TABLE [json_normalized].VALIDATION_RULES
ADD CONSTRAINT FK_VALIDATION_RULES_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_VALIDATION_RULES_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- NOTIFICATION_PREFERENCES relationships
ALTER TABLE [json_normalized].NOTIFICATION_PREFERENCES
ADD CONSTRAINT FK_NOTIF_PREF_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID) ON DELETE CASCADE;

-- FORM_FIELDS relationships
ALTER TABLE [json_normalized].FORM_FIELDS
ADD CONSTRAINT FK_FORM_FIELDS_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_FORM_FIELDS_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- ERROR_DETAILS relationships
ALTER TABLE [json_normalized].ERROR_DETAILS
ADD CONSTRAINT FK_ERROR_DETAILS_User FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_ERROR_DETAILS_ResolvedBy FOREIGN KEY (ResolvedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## ORGANIZATION SCHEMA RELATIONSHIPS

### Organizational Structure Relationships

```sql
-- TENANT relationships
ALTER TABLE [organization].TENANT
ADD CONSTRAINT FK_TENANT_ParentTenant FOREIGN KEY (ParentTenantID) REFERENCES [organization].TENANT(TenantID),
    CONSTRAINT FK_TENANT_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TENANT_UpdatedBy FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- OFFICE relationships (extended)
ALTER TABLE [system].OFFICE
ADD CONSTRAINT FK_OFFICE_Tenant FOREIGN KEY (TenantID) REFERENCES [organization].TENANT(TenantID);
GO
```

## PAYMENT SCHEMA RELATIONSHIPS

### Payment Processing Relationships

```sql
-- PAYMENT relationships
ALTER TABLE [payment].PAYMENT
ADD CONSTRAINT FK_PAYMENT_HoSo FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID) ON DELETE CASCADE,
    CONSTRAINT FK_PAYMENT_Payer FOREIGN KEY (PayerUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_PAYMENT_ProcessedBy FOREIGN KEY (ProcessedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_PAYMENT_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- PAYMENT_HISTORY relationships
ALTER TABLE [payment].PAYMENT_HISTORY
ADD CONSTRAINT FK_PAYMENT_HIST_Payment FOREIGN KEY (PaymentID) REFERENCES [payment].PAYMENT(PaymentID) ON DELETE CASCADE,
    CONSTRAINT FK_PAYMENT_HIST_ChangedBy FOREIGN KEY (ChangedBy) REFERENCES [identity].USER_PROFILE(UserID);

-- REFUND relationships
ALTER TABLE [payment].REFUND
ADD CONSTRAINT FK_REFUND_Payment FOREIGN KEY (PaymentID) REFERENCES [payment].PAYMENT(PaymentID) ON DELETE CASCADE,
    CONSTRAINT FK_REFUND_ProcessedBy FOREIGN KEY (ProcessedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_REFUND_ApprovedBy FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## CROSS-SCHEMA COMPLEX RELATIONSHIPS

### Complex Business Relationships

```sql
-- HoSo to Workflow Instance (many-to-one)
ALTER TABLE [case].HOSO
ADD CONSTRAINT FK_HOSO_WorkflowInstance FOREIGN KEY (WorkflowInstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID);

-- Workflow Instance to HoSo (one-to-one for case workflows)
ALTER TABLE [workflow].WORKFLOW_INSTANCE
ADD CONSTRAINT FK_WORKFLOW_INST_HoSo FOREIGN KEY (RelatedEntityID) REFERENCES [case].HOSO(HoSoID)
    WHERE RelatedEntityType = 'HOSO';

-- Document to Workflow Step (many-to-many through step instances)
ALTER TABLE [document].DOCUMENT
ADD CONSTRAINT FK_DOCUMENT_WorkflowStep FOREIGN KEY (WorkflowStepInstanceID) REFERENCES [workflow].WORKFLOW_STEP_INSTANCE(StepInstanceID);

-- Task Assignment to Workflow Step Instance (one-to-one)
ALTER TABLE [case].TASK_ASSIGNMENT
ADD CONSTRAINT FK_TASK_ASSIGN_WorkflowStepInst FOREIGN KEY (WorkflowStepInstanceID) REFERENCES [workflow].WORKFLOW_STEP_INSTANCE(StepInstanceID);

-- SLA Tracking to multiple entities
ALTER TABLE [case].SLA_TRACKING
ADD CONSTRAINT FK_SLA_TRACK_WorkflowStepInst FOREIGN KEY (WorkflowStepInstanceID) REFERENCES [workflow].WORKFLOW_STEP_INSTANCE(StepInstanceID);

-- Notification Queue to multiple entity types
ALTER TABLE [notification].NOTIFICATION_QUEUE
ADD CONSTRAINT FK_NOTIF_QUEUE_HoSo FOREIGN KEY (RelatedEntityID) REFERENCES [case].HOSO(HoSoID)
    WHERE RelatedEntityType = 'HOSO',
ADD CONSTRAINT FK_NOTIF_QUEUE_User FOREIGN KEY (RelatedEntityID) REFERENCES [identity].USER_PROFILE(UserID)
    WHERE RelatedEntityType = 'USER',
ADD CONSTRAINT FK_NOTIF_QUEUE_Payment FOREIGN KEY (RelatedEntityID) REFERENCES [payment].PAYMENT(PaymentID)
    WHERE RelatedEntityType = 'PAYMENT';
GO
```

## REFERENTIAL INTEGRITY MONITORING

### Constraint Monitoring Views

```sql
-- Foreign key constraint violations check
CREATE VIEW [dbo].v_ForeignKeyViolations AS
SELECT
    fk.name AS ConstraintName,
    SCHEMA_NAME(fk.schema_id) AS SchemaName,
    OBJECT_NAME(fk.parent_object_id) AS TableName,
    COL_NAME(fkc.parent_object_id, fkc.parent_column_id) AS ColumnName,
    SCHEMA_NAME(pk.schema_id) AS ReferencedSchema,
    OBJECT_NAME(fk.referenced_object_id) AS ReferencedTable,
    COL_NAME(fkc.referenced_object_id, fkc.referenced_column_id) AS ReferencedColumn,
    fk.is_disabled AS IsDisabled,
    fk.is_not_trusted AS IsNotTrusted
FROM sys.foreign_keys fk
INNER JOIN sys.foreign_key_columns fkc ON fk.object_id = fkc.constraint_object_id
INNER JOIN sys.objects pk ON fk.referenced_object_id = pk.object_id
WHERE fk.is_not_trusted = 1 OR fk.is_disabled = 1;
GO

-- Orphaned records check procedure
CREATE PROCEDURE [dbo].sp_CheckOrphanedRecords
AS
BEGIN
    SET NOCOUNT ON;

    -- Check for orphaned task assignments
    SELECT COUNT(*) AS OrphanedTaskAssignments
    FROM [case].TASK_ASSIGNMENT ta
    LEFT JOIN [case].HOSO h ON ta.HoSoID = h.HoSoID
    WHERE h.HoSoID IS NULL;

    -- Check for orphaned workflow step instances
    SELECT COUNT(*) AS OrphanedWorkflowStepInstances
    FROM [workflow].WORKFLOW_STEP_INSTANCE wsi
    LEFT JOIN [workflow].WORKFLOW_INSTANCE wi ON wsi.WorkflowInstanceID = wi.InstanceID
    WHERE wi.InstanceID IS NULL;

    -- Check for orphaned documents
    SELECT COUNT(*) AS OrphanedDocuments
    FROM [document].DOCUMENT d
    LEFT JOIN [case].HOSO h ON d.RelatedHoSoID = h.HoSoID
    WHERE h.HoSoID IS NULL AND d.RelatedHoSoID IS NOT NULL;

    -- Add more orphan checks as needed
END
GO
```

## CASCADE BEHAVIOR DOCUMENTATION

### Cascade Rules Summary

| Parent Table | Child Table | Cascade Behavior | Reason |
|--------------|-------------|------------------|--------|
| HOSO | TASK_ASSIGNMENT | CASCADE | Tasks belong to cases |
| HOSO | CITIZEN_FEEDBACK | CASCADE | Feedback belongs to cases |
| HOSO | SLA_TRACKING | CASCADE | SLA tracking belongs to cases |
| WORKFLOW_INSTANCE | WORKFLOW_STEP_INSTANCE | CASCADE | Steps belong to instances |
| USER_PROFILE | USER_SESSIONS | CASCADE | Sessions belong to users |
| TTHC | DOCUMENT_TYPE | CASCADE | Document types belong to procedures |
| DOCUMENT | DOCUMENT_VERSION | CASCADE | Versions belong to documents |
| SHIPMENT_TRACKING | DELIVERY_CONFIRMATION | CASCADE | Confirmations belong to shipments |

### No-Cascade Rules (RESTRICT)

| Parent Table | Child Table | Reason |
|--------------|-------------|--------|
| USER_PROFILE | HOSO | Cannot delete users with active cases |
| OFFICE | USER_PROFILE | Cannot delete offices with assigned users |
| TTHC | HOSO | Cannot delete procedures with active cases |

## PERFORMANCE CONSIDERATIONS

### Index Support for Foreign Keys
- All foreign key columns automatically indexed
- Composite foreign keys use covering indexes
- Filtered indexes for soft-deleted relationships

### Constraint Checking Performance
- Foreign key constraints defer checking until transaction commit
- Bulk operations use NOCHECK during load, re-enable after
- Partitioned tables maintain referential integrity across partitions

This comprehensive foreign key relationship design ensures data integrity while supporting the high-performance requirements of the DVC v2 system.