# [json_normalized] Schema - JSON Column Normalization

## OVERVIEW

The `[json_normalized]` schema contains normalized relational tables for critical JSON columns found throughout the DVC v2 system. This normalization improves performance, enables proper indexing, and supports complex queries that were previously difficult with JSON storage.

## SCHEMA CREATION

```sql
-- JSON Normalization
CREATE SCHEMA [json_normalized];
GO
```

## ADDRESS NORMALIZATION

### 1. ADDRESS_COMPONENTS - Normalized postal addresses

```sql
CREATE TABLE [json_normalized].ADDRESS_COMPONENTS (
    AddressID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- SHIPMENT_TRACKING, CITIZEN_PROFILE, etc.
    SourceID BIGINT NOT NULL, -- ID from source table
    AddressType NVARCHAR(50) NOT NULL, -- SENDER, RECEIVER, BILLING, DELIVERY, PERSONAL, WORK

    -- Vietnamese administrative levels
    ProvinceCode NVARCHAR(10), -- Mã tỉnh/thành phố
    ProvinceName NVARCHAR(100), -- Tên tỉnh/thành phố
    DistrictCode NVARCHAR(10), -- Mã quận/huyện
    DistrictName NVARCHAR(100), -- Tên quận/huyện
    WardCode NVARCHAR(10), -- Mã phường/xã
    WardName NVARCHAR(100), -- Tên phường/xã

    -- Detailed address
    StreetNumber NVARCHAR(50), -- Số nhà
    StreetName NVARCHAR(200), -- Tên đường
    Building NVARCHAR(100), -- Tòa nhà
    Floor NVARCHAR(20), -- Tầng
    Apartment NVARCHAR(50), -- Số căn hộ

    -- Full address
    FullAddress NVARCHAR(500) NOT NULL, -- Complete formatted address

    -- Geolocation
    Latitude DECIMAL(10, 8), -- GPS latitude
    Longitude DECIMAL(11, 8), -- GPS longitude

    -- Delivery metadata
    IsVerified BIT DEFAULT 0, -- Address verified by postal service
    DeliveryDifficulty TINYINT DEFAULT 1, -- 1=Easy, 2=Moderate, 3=Difficult, 4=Very Difficult
    SpecialInstructions NVARCHAR(500), -- Delivery instructions

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2
);
GO

CREATE INDEX IX_ADDRESS_COMPONENTS_Source ON [json_normalized].ADDRESS_COMPONENTS(SourceTable, SourceID);
CREATE INDEX IX_ADDRESS_COMPONENTS_Location ON [json_normalized].ADDRESS_COMPONENTS(ProvinceCode, DistrictCode, WardCode);
CREATE INDEX IX_ADDRESS_COMPONENTS_Geo ON [json_normalized].ADDRESS_COMPONENTS(Latitude, Longitude) WHERE Latitude IS NOT NULL;
GO
```

## DOCUMENT METADATA NORMALIZATION

### 2. DOCUMENT_METADATA - Normalized document properties

```sql
CREATE TABLE [json_normalized].DOCUMENT_METADATA (
    MetadataID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- DOCUMENT, SHIPMENT_TRACKING, etc.
    SourceID BIGINT NOT NULL,

    -- Metadata properties
    MetadataKey NVARCHAR(100) NOT NULL, -- Property name
    MetadataValue NVARCHAR(MAX), -- Property value
    DataType NVARCHAR(50) NOT NULL, -- STRING, NUMBER, DATE, BOOLEAN, ARRAY

    -- Array handling
    ArrayIndex INT, -- For array values, the index position
    ParentKey NVARCHAR(100), -- For nested objects, the parent key

    -- Metadata about metadata
    IsRequired BIT DEFAULT 0,
    IsSearchable BIT DEFAULT 1,
    DisplayOrder INT DEFAULT 999,

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2
);
GO

CREATE INDEX IX_DOCUMENT_METADATA_Source ON [json_normalized].DOCUMENT_METADATA(SourceTable, SourceID);
CREATE INDEX IX_DOCUMENT_METADATA_Key ON [json_normalized].DOCUMENT_METADATA(MetadataKey, DataType);
CREATE INDEX IX_DOCUMENT_METADATA_Searchable ON [json_normalized].DOCUMENT_METADATA(IsSearchable, MetadataKey) WHERE IsSearchable = 1;
GO
```

## CONFIGURATION NORMALIZATION

### 3. CONFIGURATION_ITEMS - Normalized system configurations

```sql
CREATE TABLE [json_normalized].CONFIGURATION_ITEMS (
    ConfigID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- SYSTEM_CONFIGURATION, etc.
    SourceID BIGINT NOT NULL,

    -- Configuration hierarchy
    ConfigCategory NVARCHAR(100) NOT NULL, -- FEATURE_FLAGS, VALIDATION_RULES, etc.
    ConfigKey NVARCHAR(200) NOT NULL, -- Configuration key
    ConfigPath NVARCHAR(500), -- Nested path (e.g., "features.workflow.escalation.enabled")

    -- Value and type
    ConfigValue NVARCHAR(MAX), -- Configuration value
    ValueType NVARCHAR(50) NOT NULL, -- STRING, NUMBER, BOOLEAN, JSON, ARRAY
    DefaultValue NVARCHAR(MAX), -- Default value if not set

    -- Validation and constraints
    AllowedValues NVARCHAR(MAX), -- JSON array of allowed values
    ValidationPattern NVARCHAR(500), -- Regex pattern for validation
    MinValue DECIMAL(18,4), -- For numeric values
    MaxValue DECIMAL(18,4), -- For numeric values

    -- Metadata
    Description NVARCHAR(1000), -- Configuration description
    IsRequired BIT DEFAULT 0,
    IsSensitive BIT DEFAULT 0, -- Contains sensitive data
    RequiresRestart BIT DEFAULT 0, -- Requires system restart to take effect

    -- Environment and scope
    Environment NVARCHAR(50), -- DEVELOPMENT, STAGING, PRODUCTION
    TenantID BIGINT, -- Tenant-specific configuration
    OfficeID BIGINT, -- Office-specific configuration

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2
);
GO

CREATE INDEX IX_CONFIG_ITEMS_Source ON [json_normalized].CONFIGURATION_ITEMS(SourceTable, SourceID);
CREATE INDEX IX_CONFIG_ITEMS_Category ON [json_normalized].CONFIGURATION_ITEMS(ConfigCategory, ConfigKey);
CREATE INDEX IX_CONFIG_ITEMS_Environment ON [json_normalized].CONFIGURATION_ITEMS(Environment, TenantID, OfficeID);
CREATE INDEX IX_CONFIG_ITEMS_Required ON [json_normalized].CONFIGURATION_ITEMS(IsRequired, ConfigKey) WHERE IsRequired = 1;
GO
```

## BUSINESS RULES NORMALIZATION

### 4. BUSINESS_RULES - Normalized business rule definitions

```sql
CREATE TABLE [json_normalized].BUSINESS_RULES (
    RuleID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- WORKFLOW_DEFINITION, TTHC, etc.
    SourceID BIGINT NOT NULL,

    -- Rule identification
    RuleCategory NVARCHAR(100) NOT NULL, -- VALIDATION, ASSIGNMENT, ESCALATION, ROUTING
    RuleType NVARCHAR(100) NOT NULL, -- CONDITION, ACTION, TRIGGER
    RuleName NVARCHAR(200) NOT NULL,
    RuleCode NVARCHAR(100), -- Unique rule code

    -- Rule definition
    Condition NVARCHAR(MAX), -- Rule condition (when to apply)
    Action NVARCHAR(MAX), -- Rule action (what to do)
    Priority INT DEFAULT 100, -- Rule priority (lower = higher priority)

    -- Execution context
    ExecutionOrder INT DEFAULT 1, -- Order within same priority
    IsActive BIT DEFAULT 1,
    CanOverride BIT DEFAULT 0, -- Can be overridden by higher authority

    -- Scope and applicability
    ApplicableStates NVARCHAR(MAX), -- JSON array of states where rule applies
    ApplicableRoles NVARCHAR(MAX), -- JSON array of roles for which rule applies
    ApplicableOffices NVARCHAR(MAX), -- JSON array of offices where rule applies

    -- Rule parameters
    Parameters NVARCHAR(MAX), -- JSON parameters for rule execution
    ThresholdValues NVARCHAR(MAX), -- JSON threshold values
    TimeConstraints NVARCHAR(MAX), -- JSON time-based constraints

    -- Error handling
    OnFailureAction NVARCHAR(200), -- STOP, CONTINUE, ESCALATE, NOTIFY
    ErrorMessage NVARCHAR(1000), -- Error message template

    -- Performance and monitoring
    AverageExecutionTimeMs INT DEFAULT 0,
    FailureRate DECIMAL(5,2) DEFAULT 0.00,
    LastExecuted DATETIME2,

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    CreatedBy BIGINT,
    UpdatedBy BIGINT
);
GO

CREATE INDEX IX_BUSINESS_RULES_Source ON [json_normalized].BUSINESS_RULES(SourceTable, SourceID);
CREATE INDEX IX_BUSINESS_RULES_Category ON [json_normalized].BUSINESS_RULES(RuleCategory, RuleType);
CREATE INDEX IX_BUSINESS_RULES_Active ON [json_normalized].BUSINESS_RULES(IsActive, Priority, ExecutionOrder) WHERE IsActive = 1;
CREATE INDEX IX_BUSINESS_RULES_Code ON [json_normalized].BUSINESS_RULES(RuleCode) WHERE RuleCode IS NOT NULL;
GO
```

## VALIDATION RULES NORMALIZATION

### 5. VALIDATION_RULES - Normalized validation rule definitions

```sql
CREATE TABLE [json_normalized].VALIDATION_RULES (
    ValidationID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- DOCUMENT_TYPE, FORM_FIELD, etc.
    SourceID BIGINT NOT NULL,

    -- Field identification
    FieldName NVARCHAR(200) NOT NULL, -- Field being validated
    FieldPath NVARCHAR(500), -- Nested field path

    -- Validation type
    ValidationType NVARCHAR(100) NOT NULL, -- REQUIRED, FORMAT, RANGE, CUSTOM, REGEX

    -- Validation parameters
    IsRequired BIT DEFAULT 0,
    MinLength INT,
    MaxLength INT,
    MinValue DECIMAL(18,4),
    MaxValue DECIMAL(18,4),
    RegexPattern NVARCHAR(1000),
    AllowedValues NVARCHAR(MAX), -- JSON array
    ForbiddenValues NVARCHAR(MAX), -- JSON array

    -- Custom validation
    CustomValidationFunction NVARCHAR(200), -- Function name for custom validation
    CustomValidationScript NVARCHAR(MAX), -- JavaScript or SQL script

    -- Conditional validation
    ConditionalOn NVARCHAR(200), -- Field this validation depends on
    ConditionalValue NVARCHAR(500), -- Value that triggers this validation
    ConditionalOperator NVARCHAR(20), -- EQUALS, NOT_EQUALS, GREATER_THAN, etc.

    -- Error handling
    ErrorMessage NVARCHAR(1000) NOT NULL,
    ErrorCode NVARCHAR(50),
    Severity NVARCHAR(20) DEFAULT 'ERROR', -- ERROR, WARNING, INFO

    -- Validation metadata
    ValidationOrder INT DEFAULT 100, -- Order of validation execution
    IsActive BIT DEFAULT 1,
    CanSkip BIT DEFAULT 0, -- Can be skipped by user with permission

    -- Performance tracking
    AverageValidationTimeMs INT DEFAULT 0,
    FailureRate DECIMAL(5,2) DEFAULT 0.00,

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    CreatedBy BIGINT,
    UpdatedBy BIGINT
);
GO

CREATE INDEX IX_VALIDATION_RULES_Source ON [json_normalized].VALIDATION_RULES(SourceTable, SourceID);
CREATE INDEX IX_VALIDATION_RULES_Field ON [json_normalized].VALIDATION_RULES(FieldName, ValidationType);
CREATE INDEX IX_VALIDATION_RULES_Active ON [json_normalized].VALIDATION_RULES(IsActive, ValidationOrder) WHERE IsActive = 1;
CREATE INDEX IX_VALIDATION_RULES_Conditional ON [json_normalized].VALIDATION_RULES(ConditionalOn) WHERE ConditionalOn IS NOT NULL;
GO
```

## NOTIFICATION PREFERENCES NORMALIZATION

### 6. NOTIFICATION_PREFERENCES - Normalized user notification settings

```sql
CREATE TABLE [json_normalized].NOTIFICATION_PREFERENCES (
    PreferenceID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- USER_PROFILE, CITIZEN_FEEDBACK, etc.
    SourceID BIGINT NOT NULL,
    UserID BIGINT NOT NULL,

    -- Notification category
    Category NVARCHAR(100) NOT NULL, -- WORKFLOW, PAYMENT, DOCUMENT, SYSTEM, MARKETING
    Subcategory NVARCHAR(100), -- More specific category

    -- Channel preferences
    EmailEnabled BIT DEFAULT 1,
    SMSEnabled BIT DEFAULT 1,
    PushEnabled BIT DEFAULT 1,
    InAppEnabled BIT DEFAULT 1,
    WebhookEnabled BIT DEFAULT 0,

    -- Contact information
    EmailAddress NVARCHAR(255),
    PhoneNumber NVARCHAR(20),
    WebhookURL NVARCHAR(1000),

    -- Frequency settings
    Frequency NVARCHAR(50) DEFAULT 'IMMEDIATE', -- IMMEDIATE, DAILY, WEEKLY, MONTHLY
    BatchDigest BIT DEFAULT 0, -- Group notifications into digest

    -- Time constraints
    QuietHoursStart TIME, -- No notifications after this time
    QuietHoursEnd TIME, -- No notifications before this time
    TimeZone NVARCHAR(100) DEFAULT 'Asia/Ho_Chi_Minh',
    WeekendDelivery BIT DEFAULT 1,

    -- Content preferences
    Language NVARCHAR(10) DEFAULT 'vi-VN',
    PreferHTMLFormat BIT DEFAULT 1,
    IncludeAttachments BIT DEFAULT 1,

    -- Priority filtering
    MinimumPriority TINYINT DEFAULT 1, -- Only receive notifications of this priority or higher
    MaxDailyNotifications INT DEFAULT 50, -- Limit daily notification count

    -- Metadata
    IsActive BIT DEFAULT 1,
    LastUsed DATETIME2, -- Last time this preference was used

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2
);
GO

CREATE INDEX IX_NOTIFICATION_PREF_Source ON [json_normalized].NOTIFICATION_PREFERENCES(SourceTable, SourceID);
CREATE INDEX IX_NOTIFICATION_PREF_User ON [json_normalized].NOTIFICATION_PREFERENCES(UserID, Category);
CREATE INDEX IX_NOTIFICATION_PREF_Active ON [json_normalized].NOTIFICATION_PREFERENCES(IsActive, Category) WHERE IsActive = 1;
GO
```

## FORM FIELD DEFINITIONS NORMALIZATION

### 7. FORM_FIELDS - Normalized form field configurations

```sql
CREATE TABLE [json_normalized].FORM_FIELDS (
    FieldID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- WORKFLOW_STEP, DOCUMENT_TYPE, etc.
    SourceID BIGINT NOT NULL,

    -- Field identification
    FieldName NVARCHAR(200) NOT NULL,
    FieldCode NVARCHAR(100), -- Unique field code
    FieldPath NVARCHAR(500), -- Nested field path for complex forms

    -- Field properties
    FieldType NVARCHAR(50) NOT NULL, -- TEXT, NUMBER, DATE, SELECT, CHECKBOX, FILE, etc.
    DataType NVARCHAR(50) NOT NULL, -- STRING, INTEGER, DECIMAL, BOOLEAN, DATE, FILE

    -- Display properties
    Label NVARCHAR(255) NOT NULL,
    Placeholder NVARCHAR(255),
    HelpText NVARCHAR(1000),
    Tooltip NVARCHAR(500),

    -- Layout and styling
    DisplayOrder INT DEFAULT 100,
    ColumnSpan INT DEFAULT 1, -- Bootstrap column span
    CSSClass NVARCHAR(200),

    -- Field behavior
    IsRequired BIT DEFAULT 0,
    IsReadOnly BIT DEFAULT 0,
    IsVisible BIT DEFAULT 1,
    IsSearchable BIT DEFAULT 0,

    -- Conditional display
    ConditionalDisplayField NVARCHAR(200), -- Field that controls visibility
    ConditionalDisplayValue NVARCHAR(500), -- Value that makes this field visible
    ConditionalDisplayOperator NVARCHAR(20), -- EQUALS, NOT_EQUALS, etc.

    -- Options for select fields
    OptionsSource NVARCHAR(100), -- STATIC, DATABASE, API, LOOKUP
    StaticOptions NVARCHAR(MAX), -- JSON array for static options
    DatabaseQuery NVARCHAR(MAX), -- SQL query for database options
    APIEndpoint NVARCHAR(500), -- API endpoint for dynamic options
    LookupTableName NVARCHAR(100), -- Lookup table name

    -- File upload settings
    AllowedFileTypes NVARCHAR(500), -- JSON array of allowed extensions
    MaxFileSize INT, -- Maximum file size in KB
    MaxFiles INT DEFAULT 1, -- Maximum number of files

    -- Default values
    DefaultValue NVARCHAR(MAX),
    DefaultValueExpression NVARCHAR(1000), -- Expression to calculate default

    -- Localization
    LocalizedLabels NVARCHAR(MAX), -- JSON object with translations
    LocalizedHelpText NVARCHAR(MAX), -- JSON object with translations

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    CreatedBy BIGINT,
    UpdatedBy BIGINT
);
GO

CREATE INDEX IX_FORM_FIELDS_Source ON [json_normalized].FORM_FIELDS(SourceTable, SourceID);
CREATE INDEX IX_FORM_FIELDS_Name ON [json_normalized].FORM_FIELDS(FieldName, FieldType);
CREATE INDEX IX_FORM_FIELDS_Code ON [json_normalized].FORM_FIELDS(FieldCode) WHERE FieldCode IS NOT NULL;
CREATE INDEX IX_FORM_FIELDS_Display ON [json_normalized].FORM_FIELDS(DisplayOrder, IsVisible) WHERE IsVisible = 1;
CREATE INDEX IX_FORM_FIELDS_Required ON [json_normalized].FORM_FIELDS(IsRequired, FieldName) WHERE IsRequired = 1;
GO
```

## ERROR DETAILS NORMALIZATION

### 8. ERROR_DETAILS - Normalized error information

```sql
CREATE TABLE [json_normalized].ERROR_DETAILS (
    ErrorDetailID BIGINT PRIMARY KEY IDENTITY,

    -- Source reference
    SourceTable NVARCHAR(100) NOT NULL, -- AUDIT_LOG, NOTIFICATION_QUEUE, etc.
    SourceID BIGINT NOT NULL,

    -- Error identification
    ErrorCode NVARCHAR(100) NOT NULL,
    ErrorType NVARCHAR(100) NOT NULL, -- VALIDATION, SYSTEM, BUSINESS, NETWORK, etc.
    ErrorCategory NVARCHAR(100), -- More specific categorization

    -- Error details
    ErrorMessage NVARCHAR(2000) NOT NULL,
    TechnicalMessage NVARCHAR(MAX), -- Technical details for developers
    UserFriendlyMessage NVARCHAR(1000), -- Message safe to show users

    -- Context information
    StackTrace NVARCHAR(MAX), -- Full stack trace
    RequestID NVARCHAR(100), -- Request identifier for correlation
    SessionID NVARCHAR(100), -- User session identifier
    CorrelationID NVARCHAR(100), -- Cross-system correlation ID

    -- Error location
    ServiceName NVARCHAR(100), -- Microservice that generated the error
    MethodName NVARCHAR(200), -- Method or function where error occurred
    LineNumber INT, -- Line number in code

    -- Environmental context
    ServerName NVARCHAR(100), -- Server where error occurred
    Environment NVARCHAR(50), -- DEVELOPMENT, STAGING, PRODUCTION
    Version NVARCHAR(50), -- Application version

    -- User context
    UserID BIGINT, -- User who experienced the error
    UserAgent NVARCHAR(1000), -- Browser/client information
    IPAddress NVARCHAR(45), -- Client IP address

    -- Resolution information
    IsResolved BIT DEFAULT 0,
    ResolutionNotes NVARCHAR(2000),
    ResolvedAt DATETIME2,
    ResolvedBy BIGINT,

    -- Severity and impact
    Severity NVARCHAR(20) NOT NULL, -- LOW, MEDIUM, HIGH, CRITICAL
    ImpactLevel NVARCHAR(20), -- INDIVIDUAL, TEAM, ORGANIZATION, SYSTEM

    -- Recurrence tracking
    FirstOccurrence DATETIME2 DEFAULT GETDATE(),
    LastOccurrence DATETIME2 DEFAULT GETDATE(),
    OccurrenceCount INT DEFAULT 1,

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2
);
GO

CREATE INDEX IX_ERROR_DETAILS_Source ON [json_normalized].ERROR_DETAILS(SourceTable, SourceID);
CREATE INDEX IX_ERROR_DETAILS_Code ON [json_normalized].ERROR_DETAILS(ErrorCode, ErrorType);
CREATE INDEX IX_ERROR_DETAILS_Severity ON [json_normalized].ERROR_DETAILS(Severity, CreatedAt DESC);
CREATE INDEX IX_ERROR_DETAILS_Unresolved ON [json_normalized].ERROR_DETAILS(IsResolved, Severity) WHERE IsResolved = 0;
CREATE INDEX IX_ERROR_DETAILS_Service ON [json_normalized].ERROR_DETAILS(ServiceName, CreatedAt DESC);
CREATE INDEX IX_ERROR_DETAILS_User ON [json_normalized].ERROR_DETAILS(UserID, CreatedAt DESC) WHERE UserID IS NOT NULL;
GO
```

## CROSS-SCHEMA RELATIONSHIPS

```sql
-- Foreign key relationships to normalized tables
ALTER TABLE [json_normalized].ADDRESS_COMPONENTS
ADD CONSTRAINT FK_ADDRESS_COMP_USER FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID);

ALTER TABLE [json_normalized].BUSINESS_RULES
ADD CONSTRAINT FK_BUSINESS_RULES_CREATED FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_BUSINESS_RULES_UPDATED FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

ALTER TABLE [json_normalized].VALIDATION_RULES
ADD CONSTRAINT FK_VALIDATION_RULES_CREATED FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_VALIDATION_RULES_UPDATED FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

ALTER TABLE [json_normalized].NOTIFICATION_PREFERENCES
ADD CONSTRAINT FK_NOTIF_PREF_USER FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID);

ALTER TABLE [json_normalized].FORM_FIELDS
ADD CONSTRAINT FK_FORM_FIELDS_CREATED FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_FORM_FIELDS_UPDATED FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID);

ALTER TABLE [json_normalized].ERROR_DETAILS
ADD CONSTRAINT FK_ERROR_DETAILS_USER FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_ERROR_DETAILS_RESOLVED FOREIGN KEY (ResolvedBy) REFERENCES [identity].USER_PROFILE(UserID);
GO
```

## MIGRATION VIEWS

To help with migration from JSON columns to normalized tables, create views that maintain backward compatibility:

```sql
-- Example view for backward compatibility
CREATE VIEW [json_normalized].v_AddressJSON AS
SELECT
    SourceTable,
    SourceID,
    AddressType,
    JSON_OBJECT(
        'provinceCode', ProvinceCode,
        'provinceName', ProvinceName,
        'districtCode', DistrictCode,
        'districtName', DistrictName,
        'wardCode', WardCode,
        'wardName', WardName,
        'streetNumber', StreetNumber,
        'streetName', StreetName,
        'building', Building,
        'floor', Floor,
        'apartment', Apartment,
        'fullAddress', FullAddress,
        'latitude', Latitude,
        'longitude', Longitude,
        'isVerified', IsVerified,
        'deliveryDifficulty', DeliveryDifficulty,
        'specialInstructions', SpecialInstructions
    ) AS AddressJSON
FROM [json_normalized].ADDRESS_COMPONENTS;
GO
```

## PERFORMANCE BENEFITS

### Query Performance Improvements
1. **Indexed Searches**: Proper indexes on normalized columns vs JSON path searches
2. **Join Operations**: Native SQL joins vs JSON parsing
3. **Aggregation**: Direct column aggregation vs JSON extraction
4. **Filtering**: WHERE clauses on columns vs JSON_VALUE functions

### Storage Optimization
1. **Data Compression**: Repeated values stored once vs duplicated in JSON
2. **Type Safety**: Native data types vs string representation in JSON
3. **Referential Integrity**: Foreign key constraints vs loose JSON references

### Maintenance Benefits
1. **Schema Evolution**: ALTER TABLE vs JSON structure changes
2. **Data Validation**: CHECK constraints vs application-level validation
3. **Backup/Recovery**: Column-level recovery vs full JSON reconstruction
4. **Migration**: Structured data migration vs JSON parsing/transformation

This normalization schema addresses the 73 identified JSON columns by providing proper relational structures for the most commonly used JSON data patterns in the DVC v2 system.