# [organization] Schema - Organization Management

## OVERVIEW

The `[organization]` schema handles organizational structure and administrative unit management for the DVC v2 system. It manages the hierarchical structure of Vietnamese government organizations from central to commune levels.

## SCHEMA CREATION

```sql
-- Organization Management
CREATE SCHEMA [organization];
GO
```

## MAIN ORGANIZATION TABLE

### 1. DM_DONVI - Administrative units/organizations

```sql
CREATE TABLE [organization].DM_DONVI (
    DonViID BIGINT PRIMARY KEY IDENTITY,
    DonViChaID BIGINT,
    MaDonVi NVARCHAR(50) UNIQUE NOT NULL,
    TenDonVi NVARCHAR(255) NOT NULL,
    TenDayDu NVARCHAR(500),
    TenTiengAnh NVARCHAR(255),

    -- Hierarchy & Classification
    CapDonVi TINYINT NOT NULL, -- 1=TW, 2=Tỉnh, 3=Huyện, 4=Xã
    LoaiDonVi NVARCHAR(50), -- ủy ban, sở, phòng, trung tâm
    Level INT,
    HierarchyPath NVARCHAR(500),

    -- Administrative division
    TinhID INT,
    HuyenID INT,
    PhuongXaID INT,
    TinhThanhCode NVARCHAR(20),
    TenantID BIGINT NOT NULL, -- Multi-tenant support

    -- Contact information
    DiaChiChiTiet NVARCHAR(500),
    Email NVARCHAR(255),
    SoDienThoai NVARCHAR(20),
    Website NVARCHAR(255),

    -- Business information
    MST NVARCHAR(20), -- Tax code
    TaiKhoanNganHang NVARCHAR(50),
    NganHang NVARCHAR(255),

    -- Operational details
    ThoiGianLamViec NVARCHAR(200),
    NgayNghiLe NVARCHAR(MAX), -- JSON array of holidays
    SoLuongCanBo INT DEFAULT 0,
    SucChuaPhanCong INT DEFAULT 100,

    -- Digital transformation
    SupportOnlineServices BIT DEFAULT 1,
    HasDigitalSignature BIT DEFAULT 0,
    IntegrationLevel TINYINT DEFAULT 1,

    -- Service delivery
    ReceiptMethods NVARCHAR(MAX), -- JSON array
    DeliveryMethods NVARCHAR(MAX), -- JSON array
    PaymentMethods NVARCHAR(MAX), -- JSON array

    -- Audit
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_DONVI_Parent FOREIGN KEY (DonViChaID) REFERENCES [organization].DM_DONVI(DonViID)
);
GO

-- Indexes
CREATE INDEX IX_DonVi_Ma ON [organization].DM_DONVI(MaDonVi);
CREATE INDEX IX_DonVi_Parent ON [organization].DM_DONVI(DonViChaID);
CREATE INDEX IX_DonVi_Level ON [organization].DM_DONVI(CapDonVi, Level);
CREATE INDEX IX_DonVi_Tenant ON [organization].DM_DONVI(TenantID);
CREATE INDEX IX_DonVi_Hierarchy ON [organization].DM_DONVI(HierarchyPath);
CREATE INDEX IX_DonVi_Active ON [organization].DM_DONVI(IsActive, CapDonVi);
GO
```

## ORGANIZATION-FIELD RELATIONSHIPS

### 2. DM_DONVI_LINHVUC - Organization domain/field mapping

```sql
CREATE TABLE [organization].DM_DONVI_LINHVUC (
    ID BIGINT PRIMARY KEY IDENTITY,
    DonViID BIGINT NOT NULL,
    LinhVucID INT NOT NULL,
    IsPrimary BIT DEFAULT 0,
    CanProcess BIT DEFAULT 1,
    ProcessingCapacity INT DEFAULT 10,
    ExpertiseLevel TINYINT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),

    CONSTRAINT FK_DONVI_LINHVUC_DONVI FOREIGN KEY (DonViID) REFERENCES [organization].DM_DONVI(DonViID),
    CONSTRAINT FK_DONVI_LINHVUC_LINHVUC FOREIGN KEY (LinhVucID) REFERENCES [lookup].DM_QG_LINHVUC(LinhVucID)
);
GO

CREATE INDEX IX_DonVi_LinhVuc ON [organization].DM_DONVI_LINHVUC(DonViID, LinhVucID);
CREATE INDEX IX_DonVi_LinhVuc_Primary ON [organization].DM_DONVI_LINHVUC(LinhVucID, IsPrimary);
GO
```

## KEY FEATURES

### Hierarchical Organization Structure
- **Multi-level Hierarchy**: Support for Vietnamese administrative levels (Central → Provincial → District → Commune)
- **Fast Hierarchy Queries**: Optimized path-based hierarchy navigation
- **Flexible Structure**: Support for various organization types within each level
- **Parent-Child Relationships**: Clear organizational reporting structure

### Multi-tenant Support
- **Tenant Isolation**: Complete data separation by tenant
- **Provincial Independence**: Each province can operate independently
- **Shared Infrastructure**: Common organizational patterns across tenants

### Digital Transformation Support
- **Service Capabilities**: Track digital service readiness
- **Integration Levels**: Measure and manage digital transformation progress
- **Digital Signature Support**: PKI integration capabilities
- **Online Service Flags**: Enable/disable online services per organization

### Operational Management
- **Capacity Management**: Track staff and processing capacity
- **Working Hours**: Flexible working time configuration
- **Holiday Management**: JSON-based holiday calendar
- **Contact Information**: Complete contact details for citizen access

### Service Delivery Configuration
- **Receipt Methods**: Configure how applications are received
- **Delivery Methods**: Configure how results are delivered
- **Payment Methods**: Configure supported payment options
- **Processing Capacity**: Workload management and distribution

## SAMPLE ORGANIZATION HIERARCHY

### Central Level (CapDonVi = 1)
- Ministries (Bộ)
- Central agencies (Cơ quan trung ương)
- National committees (Ủy ban quốc gia)

### Provincial Level (CapDonVi = 2)
- Provincial People's Committees (UBND Tỉnh)
- Provincial departments (Sở)
- Provincial agencies (Cơ quan Tỉnh)

### District Level (CapDonVi = 3)
- District People's Committees (UBND Huyện/Quận)
- District departments (Phòng)
- District offices (Văn phòng Huyện)

### Commune Level (CapDonVi = 4)
- Commune People's Committees (UBND Xã/Phường)
- One-stop service centers (Trung tâm một cửa)
- Local administrative offices

## CROSS-SCHEMA INTEGRATION

### Views for Other Schemas
```sql
-- View for TTHC service to access organization data
CREATE VIEW [tthc].v_DonViInfo
AS
SELECT
    DonViID,
    MaDonVi,
    TenDonVi,
    CapDonVi,
    TenantID,
    IsActive,
    SupportOnlineServices,
    HasDigitalSignature
FROM [organization].DM_DONVI
WHERE IsActive = 1;
GO

-- View for case service to access organization processing capacity
CREATE VIEW [case].v_DonViCapacity
AS
SELECT
    DonViID,
    MaDonVi,
    TenDonVi,
    SoLuongCanBo,
    SucChuaPhanCong,
    ThoiGianLamViec
FROM [organization].DM_DONVI
WHERE IsActive = 1 AND SupportOnlineServices = 1;
GO
```

### Event-Driven Integration
```sql
-- Events published by organization service
-- OrganizationCreated
-- OrganizationUpdated
-- OrganizationDeactivated
-- OrganizationCapacityChanged
-- OrganizationServiceConfigUpdated
```

## BUSINESS RULES

### Hierarchy Validation
- Organizations must have valid parent-child relationships
- Hierarchy depth cannot exceed 6 levels
- Circular references are prevented
- Level consistency must be maintained

### Capacity Management
- Processing capacity cannot exceed staff capacity
- Workload distribution based on expertise levels
- Automatic capacity adjustment based on performance metrics
- Holiday calendar affects capacity calculations

### Service Configuration
- Online services require digital signature capability
- Payment methods must be supported by the organization
- Delivery methods must align with organizational capabilities
- Receipt methods determine service channel availability

### Multi-tenant Rules
- Organizations belong to exactly one tenant
- Cross-tenant organization relationships are not allowed
- Tenant-specific configuration inheritance
- Data isolation at the tenant level

## PERFORMANCE CONSIDERATIONS

### Indexing Strategy
- Hierarchy path indexing for fast tree traversal
- Tenant-aware indexing for multi-tenant queries
- Composite indexes for common query patterns
- Foreign key indexes for join optimization

### Caching Strategy
- Organization hierarchy cached at application level
- Service configuration cached with TTL
- Capacity information updated in real-time
- Holiday calendars cached annually

### Query Optimization
- Materialized hierarchy paths for fast lookups
- Denormalized service flags for quick filtering
- Optimized joins with lookup tables
- Bulk operations for hierarchy updates

## MIGRATION CONSIDERATIONS

### From Legacy Systems
- Data mapping from existing organizational structures
- Hierarchy reconstruction and validation
- Service capability assessment and migration
- Contact information consolidation

### To Microservices
- Organization service extraction
- API design for hierarchy operations
- Event-driven updates to dependent services
- Eventual consistency for distributed operations

### Data Archiving
- Historical organization structure preservation
- Inactive organization data retention
- Audit trail for organizational changes
- Compliance with government retention policies

## MAINTENANCE PROCEDURES

### Regular Maintenance
- Hierarchy integrity validation
- Capacity utilization monitoring
- Service configuration audit
- Contact information verification

### Performance Monitoring
- Query performance analysis
- Index utilization review
- Cache hit rate monitoring
- Hierarchy operation timing

### Data Quality
- Duplicate organization detection
- Inconsistent hierarchy identification
- Missing contact information alerts
- Service configuration validation