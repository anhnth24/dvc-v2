# [payment] Schema - Payment Processing

## OVERVIEW

The `[payment]` schema handles fee collection and payment transaction management for the DVC v2 system. It manages all payment-related operations including fees, taxes, online payments, and financial reconciliation.

## SCHEMA CREATION

```sql
-- Payment
CREATE SCHEMA [payment];
GO
```

## MAIN PAYMENT TABLE

### 1. PHILEPHI_GIAODICH - Payment transactions and fee records

```sql
CREATE TABLE [payment].PHILEPHI_GIAODICH (
    PhiLePhiGiaoDichID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,
    MaHoSo NVARCHAR(100),

    -- Transaction amounts
    Phi DECIMAL(18,2) DEFAULT 0,
    LePhi DECIMAL(18,2) DEFAULT 0,
    UuTien DECIMAL(18,2) DEFAULT 0, -- Express fee
    TongTien AS (Phi + LePhi + UuTien) PERSISTED,

    -- Transaction details
    NoiDung NVARCHAR(1000),
    MaGiaoDich NVARCHAR(255) UNIQUE,
    MaGiaoDichNganHang NVARCHAR(255), -- Bank transaction ID

    -- Workflow context
    WorkflowInstanceId NVARCHAR(255),
    StepID NVARCHAR(255), -- Payment step in workflow

    -- Payment method
    HinhThucThanhToanID INT, -- From DM_HINHTHUCTHANHTOAN
    TenHinhThucThanhToan NVARCHAR(255),

    -- Payment status
    TrangThaiThanhToan TINYINT DEFAULT 0, -- 0=Pending, 1=Paid, 2=Failed, 3=Refunded
    NgayThanhToan DATETIME2,
    NgayXacNhan DATETIME2,
    NgayHetHan DATETIME2,

    -- Payment gateway integration
    PaymentGateway NVARCHAR(100),
    GatewayTransactionID NVARCHAR(255),
    GatewayResponse NVARCHAR(MAX), -- JSON response from gateway

    -- Bank information
    TenNganHang NVARCHAR(255),
    SoTaiKhoan NVARCHAR(50),
    TenChuTaiKhoan NVARCHAR(255),

    -- Citizen information
    NguoiThanhToanID BIGINT,
    TenNguoiThanhToan NVARCHAR(255),
    SoDienThoaiThanhToan NVARCHAR(20),
    EmailThanhToan NVARCHAR(255),

    -- Receipt information
    SoBienLai NVARCHAR(100),
    NgayXuatBienLai DATETIME2,
    NoiDungBienLai NVARCHAR(1000),

    -- Refund information
    LyDoHoanTien NVARCHAR(1000),
    NgayHoanTien DATETIME2,
    SoTienHoanTien DECIMAL(18,2),
    MaGiaoDichHoanTien NVARCHAR(255),

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT
);
GO

-- Indexes
CREATE INDEX IX_PAYMENT_HoSo ON [payment].PHILEPHI_GIAODICH(HoSoID);
CREATE INDEX IX_PAYMENT_MaGiaoDich ON [payment].PHILEPHI_GIAODICH(MaGiaoDich);
CREATE INDEX IX_PAYMENT_TrangThai ON [payment].PHILEPHI_GIAODICH(TrangThaiThanhToan, NgayThanhToan);
CREATE INDEX IX_PAYMENT_NgayThanhToan ON [payment].PHILEPHI_GIAODICH(NgayThanhToan DESC);
CREATE INDEX IX_PAYMENT_Gateway ON [payment].PHILEPHI_GIAODICH(PaymentGateway, GatewayTransactionID);
CREATE INDEX IX_PAYMENT_Workflow ON [payment].PHILEPHI_GIAODICH(WorkflowInstanceId, StepID);
GO
```

## PAYMENT RECONCILIATION

### 2. PAYMENT_RECONCILIATION - Bank reconciliation records

```sql
CREATE TABLE [payment].PAYMENT_RECONCILIATION (
    ReconciliationID BIGINT PRIMARY KEY IDENTITY,
    ReconciliationDate DATE NOT NULL,
    BankCode NVARCHAR(50) NOT NULL,
    AccountNumber NVARCHAR(50) NOT NULL,

    -- Reconciliation status
    Status TINYINT DEFAULT 0, -- 0=Pending, 1=Matched, 2=Discrepancy, 3=Resolved
    TotalSystemAmount DECIMAL(18,2) NOT NULL,
    TotalBankAmount DECIMAL(18,2) NOT NULL,
    Variance AS (TotalSystemAmount - TotalBankAmount) PERSISTED,

    -- File information
    BankFileID NVARCHAR(255),
    FileName NVARCHAR(255),
    ProcessedAt DATETIME2,
    ProcessedBy BIGINT,

    -- Resolution
    ResolvedAt DATETIME2,
    ResolvedBy BIGINT,
    ResolutionNotes NVARCHAR(2000),

    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL
);
GO
```

## KEY FEATURES

### Multi-Payment Type Support
- **Service Fees (Phí)**: Government service charges
- **Administrative Fees (Lệ Phí)**: Legal administrative costs
- **Express Fees (Ưu Tiên)**: Priority processing charges
- **Combined Calculations**: Automatic total computation

### Payment Gateway Integration
- **Multiple Gateways**: Support for various Vietnamese payment providers
- **Response Handling**: Comprehensive gateway response storage
- **Transaction Tracking**: Complete payment lifecycle management
- **Error Handling**: Failed transaction recovery and retry

### Financial Reconciliation
- **Bank Integration**: Automatic bank statement processing
- **Variance Detection**: Discrepancy identification and resolution
- **Audit Compliance**: Complete financial audit trail
- **Multi-Bank Support**: Integration with multiple banking partners

### Workflow Integration
- **Payment Steps**: Integration with Elsa workflow engine
- **Status Synchronization**: Real-time payment status updates
- **Conditional Processing**: Payment-dependent workflow advancement
- **Timeout Handling**: Automatic payment expiration management

## CROSS-SCHEMA INTEGRATION

### Case Service Integration
```sql
-- View for case service to check payment status
CREATE VIEW [case].v_PaymentStatus
AS
SELECT
    p.HoSoID,
    p.TrangThaiThanhToan,
    p.TongTien,
    p.NgayThanhToan,
    p.MaGiaoDich
FROM [payment].PHILEPHI_GIAODICH p
WHERE p.TrangThaiThanhToan = 1; -- Paid only
GO
```

### Workflow Service Integration
- Payment completion triggers workflow continuation
- Payment timeout triggers escalation
- Refund requests trigger approval workflow
- Payment verification gates in process flow

## BUSINESS RULES

### Fee Calculation
- Fees based on TTHC configuration
- Express processing surcharges
- Multi-tier pricing for complex services
- Discount rules for online submissions

### Payment Validation
- Amount verification against TTHC rates
- Payment method compatibility checking
- Expiration date enforcement
- Duplicate payment prevention

### Refund Processing
- Automated refund eligibility checking
- Approval workflow for refund requests
- Partial refund calculations
- Refund audit trail maintenance

## PERFORMANCE CONSIDERATIONS

### High-Volume Processing
- Optimized for 800,000 transactions/month
- Batch processing for reconciliation
- Asynchronous gateway communications
- Efficient indexing for transaction queries

### Real-Time Requirements
- Sub-second payment status updates
- Immediate workflow notification
- Real-time balance checking
- Live payment gateway monitoring

### Scalability Features
- Horizontal scaling support
- Payment gateway load balancing
- Database partitioning by date
- Archive strategy for old transactions