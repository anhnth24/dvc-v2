# [case] Schema - Application Processing

## OVERVIEW

The `[case]` schema manages the complete lifecycle of administrative procedure applications (cases/dossiers) from submission to completion. It handles case processing, status tracking, document management, and integration with workflow and audit systems for the DVC v2 platform.

## SCHEMA CREATION

```sql
-- Case/Application Processing
CREATE SCHEMA [case];
GO
```

## CORE CASE MANAGEMENT TABLES

### 1. HOSO - Main case/application records

```sql
CREATE TABLE [case].HOSO (
    HoSoID BIGINT PRIMARY KEY IDENTITY,
    TTHCID BIGINT NOT NULL, -- Administrative procedure reference

    -- Case identification
    SoHoSo NVARCHAR(100) UNIQUE NOT NULL, -- Case number
    TenHoSo NVARCHAR(500) NOT NULL, -- Case title/name
    MoTaHoSo NVARCHAR(2000), -- Case description

    -- Submission information
    NgayNop DATETIME2 DEFAULT GETDATE(),
    NgayTiepNhan DATETIME2,
    KenhNop NVARCHAR(100), -- Online/Office/Mail/Mobile
    DiaDiemNop NVARCHAR(500), -- Submission location

    -- Applicant information
    NguoiNopID BIGINT NOT NULL, -- Applicant user ID
    ThongTinNguoiNop NVARCHAR(MAX), -- JSON applicant details
    DaiDien NVARCHAR(300), -- Legal representative
    ThongTinLienHe NVARCHAR(MAX), -- JSON contact information

    -- Processing organization
    DonViTiepNhanID BIGINT NOT NULL, -- Receiving organization
    DonViXuLyID BIGINT, -- Processing organization
    CanBoTiepNhanID BIGINT, -- Receiving officer
    CanBoXuLyID BIGINT, -- Processing officer

    -- Case classification
    LoaiHoSo NVARCHAR(100), -- Type classification
    MucDoUuTien TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    MucDoPhucTap TINYINT DEFAULT 2, -- 1=Simple, 2=Medium, 3=Complex, 4=Very Complex
    NhomHoSo NVARCHAR(100), -- Case grouping

    -- Status and lifecycle
    TrangThaiID INT NOT NULL, -- Current status
    TrangThaiChiTiet NVARCHAR(200), -- Detailed status description
    TrangThaiTruoc INT, -- Previous status
    LichSuTrangThai NVARCHAR(MAX), -- JSON status history

    -- Timing and deadlines
    ThoiHanGiaiQuyet DATETIME2 NOT NULL, -- Resolution deadline
    ThoiHanGiaiQuyetGoc DATETIME2, -- Original deadline
    ThoiGianXuLyThucTe INT, -- Actual processing time in hours
    NgayDuKienHoanThanh DATETIME2, -- Expected completion date
    NgayHoanThanh DATETIME2, -- Actual completion date

    -- Workflow integration
    WorkflowInstanceID BIGINT, -- Associated workflow instance
    BuocHienTai NVARCHAR(200), -- Current workflow step
    TienDoXuLy DECIMAL(5,2) DEFAULT 0, -- Processing progress percentage

    -- Business data
    DuLieuNghiepVu NVARCHAR(MAX), -- JSON business data
    ThongSoKyThuat NVARCHAR(MAX), -- JSON technical parameters
    GiaTriKinhTe DECIMAL(18,2), -- Economic value
    TacDongXaHoi NVARCHAR(1000), -- Social impact description

    -- Document management
    SoTaiLieuYeuCau INT DEFAULT 0, -- Required document count
    SoTaiLieuDaNop INT DEFAULT 0, -- Submitted document count
    SoTaiLieuThieu INT DEFAULT 0, -- Missing document count
    DanhSachTaiLieu NVARCHAR(MAX), -- JSON document list

    -- Fee and payment
    PhiDaNop DECIMAL(18,2) DEFAULT 0, -- Paid amount
    PhiCanNop DECIMAL(18,2) DEFAULT 0, -- Required payment amount
    TrangThaiThanhToan NVARCHAR(100) DEFAULT 'Pending', -- Payment status
    NgayThanhToan DATETIME2, -- Payment date

    -- Quality and compliance
    DiemChatLuong DECIMAL(3,1), -- Quality score
    MucDoHaiLong DECIMAL(3,1), -- Satisfaction level
    KetQuaKiemTra NVARCHAR(MAX), -- JSON inspection results
    MucDoTuanThu NVARCHAR(100), -- Compliance level

    -- Communication and interaction
    SoLanLienLac INT DEFAULT 0, -- Contact count
    LichSuTuongTac NVARCHAR(MAX), -- JSON interaction history
    GhiChuDacBiet NVARCHAR(2000), -- Special notes
    YeuCauBoSung NVARCHAR(MAX), -- JSON supplementary requirements

    -- External integration
    MaTichHopNgoai NVARCHAR(200), -- External system reference
    DongBoHeTKhac NVARCHAR(MAX), -- JSON external system sync
    ApiCallLog NVARCHAR(MAX), -- JSON API call history

    -- Error and exception handling
    CoLoi BIT DEFAULT 0, -- Has errors flag
    LoiXayRa NVARCHAR(MAX), -- JSON error details
    LanXuLyLai INT DEFAULT 0, -- Reprocessing attempt count
    LyDoXuLyLai NVARCHAR(2000), -- Reprocessing reason

    -- Performance metrics
    ThoiGianChoDuyet INT, -- Approval waiting time in hours
    ThoiGianXuLy INT, -- Processing time in hours
    SoLanChuyenTiep INT DEFAULT 0, -- Transfer count
    SoLanTuChoi INT DEFAULT 0, -- Rejection count

    -- Archival and retention
    NgayLuuTru DATETIME2, -- Archive date
    ThoiHanLuuTru INT, -- Retention period in years
    CoTheBiXoa BIT DEFAULT 0, -- Can be deleted flag
    LyDoLuuTru NVARCHAR(1000), -- Retention reason

    -- Cancellation and termination
    NgayHuy DATETIME2, -- Cancellation date
    LyDoHuy NVARCHAR(2000), -- Cancellation reason
    NguoiHuy BIGINT, -- User who cancelled
    CoTheKhoiPhuc BIT DEFAULT 1, -- Can be restored flag

    -- Audit trail
    NgayTao DATETIME2 DEFAULT GETDATE(),
    NguoiTao BIGINT NOT NULL,
    NgayCapNhat DATETIME2,
    NguoiCapNhat BIGINT,
    NgayXoa DATETIME2,
    NguoiXoa BIGINT,

    -- Constraints
    CONSTRAINT CK_HOSO_MucDoUuTien CHECK (MucDoUuTien BETWEEN 1 AND 4),
    CONSTRAINT CK_HOSO_TienDoXuLy CHECK (TienDoXuLy BETWEEN 0 AND 100),
    CONSTRAINT CK_HOSO_PhiDaNop CHECK (PhiDaNop >= 0),
    CONSTRAINT CK_HOSO_SoTaiLieu CHECK (SoTaiLieuDaNop <= SoTaiLieuYeuCau)
);
GO

-- Indexes
CREATE INDEX IX_HOSO_SoHoSo ON [case].HOSO(SoHoSo);
CREATE INDEX IX_HOSO_TTHC ON [case].HOSO(TTHCID, TrangThaiID);
CREATE INDEX IX_HOSO_NguoiNop ON [case].HOSO(NguoiNopID, NgayNop DESC);
CREATE INDEX IX_HOSO_TrangThai ON [case].HOSO(TrangThaiID, NgayTao DESC);
CREATE INDEX IX_HOSO_DonViXuLy ON [case].HOSO(DonViXuLyID, TrangThaiID);
CREATE INDEX IX_HOSO_CanBoXuLy ON [case].HOSO(CanBoXuLyID, TrangThaiID);
CREATE INDEX IX_HOSO_ThoiHan ON [case].HOSO(ThoiHanGiaiQuyet, TrangThaiID);
CREATE INDEX IX_HOSO_NgayNop ON [case].HOSO(NgayNop DESC);
CREATE INDEX IX_HOSO_Workflow ON [case].HOSO(WorkflowInstanceID);
CREATE INDEX IX_HOSO_UuTien ON [case].HOSO(MucDoUuTien, TrangThaiID);
CREATE INDEX IX_HOSO_KenhNop ON [case].HOSO(KenhNop, NgayNop DESC);
CREATE INDEX IX_HOSO_ThanhToan ON [case].HOSO(TrangThaiThanhToan, NgayThanhToan DESC);
GO
```

### 2. QUATRINHXULY - Case processing history and timeline

```sql
CREATE TABLE [case].QUATRINHXULY (
    QuaTrinhID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,

    -- Processing step details
    TenBuoc NVARCHAR(500) NOT NULL,
    MoTaBuoc NVARCHAR(2000),
    LoaiBuoc NVARCHAR(100), -- Process/Review/Approve/Return/Reject

    -- Timing information
    ThoiGianBatDau DATETIME2 DEFAULT GETDATE(),
    ThoiGianKetThuc DATETIME2,
    ThoiGianXuLy INT, -- Processing time in minutes
    ThoiHanDuKien DATETIME2, -- Expected completion time

    -- Status tracking
    TrangThaiBuoc NVARCHAR(100) NOT NULL, -- InProgress/Completed/Failed/Skipped
    TrangThaiTruoc NVARCHAR(100), -- Previous status
    KetQuaBuoc NVARCHAR(100), -- Approved/Rejected/Returned/Forwarded

    -- Personnel involved
    NguoiXuLy BIGINT NOT NULL, -- Processing user
    DonViXuLy BIGINT, -- Processing organization
    VaiTro NVARCHAR(200), -- Role in processing
    QuyenHan NVARCHAR(500), -- Authority level

    -- Processing details
    NoiDungXuLy NVARCHAR(4000), -- Processing content/notes
    KetQuaXuLy NVARCHAR(2000), -- Processing results
    QuyetDinh NVARCHAR(100), -- Decision made
    LyDoQuyetDinh NVARCHAR(2000), -- Reason for decision

    -- Document and data changes
    TaiLieuXuLy NVARCHAR(MAX), -- JSON processed documents
    DuLieuThayDoi NVARCHAR(MAX), -- JSON data changes
    FileDinhKem NVARCHAR(MAX), -- JSON attached files

    -- Quality and validation
    KiemTra NVARCHAR(MAX), -- JSON validation results
    ChatLuong DECIMAL(3,1), -- Quality score for this step
    LoiPhatHien NVARCHAR(MAX), -- JSON errors found
    HanhDongKhacPhuc NVARCHAR(2000), -- Corrective actions

    -- Integration and automation
    XuLyTuDong BIT DEFAULT 0, -- Automated processing flag
    HeThongXuLy NVARCHAR(200), -- Processing system
    ApiGoi NVARCHAR(MAX), -- JSON API calls made
    KetQuaAPI NVARCHAR(MAX), -- JSON API results

    -- Escalation and exceptions
    CapBac INT DEFAULT 1, -- Processing level
    LyDoCapBac NVARCHAR(1000), -- Escalation reason
    NguoiCapBac BIGINT, -- Escalated to user
    ThoiGianCapBac DATETIME2, -- Escalation time

    -- Communication
    ThongBaoDaGui NVARCHAR(MAX), -- JSON sent notifications
    TraLoiNhan NVARCHAR(MAX), -- JSON received responses
    TuongTacKhachHang NVARCHAR(MAX), -- JSON customer interactions

    -- Performance metrics
    DanhGiaHieuQua DECIMAL(3,1), -- Efficiency rating
    TocDoXuLy NVARCHAR(100), -- Processing speed rating
    MucDoKhoKhan TINYINT, -- Difficulty level 1-5

    -- Location and context
    DiaDiemXuLy NVARCHAR(500), -- Processing location
    MoiTruongXuLy NVARCHAR(200), -- Processing environment
    ThietBiSuDung NVARCHAR(500), -- Equipment used

    -- Workflow integration
    WorkflowStepInstanceID BIGINT, -- Associated workflow step instance
    BuocWorkflow NVARCHAR(200), -- Workflow step name
    TrangThaiWorkflow NVARCHAR(100), -- Workflow status

    -- Audit and compliance
    TuanThuQuyDinh BIT DEFAULT 1, -- Compliance flag
    KiemTraTuanThu NVARCHAR(MAX), -- JSON compliance check
    BaoCaoTuanThu NVARCHAR(2000), -- Compliance report

    -- Status and flags
    IsVisible BIT DEFAULT 1, -- Visible in timeline
    IsInternal BIT DEFAULT 0, -- Internal processing step
    IsAutomated BIT DEFAULT 0, -- Automated step

    -- Audit trail
    NgayTao DATETIME2 DEFAULT GETDATE(),
    NguoiTao BIGINT NOT NULL,
    NgayCapNhat DATETIME2,
    NguoiCapNhat BIGINT,

    CONSTRAINT FK_QUATRINHXULY_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT CK_QUATRINHXULY_ThoiGianXuLy CHECK (ThoiGianXuLy >= 0),
    CONSTRAINT CK_QUATRINHXULY_CapBac CHECK (CapBac >= 1)
);
GO

-- Indexes
CREATE INDEX IX_QUATRINHXULY_HoSo ON [case].QUATRINHXULY(HoSoID, ThoiGianBatDau DESC);
CREATE INDEX IX_QUATRINHXULY_NguoiXuLy ON [case].QUATRINHXULY(NguoiXuLy, ThoiGianBatDau DESC);
CREATE INDEX IX_QUATRINHXULY_TrangThai ON [case].QUATRINHXULY(TrangThaiBuoc, ThoiGianBatDau DESC);
CREATE INDEX IX_QUATRINHXULY_LoaiBuoc ON [case].QUATRINHXULY(LoaiBuoc, ThoiGianBatDau DESC);
CREATE INDEX IX_QUATRINHXULY_DonVi ON [case].QUATRINHXULY(DonViXuLy, ThoiGianBatDau DESC);
CREATE INDEX IX_QUATRINHXULY_Workflow ON [case].QUATRINHXULY(WorkflowStepInstanceID);
CREATE INDEX IX_QUATRINHXULY_TuDong ON [case].QUATRINHXULY(XuLyTuDong, ThoiGianBatDau DESC);
GO
```

### 3. HOSOBOSUNG - Case supplementary information and amendments

```sql
CREATE TABLE [case].HOSOBOSUNG (
    BoSungID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,

    -- Supplementary request details
    LoaiBoSung NVARCHAR(100) NOT NULL, -- Document/Information/Correction/Amendment
    TieuDeBoSung NVARCHAR(500) NOT NULL,
    NoiDungBoSung NVARCHAR(4000) NOT NULL,
    MucDoCanThiet TINYINT DEFAULT 2, -- 1=Critical, 2=Important, 3=Optional

    -- Request information
    NgayYeuCau DATETIME2 DEFAULT GETDATE(),
    NguoiYeuCau BIGINT NOT NULL, -- User requesting supplement
    DonViYeuCau BIGINT, -- Organization requesting
    LyDoYeuCau NVARCHAR(2000), -- Reason for request

    -- Response deadline
    ThoiHanBoSung DATETIME2 NOT NULL, -- Deadline for supplement
    ThoiHanGoc DATETIME2, -- Original deadline
    SoLanGiaHan INT DEFAULT 0, -- Extension count
    LyDoGiaHan NVARCHAR(MAX), -- JSON extension reasons

    -- Applicant response
    NgayTraLoi DATETIME2, -- Response date
    NoiDungTraLoi NVARCHAR(4000), -- Response content
    PhuongThucTraLoi NVARCHAR(100), -- Response method
    TaiLieuTraLoi NVARCHAR(MAX), -- JSON response documents

    -- Processing and validation
    NgayXuLy DATETIME2, -- Processing date
    NguoiXuLy BIGINT, -- Processing user
    KetQuaXuLy NVARCHAR(100), -- Accepted/Rejected/Partial
    NhanXetXuLy NVARCHAR(2000), -- Processing comments

    -- Impact assessment
    AnhHuongTienDo NVARCHAR(100), -- Impact on timeline
    AnhHuongChatLuong NVARCHAR(100), -- Impact on quality
    ChiPhiBoSung DECIMAL(10,2) DEFAULT 0, -- Additional cost
    ThoiGianBoSung INT, -- Additional time required (hours)

    -- Notification and communication
    DaThongBao BIT DEFAULT 0, -- Notification sent flag
    NgayThongBao DATETIME2, -- Notification date
    PhuongThucThongBao NVARCHAR(MAX), -- JSON notification methods
    LichSuThongBao NVARCHAR(MAX), -- JSON notification history

    -- Document management
    TaiLieuYeuCau NVARCHAR(MAX), -- JSON requested documents
    TaiLieuNhan NVARCHAR(MAX), -- JSON received documents
    TaiLieuThieu NVARCHAR(MAX), -- JSON missing documents
    TaiLieuSai NVARCHAR(MAX), -- JSON incorrect documents

    -- Quality control
    KiemTraBoSung BIT DEFAULT 0, -- Quality check performed
    KetQuaKiemTra NVARCHAR(MAX), -- JSON quality check results
    DiemChatLuong DECIMAL(3,1), -- Quality score
    YeuCauSua NVARCHAR(2000), -- Correction requirements

    -- Status tracking
    TrangThai NVARCHAR(100) DEFAULT 'Pending', -- Pending/InProgress/Completed/Expired/Cancelled
    TrangThaiChiTiet NVARCHAR(200), -- Detailed status
    LichSuTrangThai NVARCHAR(MAX), -- JSON status history

    -- Escalation management
    SoLanNhacNho INT DEFAULT 0, -- Reminder count
    NgayNhacNhoCuoi DATETIME2, -- Last reminder date
    CapBacXuLy INT DEFAULT 1, -- Escalation level
    LyDoCapBac NVARCHAR(1000), -- Escalation reason

    -- Integration
    TichHopHeThong NVARCHAR(MAX), -- JSON system integration
    MaThamChieuNgoai NVARCHAR(200), -- External reference
    DongBoAPI NVARCHAR(MAX), -- JSON API synchronization

    -- Performance metrics
    ThoiGianPhanHoi INT, -- Response time in hours
    TyLeHoanThanh DECIMAL(5,2), -- Completion rate
    MucDoHaiLong DECIMAL(3,1), -- Satisfaction level

    -- Audit trail
    NgayTao DATETIME2 DEFAULT GETDATE(),
    NguoiTao BIGINT NOT NULL,
    NgayCapNhat DATETIME2,
    NguoiCapNhat BIGINT,
    NgayXoa DATETIME2,
    NguoiXoa BIGINT,

    CONSTRAINT FK_HOSOBOSUNG_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT CK_HOSOBOSUNG_MucDoCanThiet CHECK (MucDoCanThiet BETWEEN 1 AND 3),
    CONSTRAINT CK_HOSOBOSUNG_ThoiHanBoSung CHECK (ThoiHanBoSung > NgayYeuCau)
);
GO

-- Indexes
CREATE INDEX IX_HOSOBOSUNG_HoSo ON [case].HOSOBOSUNG(HoSoID, NgayYeuCau DESC);
CREATE INDEX IX_HOSOBOSUNG_NguoiYeuCau ON [case].HOSOBOSUNG(NguoiYeuCau, NgayYeuCau DESC);
CREATE INDEX IX_HOSOBOSUNG_TrangThai ON [case].HOSOBOSUNG(TrangThai, NgayYeuCau DESC);
CREATE INDEX IX_HOSOBOSUNG_ThoiHan ON [case].HOSOBOSUNG(ThoiHanBoSung, TrangThai);
CREATE INDEX IX_HOSOBOSUNG_LoaiBoSung ON [case].HOSOBOSUNG(LoaiBoSung, TrangThai);
GO
```

### 4. HOSOKHONGGIAIQUYET - Rejected/unresolved cases

```sql
CREATE TABLE [case].HOSOKHONGGIAIQUYET (
    KhongGiaiQuyetID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,

    -- Rejection details
    LoaiKhongGiaiQuyet NVARCHAR(100) NOT NULL, -- Rejected/Withdrawn/Expired/Cancelled/Returned
    NgayKhongGiaiQuyet DATETIME2 DEFAULT GETDATE(),
    NguoiQuyetDinh BIGINT NOT NULL, -- Decision maker
    CapDoQuyetDinh TINYINT NOT NULL, -- Decision level 1-5

    -- Reason and justification
    LyDoChinh NVARCHAR(100) NOT NULL, -- Primary reason category
    LyDoChiTiet NVARCHAR(4000) NOT NULL, -- Detailed explanation
    QuyDinhVietPham NVARCHAR(MAX), -- JSON violated regulations
    VanBanThamChieu NVARCHAR(MAX), -- JSON reference documents

    -- Legal and regulatory basis
    CoBapPhapLy NVARCHAR(2000), -- Legal basis
    VanBanQuyDinh NVARCHAR(1000), -- Regulatory documents
    DieuKhoanViPham NVARCHAR(1000), -- Violated clauses
    MucPhat DECIMAL(18,2) DEFAULT 0, -- Penalty amount

    -- Processing context
    BuocKhongGiaiQuyet NVARCHAR(300), -- Step where rejection occurred
    TrangThaiLucKhongGiaiQuyet NVARCHAR(100), -- Status at rejection
    TienDoLucKhongGiaiQuyet DECIMAL(5,2), -- Progress at rejection
    NguyenNhanKyThuat NVARCHAR(2000), -- Technical reasons

    -- Impact assessment
    AnhHuongDenKhachHang NVARCHAR(100), -- High/Medium/Low customer impact
    AnhHuongDenDonVi NVARCHAR(100), -- Organizational impact
    ChiPhiXuLy DECIMAL(10,2), -- Processing cost incurred
    ThoiGianDaXuLy INT, -- Time spent processing (hours)

    -- Customer notification
    DaThongBaoKhachHang BIT DEFAULT 0, -- Customer notified flag
    NgayThongBao DATETIME2, -- Notification date
    PhuongThucThongBao NVARCHAR(200), -- Notification method
    NoiDungThongBao NVARCHAR(4000), -- Notification content

    -- Appeal and recourse options
    CoTheKhangCao BIT DEFAULT 1, -- Appeal allowed flag
    ThoiHanKhangCao DATETIME2, -- Appeal deadline
    HuongDanKhangCao NVARCHAR(2000), -- Appeal instructions
    ThuTucKhangCao NVARCHAR(1000), -- Appeal procedure

    -- Follow-up actions
    HanhDongTiepTheo NVARCHAR(MAX), -- JSON next actions
    YeuCauKhacPhuc NVARCHAR(2000), -- Remediation requirements
    DieuKienTaiNop NVARCHAR(2000), -- Resubmission conditions
    HuongDanSua NVARCHAR(4000), -- Correction guidance

    -- Quality and learning
    BaiHocKinhNghiem NVARCHAR(2000), -- Lessons learned
    DeXuatCaiTien NVARCHAR(2000), -- Improvement suggestions
    DanhGiaQuyTrinh NVARCHAR(MAX), -- JSON process evaluation
    DiemSo DECIMAL(3,1), -- Quality score

    -- Document preservation
    TaiLieuLuuTru NVARCHAR(MAX), -- JSON archived documents
    ThoiHanLuuTru INT DEFAULT 5, -- Retention period (years)
    LyDoLuuTru NVARCHAR(1000), -- Retention reason
    CoTheHuy BIT DEFAULT 0, -- Can be destroyed flag

    -- Statistics and reporting
    NhomLyDo NVARCHAR(100), -- Reason category for reporting
    MaThongKe NVARCHAR(100), -- Statistical code
    ThuocBaoCao NVARCHAR(200), -- Report category
    MucDoAnhHuong TINYINT DEFAULT 2, -- Impact level 1-5

    -- External reporting
    BaoCaoCapTren BIT DEFAULT 0, -- Report to higher authority
    NgayBaoCao DATETIME2, -- Reporting date
    NguoiBaoCao BIGINT, -- Reporting user
    NoiDungBaoCao NVARCHAR(4000), -- Report content

    -- Review and audit
    KiemTraLai BIT DEFAULT 0, -- Re-review performed
    NgayKiemTraLai DATETIME2, -- Re-review date
    NguoiKiemTraLai BIGINT, -- Re-reviewer
    KetQuaKiemTraLai NVARCHAR(2000), -- Re-review results

    -- Status and lifecycle
    TrangThai NVARCHAR(100) DEFAULT 'Final', -- Final/Under Review/Appealed
    CoTheKhoiPhuc BIT DEFAULT 0, -- Can be restored flag
    LyDoKhoiPhuc NVARCHAR(1000), -- Restoration reason

    -- Audit trail
    NgayTao DATETIME2 DEFAULT GETDATE(),
    NguoiTao BIGINT NOT NULL,
    NgayCapNhat DATETIME2,
    NguoiCapNhat BIGINT,

    CONSTRAINT FK_HOSOKHONGGIAIQUYET_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT CK_HOSOKHONGGIAIQUYET_CapDoQuyetDinh CHECK (CapDoQuyetDinh BETWEEN 1 AND 5),
    CONSTRAINT CK_HOSOKHONGGIAIQUYET_MucPhat CHECK (MucPhat >= 0)
);
GO

-- Indexes
CREATE INDEX IX_HOSOKHONGGIAIQUYET_HoSo ON [case].HOSOKHONGGIAIQUYET(HoSoID);
CREATE INDEX IX_HOSOKHONGGIAIQUYET_Loai ON [case].HOSOKHONGGIAIQUYET(LoaiKhongGiaiQuyet, NgayKhongGiaiQuyet DESC);
CREATE INDEX IX_HOSOKHONGGIAIQUYET_NguoiQuyetDinh ON [case].HOSOKHONGGIAIQUYET(NguoiQuyetDinh, NgayKhongGiaiQuyet DESC);
CREATE INDEX IX_HOSOKHONGGIAIQUYET_LyDo ON [case].HOSOKHONGGIAIQUYET(LyDoChinh, NgayKhongGiaiQuyet DESC);
CREATE INDEX IX_HOSOKHONGGIAIQUYET_KhangCao ON [case].HOSOKHONGGIAIQUYET(CoTheKhangCao, ThoiHanKhangCao);
CREATE INDEX IX_HOSOKHONGGIAIQUYET_BaoCao ON [case].HOSOKHONGGIAIQUYET(NhomLyDo, NgayKhongGiaiQuyet DESC);
GO
```

## SUPPORTING TABLES

### 5. CASE_ASSIGNMENT_HISTORY - Case assignment tracking

```sql
CREATE TABLE [case].CASE_ASSIGNMENT_HISTORY (
    AssignmentID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,

    -- Assignment details
    AssignmentType NVARCHAR(100) NOT NULL, -- Initial/Transfer/Escalation/Delegation/Return
    AssignedFrom BIGINT, -- Previous assignee
    AssignedTo BIGINT NOT NULL, -- New assignee
    AssignedBy BIGINT NOT NULL, -- User who made assignment

    -- Organization context
    FromOrganization BIGINT, -- Previous organization
    ToOrganization BIGINT NOT NULL, -- New organization
    FromDepartment NVARCHAR(200), -- Previous department
    ToDepartment NVARCHAR(200), -- New department

    -- Assignment timing
    AssignedAt DATETIME2 DEFAULT GETDATE(),
    EffectiveFrom DATETIME2 DEFAULT GETDATE(),
    EffectiveTo DATETIME2, -- For temporary assignments
    ActualHandoverAt DATETIME2, -- When actually handed over

    -- Assignment reason and context
    Reason NVARCHAR(2000) NOT NULL, -- Assignment reason
    Priority TINYINT DEFAULT 3, -- Assignment priority
    Urgency TINYINT DEFAULT 3, -- Assignment urgency
    Context NVARCHAR(MAX), -- JSON assignment context

    -- Workload and capacity
    WorkloadAtAssignment INT, -- Assignee workload at time of assignment
    EstimatedEffort INT, -- Estimated effort in hours
    ComplexityLevel TINYINT, -- Case complexity level
    RequiredSkills NVARCHAR(MAX), -- JSON required skills

    -- Handover information
    HandoverNotes NVARCHAR(4000), -- Handover notes
    HandoverDocuments NVARCHAR(MAX), -- JSON handover documents
    KnowledgeTransfer NVARCHAR(4000), -- Knowledge transfer details
    HandoverComplete BIT DEFAULT 0, -- Handover completed flag

    -- Assignment rules and automation
    AssignmentRule NVARCHAR(500), -- Assignment rule used
    AutoAssigned BIT DEFAULT 0, -- Automatically assigned
    RuleParameters NVARCHAR(MAX), -- JSON rule parameters
    OverrideReason NVARCHAR(1000), -- Manual override reason

    -- Performance tracking
    AcceptanceTime INT, -- Time to accept assignment (minutes)
    FirstActionTime INT, -- Time to first action (hours)
    AssignmentEffectiveness DECIMAL(3,1), -- Effectiveness rating
    WorkQuality DECIMAL(3,1), -- Work quality rating

    -- Status tracking
    Status NVARCHAR(100) DEFAULT 'Active', -- Active/Completed/Cancelled/Transferred
    AcceptedAt DATETIME2, -- When assignment was accepted
    CompletedAt DATETIME2, -- When assignment was completed
    CancelledAt DATETIME2, -- When assignment was cancelled

    -- Communication
    NotificationSent BIT DEFAULT 0, -- Notification sent flag
    NotificationMethod NVARCHAR(100), -- Notification method
    ResponseReceived BIT DEFAULT 0, -- Response received flag
    CommunicationLog NVARCHAR(MAX), -- JSON communication history

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_CASE_ASSIGNMENT_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT CK_CASE_ASSIGNMENT_Priority CHECK (Priority BETWEEN 1 AND 5),
    CONSTRAINT CK_CASE_ASSIGNMENT_Urgency CHECK (Urgency BETWEEN 1 AND 5)
);
GO

-- Indexes
CREATE INDEX IX_CASE_ASSIGNMENT_HoSo ON [case].CASE_ASSIGNMENT_HISTORY(HoSoID, AssignedAt DESC);
CREATE INDEX IX_CASE_ASSIGNMENT_To ON [case].CASE_ASSIGNMENT_HISTORY(AssignedTo, Status);
CREATE INDEX IX_CASE_ASSIGNMENT_From ON [case].CASE_ASSIGNMENT_HISTORY(AssignedFrom, AssignedAt DESC);
CREATE INDEX IX_CASE_ASSIGNMENT_Type ON [case].CASE_ASSIGNMENT_HISTORY(AssignmentType, AssignedAt DESC);
CREATE INDEX IX_CASE_ASSIGNMENT_Organization ON [case].CASE_ASSIGNMENT_HISTORY(ToOrganization, Status);
GO
```

### 6. CASE_COLLABORATION - Multi-organization collaboration

```sql
CREATE TABLE [case].CASE_COLLABORATION (
    CollaborationID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,

    -- Collaboration setup
    CollaborationType NVARCHAR(100) NOT NULL, -- Consultation/Joint Review/Sequential/Parallel
    LeadOrganization BIGINT NOT NULL, -- Lead organization
    CoordinatorID BIGINT NOT NULL, -- Coordination contact

    -- Participating organizations
    ParticipatingOrganizations NVARCHAR(MAX) NOT NULL, -- JSON array of organizations
    RolesResponsibilities NVARCHAR(MAX) NOT NULL, -- JSON roles and responsibilities
    ContactPoints NVARCHAR(MAX), -- JSON contact information

    -- Collaboration timeline
    StartDate DATETIME2 DEFAULT GETDATE(),
    ExpectedEndDate DATETIME2 NOT NULL,
    ActualEndDate DATETIME2,
    MilestoneSchedule NVARCHAR(MAX), -- JSON milestone schedule

    -- Coordination mechanism
    CommunicationPlan NVARCHAR(MAX), -- JSON communication plan
    MeetingSchedule NVARCHAR(MAX), -- JSON meeting schedule
    ReportingStructure NVARCHAR(MAX), -- JSON reporting structure
    DecisionMakingProcess NVARCHAR(2000), -- Decision making process

    -- Information sharing
    SharedDocuments NVARCHAR(MAX), -- JSON shared document list
    SharedData NVARCHAR(MAX), -- JSON shared data elements
    AccessPermissions NVARCHAR(MAX), -- JSON access permissions
    SecurityRequirements NVARCHAR(2000), -- Security requirements

    -- Progress tracking
    CollaborationStatus NVARCHAR(100) DEFAULT 'Active', -- Active/Suspended/Completed/Failed
    ProgressReports NVARCHAR(MAX), -- JSON progress reports
    IssuesRisks NVARCHAR(MAX), -- JSON issues and risks
    ResolutionActions NVARCHAR(MAX), -- JSON resolution actions

    -- Quality and outcomes
    CollaborationEffectiveness DECIMAL(3,1), -- Effectiveness rating
    OutcomeQuality DECIMAL(3,1), -- Outcome quality rating
    LessonsLearned NVARCHAR(4000), -- Lessons learned
    BestPractices NVARCHAR(4000), -- Best practices identified

    -- Cost and resource tracking
    EstimatedCost DECIMAL(12,2), -- Estimated collaboration cost
    ActualCost DECIMAL(12,2), -- Actual collaboration cost
    ResourceUtilization NVARCHAR(MAX), -- JSON resource utilization
    CostSharing NVARCHAR(MAX), -- JSON cost sharing arrangement

    -- Legal and compliance
    LegalFramework NVARCHAR(2000), -- Legal framework for collaboration
    ComplianceRequirements NVARCHAR(2000), -- Compliance requirements
    DataProtection NVARCHAR(1000), -- Data protection measures
    LiabilityArrangement NVARCHAR(2000), -- Liability arrangement

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT NOT NULL,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    CONSTRAINT FK_CASE_COLLABORATION_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID)
);
GO

-- Indexes
CREATE INDEX IX_CASE_COLLABORATION_HoSo ON [case].CASE_COLLABORATION(HoSoID, StartDate DESC);
CREATE INDEX IX_CASE_COLLABORATION_Lead ON [case].CASE_COLLABORATION(LeadOrganization, CollaborationStatus);
CREATE INDEX IX_CASE_COLLABORATION_Type ON [case].CASE_COLLABORATION(CollaborationType, StartDate DESC);
CREATE INDEX IX_CASE_COLLABORATION_Status ON [case].CASE_COLLABORATION(CollaborationStatus, StartDate DESC);
GO
```

### 7. CASE_PERFORMANCE_METRICS - Case-level performance tracking

```sql
CREATE TABLE [case].CASE_PERFORMANCE_METRICS (
    MetricID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,

    -- Timing metrics
    TotalProcessingTimeHours DECIMAL(10,2), -- Total processing time
    ActualVsEstimatedRatio DECIMAL(5,2), -- Actual vs estimated time ratio
    WaitTimePercentage DECIMAL(5,2), -- Percentage of time spent waiting
    ActiveProcessingPercentage DECIMAL(5,2), -- Percentage of time actively processed

    -- Quality metrics
    FirstTimeRightIndicator BIT, -- Processed correctly first time
    ReworkCount INT DEFAULT 0, -- Number of rework cycles
    ErrorCount INT DEFAULT 0, -- Number of errors detected
    QualityScore DECIMAL(3,1), -- Overall quality score

    -- Efficiency metrics
    StepsCompleted INT, -- Number of steps completed
    StepsSkipped INT DEFAULT 0, -- Number of steps skipped
    AutomationPercentage DECIMAL(5,2), -- Percentage of automated processing
    ManualInterventionCount INT DEFAULT 0, -- Manual intervention count

    -- Customer experience metrics
    CustomerSatisfactionScore DECIMAL(3,1), -- Customer satisfaction
    CustomerContactCount INT DEFAULT 0, -- Number of customer contacts
    ComplaintCount INT DEFAULT 0, -- Number of complaints
    ComplimentCount INT DEFAULT 0, -- Number of compliments

    -- Resource utilization
    StaffHoursUsed DECIMAL(8,2), -- Total staff hours utilized
    ResourceCost DECIMAL(12,2), -- Total resource cost
    CostPerHour DECIMAL(8,2), -- Cost per hour
    ResourceEfficiency DECIMAL(5,2), -- Resource efficiency percentage

    -- Compliance metrics
    ComplianceScore DECIMAL(3,1), -- Compliance score
    RegulatoryViolations INT DEFAULT 0, -- Number of violations
    AuditFindings INT DEFAULT 0, -- Number of audit findings
    ComplianceGaps NVARCHAR(MAX), -- JSON compliance gaps

    -- Communication metrics
    NotificationsSent INT DEFAULT 0, -- Number of notifications sent
    ResponseRate DECIMAL(5,2), -- Response rate percentage
    CommunicationScore DECIMAL(3,1), -- Communication effectiveness
    ChannelEffectiveness NVARCHAR(MAX), -- JSON channel effectiveness

    -- Business value metrics
    BusinessValue DECIMAL(12,2), -- Business value delivered
    CostBenefit DECIMAL(5,2), -- Cost-benefit ratio
    ROI DECIMAL(5,2), -- Return on investment
    ValueDeliveryTime DECIMAL(8,2), -- Time to value delivery

    -- Risk and issue metrics
    RiskLevel TINYINT, -- Current risk level 1-5
    IssuesIdentified INT DEFAULT 0, -- Number of issues identified
    IssuesResolved INT DEFAULT 0, -- Number of issues resolved
    RiskMitigationEffectiveness DECIMAL(3,1), -- Risk mitigation effectiveness

    -- Collaboration metrics
    OrganizationsInvolved INT DEFAULT 1, -- Number of organizations involved
    CollaborationEffectiveness DECIMAL(3,1), -- Collaboration effectiveness
    HandoffCount INT DEFAULT 0, -- Number of handoffs
    CoordinationScore DECIMAL(3,1), -- Coordination effectiveness

    -- Technology metrics
    SystemUptime DECIMAL(5,2), -- System uptime percentage
    APICallCount INT DEFAULT 0, -- Number of API calls made
    IntegrationEffectiveness DECIMAL(3,1), -- Integration effectiveness
    TechnologyAdoption DECIMAL(5,2), -- Technology adoption rate

    -- Benchmarking
    IndustryBenchmark DECIMAL(5,2), -- Industry benchmark comparison
    OrganizationBenchmark DECIMAL(5,2), -- Organization benchmark comparison
    HistoricalComparison DECIMAL(5,2), -- Historical comparison
    PeerComparison DECIMAL(5,2), -- Peer comparison

    -- Calculated metrics
    OverallPerformanceScore DECIMAL(3,1), -- Overall performance score
    PerformanceCategory NVARCHAR(100), -- Excellent/Good/Average/Poor
    ImprovementOpportunities NVARCHAR(MAX), -- JSON improvement opportunities
    BestPractices NVARCHAR(MAX), -- JSON best practices identified

    -- Calculation metadata
    CalculatedAt DATETIME2 DEFAULT GETDATE(),
    CalculatedBy BIGINT,
    CalculationMethod NVARCHAR(500), -- Calculation method used
    DataSources NVARCHAR(MAX), -- JSON data sources used

    CONSTRAINT FK_CASE_PERFORMANCE_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT UC_CASE_PERFORMANCE_HOSO UNIQUE (HoSoID) -- One record per case
);
GO

-- Indexes
CREATE INDEX IX_CASE_PERFORMANCE_HoSo ON [case].CASE_PERFORMANCE_METRICS(HoSoID);
CREATE INDEX IX_CASE_PERFORMANCE_Score ON [case].CASE_PERFORMANCE_METRICS(OverallPerformanceScore DESC);
CREATE INDEX IX_CASE_PERFORMANCE_Category ON [case].CASE_PERFORMANCE_METRICS(PerformanceCategory, CalculatedAt DESC);
CREATE INDEX IX_CASE_PERFORMANCE_Quality ON [case].CASE_PERFORMANCE_METRICS(QualityScore DESC);
GO
```

### 8. TASK_ASSIGNMENT - Task assignment management

```sql
CREATE TABLE [case].TASK_ASSIGNMENT (
    AssignmentID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,
    WorkflowInstanceID BIGINT,
    WorkflowStepInstanceID BIGINT,

    -- Task identification
    TaskCode NVARCHAR(100) NOT NULL,
    TaskName NVARCHAR(500) NOT NULL,
    TaskType NVARCHAR(100) NOT NULL, -- Processing/Review/Approval/QC/Support
    TaskCategory NVARCHAR(100), -- Primary/Secondary/Escalated/Delegated

    -- Assignment details
    AssignedUserID BIGINT NOT NULL,
    AssignedByID BIGINT NOT NULL,
    AssignmentMethod NVARCHAR(100), -- Auto/Manual/Rule-based/Load-balanced
    AssignmentReason NVARCHAR(1000),

    -- Timing
    AssignedAt DATETIME2 DEFAULT GETDATE(),
    DueDate DATETIME2 NOT NULL,
    EstimatedDurationHours INT DEFAULT 1,
    ActualDurationHours INT,

    -- Status and progress
    Status NVARCHAR(100) DEFAULT 'Assigned', -- Assigned/Accepted/InProgress/Completed/Rejected/Escalated
    Progress DECIMAL(5,2) DEFAULT 0.0,
    LastActivityAt DATETIME2,

    -- Completion details
    CompletedAt DATETIME2,
    CompletionQuality DECIMAL(3,1), -- Quality score 1-5
    CompletionNotes NVARCHAR(2000),

    -- Priority and urgency
    Priority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    UrgencyLevel TINYINT DEFAULT 2, -- 1=Urgent, 2=Normal, 3=Low

    -- Workload and capacity
    ComplexityLevel TINYINT DEFAULT 2, -- 1=Simple, 2=Medium, 3=Complex, 4=Very Complex
    EffortPoints INT DEFAULT 1, -- Story points or effort estimation

    -- Delegation support
    CanBeDelegated BIT DEFAULT 1,
    DelegationLevel INT DEFAULT 0, -- 0=Original, 1=First delegation, etc.
    OriginalAssigneeID BIGINT, -- Original assignee if delegated

    -- Reminders and notifications
    RemindersSent INT DEFAULT 0,
    LastReminderAt DATETIME2,
    EscalationSent BIT DEFAULT 0,
    EscalationAt DATETIME2,

    -- Performance tracking
    SLAStatus NVARCHAR(50) DEFAULT 'OnTrack', -- OnTrack/AtRisk/Breached
    PerformanceScore DECIMAL(5,2),

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints and relationships
    CONSTRAINT FK_TASK_ASSIGNMENT_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_TASK_ASSIGNMENT_USER FOREIGN KEY (AssignedUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TASK_ASSIGNMENT_ASSIGNED_BY FOREIGN KEY (AssignedByID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_TASK_ASSIGNMENT_ORIGINAL FOREIGN KEY (OriginalAssigneeID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_TASK_ASSIGNMENT_Priority CHECK (Priority BETWEEN 1 AND 4),
    CONSTRAINT CK_TASK_ASSIGNMENT_Progress CHECK (Progress BETWEEN 0 AND 100)
);
GO

-- Indexes for TASK_ASSIGNMENT
CREATE INDEX IX_TASK_ASSIGNMENT_HoSo ON [case].TASK_ASSIGNMENT(HoSoID, Status);
CREATE INDEX IX_TASK_ASSIGNMENT_User ON [case].TASK_ASSIGNMENT(AssignedUserID, Status, DueDate);
CREATE INDEX IX_TASK_ASSIGNMENT_Status ON [case].TASK_ASSIGNMENT(Status, Priority DESC, DueDate);
CREATE INDEX IX_TASK_ASSIGNMENT_Due ON [case].TASK_ASSIGNMENT(DueDate, Status) WHERE Status IN ('Assigned', 'InProgress');
CREATE INDEX IX_TASK_ASSIGNMENT_Performance ON [case].TASK_ASSIGNMENT(SLAStatus, PerformanceScore DESC);
CREATE INDEX IX_TASK_ASSIGNMENT_Workflow ON [case].TASK_ASSIGNMENT(WorkflowInstanceID, WorkflowStepInstanceID);
GO
```

### 9. TASK_QUEUE - Task queue management

```sql
CREATE TABLE [case].TASK_QUEUE (
    QueueID BIGINT PRIMARY KEY IDENTITY,
    QueueName NVARCHAR(100) NOT NULL,
    QueueType NVARCHAR(100) NOT NULL, -- Department/Skill/Priority/General

    -- Queue assignment
    TaskAssignmentID BIGINT NOT NULL,

    -- Queue properties
    Priority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    ProcessingOrder INT DEFAULT 1000, -- Lower number = higher priority

    -- Queue timing
    EnqueuedAt DATETIME2 DEFAULT GETDATE(),
    ProcessedAt DATETIME2,
    ProcessedBy BIGINT,

    -- Queue status
    Status NVARCHAR(100) DEFAULT 'Pending', -- Pending/Processing/Completed/Failed/Cancelled
    RetryCount INT DEFAULT 0,
    MaxRetries INT DEFAULT 3,

    -- Auto-assignment rules
    AssignmentRuleID BIGINT,
    EligibleUsers NVARCHAR(MAX), -- JSON array of eligible user IDs
    RequiredSkills NVARCHAR(MAX), -- JSON array of required skills

    -- Processing metadata
    ProcessingStartedAt DATETIME2,
    ProcessingCompletedAt DATETIME2,
    ProcessingNotes NVARCHAR(1000),

    -- SLA tracking
    SLATargetMinutes INT DEFAULT 480, -- 8 hours default
    SLAWarningMinutes INT DEFAULT 360, -- 6 hours warning
    SLAStatus NVARCHAR(50) DEFAULT 'OnTrack', -- OnTrack/Warning/Breached

    -- Load balancing
    ProcessingNode NVARCHAR(100), -- Processing node identifier
    WorkerThreadID NVARCHAR(100), -- Worker thread identifier

    -- Error handling
    ErrorMessage NVARCHAR(2000),
    LastErrorAt DATETIME2,

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,

    -- Constraints
    CONSTRAINT FK_TASK_QUEUE_ASSIGNMENT FOREIGN KEY (TaskAssignmentID) REFERENCES [case].TASK_ASSIGNMENT(AssignmentID),
    CONSTRAINT FK_TASK_QUEUE_PROCESSED_BY FOREIGN KEY (ProcessedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_TASK_QUEUE_Priority CHECK (Priority BETWEEN 1 AND 4),
    CONSTRAINT CK_TASK_QUEUE_Retry CHECK (RetryCount <= MaxRetries)
);
GO

-- Indexes for TASK_QUEUE
CREATE INDEX IX_TASK_QUEUE_Pending ON [case].TASK_QUEUE(QueueName, Status, Priority DESC, ProcessingOrder) WHERE Status = 'Pending';
CREATE INDEX IX_TASK_QUEUE_Processing ON [case].TASK_QUEUE(ProcessedBy, Status, ProcessingStartedAt) WHERE Status = 'Processing';
CREATE INDEX IX_TASK_QUEUE_SLA ON [case].TASK_QUEUE(SLAStatus, EnqueuedAt) WHERE Status IN ('Pending', 'Processing');
CREATE INDEX IX_TASK_QUEUE_Type ON [case].TASK_QUEUE(QueueType, QueueName, Priority DESC);
CREATE INDEX IX_TASK_QUEUE_Assignment ON [case].TASK_QUEUE(TaskAssignmentID);
GO
```

### 10. DELEGATION - Task delegation management

```sql
CREATE TABLE [case].DELEGATION (
    DelegationID BIGINT PRIMARY KEY IDENTITY,

    -- Delegation parties
    FromUserID BIGINT NOT NULL, -- Delegator
    ToUserID BIGINT NOT NULL, -- Delegate
    ApprovedBy BIGINT, -- Supervisor who approved delegation

    -- Delegation scope
    DelegationType NVARCHAR(100) NOT NULL, -- Full/Partial/Specific/Temporary/Emergency
    Scope NVARCHAR(200), -- All tasks, specific TTHC, specific cases, etc.
    TaskAssignmentIDs NVARCHAR(MAX), -- JSON array of specific task assignments (if applicable)

    -- Timing
    StartDate DATETIME2 NOT NULL,
    EndDate DATETIME2 NOT NULL,
    RequestedAt DATETIME2 DEFAULT GETDATE(),
    ApprovedAt DATETIME2,
    ActivatedAt DATETIME2,

    -- Status and approval
    Status NVARCHAR(100) DEFAULT 'Pending', -- Pending/Approved/Rejected/Active/Expired/Revoked
    ApprovalRequired BIT DEFAULT 1,
    ApprovalNotes NVARCHAR(2000),
    RejectionReason NVARCHAR(2000),

    -- Delegation reason and context
    Reason NVARCHAR(2000) NOT NULL,
    Context NVARCHAR(100), -- Vacation/Training/Overload/Emergency/Skill-transfer
    BusinessJustification NVARCHAR(2000),

    -- Delegation conditions
    Conditions NVARCHAR(MAX), -- JSON conditions that must be met
    Restrictions NVARCHAR(MAX), -- JSON restrictions on delegation
    RequiredNotifications NVARCHAR(MAX), -- JSON notification requirements

    -- Performance tracking
    TasksCompleted INT DEFAULT 0,
    AverageCompletionTime DECIMAL(8,2),
    QualityScore DECIMAL(3,1),
    IssuesEncountered INT DEFAULT 0,

    -- Auto-extension and renewal
    AutoExtensionEnabled BIT DEFAULT 0,
    ExtensionConditions NVARCHAR(MAX), -- JSON auto-extension conditions
    MaxExtensionDays INT DEFAULT 0,
    ExtensionCount INT DEFAULT 0,

    -- Notification tracking
    RemindersSent INT DEFAULT 0,
    LastReminderAt DATETIME2,
    NotificationPreferences NVARCHAR(MAX), -- JSON notification preferences

    -- Audit and compliance
    AuditNotes NVARCHAR(MAX), -- JSON audit trail specific to delegation
    ComplianceChecked BIT DEFAULT 0,
    RiskLevel TINYINT DEFAULT 2, -- 1=Low, 2=Medium, 3=High, 4=Critical

    -- Delegation effectiveness
    EffectivenessScore DECIMAL(5,2),
    DelegateeFeedback NVARCHAR(2000),
    DelegatorFeedback NVARCHAR(2000),

    -- Revocation and termination
    RevokedAt DATETIME2,
    RevokedBy BIGINT,
    RevocationReason NVARCHAR(2000),
    TerminationNotes NVARCHAR(2000),

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_DELEGATION_FROM_USER FOREIGN KEY (FromUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELEGATION_TO_USER FOREIGN KEY (ToUserID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELEGATION_APPROVED_BY FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELEGATION_REVOKED_BY FOREIGN KEY (RevokedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELEGATION_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_DELEGATION_Dates CHECK (StartDate <= EndDate),
    CONSTRAINT CK_DELEGATION_Users CHECK (FromUserID != ToUserID),
    CONSTRAINT CK_DELEGATION_Risk CHECK (RiskLevel BETWEEN 1 AND 4)
);
GO

-- Indexes for DELEGATION
CREATE INDEX IX_DELEGATION_From_User ON [case].DELEGATION(FromUserID, Status, EndDate DESC);
CREATE INDEX IX_DELEGATION_To_User ON [case].DELEGATION(ToUserID, Status, StartDate DESC);
CREATE INDEX IX_DELEGATION_Status ON [case].DELEGATION(Status, StartDate, EndDate);
CREATE INDEX IX_DELEGATION_Approval ON [case].DELEGATION(ApprovedBy, Status, RequestedAt DESC);
CREATE INDEX IX_DELEGATION_Active ON [case].DELEGATION(Status, StartDate, EndDate) WHERE Status = 'Active';
CREATE INDEX IX_DELEGATION_Type ON [case].DELEGATION(DelegationType, Context, Status);
GO
```

### 11. APPROVAL_CHAIN - Approval workflow management

```sql
CREATE TABLE [case].APPROVAL_CHAIN (
    ApprovalID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,
    WorkflowInstanceID BIGINT,
    TaskAssignmentID BIGINT,

    -- Chain definition
    ApprovalChainName NVARCHAR(200) NOT NULL,
    ApprovalLevel INT NOT NULL, -- 1=First level, 2=Second level, etc.
    TotalLevels INT NOT NULL,

    -- Approver details
    ApproverID BIGINT NOT NULL,
    ApproverRole NVARCHAR(100), -- Manager/Director/Deputy/Specialist
    ApprovalScope NVARCHAR(200), -- Financial/Technical/Legal/Administrative

    -- Approval requirements
    IsRequired BIT DEFAULT 1,
    CanSkip BIT DEFAULT 0,
    SkipConditions NVARCHAR(MAX), -- JSON conditions when this level can be skipped
    RequiredDocuments NVARCHAR(MAX), -- JSON required documents for approval

    -- Decision details
    Decision NVARCHAR(100), -- Pending/Approved/Rejected/RequestInfo/Delegated/Skipped
    DecisionDate DATETIME2,
    DecisionNotes NVARCHAR(2000),
    RequestedInfo NVARCHAR(MAX), -- JSON requested additional information

    -- Timing and SLA
    RequestedAt DATETIME2 DEFAULT GETDATE(),
    DueDate DATETIME2 NOT NULL,
    RemindersSent INT DEFAULT 0,
    LastReminderAt DATETIME2,
    EscalationLevel INT DEFAULT 0,

    -- Delegation of approval
    DelegatedTo BIGINT, -- If approver delegates their approval
    DelegationReason NVARCHAR(1000),
    DelegatedAt DATETIME2,

    -- Supporting information
    BusinessCase NVARCHAR(MAX), -- Business justification for approval request
    RiskAssessment NVARCHAR(MAX), -- JSON risk assessment
    FinancialImpact DECIMAL(18,2), -- Financial impact if applicable
    TechnicalRequirements NVARCHAR(MAX), -- JSON technical requirements

    -- Decision rationale
    ApprovalCriteria NVARCHAR(MAX), -- JSON criteria used for decision
    DecisionFactors NVARCHAR(MAX), -- JSON factors that influenced decision
    AlternativesConsidered NVARCHAR(MAX), -- JSON alternative options considered

    -- Quality and compliance
    ComplianceChecked BIT DEFAULT 0,
    ComplianceNotes NVARCHAR(2000),
    QualityScore DECIMAL(3,1),
    ReviewerComments NVARCHAR(2000),

    -- Escalation tracking
    EscalatedAt DATETIME2,
    EscalatedTo BIGINT,
    EscalationReason NVARCHAR(1000),
    EscalationResolution NVARCHAR(2000),

    -- Performance metrics
    ProcessingTime DECIMAL(8,2), -- Hours taken for decision
    DecisionEffectiveness DECIMAL(5,2), -- Effectiveness score
    PostDecisionOutcome NVARCHAR(200), -- Outcome after decision

    -- Attachments and evidence
    SupportingDocuments NVARCHAR(MAX), -- JSON array of supporting document IDs
    EvidenceProvided NVARCHAR(MAX), -- JSON evidence for decision
    ExpertConsultation NVARCHAR(MAX), -- JSON expert opinions consulted

    -- Notification and communication
    NotificationsSent INT DEFAULT 0,
    CommunicationLog NVARCHAR(MAX), -- JSON communication history
    StakeholdersNotified NVARCHAR(MAX), -- JSON stakeholders notified

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_APPROVAL_CHAIN_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_APPROVAL_CHAIN_APPROVER FOREIGN KEY (ApproverID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_APPROVAL_CHAIN_DELEGATED FOREIGN KEY (DelegatedTo) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_APPROVAL_CHAIN_ESCALATED FOREIGN KEY (EscalatedTo) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_APPROVAL_CHAIN_TASK FOREIGN KEY (TaskAssignmentID) REFERENCES [case].TASK_ASSIGNMENT(AssignmentID),
    CONSTRAINT CK_APPROVAL_CHAIN_Level CHECK (ApprovalLevel > 0 AND ApprovalLevel <= TotalLevels),
    CONSTRAINT CK_APPROVAL_CHAIN_Dates CHECK (RequestedAt <= ISNULL(DueDate, '2099-12-31'))
);
GO

-- Indexes for APPROVAL_CHAIN
CREATE INDEX IX_APPROVAL_CHAIN_HoSo ON [case].APPROVAL_CHAIN(HoSoID, ApprovalLevel, Decision);
CREATE INDEX IX_APPROVAL_CHAIN_Approver ON [case].APPROVAL_CHAIN(ApproverID, Decision, RequestedAt DESC);
CREATE INDEX IX_APPROVAL_CHAIN_Pending ON [case].APPROVAL_CHAIN(Decision, DueDate) WHERE Decision = 'Pending';
CREATE INDEX IX_APPROVAL_CHAIN_Chain ON [case].APPROVAL_CHAIN(ApprovalChainName, ApprovalLevel);
CREATE INDEX IX_APPROVAL_CHAIN_SLA ON [case].APPROVAL_CHAIN(DueDate, RemindersSent) WHERE Decision = 'Pending';
CREATE INDEX IX_APPROVAL_CHAIN_Workflow ON [case].APPROVAL_CHAIN(WorkflowInstanceID, TaskAssignmentID);
GO
```

### 12. STATUS_DEFINITION - Status definition and management

```sql
CREATE TABLE [case].STATUS_DEFINITION (
    StatusID INT PRIMARY KEY,
    StatusCode NVARCHAR(50) UNIQUE NOT NULL,
    StatusName NVARCHAR(100) NOT NULL,
    StatusNameEN NVARCHAR(100), -- English name

    -- Status classification
    StatusType NVARCHAR(100) NOT NULL, -- Initial/Processing/Waiting/Completed/Cancelled/Error
    StatusCategory NVARCHAR(100), -- Submission/Review/Approval/Payment/Delivery/Finalization
    StatusGroup NVARCHAR(100), -- Pending/Active/Final/Exception

    -- Visual properties
    ColorCode NVARCHAR(7) DEFAULT '#6B7280', -- Hex color for UI
    BackgroundColor NVARCHAR(7) DEFAULT '#F9FAFB',
    IconName NVARCHAR(50) DEFAULT 'circle',
    BadgeStyle NVARCHAR(50) DEFAULT 'secondary', -- primary/secondary/success/warning/danger/info

    -- Display properties
    DisplayOrder INT DEFAULT 100,
    ShortDescription NVARCHAR(200),
    LongDescription NVARCHAR(1000),
    UserFriendlyName NVARCHAR(100), -- Citizen-facing name

    -- Business rules
    IsInitialStatus BIT DEFAULT 0, -- Can be set as initial status
    IsFinalStatus BIT DEFAULT 0, -- Terminal status
    IsSystemStatus BIT DEFAULT 0, -- Only system can set this status
    RequiresApproval BIT DEFAULT 0, -- Requires approval to set
    RequiresDocuments BIT DEFAULT 0, -- Requires documents to proceed
    RequiresPayment BIT DEFAULT 0, -- Requires payment to proceed

    -- Timing and SLA
    DefaultSLAHours INT, -- Default SLA for this status
    MaxSLAHours INT, -- Maximum allowed SLA
    WarningThresholdHours INT, -- Warning threshold before SLA breach
    AutoTransitionHours INT, -- Auto transition after specified hours

    -- Notification rules
    NotifySubmitter BIT DEFAULT 0, -- Notify case submitter
    NotifyAssignee BIT DEFAULT 0, -- Notify assigned staff
    NotifySupervisor BIT DEFAULT 0, -- Notify supervisor
    NotificationTemplate NVARCHAR(100), -- Notification template to use

    -- Workflow integration
    WorkflowStepTypes NVARCHAR(MAX), -- JSON array of workflow step types that can set this status
    AutomationRules NVARCHAR(MAX), -- JSON automation rules
    EscalationRules NVARCHAR(MAX), -- JSON escalation rules

    -- External system integration
    ExternalStatusCode NVARCHAR(100), -- External system status code
    LGSPStatusMapping NVARCHAR(100), -- LGSP status mapping
    APIStatusCode NVARCHAR(50), -- API response status code

    -- Reporting and analytics
    ReportingCategory NVARCHAR(100), -- Category for reporting
    KPICategory NVARCHAR(100), -- KPI calculation category
    PerformanceWeight DECIMAL(5,2) DEFAULT 1.0, -- Weight for performance calculations

    -- Citizen portal display
    ShowOnPortal BIT DEFAULT 1, -- Show on citizen portal
    PortalDescription NVARCHAR(500), -- Description for citizen portal
    AllowCitizenCancel BIT DEFAULT 0, -- Allow citizen to cancel from this status
    AllowCitizenWithdraw BIT DEFAULT 0, -- Allow citizen to withdraw from this status

    -- Status transitions
    AllowedNextStatuses NVARCHAR(MAX), -- JSON array of allowed next status IDs
    ForbiddenFromStatuses NVARCHAR(MAX), -- JSON array of statuses that cannot transition to this
    ConditionalTransitions NVARCHAR(MAX), -- JSON conditional transition rules

    -- Quality and compliance
    QualityCheckRequired BIT DEFAULT 0, -- Requires quality check
    ComplianceCheckRequired BIT DEFAULT 0, -- Requires compliance check
    AuditTrailRequired BIT DEFAULT 1, -- Requires detailed audit trail

    -- Performance metrics
    AverageProcessingHours DECIMAL(8,2), -- Historical average processing time
    SuccessRate DECIMAL(5,2) DEFAULT 100.0, -- Historical success rate
    LastMetricsUpdate DATETIME2, -- Last metrics calculation

    -- Status lifecycle
    IsActive BIT DEFAULT 1,
    IsDeprecated BIT DEFAULT 0,
    DeprecatedDate DATETIME2,
    ReplacedByStatusID INT, -- Status that replaces this one if deprecated

    -- Localization
    LocalizedNames NVARCHAR(MAX), -- JSON localized names for different languages
    LocalizedDescriptions NVARCHAR(MAX), -- JSON localized descriptions

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_STATUS_DEFINITION_REPLACED_BY FOREIGN KEY (ReplacedByStatusID) REFERENCES [case].STATUS_DEFINITION(StatusID),
    CONSTRAINT FK_STATUS_DEFINITION_CREATED_BY FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_STATUS_DEFINITION_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_STATUS_DEFINITION_SLA CHECK (DefaultSLAHours IS NULL OR DefaultSLAHours > 0),
    CONSTRAINT CK_STATUS_DEFINITION_Performance CHECK (PerformanceWeight >= 0)
);
GO

-- Indexes for STATUS_DEFINITION
CREATE INDEX IX_STATUS_DEFINITION_Code ON [case].STATUS_DEFINITION(StatusCode);
CREATE INDEX IX_STATUS_DEFINITION_Type ON [case].STATUS_DEFINITION(StatusType, StatusCategory);
CREATE INDEX IX_STATUS_DEFINITION_Active ON [case].STATUS_DEFINITION(IsActive, DisplayOrder);
CREATE INDEX IX_STATUS_DEFINITION_Final ON [case].STATUS_DEFINITION(IsFinalStatus, IsInitialStatus);
CREATE INDEX IX_STATUS_DEFINITION_Portal ON [case].STATUS_DEFINITION(ShowOnPortal, IsActive);
GO
```

### 13. STATUS_TRANSITION - Status transition rules and validation

```sql
CREATE TABLE [case].STATUS_TRANSITION (
    TransitionID BIGINT PRIMARY KEY IDENTITY,

    -- Transition definition
    TransitionName NVARCHAR(200) NOT NULL,
    TransitionCode NVARCHAR(100) UNIQUE NOT NULL,
    FromStatusID INT, -- NULL means can transition from any status
    ToStatusID INT NOT NULL,

    -- Transition classification
    TransitionType NVARCHAR(100) NOT NULL, -- Manual/Automatic/Conditional/System/API
    TransitionCategory NVARCHAR(100), -- Forward/Backward/Lateral/Exception/Escalation
    ActionType NVARCHAR(100), -- Submit/Approve/Reject/Return/Cancel/Complete/Escalate

    -- Conditions and rules
    RequiredConditions NVARCHAR(MAX), -- JSON conditions that must be met
    ValidationRules NVARCHAR(MAX), -- JSON validation rules
    BusinessRules NVARCHAR(MAX), -- JSON business rules
    PreConditions NVARCHAR(MAX), -- JSON pre-conditions
    PostConditions NVARCHAR(MAX), -- JSON post-conditions

    -- Authorization and permissions
    RequiredRole NVARCHAR(100), -- Role required to perform transition
    RequiredPermissions NVARCHAR(MAX), -- JSON array of required permissions
    AllowedUserRoles NVARCHAR(MAX), -- JSON array of allowed user roles
    AuthorizationLevel INT DEFAULT 1, -- 1=Basic, 2=Supervisor, 3=Manager, 4=Director

    -- Approval requirements
    RequiresApproval BIT DEFAULT 0,
    ApprovalLevels INT DEFAULT 0, -- Number of approval levels required
    ApprovalRoles NVARCHAR(MAX), -- JSON array of roles that can approve
    ParallelApproval BIT DEFAULT 0, -- Requires all approvers or just one

    -- Document and data requirements
    RequiredDocuments NVARCHAR(MAX), -- JSON array of required document types
    RequiredFields NVARCHAR(MAX), -- JSON array of required data fields
    OptionalDocuments NVARCHAR(MAX), -- JSON array of optional documents
    DataValidationRules NVARCHAR(MAX), -- JSON data validation rules

    -- Timing and scheduling
    TimingConstraints NVARCHAR(MAX), -- JSON timing constraints
    BusinessHoursOnly BIT DEFAULT 0, -- Only allowed during business hours
    MinimumWaitHours INT DEFAULT 0, -- Minimum wait time before transition
    MaximumWaitHours INT, -- Maximum wait time before auto-transition

    -- Workflow integration
    WorkflowRequired BIT DEFAULT 0, -- Requires workflow execution
    WorkflowID BIGINT, -- Associated workflow for this transition
    WorkflowStepID BIGINT, -- Specific workflow step
    TriggerWorkflow BIT DEFAULT 0, -- Should trigger new workflow

    -- Notifications and communications
    NotificationRequired BIT DEFAULT 0,
    NotificationTemplates NVARCHAR(MAX), -- JSON notification templates
    NotificationRecipients NVARCHAR(MAX), -- JSON notification recipients
    AutoNotify BIT DEFAULT 1, -- Automatically send notifications

    -- Cost and fee implications
    TransitionFee DECIMAL(18,2) DEFAULT 0, -- Fee for this transition
    RefundPolicy NVARCHAR(200), -- Refund policy if applicable
    CostCenter NVARCHAR(100), -- Cost center for accounting

    -- Quality and compliance
    QualityCheckRequired BIT DEFAULT 0,
    ComplianceValidation NVARCHAR(MAX), -- JSON compliance validation rules
    AuditSignificance TINYINT DEFAULT 2, -- 1=Low, 2=Medium, 3=High, 4=Critical

    -- Performance and monitoring
    SLAImpact NVARCHAR(100), -- None/Positive/Negative/Pause/Resume
    SLAAdjustmentHours INT DEFAULT 0, -- SLA adjustment for this transition
    PerformanceWeight DECIMAL(5,2) DEFAULT 1.0, -- Weight for performance metrics

    -- Rollback and recovery
    AllowRollback BIT DEFAULT 0, -- Allow reverting this transition
    RollbackConditions NVARCHAR(MAX), -- JSON rollback conditions
    RollbackRequiresApproval BIT DEFAULT 1,
    MaxRollbackHours INT DEFAULT 24, -- Time limit for rollback

    -- External system integration
    ExternalSystemCall BIT DEFAULT 0, -- Requires external system call
    ExternalSystemEndpoint NVARCHAR(500), -- External system endpoint
    ExternalValidation NVARCHAR(MAX), -- JSON external validation rules

    -- Automation and scripting
    AutomationScript NVARCHAR(MAX), -- Script to execute during transition
    ErrorHandling NVARCHAR(MAX), -- JSON error handling rules
    RetryPolicy NVARCHAR(MAX), -- JSON retry policy

    -- User experience
    UserMessage NVARCHAR(1000), -- Message to show to user
    ConfirmationRequired BIT DEFAULT 0, -- Requires user confirmation
    ReasonRequired BIT DEFAULT 0, -- Requires reason for transition
    CommentsRequired BIT DEFAULT 0, -- Requires user comments

    -- Statistics and analytics
    UsageCount BIGINT DEFAULT 0, -- Number of times used
    SuccessCount BIGINT DEFAULT 0, -- Number of successful transitions
    FailureCount BIGINT DEFAULT 0, -- Number of failed transitions
    AverageProcessingTime DECIMAL(8,2), -- Average processing time
    LastUsed DATETIME2, -- Last time this transition was used

    -- Configuration and flags
    IsActive BIT DEFAULT 1,
    IsSystemTransition BIT DEFAULT 0, -- System-only transition
    IsEmergencyTransition BIT DEFAULT 0, -- Emergency use only
    IsTestTransition BIT DEFAULT 0, -- For testing purposes

    -- Priority and ordering
    Priority INT DEFAULT 100, -- Priority for UI ordering
    DisplayOrder INT DEFAULT 100, -- Display order in UI
    IsDefault BIT DEFAULT 0, -- Default transition for status
    IsQuickAction BIT DEFAULT 0, -- Show as quick action in UI

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_STATUS_TRANSITION_FROM FOREIGN KEY (FromStatusID) REFERENCES [case].STATUS_DEFINITION(StatusID),
    CONSTRAINT FK_STATUS_TRANSITION_TO FOREIGN KEY (ToStatusID) REFERENCES [case].STATUS_DEFINITION(StatusID),
    CONSTRAINT FK_STATUS_TRANSITION_WORKFLOW FOREIGN KEY (WorkflowID) REFERENCES [workflow].DM_WORKFLOW(WorkflowID),
    CONSTRAINT FK_STATUS_TRANSITION_CREATED_BY FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_STATUS_TRANSITION_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_STATUS_TRANSITION_Auth_Level CHECK (AuthorizationLevel BETWEEN 1 AND 4),
    CONSTRAINT CK_STATUS_TRANSITION_Fee CHECK (TransitionFee >= 0),
    CONSTRAINT CK_STATUS_TRANSITION_Not_Self CHECK (FromStatusID != ToStatusID OR FromStatusID IS NULL)
);
GO

-- Indexes for STATUS_TRANSITION
CREATE INDEX IX_STATUS_TRANSITION_From_To ON [case].STATUS_TRANSITION(FromStatusID, ToStatusID, IsActive);
CREATE INDEX IX_STATUS_TRANSITION_To ON [case].STATUS_TRANSITION(ToStatusID, TransitionType);
CREATE INDEX IX_STATUS_TRANSITION_Type ON [case].STATUS_TRANSITION(TransitionType, TransitionCategory);
CREATE INDEX IX_STATUS_TRANSITION_Active ON [case].STATUS_TRANSITION(IsActive, Priority, DisplayOrder);
CREATE INDEX IX_STATUS_TRANSITION_Role ON [case].STATUS_TRANSITION(RequiredRole, AuthorizationLevel);
CREATE INDEX IX_STATUS_TRANSITION_Usage ON [case].STATUS_TRANSITION(UsageCount DESC, LastUsed DESC);
CREATE INDEX IX_STATUS_TRANSITION_Workflow ON [case].STATUS_TRANSITION(WorkflowID, WorkflowStepID);
GO
```

### 14. STATUS_HISTORY - Complete status change history

```sql
CREATE TABLE [case].STATUS_HISTORY (
    HistoryID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,
    TransitionID BIGINT, -- Reference to the transition used (nullable for legacy data)

    -- Status change details
    OldStatusID INT, -- NULL for initial status
    NewStatusID INT NOT NULL,
    StatusChangedAt DATETIME2 DEFAULT GETDATE(),

    -- Change context
    ChangedBy BIGINT NOT NULL, -- User who made the change
    ChangeReason NVARCHAR(200), -- Reason category
    ChangeComments NVARCHAR(2000), -- Detailed comments
    ChangeMethod NVARCHAR(100), -- Manual/Automatic/System/API/Workflow

    -- Change authorization
    AuthorizationLevel INT, -- Authorization level used
    ApprovalRequired BIT DEFAULT 0,
    ApprovedBy BIGINT, -- User who approved the change
    ApprovalDate DATETIME2,
    ApprovalComments NVARCHAR(1000),

    -- System context
    IPAddress NVARCHAR(45), -- IP address of the change
    UserAgent NVARCHAR(500), -- Browser/system user agent
    SessionID NVARCHAR(128), -- User session ID
    SystemName NVARCHAR(100), -- System that made the change

    -- Business context
    BusinessReason NVARCHAR(200), -- Business justification
    WorkflowInstanceID BIGINT, -- Associated workflow instance
    TaskAssignmentID BIGINT, -- Associated task assignment
    RelatedCases NVARCHAR(MAX), -- JSON array of related case IDs

    -- Timing and SLA impact
    SLAAdjustment INT DEFAULT 0, -- SLA adjustment in hours
    DeadlineExtension INT DEFAULT 0, -- Deadline extension in hours
    NewDeadline DATETIME2, -- New deadline if changed
    SLAJustification NVARCHAR(1000), -- Justification for SLA changes

    -- Data changes
    FieldChanges NVARCHAR(MAX), -- JSON of specific field changes
    DocumentChanges NVARCHAR(MAX), -- JSON of document changes
    AttachmentChanges NVARCHAR(MAX), -- JSON of attachment changes
    MetadataChanges NVARCHAR(MAX), -- JSON of metadata changes

    -- Quality and validation
    ValidationStatus NVARCHAR(100), -- Passed/Failed/Warning/Bypassed
    ValidationResults NVARCHAR(MAX), -- JSON validation results
    QualityScore DECIMAL(3,1), -- Quality score for this change
    ComplianceCheck BIT DEFAULT 0, -- Compliance check performed

    -- External system integration
    ExternalSystemResponse NVARCHAR(MAX), -- JSON response from external systems
    LGSPSyncStatus NVARCHAR(100), -- LGSP synchronization status
    APICallResults NVARCHAR(MAX), -- JSON API call results

    -- Performance metrics
    ProcessingTime DECIMAL(8,2), -- Time taken to process change in minutes
    SystemResponseTime DECIMAL(8,2), -- System response time in milliseconds
    ComplexityScore INT DEFAULT 1, -- Complexity of the change

    -- Rollback information
    CanRollback BIT DEFAULT 0, -- Can this change be rolled back
    RollbackDeadline DATETIME2, -- Deadline for rollback
    RolledBack BIT DEFAULT 0, -- Has been rolled back
    RollbackBy BIGINT, -- User who performed rollback
    RollbackAt DATETIME2, -- When rollback was performed
    RollbackReason NVARCHAR(1000), -- Reason for rollback

    -- Communication and notifications
    NotificationsSent INT DEFAULT 0, -- Number of notifications sent
    NotificationRecipients NVARCHAR(MAX), -- JSON array of notification recipients
    CommunicationLog NVARCHAR(MAX), -- JSON communication log

    -- Error handling
    HasErrors BIT DEFAULT 0, -- Whether errors occurred during change
    ErrorDetails NVARCHAR(MAX), -- JSON error details
    WarningMessages NVARCHAR(MAX), -- JSON warning messages
    RecoveryActions NVARCHAR(MAX), -- JSON recovery actions taken

    -- Audit and compliance specific
    ComplianceLevel TINYINT DEFAULT 2, -- 1=Low, 2=Medium, 3=High, 4=Critical
    AuditSignificance TINYINT DEFAULT 2, -- Audit significance level
    RegulatoryImpact NVARCHAR(200), -- Regulatory impact assessment
    DataClassification NVARCHAR(100), -- Data classification level

    -- Performance and optimization
    CacheInvalidated BIT DEFAULT 0, -- Whether cache was invalidated
    IndexesRebuilt BIT DEFAULT 0, -- Whether indexes were rebuilt
    StatisticsUpdated BIT DEFAULT 0, -- Whether statistics were updated

    -- Workflow correlation
    ParentHistoryID BIGINT, -- Parent history record if part of a sequence
    ChildHistoryCount INT DEFAULT 0, -- Number of child history records
    SequenceNumber INT DEFAULT 1, -- Sequence number in a batch of changes
    BatchID NVARCHAR(100), -- Batch identifier for grouped changes

    -- Constraints
    CONSTRAINT FK_STATUS_HISTORY_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_STATUS_HISTORY_OLD_STATUS FOREIGN KEY (OldStatusID) REFERENCES [case].STATUS_DEFINITION(StatusID),
    CONSTRAINT FK_STATUS_HISTORY_NEW_STATUS FOREIGN KEY (NewStatusID) REFERENCES [case].STATUS_DEFINITION(StatusID),
    CONSTRAINT FK_STATUS_HISTORY_TRANSITION FOREIGN KEY (TransitionID) REFERENCES [case].STATUS_TRANSITION(TransitionID),
    CONSTRAINT FK_STATUS_HISTORY_CHANGED_BY FOREIGN KEY (ChangedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_STATUS_HISTORY_APPROVED_BY FOREIGN KEY (ApprovedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_STATUS_HISTORY_ROLLBACK_BY FOREIGN KEY (RollbackBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_STATUS_HISTORY_TASK FOREIGN KEY (TaskAssignmentID) REFERENCES [case].TASK_ASSIGNMENT(AssignmentID),
    CONSTRAINT FK_STATUS_HISTORY_PARENT FOREIGN KEY (ParentHistoryID) REFERENCES [case].STATUS_HISTORY(HistoryID),
    CONSTRAINT CK_STATUS_HISTORY_Auth_Level CHECK (AuthorizationLevel IS NULL OR AuthorizationLevel BETWEEN 1 AND 4),
    CONSTRAINT CK_STATUS_HISTORY_Processing_Time CHECK (ProcessingTime >= 0)
);
GO

-- Indexes for STATUS_HISTORY
CREATE INDEX IX_STATUS_HISTORY_HoSo_Date ON [case].STATUS_HISTORY(HoSoID, StatusChangedAt DESC);
CREATE INDEX IX_STATUS_HISTORY_Status_Date ON [case].STATUS_HISTORY(NewStatusID, StatusChangedAt DESC);
CREATE INDEX IX_STATUS_HISTORY_User ON [case].STATUS_HISTORY(ChangedBy, StatusChangedAt DESC);
CREATE INDEX IX_STATUS_HISTORY_Transition ON [case].STATUS_HISTORY(TransitionID, StatusChangedAt DESC);
CREATE INDEX IX_STATUS_HISTORY_Method ON [case].STATUS_HISTORY(ChangeMethod, StatusChangedAt DESC);
CREATE INDEX IX_STATUS_HISTORY_Workflow ON [case].STATUS_HISTORY(WorkflowInstanceID, TaskAssignmentID);
CREATE INDEX IX_STATUS_HISTORY_Rollback ON [case].STATUS_HISTORY(CanRollback, RollbackDeadline) WHERE RolledBack = 0;
CREATE INDEX IX_STATUS_HISTORY_Batch ON [case].STATUS_HISTORY(BatchID, SequenceNumber) WHERE BatchID IS NOT NULL;
GO
```

### 15. SLA_TRACKING - Service Level Agreement tracking and management

```sql
CREATE TABLE [case].SLA_TRACKING (
    SLAID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL,

    -- SLA identification and classification
    SLAType NVARCHAR(100) NOT NULL, -- Overall/Step/Task/Escalation/Custom
    SLACategory NVARCHAR(100), -- Processing/Response/Resolution/Delivery/Quality
    SLAName NVARCHAR(200), -- Descriptive name of the SLA
    SLADescription NVARCHAR(1000), -- Detailed SLA description

    -- Associated entities
    WorkflowInstanceID BIGINT, -- Associated workflow instance
    TaskAssignmentID BIGINT, -- Associated task assignment
    StepInstanceID BIGINT, -- Associated workflow step
    StatusTransitionID BIGINT, -- Associated status transition

    -- Target timelines
    TargetStartTime DATETIME2 NOT NULL, -- When SLA period starts
    TargetEndTime DATETIME2 NOT NULL, -- When SLA should be met
    OriginalTargetEndTime DATETIME2, -- Original target (before any extensions)
    BusinessHoursOnly BIT DEFAULT 0, -- Calculate SLA using business hours only

    -- Actual timelines
    ActualStartTime DATETIME2, -- When work actually started
    ActualEndTime DATETIME2, -- When work actually completed
    PausedTime DATETIME2, -- When SLA was paused
    ResumedTime DATETIME2, -- When SLA was resumed
    TotalPausedDuration INT DEFAULT 0, -- Total paused time in minutes

    -- SLA duration and thresholds
    SLADurationHours DECIMAL(8,2) NOT NULL, -- SLA duration in hours
    WarningThresholdHours DECIMAL(8,2), -- Warning threshold before breach
    CriticalThresholdHours DECIMAL(8,2), -- Critical threshold before breach
    BufferTimeHours DECIMAL(8,2) DEFAULT 0, -- Buffer time allowed

    -- Current status
    SLAStatus NVARCHAR(50) DEFAULT 'OnTrack', -- OnTrack/Warning/Critical/Breached/Met/Paused/Cancelled
    CompletionPercentage DECIMAL(5,2) DEFAULT 0, -- Estimated completion percentage
    RemainingHours DECIMAL(8,2), -- Calculated remaining hours
    ElapsedHours DECIMAL(8,2), -- Elapsed hours so far

    -- Breach tracking
    IsBreached BIT DEFAULT 0, -- SLA has been breached
    BreachTime DATETIME2, -- When SLA was breached
    BreachDurationMinutes INT DEFAULT 0, -- How long the breach lasted
    BreachSeverity TINYINT DEFAULT 1, -- 1=Minor, 2=Major, 3=Critical, 4=Severe
    BreachImpact NVARCHAR(100), -- Low/Medium/High/Critical impact
    BreachReason NVARCHAR(2000), -- Reason for breach

    -- Escalation tracking
    EscalationLevel INT DEFAULT 0, -- 0=None, 1=Supervisor, 2=Manager, 3=Director, 4+
    EscalatedAt DATETIME2, -- When escalated
    EscalatedTo BIGINT, -- Who it was escalated to
    EscalationReason NVARCHAR(1000), -- Reason for escalation
    EscalationResolved BIT DEFAULT 0, -- Escalation resolved

    -- Extension and adjustment
    ExtensionRequested BIT DEFAULT 0, -- Extension requested
    ExtensionGranted BIT DEFAULT 0, -- Extension granted
    ExtensionHours DECIMAL(8,2) DEFAULT 0, -- Extension granted in hours
    ExtensionReason NVARCHAR(2000), -- Reason for extension
    ExtensionApprovedBy BIGINT, -- Who approved extension
    ExtensionApprovedAt DATETIME2, -- When extension was approved

    -- Performance metrics
    PerformanceScore DECIMAL(5,2), -- SLA performance score (0-100)
    QualityScore DECIMAL(3,1), -- Quality score (1-5)
    EfficiencyScore DECIMAL(5,2), -- Efficiency score (0-100)
    CustomerImpact NVARCHAR(100), -- None/Low/Medium/High/Critical

    -- Risk and priority
    RiskLevel TINYINT DEFAULT 2, -- 1=Low, 2=Medium, 3=High, 4=Critical
    BusinessPriority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    UrgencyLevel TINYINT DEFAULT 3, -- 1=Urgent, 2=High, 3=Normal, 4=Low

    -- Dependencies and constraints
    Dependencies NVARCHAR(MAX), -- JSON array of dependency SLA IDs
    Constraints NVARCHAR(MAX), -- JSON constraints affecting SLA
    ExternalFactors NVARCHAR(MAX), -- JSON external factors affecting SLA

    -- Notification and communication
    NotificationsSent INT DEFAULT 0, -- Number of notifications sent
    LastNotificationAt DATETIME2, -- When last notification was sent
    NotificationPreferences NVARCHAR(MAX), -- JSON notification preferences
    AutoNotifyEnabled BIT DEFAULT 1, -- Enable automatic notifications

    -- History and audit
    StatusHistory NVARCHAR(MAX), -- JSON history of status changes
    PerformanceHistory NVARCHAR(MAX), -- JSON history of performance metrics
    EscalationHistory NVARCHAR(MAX), -- JSON history of escalations
    AuditNotes NVARCHAR(MAX), -- JSON audit notes

    -- Business rules and exceptions
    BusinessRules NVARCHAR(MAX), -- JSON business rules applied
    ExceptionRules NVARCHAR(MAX), -- JSON exception rules
    ComplianceRules NVARCHAR(MAX), -- JSON compliance requirements
    CustomRules NVARCHAR(MAX), -- JSON custom rules

    -- Resource and workload tracking
    AssignedResources NVARCHAR(MAX), -- JSON assigned resources
    WorkloadFactor DECIMAL(5,2) DEFAULT 1.0, -- Workload factor affecting SLA
    ComplexityFactor DECIMAL(5,2) DEFAULT 1.0, -- Complexity factor
    ResourceUtilization DECIMAL(5,2), -- Resource utilization percentage

    -- Cost and impact analysis
    EstimatedCost DECIMAL(18,2), -- Estimated cost of meeting SLA
    ActualCost DECIMAL(18,2), -- Actual cost incurred
    SavingsPotential DECIMAL(18,2), -- Potential savings from meeting SLA
    PenaltyCost DECIMAL(18,2), -- Penalty cost for breach

    -- External system integration
    ExternalSLAID NVARCHAR(255), -- External system SLA ID
    ProviderSLA NVARCHAR(MAX), -- JSON provider SLA terms
    ContractualSLA NVARCHAR(MAX), -- JSON contractual SLA requirements
    LegalRequirements NVARCHAR(MAX), -- JSON legal requirements

    -- Reporting and analytics
    ReportingPeriod NVARCHAR(50), -- Daily/Weekly/Monthly/Quarterly
    KPICategory NVARCHAR(100), -- KPI category for reporting
    BenchmarkData NVARCHAR(MAX), -- JSON benchmark data
    TrendAnalysis NVARCHAR(MAX), -- JSON trend analysis

    -- Environment and conditions
    WorkingHours NVARCHAR(MAX), -- JSON working hours configuration
    Holidays NVARCHAR(MAX), -- JSON holiday calendar
    WeatherConditions NVARCHAR(200), -- Weather impact if applicable
    SystemConditions NVARCHAR(200), -- System conditions affecting SLA

    -- Machine learning and prediction
    PredictedCompletionTime DATETIME2, -- ML-predicted completion time
    PredictionConfidence DECIMAL(5,2), -- Prediction confidence score
    RiskPrediction DECIMAL(5,2), -- Risk prediction score
    RecommendedActions NVARCHAR(MAX), -- JSON recommended actions

    -- Lifecycle management
    IsActive BIT DEFAULT 1, -- SLA is currently active
    IsPaused BIT DEFAULT 0, -- SLA is currently paused
    PauseReason NVARCHAR(1000), -- Reason for pausing
    PausedBy BIGINT, -- Who paused the SLA

    -- Completion and closure
    CompletedAt DATETIME2, -- When SLA was completed
    CompletionMethod NVARCHAR(100), -- Automatic/Manual/System/External
    CompletionNotes NVARCHAR(2000), -- Completion notes
    FinalScore DECIMAL(5,2), -- Final SLA score
    LessonsLearned NVARCHAR(MAX), -- JSON lessons learned

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_SLA_TRACKING_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_SLA_TRACKING_WORKFLOW FOREIGN KEY (WorkflowInstanceID) REFERENCES [workflow].WORKFLOW_INSTANCE(InstanceID),
    CONSTRAINT FK_SLA_TRACKING_TASK FOREIGN KEY (TaskAssignmentID) REFERENCES [case].TASK_ASSIGNMENT(AssignmentID),
    CONSTRAINT FK_SLA_TRACKING_STATUS_TRANSITION FOREIGN KEY (StatusTransitionID) REFERENCES [case].STATUS_TRANSITION(TransitionID),
    CONSTRAINT FK_SLA_TRACKING_ESCALATED_TO FOREIGN KEY (EscalatedTo) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACKING_EXTENSION_APPROVED FOREIGN KEY (ExtensionApprovedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACKING_PAUSED_BY FOREIGN KEY (PausedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACKING_CREATED_BY FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_SLA_TRACKING_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_SLA_TRACKING_Target_Times CHECK (TargetStartTime <= TargetEndTime),
    CONSTRAINT CK_SLA_TRACKING_Duration CHECK (SLADurationHours > 0),
    CONSTRAINT CK_SLA_TRACKING_Completion CHECK (CompletionPercentage BETWEEN 0 AND 100),
    CONSTRAINT CK_SLA_TRACKING_Breach_Severity CHECK (BreachSeverity BETWEEN 1 AND 4),
    CONSTRAINT CK_SLA_TRACKING_Risk_Level CHECK (RiskLevel BETWEEN 1 AND 4),
    CONSTRAINT CK_SLA_TRACKING_Priority CHECK (BusinessPriority BETWEEN 1 AND 4),
    CONSTRAINT CK_SLA_TRACKING_Urgency CHECK (UrgencyLevel BETWEEN 1 AND 4)
);
GO

-- Indexes for SLA_TRACKING
CREATE INDEX IX_SLA_TRACKING_HoSo ON [case].SLA_TRACKING(HoSoID, SLAStatus, TargetEndTime);
CREATE INDEX IX_SLA_TRACKING_Status ON [case].SLA_TRACKING(SLAStatus, TargetEndTime) WHERE IsActive = 1;
CREATE INDEX IX_SLA_TRACKING_Breach ON [case].SLA_TRACKING(IsBreached, BreachTime DESC) WHERE IsBreached = 1;
CREATE INDEX IX_SLA_TRACKING_Warning ON [case].SLA_TRACKING(SLAStatus, RemainingHours) WHERE SLAStatus IN ('Warning', 'Critical');
CREATE INDEX IX_SLA_TRACKING_Escalation ON [case].SLA_TRACKING(EscalationLevel, EscalatedAt DESC) WHERE EscalationLevel > 0;
CREATE INDEX IX_SLA_TRACKING_Type ON [case].SLA_TRACKING(SLAType, SLACategory, IsActive);
CREATE INDEX IX_SLA_TRACKING_Workflow ON [case].SLA_TRACKING(WorkflowInstanceID, TaskAssignmentID);
CREATE INDEX IX_SLA_TRACKING_Performance ON [case].SLA_TRACKING(PerformanceScore DESC, QualityScore DESC);
CREATE INDEX IX_SLA_TRACKING_Risk ON [case].SLA_TRACKING(RiskLevel DESC, BusinessPriority, UrgencyLevel);
CREATE INDEX IX_SLA_TRACKING_Target_End ON [case].SLA_TRACKING(TargetEndTime, SLAStatus) WHERE IsActive = 1;
CREATE INDEX IX_SLA_TRACKING_Active ON [case].SLA_TRACKING(IsActive, IsPaused, CreatedAt DESC);
GO
```

### 16. CITIZEN_FEEDBACK - Citizen satisfaction and feedback system

```sql
CREATE TABLE [case].CITIZEN_FEEDBACK (
    FeedbackID BIGINT PRIMARY KEY IDENTITY,

    -- Case relationship
    HoSoID BIGINT NOT NULL,
    CitizenID BIGINT NOT NULL, -- From identity schema

    -- Feedback identification
    FeedbackCode NVARCHAR(50) UNIQUE NOT NULL, -- FB-YYYY-NNNNNN format
    FeedbackType NVARCHAR(50) NOT NULL, -- COMPLETION, PROCESS, SERVICE, COMPLAINT, SUGGESTION
    FeedbackChannel NVARCHAR(50) NOT NULL, -- ONLINE, MOBILE, PHONE, COUNTER, SURVEY

    -- Service evaluation
    OverallRating TINYINT, -- 1-5 scale
    ProcessEfficiencyRating TINYINT, -- 1-5 scale (How smooth was the process)
    StaffServiceRating TINYINT, -- 1-5 scale (Quality of staff interaction)
    TimelinessRating TINYINT, -- 1-5 scale (Meeting deadlines)
    DocumentClarityRating TINYINT, -- 1-5 scale (Clear requirements and forms)
    DigitalExperienceRating TINYINT, -- 1-5 scale (Online portal usability)

    -- Feedback content
    Title NVARCHAR(255) NOT NULL,
    Content NVARCHAR(MAX) NOT NULL,
    PositiveAspects NVARCHAR(MAX), -- What worked well
    ImprovementSuggestions NVARCHAR(MAX), -- Areas for improvement
    SpecificComplaint NVARCHAR(MAX), -- Specific issues encountered

    -- Satisfaction metrics
    WouldRecommend BIT, -- Would recommend service to others
    WouldUseAgain BIT, -- Would use the service again
    MetExpectations TINYINT, -- 1=Far Below, 2=Below, 3=Met, 4=Exceeded, 5=Far Exceeded

    -- Processing details
    ProcessingStage NVARCHAR(100), -- Which stage the feedback relates to
    StaffMembersInvolved NVARCHAR(MAX), -- JSON array of staff IDs involved
    ProcessingTime DECIMAL(10,2), -- Actual processing time in hours
    ExpectedTime DECIMAL(10,2), -- Expected processing time in hours

    -- Geographic and demographic context
    ServiceOfficeID BIGINT, -- Which office provided the service
    CitizenAge TINYINT, -- Age group: 1=<25, 2=25-35, 3=36-50, 4=51-65, 5=>65
    CitizenGender TINYINT, -- 1=Male, 2=Female, 3=Other, 4=Prefer not to say
    CitizenEducation TINYINT, -- 1=Primary, 2=Secondary, 3=University, 4=Graduate
    ServiceFrequency TINYINT, -- 1=First time, 2=Occasionally, 3=Regular, 4=Frequent

    -- Feedback processing
    Status NVARCHAR(50) DEFAULT 'Submitted', -- Submitted/UnderReview/Acknowledged/Addressed/Closed
    Priority TINYINT DEFAULT 3, -- 1=Low, 2=Medium, 3=High, 4=Urgent
    IsPublic BIT DEFAULT 0, -- Can be displayed publicly (with consent)
    RequiresFollowUp BIT DEFAULT 0, -- Needs follow-up contact

    -- Sentiment analysis (AI-generated)
    SentimentScore DECIMAL(5,4), -- -1 to 1 (negative to positive)
    SentimentLabel NVARCHAR(50), -- VERY_NEGATIVE, NEGATIVE, NEUTRAL, POSITIVE, VERY_POSITIVE
    EmotionalTone NVARCHAR(MAX), -- JSON array of emotions detected
    KeyTopics NVARCHAR(MAX), -- JSON array of topics extracted
    SatisfactionPrediction DECIMAL(5,4), -- ML prediction of satisfaction (0-1)

    -- Response and resolution
    ResponseRequired BIT DEFAULT 0,
    ResponseSentAt DATETIME2,
    ResponseContent NVARCHAR(MAX),
    ResponseBy BIGINT, -- Staff member who responded
    ResolutionStatus NVARCHAR(50), -- PENDING, IN_PROGRESS, RESOLVED, CANNOT_RESOLVE
    ResolutionDetails NVARCHAR(MAX),
    ResolutionTime DECIMAL(10,2), -- Hours taken to resolve

    -- Follow-up and verification
    FollowUpScheduled BIT DEFAULT 0,
    FollowUpDate DATETIME2,
    FollowUpMethod NVARCHAR(50), -- PHONE, EMAIL, SMS, VISIT
    VerificationStatus NVARCHAR(50), -- PENDING, VERIFIED, DISPUTED
    VerifiedAt DATETIME2,
    VerifiedBy BIGINT,

    -- Quality assurance
    QualityScore DECIMAL(5,2), -- Internal quality assessment (0-100)
    QualityNotes NVARCHAR(1000), -- Internal quality notes
    IsEscalated BIT DEFAULT 0,
    EscalatedTo BIGINT, -- Supervisor/manager
    EscalatedAt DATETIME2,
    EscalationReason NVARCHAR(500),

    -- Privacy and consent
    ConsentToContact BIT DEFAULT 0, -- Consent for follow-up contact
    ConsentToPublish BIT DEFAULT 0, -- Consent to publish anonymized feedback
    DataRetentionDays INT DEFAULT 2555, -- 7 years default retention
    AnonymizeAfterDays INT DEFAULT 90, -- Anonymize personal data after 90 days

    -- Metadata
    SubmittedAt DATETIME2 DEFAULT GETDATE(),
    IPAddress NVARCHAR(45), -- For security/analytics
    UserAgent NVARCHAR(500), -- Browser/app info
    DeviceType NVARCHAR(50), -- DESKTOP, MOBILE, TABLET

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints and relationships
    CONSTRAINT FK_CITIZEN_FEEDBACK_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_CITIZEN FOREIGN KEY (CitizenID) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_OFFICE FOREIGN KEY (ServiceOfficeID) REFERENCES [system].OFFICE(OfficeID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_RESPONSE_BY FOREIGN KEY (ResponseBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_ESCALATED_TO FOREIGN KEY (EscalatedTo) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_VERIFIED_BY FOREIGN KEY (VerifiedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_CREATED_BY FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_CITIZEN_FEEDBACK_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),

    -- Check constraints
    CONSTRAINT CK_CITIZEN_FEEDBACK_Overall_Rating CHECK (OverallRating BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Process_Rating CHECK (ProcessEfficiencyRating BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Staff_Rating CHECK (StaffServiceRating BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Timeliness_Rating CHECK (TimelinessRating BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Document_Rating CHECK (DocumentClarityRating BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Digital_Rating CHECK (DigitalExperienceRating BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Expectations CHECK (MetExpectations BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Age CHECK (CitizenAge BETWEEN 1 AND 5),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Gender CHECK (CitizenGender BETWEEN 1 AND 4),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Education CHECK (CitizenEducation BETWEEN 1 AND 4),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Frequency CHECK (ServiceFrequency BETWEEN 1 AND 4),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Priority CHECK (Priority BETWEEN 1 AND 4),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Sentiment CHECK (SentimentScore BETWEEN -1 AND 1),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Satisfaction_Prediction CHECK (SatisfactionPrediction BETWEEN 0 AND 1),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Quality CHECK (QualityScore BETWEEN 0 AND 100),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Retention CHECK (DataRetentionDays > 0),
    CONSTRAINT CK_CITIZEN_FEEDBACK_Anonymize CHECK (AnonymizeAfterDays >= 0)
);
GO

-- Indexes for CITIZEN_FEEDBACK
CREATE INDEX IX_CITIZEN_FEEDBACK_HoSo ON [case].CITIZEN_FEEDBACK(HoSoID, SubmittedAt DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Citizen ON [case].CITIZEN_FEEDBACK(CitizenID, SubmittedAt DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Status ON [case].CITIZEN_FEEDBACK(Status, Priority DESC, SubmittedAt DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Rating ON [case].CITIZEN_FEEDBACK(OverallRating, SubmittedAt DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Type ON [case].CITIZEN_FEEDBACK(FeedbackType, FeedbackChannel, SubmittedAt DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Office ON [case].CITIZEN_FEEDBACK(ServiceOfficeID, SubmittedAt DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Response_Required ON [case].CITIZEN_FEEDBACK(ResponseRequired, Status) WHERE ResponseRequired = 1;
CREATE INDEX IX_CITIZEN_FEEDBACK_Follow_Up ON [case].CITIZEN_FEEDBACK(FollowUpScheduled, FollowUpDate) WHERE FollowUpScheduled = 1;
CREATE INDEX IX_CITIZEN_FEEDBACK_Escalated ON [case].CITIZEN_FEEDBACK(IsEscalated, EscalatedAt DESC) WHERE IsEscalated = 1;
CREATE INDEX IX_CITIZEN_FEEDBACK_Sentiment ON [case].CITIZEN_FEEDBACK(SentimentLabel, SentimentScore DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Quality ON [case].CITIZEN_FEEDBACK(QualityScore DESC, SubmittedAt DESC);
CREATE INDEX IX_CITIZEN_FEEDBACK_Public ON [case].CITIZEN_FEEDBACK(IsPublic, ConsentToPublish) WHERE IsPublic = 1;
CREATE INDEX IX_CITIZEN_FEEDBACK_Code ON [case].CITIZEN_FEEDBACK(FeedbackCode);
GO
```

### 17. SERVICE_RATING - Aggregate service performance ratings

```sql
CREATE TABLE [case].SERVICE_RATING (
    RatingID BIGINT PRIMARY KEY IDENTITY,

    -- Service identification
    ServiceCode NVARCHAR(100) NOT NULL, -- THU_TUC code
    ServiceName NVARCHAR(255) NOT NULL,
    ServiceOfficeID BIGINT NOT NULL,

    -- Rating period
    RatingPeriodType NVARCHAR(50) NOT NULL, -- DAILY, WEEKLY, MONTHLY, QUARTERLY, YEARLY
    PeriodStartDate DATE NOT NULL,
    PeriodEndDate DATE NOT NULL,

    -- Aggregate ratings
    OverallRating DECIMAL(3,2), -- Average overall rating (1.00-5.00)
    ProcessEfficiencyRating DECIMAL(3,2), -- Average process efficiency
    StaffServiceRating DECIMAL(3,2), -- Average staff service
    TimelinessRating DECIMAL(3,2), -- Average timeliness
    DocumentClarityRating DECIMAL(3,2), -- Average document clarity
    DigitalExperienceRating DECIMAL(3,2), -- Average digital experience

    -- Statistical data
    TotalFeedbacks INT DEFAULT 0, -- Total feedback received
    PositiveFeedbacks INT DEFAULT 0, -- Ratings 4-5
    NeutralFeedbacks INT DEFAULT 0, -- Rating 3
    NegativeFeedbacks INT DEFAULT 0, -- Ratings 1-2
    ResponseRate DECIMAL(5,2), -- % of completed cases with feedback

    -- Satisfaction metrics
    RecommendationRate DECIMAL(5,2), -- % who would recommend
    ReturnRate DECIMAL(5,2), -- % who would use again
    ExpectationsMet DECIMAL(5,2), -- % who met/exceeded expectations

    -- Performance indicators
    AverageProcessingTime DECIMAL(10,2), -- Hours
    SLAComplianceRate DECIMAL(5,2), -- % meeting SLA
    FirstPassSuccessRate DECIMAL(5,2), -- % completed without returns

    -- Sentiment analysis
    PositiveSentimentRate DECIMAL(5,2), -- % positive sentiment
    NegativeSentimentRate DECIMAL(5,2), -- % negative sentiment
    AverageSentimentScore DECIMAL(5,4), -- Average sentiment (-1 to 1)

    -- Trend analysis
    RatingTrend NVARCHAR(50), -- IMPROVING, STABLE, DECLINING
    TrendPercentage DECIMAL(5,2), -- % change from previous period
    TrendConfidence DECIMAL(5,2), -- Statistical confidence in trend

    -- Benchmarking
    NationalBenchmark DECIMAL(3,2), -- National average for this service type
    RegionalBenchmark DECIMAL(3,2), -- Regional average
    PerformanceIndex DECIMAL(5,2), -- Performance vs benchmark (100 = average)

    -- Quality indicators
    ComplaintRate DECIMAL(5,2), -- % of cases with complaints
    EscalationRate DECIMAL(5,2), -- % of feedback escalated
    ResolutionRate DECIMAL(5,2), -- % of issues resolved
    AverageResolutionTime DECIMAL(10,2), -- Hours to resolve issues

    -- Demographic insights
    AverageCustomerAge DECIMAL(4,1), -- Average customer age
    NewCustomerRate DECIMAL(5,2), -- % first-time users
    ReturnCustomerRate DECIMAL(5,2), -- % returning customers
    DigitalAdoptionRate DECIMAL(5,2), -- % using digital channels

    -- Statistical confidence
    ConfidenceLevel DECIMAL(5,2), -- Statistical confidence in ratings
    MarginOfError DECIMAL(5,4), -- Statistical margin of error
    SampleSize INT, -- Effective sample size

    -- Metadata
    CalculatedAt DATETIME2 DEFAULT GETDATE(),
    CalculatedBy NVARCHAR(100), -- System process or user
    Version INT DEFAULT 1, -- Rating calculation version

    -- Audit
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,

    -- Constraints
    CONSTRAINT FK_SERVICE_RATING_OFFICE FOREIGN KEY (ServiceOfficeID) REFERENCES [system].OFFICE(OfficeID),
    CONSTRAINT CK_SERVICE_RATING_Overall CHECK (OverallRating BETWEEN 1.00 AND 5.00),
    CONSTRAINT CK_SERVICE_RATING_Process CHECK (ProcessEfficiencyRating BETWEEN 1.00 AND 5.00),
    CONSTRAINT CK_SERVICE_RATING_Staff CHECK (StaffServiceRating BETWEEN 1.00 AND 5.00),
    CONSTRAINT CK_SERVICE_RATING_Timeliness CHECK (TimelinessRating BETWEEN 1.00 AND 5.00),
    CONSTRAINT CK_SERVICE_RATING_Document CHECK (DocumentClarityRating BETWEEN 1.00 AND 5.00),
    CONSTRAINT CK_SERVICE_RATING_Digital CHECK (DigitalExperienceRating BETWEEN 1.00 AND 5.00),
    CONSTRAINT CK_SERVICE_RATING_Feedbacks CHECK (TotalFeedbacks = PositiveFeedbacks + NeutralFeedbacks + NegativeFeedbacks),
    CONSTRAINT CK_SERVICE_RATING_Rates CHECK (ResponseRate BETWEEN 0 AND 100),
    CONSTRAINT CK_SERVICE_RATING_Performance CHECK (SLAComplianceRate BETWEEN 0 AND 100),
    CONSTRAINT CK_SERVICE_RATING_Sentiment_Score CHECK (AverageSentimentScore BETWEEN -1 AND 1),
    CONSTRAINT CK_SERVICE_RATING_Trend CHECK (TrendPercentage BETWEEN -100 AND 100),
    CONSTRAINT CK_SERVICE_RATING_Confidence CHECK (ConfidenceLevel BETWEEN 0 AND 100),
    CONSTRAINT CK_SERVICE_RATING_Benchmark CHECK (PerformanceIndex >= 0)
);
GO

-- Indexes for SERVICE_RATING
CREATE INDEX IX_SERVICE_RATING_Service ON [case].SERVICE_RATING(ServiceCode, ServiceOfficeID);
CREATE INDEX IX_SERVICE_RATING_Period ON [case].SERVICE_RATING(RatingPeriodType, PeriodStartDate, PeriodEndDate);
CREATE INDEX IX_SERVICE_RATING_Overall ON [case].SERVICE_RATING(OverallRating DESC, PeriodEndDate DESC);
CREATE INDEX IX_SERVICE_RATING_Office_Period ON [case].SERVICE_RATING(ServiceOfficeID, RatingPeriodType, PeriodEndDate DESC);
CREATE INDEX IX_SERVICE_RATING_Trend ON [case].SERVICE_RATING(RatingTrend, TrendPercentage DESC);
CREATE INDEX IX_SERVICE_RATING_Performance ON [case].SERVICE_RATING(PerformanceIndex DESC, OverallRating DESC);
CREATE INDEX IX_SERVICE_RATING_Calculated ON [case].SERVICE_RATING(CalculatedAt DESC);
GO
```

## CROSS-SCHEMA INTEGRATION VIEWS

```sql
-- View for Workflow service to access case information
CREATE VIEW [workflow].v_CaseInfo
AS
SELECT
    h.HoSoID,
    h.SoHoSo,
    h.TenHoSo,
    h.TTHCID,
    h.NguoiNopID,
    h.DonViXuLyID,
    h.CanBoXuLyID,
    h.TrangThaiID,
    h.MucDoUuTien,
    h.ThoiHanGiaiQuyet,
    h.WorkflowInstanceID,
    h.TienDoXuLy
FROM [case].HOSO h
WHERE h.NgayXoa IS NULL;
GO

-- View for Document service to access case document requirements
CREATE VIEW [document].v_CaseDocuments
AS
SELECT
    h.HoSoID,
    h.SoHoSo,
    h.TTHCID,
    h.SoTaiLieuYeuCau,
    h.SoTaiLieuDaNop,
    h.SoTaiLieuThieu,
    h.DanhSachTaiLieu,
    h.TrangThaiID
FROM [case].HOSO h
WHERE h.NgayXoa IS NULL;
GO

-- View for Payment service to access case payment information
CREATE VIEW [payment].v_CasePayments
AS
SELECT
    h.HoSoID,
    h.SoHoSo,
    h.TTHCID,
    h.NguoiNopID,
    h.PhiCanNop,
    h.PhiDaNop,
    h.TrangThaiThanhToan,
    h.NgayThanhToan
FROM [case].HOSO h
WHERE h.NgayXoa IS NULL;
GO

-- View for Notification service to access case communication needs
CREATE VIEW [notification].v_CaseNotifications
AS
SELECT
    h.HoSoID,
    h.SoHoSo,
    h.NguoiNopID,
    h.CanBoXuLyID,
    h.TrangThaiID,
    h.ThoiHanGiaiQuyet,
    h.ThongTinLienHe,
    bs.BoSungID,
    bs.ThoiHanBoSung,
    bs.TrangThai as TrangThaiBoSung
FROM [case].HOSO h
LEFT JOIN [case].HOSOBOSUNG bs ON h.HoSoID = bs.HoSoID AND bs.TrangThai IN ('Pending', 'InProgress')
WHERE h.NgayXoa IS NULL;
GO

-- View for Audit service to access case processing history
CREATE VIEW [audit].v_CaseAuditTrail
AS
SELECT
    qt.HoSoID,
    h.SoHoSo,
    qt.TenBuoc,
    qt.ThoiGianBatDau,
    qt.ThoiGianKetThuc,
    qt.NguoiXuLy,
    qt.TrangThaiBuoc,
    qt.KetQuaBuoc,
    qt.NoiDungXuLy
FROM [case].QUATRINHXULY qt
INNER JOIN [case].HOSO h ON qt.HoSoID = h.HoSoID
WHERE h.NgayXoa IS NULL
ORDER BY qt.ThoiGianBatDau DESC;
GO
```

## KEY FEATURES

### Comprehensive Case Lifecycle Management
- **End-to-End Tracking**: Complete case journey from submission to resolution
- **Status Management**: Detailed status tracking with history preservation
- **Timeline Visibility**: Comprehensive processing timeline with step-by-step details
- **Quality Assurance**: Built-in quality control and compliance tracking

### Advanced Workflow Integration
- **Workflow Engine Integration**: Seamless integration with Elsa workflow engine
- **Process Automation**: Support for automated and manual processing steps
- **Dynamic Assignment**: Intelligent case assignment based on rules and capacity
- **Escalation Management**: Comprehensive escalation with multiple levels

### Multi-Organization Collaboration
- **Inter-Organization Coordination**: Support for multi-organization case processing
- **Role-Based Collaboration**: Clear roles and responsibilities definition
- **Communication Management**: Structured communication and coordination tools
- **Resource Sharing**: Efficient resource sharing and cost allocation

### Performance and Analytics
- **Real-Time Metrics**: Live performance monitoring and analytics
- **Benchmarking**: Industry and historical performance comparison
- **Quality Scoring**: Comprehensive quality assessment framework
- **Improvement Insights**: AI-driven improvement recommendations

### Customer Experience Focus
- **Transparency**: Complete visibility into case progress
- **Communication**: Proactive communication and notification system
- **Self-Service**: Self-service capabilities for case tracking
- **Satisfaction Tracking**: Customer satisfaction monitoring and feedback

## BUSINESS RULES

### Case Processing Rules
- Cases must follow defined workflow sequences
- SLA deadlines must be monitored and enforced
- Quality checks are mandatory at defined checkpoints
- All processing steps must be documented and auditable

### Assignment and Routing Rules
- Cases assigned based on organizational capacity and expertise
- Emergency cases can bypass normal routing rules
- Workload balancing must be maintained across staff
- Escalation triggers automatically after defined thresholds

### Document and Data Rules
- All required documents must be submitted before processing
- Document quality must meet defined standards
- Data integrity must be maintained throughout processing
- Version control required for all document changes

### Performance and Quality Rules
- Minimum quality scores must be maintained
- SLA compliance rates must meet organizational targets
- Customer satisfaction scores must be above threshold
- Performance metrics updated in real-time

## PERFORMANCE CONSIDERATIONS

### Indexing Strategy
- Composite indexes for common query patterns (case lookup, status tracking)
- Time-based indexes for SLA monitoring and reporting
- User-based indexes for assignment and workload management
- Performance metric indexes for analytics and benchmarking

### Caching Strategy
- Case status information cached with smart invalidation
- Processing timeline cached for quick access
- Performance metrics cached with time-based expiration
- Assignment rules cached with dependency tracking

### Scalability Design
- Horizontal scaling support for high-volume case processing
- Partition tables by date for historical data management
- Archive completed cases to separate storage systems
- Load balancing for processing and assignment engines

### Data Archival Strategy
- Automated archival of completed cases based on retention policies
- Historical data preservation for compliance and analytics
- Efficient query performance for both active and archived data
- Compliance with government data retention requirements

## INTEGRATION PATTERNS

### Event-Driven Architecture
```sql
-- Events published by Case service:
-- CaseSubmitted
-- CaseAssigned
-- CaseStatusChanged
-- CaseCompleted
-- CaseRejected
-- SLABreached
-- QualityIssueDetected
-- DocumentRequested
-- PaymentRequired
-- CollaborationInitiated
```

### Workflow Integration Events
- CaseSubmitted → Start workflow instance
- WorkflowStepCompleted → Update case progress
- WorkflowSLABreached → Trigger escalation
- WorkflowCompleted → Mark case as completed

### Cross-Service Communication
- Identity service provides user and organization information
- TTHC service provides procedure definitions and requirements
- Document service manages case-related documents
- Payment service handles fee processing
- Notification service manages case communications
- Audit service logs all case activities

## MIGRATION CONSIDERATIONS

### From Legacy Case Management Systems
- Case data migration with status mapping
- Processing history preservation and transformation
- Document association and migration
- Performance metrics historical data import

### To Microservices Architecture
- Case service extraction with complete case management
- Event-driven synchronization with workflow service
- API design for case operations and queries
- Eventual consistency for distributed case data

### Data Quality and Cleansing
- Duplicate case detection and resolution
- Data validation and normalization
- Missing information identification and completion
- Performance baseline establishment for new system