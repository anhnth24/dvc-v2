# [notification] Schema - Notification System

## OVERVIEW

The `[notification]` schema handles multi-channel notification and communication management for the DVC v2 system. This schema primarily uses event-driven architecture with RabbitMQ for asynchronous processing rather than database tables for queue management.

## SCHEMA CREATION

```sql
-- Notification
CREATE SCHEMA [notification];
GO
```

## NOTIFICATION CONFIGURATION

### 1. NOTIFICATION_TEMPLATES - Message templates

```sql
CREATE TABLE [notification].NOTIFICATION_TEMPLATES (
    TemplateID BIGINT PRIMARY KEY IDENTITY,
    TemplateCode NVARCHAR(100) UNIQUE NOT NULL,
    TemplateName NVARCHAR(255) NOT NULL,

    -- Template type and channel
    NotificationType NVARCHAR(50) NOT NULL, -- SMS, EMAIL, PUSH, IN_APP
    Channel NVARCHAR(50) NOT NULL, -- System, Workflow, Payment, Document

    -- Content
    Subject NVARCHAR(500),
    BodyTemplate NVARCHAR(MAX) NOT NULL,
    BodyHTML NVARCHAR(MAX),

    -- Personalization
    VariableFields NVARCHAR(MAX), -- JSON array of variable placeholders
    LocalizedContent NVARCHAR(MAX), -- JSON object with translations

    -- Delivery settings
    Priority TINYINT DEFAULT 1, -- 1=Low, 2=Normal, 3=High, 4=Urgent
    RetryAttempts INT DEFAULT 3,
    RetryInterval INT DEFAULT 300, -- Seconds
    ExpirationHours INT DEFAULT 72,

    -- Status
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT
);
GO

CREATE INDEX IX_NOTIFICATION_TEMPLATE_Code ON [notification].NOTIFICATION_TEMPLATES(TemplateCode);
CREATE INDEX IX_NOTIFICATION_TEMPLATE_Type ON [notification].NOTIFICATION_TEMPLATES(NotificationType, Channel);
GO
```

### 2. NOTIFICATION_PREFERENCES - User notification preferences

```sql
CREATE TABLE [notification].NOTIFICATION_PREFERENCES (
    PreferenceID BIGINT PRIMARY KEY IDENTITY,
    UserID BIGINT NOT NULL,

    -- Channel preferences
    EmailEnabled BIT DEFAULT 1,
    SMSEnabled BIT DEFAULT 1,
    PushEnabled BIT DEFAULT 1,
    InAppEnabled BIT DEFAULT 1,

    -- Contact information
    PreferredEmail NVARCHAR(255),
    PreferredPhone NVARCHAR(20),
    BackupEmail NVARCHAR(255),
    BackupPhone NVARCHAR(20),

    -- Notification categories
    WorkflowNotifications BIT DEFAULT 1,
    PaymentNotifications BIT DEFAULT 1,
    DocumentNotifications BIT DEFAULT 1,
    SystemNotifications BIT DEFAULT 1,
    MarketingNotifications BIT DEFAULT 0,

    -- Timing preferences
    QuietHoursStart TIME,
    QuietHoursEnd TIME,
    WeekendDelivery BIT DEFAULT 1,
    BulkNotificationDigest BIT DEFAULT 0,

    -- Language and format
    PreferredLanguage NVARCHAR(10) DEFAULT 'vi-VN',
    HTMLFormat BIT DEFAULT 1,

    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,

    CONSTRAINT FK_NOTIFICATION_PREF_USER FOREIGN KEY (UserID) REFERENCES [identity].USER_PROFILE(UserID)
);
GO

CREATE INDEX IX_NOTIFICATION_PREF_User ON [notification].NOTIFICATION_PREFERENCES(UserID);
GO
```

### 3. NOTIFICATION_QUEUE - Async message processing queue

```sql
CREATE TABLE [notification].NOTIFICATION_QUEUE (
    QueueID BIGINT PRIMARY KEY IDENTITY,

    -- Message identification
    MessageID NVARCHAR(255) UNIQUE NOT NULL, -- UUID for message tracking
    CorrelationID NVARCHAR(255), -- For message correlation across systems
    ParentMessageID NVARCHAR(255), -- For message threading and replies

    -- Message type and channel
    MessageType NVARCHAR(50) NOT NULL, -- SMS/EMAIL/PUSH/IN_APP/WEBHOOK
    Channel NVARCHAR(50) NOT NULL, -- System/Workflow/Payment/Document/Emergency
    Priority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low, 5=Bulk

    -- Recipient information
    RecipientType NVARCHAR(50) NOT NULL, -- User/Role/Group/Broadcast/External
    RecipientID NVARCHAR(255), -- User ID, role name, group ID, etc.
    RecipientAddress NVARCHAR(500) NOT NULL, -- Email/phone/device token/webhook URL
    RecipientName NVARCHAR(255), -- Display name for personalization

    -- Message content
    Subject NVARCHAR(500),
    Content NVARCHAR(MAX) NOT NULL,
    ContentType NVARCHAR(100) DEFAULT 'text/plain', -- text/plain, text/html, application/json
    ContentEncoding NVARCHAR(50) DEFAULT 'UTF-8',

    -- Template integration
    TemplateID BIGINT, -- Reference to notification template
    TemplateVariables NVARCHAR(MAX), -- JSON template variables
    TemplateVersion NVARCHAR(20), -- Template version used

    -- Scheduling and timing
    ScheduledFor DATETIME2, -- When to send (NULL = immediate)
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    ProcessAfter DATETIME2 DEFAULT GETDATE(), -- Earliest processing time
    ExpiresAt DATETIME2, -- Message expiration time
    TimeZone NVARCHAR(100) DEFAULT 'Asia/Ho_Chi_Minh', -- Recipient timezone

    -- Processing status
    Status NVARCHAR(50) DEFAULT 'Pending', -- Pending/Processing/Sent/Delivered/Failed/Expired/Cancelled
    ProcessingNode NVARCHAR(100), -- Processing node identifier
    ProcessingStartedAt DATETIME2, -- When processing started
    ProcessedAt DATETIME2, -- When processing completed

    -- Business context
    RelatedEntityType NVARCHAR(100), -- HOSO/WORKFLOW/PAYMENT/SYSTEM/USER
    RelatedEntityID BIGINT, -- ID of related entity
    BusinessContext NVARCHAR(500), -- Business context description
    ActionContext NVARCHAR(200), -- Action that triggered notification

    -- Retry logic and error handling
    RetryCount INT DEFAULT 0, -- Current retry attempt
    MaxRetries INT DEFAULT 3, -- Maximum retry attempts
    RetryInterval INT DEFAULT 300, -- Retry interval in seconds (starts at 5 minutes)
    NextRetryAt DATETIME2, -- Next retry time
    BackoffMultiplier DECIMAL(3,1) DEFAULT 2.0, -- Exponential backoff multiplier

    -- Delivery tracking
    SentAt DATETIME2, -- When message was sent to provider
    DeliveredAt DATETIME2, -- When message was delivered to recipient
    ReadAt DATETIME2, -- When message was read/opened
    DeliveryConfirmed BIT DEFAULT 0, -- Delivery confirmation received
    ReadConfirmed BIT DEFAULT 0, -- Read confirmation received

    -- Provider integration
    ProviderName NVARCHAR(100), -- SMS gateway, email service, push service name
    ProviderMessageID NVARCHAR(255), -- Provider's message ID
    ProviderStatus NVARCHAR(100), -- Provider-specific status
    ProviderResponse NVARCHAR(MAX), -- JSON provider response
    DeliveryReportURL NVARCHAR(1000), -- Provider delivery report URL

    -- Cost and billing
    EstimatedCost DECIMAL(10,4) DEFAULT 0, -- Estimated cost
    ActualCost DECIMAL(10,4) DEFAULT 0, -- Actual cost charged by provider
    CostCurrency NVARCHAR(10) DEFAULT 'VND', -- Cost currency
    BillingReference NVARCHAR(100), -- Provider billing reference

    -- Error handling and debugging
    HasErrors BIT DEFAULT 0, -- Whether errors occurred
    ErrorCode NVARCHAR(100), -- Error code if failed
    ErrorMessage NVARCHAR(2000), -- Detailed error message
    ErrorDetails NVARCHAR(MAX), -- JSON error details
    ErrorOccurredAt DATETIME2, -- When error occurred

    -- Batch processing
    BatchID NVARCHAR(100), -- Batch identifier for bulk messages
    BatchSize INT, -- Size of the batch
    BatchPosition INT, -- Position within batch
    IsBatchMessage BIT DEFAULT 0, -- Is part of a batch

    -- Localization and personalization
    Language NVARCHAR(10) DEFAULT 'vi-VN', -- Message language
    LocalizationData NVARCHAR(MAX), -- JSON localization data
    PersonalizationData NVARCHAR(MAX), -- JSON personalization data

    -- Audit trail
    UpdatedAt DATETIME2, -- Last update time
    UpdatedBy BIGINT, -- User who updated

    -- Constraints
    CONSTRAINT FK_NOTIFICATION_QUEUE_TEMPLATE FOREIGN KEY (TemplateID) REFERENCES [notification].NOTIFICATION_TEMPLATES(TemplateID),
    CONSTRAINT FK_NOTIFICATION_QUEUE_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_NOTIFICATION_QUEUE_Priority CHECK (Priority BETWEEN 1 AND 5),
    CONSTRAINT CK_NOTIFICATION_QUEUE_Retry CHECK (RetryCount <= MaxRetries),
    CONSTRAINT CK_NOTIFICATION_QUEUE_Cost CHECK (EstimatedCost >= 0 AND ActualCost >= 0)
);
GO

-- Indexes for NOTIFICATION_QUEUE
CREATE INDEX IX_NOTIFICATION_QUEUE_Status ON [notification].NOTIFICATION_QUEUE(Status, Priority DESC, ProcessAfter);
CREATE INDEX IX_NOTIFICATION_QUEUE_Pending ON [notification].NOTIFICATION_QUEUE(Status, Priority DESC, CreatedAt) WHERE Status = 'Pending';
CREATE INDEX IX_NOTIFICATION_QUEUE_Processing ON [notification].NOTIFICATION_QUEUE(ProcessingNode, Status, ProcessingStartedAt) WHERE Status = 'Processing';
CREATE INDEX IX_NOTIFICATION_QUEUE_Scheduled ON [notification].NOTIFICATION_QUEUE(ScheduledFor, Status) WHERE ScheduledFor IS NOT NULL;
CREATE INDEX IX_NOTIFICATION_QUEUE_Retry ON [notification].NOTIFICATION_QUEUE(NextRetryAt, RetryCount) WHERE Status = 'Failed' AND RetryCount < MaxRetries;
CREATE INDEX IX_NOTIFICATION_QUEUE_Entity ON [notification].NOTIFICATION_QUEUE(RelatedEntityType, RelatedEntityID);
CREATE INDEX IX_NOTIFICATION_QUEUE_Recipient ON [notification].NOTIFICATION_QUEUE(RecipientType, RecipientID, CreatedAt DESC);
CREATE INDEX IX_NOTIFICATION_QUEUE_Provider ON [notification].NOTIFICATION_QUEUE(ProviderName, ProviderStatus, SentAt DESC);
CREATE INDEX IX_NOTIFICATION_QUEUE_Batch ON [notification].NOTIFICATION_QUEUE(BatchID, BatchPosition) WHERE IsBatchMessage = 1;
CREATE INDEX IX_NOTIFICATION_QUEUE_MessageID ON [notification].NOTIFICATION_QUEUE(MessageID);
CREATE INDEX IX_NOTIFICATION_QUEUE_Expiry ON [notification].NOTIFICATION_QUEUE(ExpiresAt) WHERE Status NOT IN ('Delivered', 'Failed', 'Expired');
GO
```

### 4. NOTIFICATION_HISTORY - Sent notification tracking

```sql
CREATE TABLE [notification].NOTIFICATION_HISTORY (
    NotificationID BIGINT PRIMARY KEY IDENTITY,

    -- Message identification
    MessageID NVARCHAR(255) UNIQUE NOT NULL,
    TemplateID BIGINT,
    TemplateCode NVARCHAR(100),

    -- Recipient information
    RecipientUserID BIGINT,
    RecipientType NVARCHAR(50), -- USER, EXTERNAL, SYSTEM
    RecipientAddress NVARCHAR(500), -- Email or phone number

    -- Message details
    NotificationType NVARCHAR(50) NOT NULL,
    Subject NVARCHAR(500),
    Body NVARCHAR(MAX),
    Priority TINYINT DEFAULT 1,

    -- Context
    RelatedEntityType NVARCHAR(100), -- HOSO, PAYMENT, WORKFLOW, SYSTEM
    RelatedEntityID NVARCHAR(100),
    BusinessContext NVARCHAR(500),

    -- Delivery tracking
    Status TINYINT DEFAULT 0, -- 0=Queued, 1=Sent, 2=Delivered, 3=Failed, 4=Expired
    SentAt DATETIME2,
    DeliveredAt DATETIME2,
    ReadAt DATETIME2,

    -- Failure handling
    FailureReason NVARCHAR(1000),
    RetryCount INT DEFAULT 0,
    NextRetryAt DATETIME2,
    ExpiresAt DATETIME2,

    -- Provider details
    ProviderName NVARCHAR(100),
    ProviderMessageID NVARCHAR(255),
    ProviderResponse NVARCHAR(MAX),

    CreatedAt DATETIME2 DEFAULT GETDATE(),

    CONSTRAINT FK_NOTIFICATION_HIST_TEMPLATE FOREIGN KEY (TemplateID) REFERENCES [notification].NOTIFICATION_TEMPLATES(TemplateID)
);
GO

-- Indexes for performance
CREATE INDEX IX_NOTIFICATION_HIST_Recipient ON [notification].NOTIFICATION_HISTORY(RecipientUserID, CreatedAt DESC);
CREATE INDEX IX_NOTIFICATION_HIST_Entity ON [notification].NOTIFICATION_HISTORY(RelatedEntityType, RelatedEntityID);
CREATE INDEX IX_NOTIFICATION_HIST_Status ON [notification].NOTIFICATION_HISTORY(Status, NextRetryAt);
CREATE INDEX IX_NOTIFICATION_HIST_Type ON [notification].NOTIFICATION_HISTORY(NotificationType, CreatedAt DESC);

-- Partitioning by month for performance
CREATE PARTITION FUNCTION pf_NotificationHistory_Month (DATETIME2)
AS RANGE RIGHT FOR VALUES (
    '2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01',
    '2024-05-01', '2024-06-01', '2024-07-01', '2024-08-01',
    '2024-09-01', '2024-10-01', '2024-11-01', '2024-12-01'
);
GO
```

## EVENT-DRIVEN ARCHITECTURE

### RabbitMQ Integration
The notification system primarily uses RabbitMQ for message processing:

```
Exchange: dvc.notifications
Routing Keys:
- notification.email.*
- notification.sms.*
- notification.push.*
- notification.system.*
```

### Notification Workers
Background workers handle notification processing:
- **Email Worker**: SMTP integration for email delivery
- **SMS Worker**: Integration with Vietnamese SMS gateways (Viettel, MobiFone, VinaPhone)
- **Push Worker**: Mobile push notification delivery
- **System Worker**: In-app notification management

## KEY FEATURES

### Multi-Channel Support
- **Email**: SMTP with template support
- **SMS**: Vietnamese carrier integration
- **Push Notifications**: Mobile app integration
- **In-App**: Real-time SignalR notifications

### Template System
- **Variable Substitution**: Dynamic content insertion
- **Localization**: Multi-language support
- **HTML/Plain Text**: Format flexibility
- **Personalization**: User-specific customization

### Delivery Management
- **Priority Queues**: Urgent message prioritization
- **Retry Logic**: Automatic failure recovery
- **Delivery Tracking**: Complete delivery lifecycle
- **Expiration Handling**: Time-sensitive message management

### User Preferences
- **Channel Control**: User-managed notification preferences
- **Quiet Hours**: Time-based delivery restriction
- **Category Filtering**: Selective notification types
- **Contact Management**: Multiple delivery addresses

## CROSS-SCHEMA INTEGRATION

### Workflow Integration
```sql
-- Workflow events trigger notifications
-- WorkflowStepCompleted → StatusUpdateNotification
-- WorkflowAssigned → TaskAssignmentNotification
-- WorkflowEscalated → EscalationNotification
```

### Case Integration
```sql
-- Case events trigger notifications
-- ApplicationReceived → ReceiptNotification
-- ApplicationCompleted → CompletionNotification
-- SupplementRequired → SupplementRequestNotification
```

### Payment Integration
```sql
-- Payment events trigger notifications
-- PaymentReceived → PaymentConfirmationNotification
-- PaymentFailed → PaymentFailureNotification
-- RefundProcessed → RefundNotification
```

## PERFORMANCE CONSIDERATIONS

### High-Volume Processing
- Asynchronous processing via RabbitMQ
- Worker scaling based on queue depth
- Batch processing for bulk notifications
- Database partitioning for history

### Real-Time Delivery
- SignalR for instant in-app notifications
- WebSocket connections for live updates
- Priority queues for urgent messages
- Circuit breakers for external services

### Scalability Features
- Horizontal worker scaling
- Message queue clustering
- Database read replicas
- CDN integration for templates

## BUSINESS RULES

### Notification Triggers
- Workflow state changes
- Application status updates
- Payment transactions
- Document processing events
- System maintenance alerts

### Delivery Rules
- Respect user preferences
- Honor quiet hours
- Implement retry policies
- Track delivery confirmations

### Privacy and Compliance
- Personal data protection
- Opt-out mechanisms
- Data retention policies
- Audit trail maintenance

## EXTERNAL INTEGRATIONS

### SMS Gateways
- **Viettel**: Primary SMS provider
- **MobiFone**: Secondary provider
- **VinaPhone**: Tertiary provider
- **Failover Logic**: Automatic provider switching

### Email Services
- **SMTP Servers**: Government email infrastructure
- **Cloud Services**: Backup email delivery
- **Template Engines**: Rich HTML formatting
- **Bounce Handling**: Failed delivery management

### Push Notification Services
- **Firebase**: Android push notifications
- **APNs**: iOS push notifications
- **Web Push**: Browser notifications
- **Analytics**: Delivery and engagement tracking