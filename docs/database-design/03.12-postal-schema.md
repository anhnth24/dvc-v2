# [postal] Schema - Postal Service Integration

## OVERVIEW

The `[postal]` schema manages comprehensive postal service integration with VietnamPost and other postal providers for the DVC v2 system. This schema handles shipment creation, tracking, delivery confirmation, and return processing for both document submission and result delivery.

## SCHEMA CREATION

```sql
-- Postal Service Integration
CREATE SCHEMA [postal];
GO
```

## CORE POSTAL TABLES

### 1. SHIPMENT_TRACKING - Main shipment tracking

```sql
CREATE TABLE [postal].SHIPMENT_TRACKING (
    ShipmentID BIGINT PRIMARY KEY IDENTITY,
    HoSoID BIGINT NOT NULL, -- Associated case/application

    -- Shipment identification
    TrackingNumber NVARCHAR(100) UNIQUE NOT NULL, -- Postal provider tracking number
    ShipmentCode NVARCHAR(100) UNIQUE NOT NULL, -- Internal shipment code
    ShipmentType NVARCHAR(50) NOT NULL, -- SendDocument/ReceiveDocument/ReturnDocument/NotificationLetter

    -- Postal provider information
    PostalProvider NVARCHAR(100) DEFAULT 'VietnamPost', -- VietnamPost/EMS/DHL/FedEx/Other
    ServiceType NVARCHAR(100) NOT NULL, -- Standard/Express/Priority/Economy/COD
    PostalServiceCode NVARCHAR(50), -- Provider-specific service code

    -- Shipment direction and purpose
    Direction NVARCHAR(50) NOT NULL, -- Incoming/Outgoing
    Purpose NVARCHAR(100) NOT NULL, -- DocumentSubmission/ResultDelivery/ReturnUndelivered/Notification

    -- Sender information
    SenderName NVARCHAR(255) NOT NULL,
    SenderPhone NVARCHAR(20),
    SenderEmail NVARCHAR(255),
    SenderAddress NVARCHAR(MAX) NOT NULL, -- JSON address structure
    SenderPostalCode NVARCHAR(20),
    SenderOrganization NVARCHAR(255), -- For official documents

    -- Receiver information
    ReceiverName NVARCHAR(255) NOT NULL,
    ReceiverPhone NVARCHAR(20),
    ReceiverEmail NVARCHAR(255),
    ReceiverAddress NVARCHAR(MAX) NOT NULL, -- JSON address structure
    ReceiverPostalCode NVARCHAR(20),
    ReceiverOrganization NVARCHAR(255),
    ReceiverIDCard NVARCHAR(20), -- For identity verification

    -- Shipment details
    PackageCount INT DEFAULT 1,
    TotalWeight DECIMAL(8,3), -- Weight in kg
    PackageDimensions NVARCHAR(MAX), -- JSON dimensions (length/width/height)
    PackageDescription NVARCHAR(1000),
    ValueDeclaration DECIMAL(18,2), -- Declared value

    -- Shipping costs and payment
    ShippingCost DECIMAL(18,2) NOT NULL,
    CODAmount DECIMAL(18,2) DEFAULT 0, -- Cash on delivery amount
    Insurance DECIMAL(18,2) DEFAULT 0,
    AdditionalFees DECIMAL(18,2) DEFAULT 0,
    PaymentMethod NVARCHAR(100), -- Prepaid/COD/Account/Other
    PaymentStatus NVARCHAR(100) DEFAULT 'Pending', -- Pending/Paid/Failed/Refunded

    -- Status and tracking
    Status NVARCHAR(100) NOT NULL, -- Created/Collected/InTransit/OutForDelivery/Delivered/Failed/Returned/Cancelled
    SubStatus NVARCHAR(100), -- Detailed status from provider
    CurrentLocation NVARCHAR(500), -- Current location description
    CurrentLocationCode NVARCHAR(100), -- Location code from provider

    -- Timing information
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CollectedAt DATETIME2, -- When picked up by postal service
    EstimatedDelivery DATETIME2,
    ActualDelivery DATETIME2,
    DeliveryWindow NVARCHAR(100), -- Morning/Afternoon/Evening/Anytime

    -- Delivery attempts and issues
    DeliveryAttempts INT DEFAULT 0,
    MaxDeliveryAttempts INT DEFAULT 3,
    LastAttemptAt DATETIME2,
    DeliveryIssues NVARCHAR(MAX), -- JSON array of delivery issues
    FailureReason NVARCHAR(1000),

    -- Special instructions and requirements
    SpecialInstructions NVARCHAR(2000),
    DeliveryRequirements NVARCHAR(MAX), -- JSON requirements (signature, ID verification, etc.)
    HandlingInstructions NVARCHAR(MAX), -- JSON handling instructions (fragile, urgent, etc.)

    -- Return and forwarding
    ReturnService BIT DEFAULT 0, -- Enable return service
    ForwardingAddress NVARCHAR(MAX), -- JSON forwarding address if applicable
    ReturnReason NVARCHAR(1000),
    ReturnTrackingNumber NVARCHAR(100), -- Tracking number for return shipment

    -- Documents and attachments
    DocumentList NVARCHAR(MAX), -- JSON array of documents in shipment
    AttachmentIDs NVARCHAR(MAX), -- JSON array of file IDs
    ManifestURL NVARCHAR(2000), -- URL to shipping manifest

    -- Quality and service level
    ServiceLevel NVARCHAR(100), -- Standard/Premium/VIP/Government
    Priority TINYINT DEFAULT 3, -- 1=Critical, 2=High, 3=Normal, 4=Low
    UrgencyFlag BIT DEFAULT 0, -- Mark as urgent shipment

    -- API integration
    ProviderAPIResponse NVARCHAR(MAX), -- JSON response from provider API
    LastAPISync DATETIME2, -- Last sync with provider API
    APICallCount INT DEFAULT 0, -- Number of API calls made

    -- Notifications
    NotificationsSent INT DEFAULT 0,
    ReceiverNotified BIT DEFAULT 0,
    SenderNotified BIT DEFAULT 0,
    NotificationPreferences NVARCHAR(MAX), -- JSON notification preferences

    -- Quality and compliance
    QualityChecked BIT DEFAULT 0,
    ComplianceStatus NVARCHAR(100), -- Compliant/NonCompliant/Pending/Exempt
    CustomsDeclaration NVARCHAR(MAX), -- JSON customs information if international

    -- Performance metrics
    TransitTime INT, -- Actual transit time in hours
    DeliveryPerformance NVARCHAR(100), -- OnTime/Early/Late/Failed
    CustomerSatisfaction DECIMAL(3,1), -- Customer rating 1-5

    -- Error handling and logging
    ErrorLog NVARCHAR(MAX), -- JSON error log
    RetryCount INT DEFAULT 0,
    LastRetryAt DATETIME2,

    -- Audit trail
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_SHIPMENT_HOSO FOREIGN KEY (HoSoID) REFERENCES [case].HOSO(HoSoID),
    CONSTRAINT FK_SHIPMENT_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_SHIPMENT_Weight CHECK (TotalWeight >= 0),
    CONSTRAINT CK_SHIPMENT_Cost CHECK (ShippingCost >= 0),
    CONSTRAINT CK_SHIPMENT_Priority CHECK (Priority BETWEEN 1 AND 4)
);
GO

-- Indexes for SHIPMENT_TRACKING
CREATE INDEX IX_SHIPMENT_TRACKING_Number ON [postal].SHIPMENT_TRACKING(TrackingNumber);
CREATE INDEX IX_SHIPMENT_TRACKING_HoSo ON [postal].SHIPMENT_TRACKING(HoSoID, Status);
CREATE INDEX IX_SHIPMENT_TRACKING_Status ON [postal].SHIPMENT_TRACKING(Status, EstimatedDelivery);
CREATE INDEX IX_SHIPMENT_TRACKING_Provider ON [postal].SHIPMENT_TRACKING(PostalProvider, ServiceType, Status);
CREATE INDEX IX_SHIPMENT_TRACKING_Delivery ON [postal].SHIPMENT_TRACKING(EstimatedDelivery, Status) WHERE Status IN ('InTransit', 'OutForDelivery');
CREATE INDEX IX_SHIPMENT_TRACKING_Location ON [postal].SHIPMENT_TRACKING(CurrentLocationCode, Status);
CREATE INDEX IX_SHIPMENT_TRACKING_Performance ON [postal].SHIPMENT_TRACKING(DeliveryPerformance, TransitTime);
CREATE INDEX IX_SHIPMENT_TRACKING_Created ON [postal].SHIPMENT_TRACKING(CreatedAt DESC);
GO
```

### 2. DELIVERY_CONFIRMATION - Delivery confirmation and proof

```sql
CREATE TABLE [postal].DELIVERY_CONFIRMATION (
    ConfirmationID BIGINT PRIMARY KEY IDENTITY,
    ShipmentID BIGINT NOT NULL,

    -- Delivery details
    DeliveredAt DATETIME2 NOT NULL,
    DeliveryMethod NVARCHAR(100), -- HandDelivery/SecureBox/Reception/Neighbor/Other
    DeliveryLocation NVARCHAR(500), -- Specific delivery location

    -- Receiver information
    ReceiverName NVARCHAR(255) NOT NULL, -- Actual receiver name
    ReceiverIDCard NVARCHAR(20), -- ID verification
    ReceiverPhone NVARCHAR(20),
    ReceiverRelation NVARCHAR(100), -- Self/Family/Secretary/Guard/Other

    -- Delivery verification
    SignatureRequired BIT DEFAULT 1,
    SignatureObtained BIT DEFAULT 0,
    DigitalSignature VARBINARY(MAX), -- Digital signature capture
    PhotoProof VARBINARY(MAX), -- Delivery photo
    GPSLocation NVARCHAR(100), -- GPS coordinates of delivery

    -- Delivery agent information
    DeliveryAgentID NVARCHAR(100), -- Postal agent ID
    DeliveryAgentName NVARCHAR(255),
    DeliveryAgentPhone NVARCHAR(20),
    VehicleNumber NVARCHAR(50), -- Delivery vehicle

    -- Package condition
    PackageCondition NVARCHAR(100), -- Perfect/Good/Damaged/Tampered
    ConditionNotes NVARCHAR(1000),
    DamagePhotos VARBINARY(MAX), -- Photos of damage if any

    -- Special circumstances
    DeliveryNotes NVARCHAR(2000), -- Special delivery notes
    SpecialCircumstances NVARCHAR(MAX), -- JSON special circumstances
    WeatherConditions NVARCHAR(100), -- Weather at delivery time

    -- Verification codes
    DeliveryCode NVARCHAR(50), -- SMS/email verification code
    VerificationStatus NVARCHAR(100), -- Verified/Unverified/Failed
    VerificationMethod NVARCHAR(100), -- SMS/Email/Phone/InPerson

    -- Quality assessment
    DeliveryQuality DECIMAL(3,1), -- Quality score 1-5
    CustomerFeedback NVARCHAR(2000),
    DeliveryRating TINYINT, -- 1-5 rating

    -- Return receipt
    ReturnReceiptRequired BIT DEFAULT 0,
    ReturnReceiptObtained BIT DEFAULT 0,
    ReturnReceiptID NVARCHAR(100),

    -- Legal and compliance
    WitnessName NVARCHAR(255), -- Witness to delivery
    WitnessContact NVARCHAR(100),
    LegalConfirmation BIT DEFAULT 0,
    ComplianceNotes NVARCHAR(1000),

    -- Integration with external systems
    ExternalConfirmationID NVARCHAR(255), -- External system confirmation ID
    APIResponseData NVARCHAR(MAX), -- JSON API response data

    -- Proof documents
    ProofDocuments NVARCHAR(MAX), -- JSON array of proof document IDs
    CertificateNumber NVARCHAR(100), -- Delivery certificate number

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CreatedBy BIGINT,
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_DELIVERY_CONFIRMATION_SHIPMENT FOREIGN KEY (ShipmentID) REFERENCES [postal].SHIPMENT_TRACKING(ShipmentID),
    CONSTRAINT FK_DELIVERY_CONFIRMATION_CREATED_BY FOREIGN KEY (CreatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_DELIVERY_CONFIRMATION_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_DELIVERY_CONFIRMATION_Quality CHECK (DeliveryQuality BETWEEN 1 AND 5),
    CONSTRAINT CK_DELIVERY_CONFIRMATION_Rating CHECK (DeliveryRating BETWEEN 1 AND 5)
);
GO

-- Indexes for DELIVERY_CONFIRMATION
CREATE INDEX IX_DELIVERY_CONFIRMATION_Shipment ON [postal].DELIVERY_CONFIRMATION(ShipmentID);
CREATE INDEX IX_DELIVERY_CONFIRMATION_Delivered ON [postal].DELIVERY_CONFIRMATION(DeliveredAt DESC);
CREATE INDEX IX_DELIVERY_CONFIRMATION_Receiver ON [postal].DELIVERY_CONFIRMATION(ReceiverIDCard, DeliveredAt DESC);
CREATE INDEX IX_DELIVERY_CONFIRMATION_Agent ON [postal].DELIVERY_CONFIRMATION(DeliveryAgentID, DeliveredAt DESC);
CREATE INDEX IX_DELIVERY_CONFIRMATION_Quality ON [postal].DELIVERY_CONFIRMATION(DeliveryQuality DESC, CustomerFeedback);
CREATE INDEX IX_DELIVERY_CONFIRMATION_Verification ON [postal].DELIVERY_CONFIRMATION(VerificationStatus, VerificationMethod);
GO
```

### 3. RETURN_HANDLING - Undelivered and return shipment management

```sql
CREATE TABLE [postal].RETURN_HANDLING (
    ReturnID BIGINT PRIMARY KEY IDENTITY,
    ShipmentID BIGINT NOT NULL,

    -- Return details
    ReturnType NVARCHAR(100) NOT NULL, -- Undelivered/Refused/Damaged/AddressIncorrect/RecipientMoved/Other
    ReturnReason NVARCHAR(2000) NOT NULL,
    ReturnCode NVARCHAR(50), -- Postal provider return code

    -- Return timing
    ReturnInitiatedAt DATETIME2 DEFAULT GETDATE(),
    ReturnCompletedAt DATETIME2,
    ReturnReceivedAt DATETIME2, -- When returned to sender

    -- Return tracking
    ReturnTrackingNumber NVARCHAR(100), -- New tracking number for return
    ReturnStatus NVARCHAR(100) DEFAULT 'Initiated', -- Initiated/InTransit/Completed/Failed
    ReturnLocation NVARCHAR(500), -- Current location during return

    -- Failure analysis
    FailureCategory NVARCHAR(100), -- Address/Recipient/Service/System/Other
    FailureDetails NVARCHAR(MAX), -- JSON detailed failure analysis
    DeliveryAttemptCount INT DEFAULT 0,
    LastDeliveryAttempt DATETIME2,

    -- Address issues
    AddressIssue NVARCHAR(100), -- Incomplete/Incorrect/NotFound/Inaccessible/Other
    CorrectedAddress NVARCHAR(MAX), -- JSON corrected address if available
    AddressVerificationStatus NVARCHAR(100), -- Verified/Unverified/Invalid

    -- Recipient issues
    RecipientIssue NVARCHAR(100), -- NotFound/Refused/Unavailable/Moved/Deceased/Other
    RecipientAlternativeContact NVARCHAR(MAX), -- JSON alternative contact information
    ContactAttempts INT DEFAULT 0,
    LastContactAttempt DATETIME2,

    -- Package condition
    PackageCondition NVARCHAR(100), -- Perfect/Good/Damaged/Tampered/Lost
    DamageAssessment NVARCHAR(MAX), -- JSON damage assessment
    DamagePhotos VARBINARY(MAX),
    PackageIntegrity BIT DEFAULT 1,

    -- Resolution actions
    ResolutionAction NVARCHAR(100), -- ReturnToSender/Redelivery/HoldAtOffice/Destroy/Forward/Other
    ResolutionNotes NVARCHAR(2000),
    ResolutionDeadline DATETIME2,

    -- Redelivery options
    RedeliveryAttempted BIT DEFAULT 0,
    RedeliveryInstructions NVARCHAR(MAX), -- JSON redelivery instructions
    AlternativeDeliveryMethod NVARCHAR(100), -- PostOfficePickup/DifferentAddress/ScheduledDelivery/Other
    RedeliveryFee DECIMAL(10,2) DEFAULT 0,

    -- Cost implications
    ReturnCost DECIMAL(10,2) DEFAULT 0,
    RefundAmount DECIMAL(10,2) DEFAULT 0,
    AdditionalCharges DECIMAL(10,2) DEFAULT 0,
    CostResponsibility NVARCHAR(100), -- Sender/Receiver/PostalService/Shared

    -- Hold and storage
    HoldLocation NVARCHAR(255), -- Post office or depot holding package
    HoldStartDate DATETIME2,
    HoldExpiryDate DATETIME2,
    HoldInstructions NVARCHAR(MAX), -- JSON hold instructions
    StorageFee DECIMAL(10,2) DEFAULT 0,

    -- Customer communication
    SenderNotified BIT DEFAULT 0,
    ReceiverNotified BIT DEFAULT 0,
    NotificationMethod NVARCHAR(100), -- SMS/Email/Phone/Letter/InPerson
    NotificationsSent INT DEFAULT 0,
    LastNotificationAt DATETIME2,

    -- Investigation and dispute
    InvestigationRequired BIT DEFAULT 0,
    InvestigationStatus NVARCHAR(100), -- NotRequired/Initiated/InProgress/Completed/Escalated
    InvestigationNotes NVARCHAR(MAX), -- JSON investigation details
    DisputeRaised BIT DEFAULT 0,
    DisputeResolution NVARCHAR(2000),

    -- Insurance and compensation
    InsuranceClaim BIT DEFAULT 0,
    ClaimAmount DECIMAL(18,2) DEFAULT 0,
    ClaimStatus NVARCHAR(100), -- NotApplicable/Initiated/UnderReview/Approved/Rejected/Paid
    CompensationPaid DECIMAL(18,2) DEFAULT 0,

    -- Process tracking
    ProcessedBy BIGINT, -- Staff member handling return
    ProcessingNotes NVARCHAR(2000),
    QualityReview BIT DEFAULT 0,
    ReviewNotes NVARCHAR(1000),

    -- External system integration
    ProviderReturnID NVARCHAR(255), -- Provider's return reference
    APIResponseData NVARCHAR(MAX), -- JSON API response

    -- Learning and improvement
    RootCause NVARCHAR(200), -- Root cause category
    PreventiveMeasures NVARCHAR(MAX), -- JSON preventive measures
    ProcessImprovement NVARCHAR(2000), -- Process improvement suggestions

    -- Legal and compliance
    RegulatoryCompliance BIT DEFAULT 1,
    LegalRequirements NVARCHAR(MAX), -- JSON legal requirements
    DocumentRetention NVARCHAR(100), -- Retention period for return documents

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_RETURN_HANDLING_SHIPMENT FOREIGN KEY (ShipmentID) REFERENCES [postal].SHIPMENT_TRACKING(ShipmentID),
    CONSTRAINT FK_RETURN_HANDLING_PROCESSED_BY FOREIGN KEY (ProcessedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT FK_RETURN_HANDLING_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_RETURN_HANDLING_Cost CHECK (ReturnCost >= 0),
    CONSTRAINT CK_RETURN_HANDLING_Refund CHECK (RefundAmount >= 0)
);
GO

-- Indexes for RETURN_HANDLING
CREATE INDEX IX_RETURN_HANDLING_Shipment ON [postal].RETURN_HANDLING(ShipmentID);
CREATE INDEX IX_RETURN_HANDLING_Type ON [postal].RETURN_HANDLING(ReturnType, ReturnStatus);
CREATE INDEX IX_RETURN_HANDLING_Status ON [postal].RETURN_HANDLING(ReturnStatus, ReturnInitiatedAt DESC);
CREATE INDEX IX_RETURN_HANDLING_Tracking ON [postal].RETURN_HANDLING(ReturnTrackingNumber);
CREATE INDEX IX_RETURN_HANDLING_Processing ON [postal].RETURN_HANDLING(ProcessedBy, ReturnStatus);
CREATE INDEX IX_RETURN_HANDLING_Investigation ON [postal].RETURN_HANDLING(InvestigationStatus, InvestigationRequired);
CREATE INDEX IX_RETURN_HANDLING_Hold ON [postal].RETURN_HANDLING(HoldLocation, HoldExpiryDate) WHERE HoldStartDate IS NOT NULL;
GO
```

### 4. POSTAL_PROVIDER_CONFIG - Postal service provider configuration

```sql
CREATE TABLE [postal].POSTAL_PROVIDER_CONFIG (
    ProviderConfigID BIGINT PRIMARY KEY IDENTITY,

    -- Provider identification
    ProviderName NVARCHAR(100) UNIQUE NOT NULL, -- VietnamPost/EMS/DHL/FedEx
    ProviderCode NVARCHAR(50) UNIQUE NOT NULL,
    ProviderType NVARCHAR(50) NOT NULL, -- National/International/Express/Standard

    -- API configuration
    APIEndpoint NVARCHAR(500),
    APIVersion NVARCHAR(20),
    APIKey NVARCHAR(500), -- Encrypted
    Username NVARCHAR(255), -- Encrypted if needed
    Password NVARCHAR(500), -- Encrypted
    AuthMethod NVARCHAR(100), -- APIKey/Basic/OAuth2/Bearer

    -- Service capabilities
    SupportedServices NVARCHAR(MAX), -- JSON array of supported services
    MaxWeight DECIMAL(8,3), -- Maximum weight supported in kg
    MaxDimensions NVARCHAR(200), -- Maximum dimensions supported
    CoverageAreas NVARCHAR(MAX), -- JSON array of coverage areas

    -- Pricing configuration
    PricingModel NVARCHAR(100), -- Fixed/Weight-based/Distance-based/Zone-based
    BaseCost DECIMAL(10,2),
    PricingMatrix NVARCHAR(MAX), -- JSON pricing matrix
    CurrencyCode NVARCHAR(10) DEFAULT 'VND',

    -- SLA and performance
    StandardDeliveryDays INT DEFAULT 3,
    ExpressDeliveryDays INT DEFAULT 1,
    SLAGuarantee BIT DEFAULT 0,
    TrackingCapability BIT DEFAULT 1,

    -- Integration settings
    RateLimitRPM INT DEFAULT 60, -- Requests per minute
    BatchSize INT DEFAULT 100, -- Maximum batch size for bulk operations
    RetryAttempts INT DEFAULT 3,
    TimeoutSeconds INT DEFAULT 30,

    -- Status and configuration
    IsActive BIT DEFAULT 1,
    IsPreferred BIT DEFAULT 0,
    Priority INT DEFAULT 100, -- Lower number = higher priority
    ConfigurationJSON NVARCHAR(MAX), -- Additional configuration

    -- Monitoring and health
    LastHealthCheck DATETIME2,
    HealthStatus NVARCHAR(100), -- Healthy/Degraded/Unhealthy/Unknown
    ErrorRate DECIMAL(5,2) DEFAULT 0,
    AverageResponseTime DECIMAL(8,2), -- Average response time in ms

    -- Contact information
    ContactName NVARCHAR(255),
    ContactPhone NVARCHAR(20),
    ContactEmail NVARCHAR(255),
    SupportURL NVARCHAR(500),

    -- Audit trail
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2,
    UpdatedBy BIGINT,

    -- Constraints
    CONSTRAINT FK_POSTAL_PROVIDER_CONFIG_UPDATED_BY FOREIGN KEY (UpdatedBy) REFERENCES [identity].USER_PROFILE(UserID),
    CONSTRAINT CK_POSTAL_PROVIDER_CONFIG_Priority CHECK (Priority > 0),
    CONSTRAINT CK_POSTAL_PROVIDER_CONFIG_Weight CHECK (MaxWeight > 0)
);
GO

-- Indexes for POSTAL_PROVIDER_CONFIG
CREATE INDEX IX_POSTAL_PROVIDER_CONFIG_Active ON [postal].POSTAL_PROVIDER_CONFIG(IsActive, Priority);
CREATE INDEX IX_POSTAL_PROVIDER_CONFIG_Type ON [postal].POSTAL_PROVIDER_CONFIG(ProviderType, IsActive);
CREATE INDEX IX_POSTAL_PROVIDER_CONFIG_Health ON [postal].POSTAL_PROVIDER_CONFIG(HealthStatus, LastHealthCheck DESC);
GO
```

## CROSS-SCHEMA INTEGRATION VIEWS

```sql
-- View for Case service to access shipment information
CREATE VIEW [case].v_PostalShipments
AS
SELECT
    s.ShipmentID,
    s.HoSoID,
    s.TrackingNumber,
    s.ShipmentType,
    s.PostalProvider,
    s.Status,
    s.EstimatedDelivery,
    s.ActualDelivery,
    s.ShippingCost,
    s.ReceiverName,
    s.CreatedAt
FROM [postal].SHIPMENT_TRACKING s
WHERE s.HoSoID IS NOT NULL;
GO

-- View for Notification service to access delivery events
CREATE VIEW [notification].v_PostalNotifications
AS
SELECT
    s.ShipmentID,
    s.HoSoID,
    s.TrackingNumber,
    s.ReceiverPhone,
    s.ReceiverEmail,
    s.Status,
    s.EstimatedDelivery,
    s.ActualDelivery,
    s.DeliveryAttempts,
    CASE
        WHEN s.Status = 'Delivered' THEN 'DeliverySuccess'
        WHEN s.Status = 'Failed' THEN 'DeliveryFailed'
        WHEN s.Status = 'OutForDelivery' THEN 'OutForDelivery'
        WHEN DATEDIFF(hour, GETDATE(), s.EstimatedDelivery) <= 4 THEN 'DeliverySoon'
        ELSE 'StatusUpdate'
    END as NotificationType
FROM [postal].SHIPMENT_TRACKING s;
GO
```

## KEY FEATURES

### VietnamPost Integration
- **Complete API Support**: Full integration with VietnamPost tracking and delivery APIs
- **Service Level Support**: Standard mail, registered mail, EMS, and express services
- **Real-time Tracking**: Live status updates and location tracking
- **Delivery Confirmation**: Digital signatures, photos, and GPS verification

### Multi-Provider Support
- **Provider Abstraction**: Support for multiple postal providers with unified interface
- **Failover Capability**: Automatic failover to backup providers
- **Cost Optimization**: Automatic provider selection based on cost and service level
- **Performance Monitoring**: Provider performance tracking and health monitoring

### Advanced Tracking Features
- **Event-Driven Updates**: Real-time status updates via webhooks and polling
- **Geolocation Tracking**: GPS coordinates for delivery verification
- **Photo Proof**: Visual confirmation of delivery and package condition
- **Digital Signatures**: Secure signature capture for high-value deliveries

### Return and Exception Handling
- **Comprehensive Return Processing**: Full return workflow for undelivered items
- **Root Cause Analysis**: Detailed failure analysis and prevention measures
- **Redelivery Management**: Flexible redelivery options and scheduling
- **Cost Management**: Transparent cost tracking and responsibility assignment

## INTEGRATION PATTERNS

### Event-Driven Architecture
```sql
-- Events published by Postal service:
-- ShipmentCreated
-- ShipmentCollected
-- ShipmentInTransit
-- ShipmentOutForDelivery
-- ShipmentDelivered
-- ShipmentFailed
-- ShipmentReturned
-- DeliveryConfirmed
-- ReturnInitiated
```

### Case Service Integration
- CaseCompleted → Create delivery shipment
- PaymentCompleted → Enable COD delivery
- DocumentsReady → Package and ship results
- AddressUpdated → Update shipment delivery address

### Notification Service Integration
- ShipmentCreated → Send tracking information
- StatusUpdated → Send progress notifications
- DeliveryFailed → Send failure notifications
- DeliverySuccess → Send confirmation notifications

## PERFORMANCE CONSIDERATIONS

### Indexing Strategy
- Composite indexes for tracking number lookups and status filtering
- Time-based indexes for delivery scheduling and SLA monitoring
- Provider-specific indexes for performance analysis
- Location-based indexes for route optimization

### Caching Strategy
- Provider API responses cached with smart invalidation
- Tracking status cached with time-based expiration
- Delivery schedules cached for route planning
- Configuration data cached with dependency tracking

### Scalability Design
- Horizontal scaling support for high-volume shipping
- Partition tables by date for historical tracking data
- Queue-based processing for API calls and notifications
- Load balancing for multiple provider integrations